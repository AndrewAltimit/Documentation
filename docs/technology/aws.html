<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>AWS Developer’s Guide - Andrews Notebook</title>
<meta name="description" content="Technology and Physics notes">


  <meta name="author" content="Andrew">
  


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Andrews Notebook">
<meta property="og:title" content="AWS Developer’s Guide">
<meta property="og:url" content="https://andrewaltimit.github.io/Documentation/docs/technology/aws.html">


  <meta property="og:description" content="Technology and Physics notes">












<link rel="canonical" href="https://andrewaltimit.github.io/Documentation/docs/technology/aws.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://andrewaltimit.github.io/Documentation/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/Documentation/feed.xml" type="application/atom+xml" rel="alternate" title="Andrews Notebook Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/Documentation/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- Custom styles -->
<!-- Custom styles for documentation -->
<link rel="stylesheet" href="/Documentation/style.css">
<style>
  /* Navigation improvements - Sidebar navigation */
  .nav__list .nav__items a {
    display: block;
    padding: 0.2rem 0.75rem !important; /* Reduced padding */
    font-size: 0.8rem !important; /* Smaller font */
    font-weight: normal;
    color: inherit;
    text-decoration: none;
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
    line-height: 1.3 !important; /* Tighter line height */
  }
  
  .nav__list .nav__items a:hover {
    color: #0066cc;
    background-color: rgba(0, 102, 204, 0.05);
    border-left-color: #0066cc;
  }
  
  .nav__list .nav__items a.active {
    color: #0066cc;
    font-weight: bold;
    border-left-color: #0066cc;
    background-color: rgba(0, 102, 204, 0.05);
  }
  
  .nav__title {
    margin: 1rem 0 0.25rem !important; /* Less vertical spacing */
    padding: 0.25rem 0 !important;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 0.75rem !important; /* Smaller section titles */
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px !important;
    color: #666;
    border-bottom: 1px solid #e1e4e8;
  }
  
  /* Override Minimal Mistakes navbar styling with maximum specificity */
  html body .masthead {
    border-bottom: 1px solid #e1e4e8 !important;
    background: white !important;
    position: relative !important;
    clear: both !important;
    margin-bottom: 0 !important;
    padding: 0 !important;
  }
  
  html body .masthead__inner-wrap {
    padding: 0.15em 0.5em !important; /* Even more compact */
    max-width: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
  }
  
  html body .greedy-nav {
    background: transparent !important;
    display: flex !important;
    align-items: center !important;
    width: 100% !important;
    max-width: 100% !important;
    min-height: 1.2rem !important; /* Reduce minimum height */
    gap: 0 !important; /* Remove flexbox gap */
  }
  
  html body .greedy-nav a,
  html body .greedy-nav__toggle {
    margin: 0 0.1rem !important; /* Minimal spacing */
    padding: 0.1rem 0.25rem !important; /* Very small padding */
    font-size: 0.75rem !important; /* Even smaller font */
    line-height: 1 !important;
    display: inline-flex !important;
    align-items: center !important;
  }
  
  body .greedy-nav .visible-links {
    display: flex;
    align-items: center;
    font-size: 0.875rem !important;
    overflow: visible;
  }
  
  body .greedy-nav .visible-links li {
    flex: 0 0 auto;
  }
  
  html body .greedy-nav .visible-links {
    gap: 0 !important;
  }
  
  html body .greedy-nav .visible-links li {
    margin: 0 !important;
  }
  
  html body .greedy-nav .visible-links a {
    position: relative !important;
    margin: 0 0.05rem !important; /* Almost no margin */
    padding: 0.1rem 0.2rem !important;
    white-space: nowrap !important;
    font-size: 0.75rem !important;
  }
  
  body .greedy-nav .visible-links a:before {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    height: 2px;
    background: #0066cc;
    width: 100%;
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }
  
  body .greedy-nav .visible-links a:hover:before {
    transform: scaleX(1);
  }
  
  body .masthead__menu {
    display: flex;
    align-items: center;
    width: 100%;
  }
  
  body .masthead__menu-item {
    display: flex;
    align-items: center;
    font-size: 0.875rem !important;
  }
  
  /* Site title in masthead */
  html body .site-title {
    font-size: 0.9rem !important; /* Smaller site title */
    font-weight: 600 !important;
    margin: 0 !important;
    margin-right: 0.5rem !important;
    padding: 0 !important;
    line-height: 1 !important;
  }
  
  body .site-subtitle {
    display: none; /* Hide subtitle to save space */
  }
  
  /* Ensure the navbar takes minimal vertical space */
  body .masthead {
    min-height: auto !important;
  }
  
  /* Hidden links (hamburger menu) also need to be smaller */
  body .greedy-nav .hidden-links {
    font-size: 0.875rem !important;
  }
  
  body .greedy-nav .hidden-links a {
    padding: 0.25rem 1rem !important;
    font-size: 0.875rem !important;
  }
  
  /* Widescreen optimized layout */
  body {
    overflow-x: hidden;
  }
  
  /* Main container - no max-width for widescreen usage */
  #main {
    display: block;
    position: relative;
    min-height: 100vh;
    width: 100%;
  }
  
  /* Ensure the page fills available width */
  .page {
    width: 100%;
  }
  
  /* Sidebar fixed to left edge of viewport */
  .sidebar.sticky {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    overflow-y: auto;
    background-color: #f8f9fa;
    border-right: 1px solid #e1e4e8;
    padding: 2rem 1rem;
    z-index: 100;
  }
  
  /* Scroll styling for sidebar */
  .sidebar.sticky::-webkit-scrollbar {
    width: 6px;
  }
  
  .sidebar.sticky::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .sidebar.sticky::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
  }
  
  .sidebar.sticky::-webkit-scrollbar-thumb:hover {
    background: #999;
  }
  
  /* Content area with left margin for sidebar */
  article.page {
    margin-left: 280px;
    min-height: 100vh;
    background: white;
  }
  
  /* Content wrapper - use full width */
  .page__inner-wrap {
    max-width: none;
    margin: 0;
    padding: 2rem 3rem;
  }
  
  /* Let content use available width */
  .page__content {
    max-width: none;
    width: 100%;
  }
  
  /* For optimal reading, constrain just the text paragraphs */
  .page__content > p,
  .page__content > ul,
  .page__content > ol {
    max-width: 65ch; /* Optimal line length for reading */
  }
  
  /* Let code blocks, tables, and special content use full width */
  .page__content pre,
  .page__content table,
  .page__content .noteBoxes,
  .page__content .hero-section,
  .page__content figure {
    max-width: 100%;
  }
  
  /* Wide class adjustments */
  .wide .page__inner-wrap {
    max-width: none;
  }
  
  /* Ultra-wide screens (>2000px) */
  @media (min-width: 2000px) {
    .sidebar.sticky {
      width: 320px;
      padding: 2rem 1.5rem;
    }
    
    article.page {
      margin-left: 320px;
    }
    
    .page__inner-wrap {
      padding: 2rem 4rem;
    }
    
    /* Slightly longer optimal line length for larger screens */
    .page__content > p,
    .page__content > ul,
    .page__content > ol {
      max-width: 75ch;
    }
  }
  
  /* Large screens (1440px - 2000px) */
  @media (min-width: 1440px) and (max-width: 1999px) {
    .page__inner-wrap {
      padding: 2rem 3rem;
    }
  }
  
  /* Medium screens (1024px - 1439px) */
  @media (min-width: 1024px) and (max-width: 1439px) {
    .sidebar.sticky {
      width: 250px;
    }
    
    article.page {
      margin-left: 250px;
    }
    
    .page__inner-wrap {
      max-width: 100%;
      padding: 2rem 2rem;
    }
  }
  
  /* Tablet and mobile (<1024px) */
  @media (max-width: 1023px) {
    .sidebar.sticky {
      position: relative;
      width: 100%;
      height: auto;
      border-right: none;
      border-bottom: 1px solid #e1e4e8;
      padding: 1rem;
    }
    
    article.page {
      margin-left: 0;
    }
    
    .page__inner-wrap {
      padding: 1rem;
    }
    
    .page__content {
      max-width: 100%;
    }
  }
  
  /* Mobile menu toggle button - hidden by default */
  .nav-toggle {
    display: none;
  }
  
  @media (max-width: 1023px) {
    .nav-toggle {
      display: block;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 200;
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .sidebar.sticky {
      position: fixed;
      left: -100%;
      transition: left 0.3s ease;
      z-index: 150;
      height: 100vh;
      width: 280px;
      background: #f8f9fa;
    }
    
    .sidebar.sticky.active {
      left: 0;
    }
    
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 140;
    }
    
    .sidebar-overlay.active {
      display: block;
    }
  }
  
  /* Hide title when hero section is present */
  .hero-section {
    margin-bottom: 2rem;
  }
  
  /* Hide the page title when content starts with a hero section */
  .page__inner-wrap header h1#page-title {
    display: none;
  }
  
  /* Show title only when there's no hero section - use JavaScript to add class */
  .page__inner-wrap.no-hero header h1#page-title {
    display: block;
  }
  
  /* Ensure hero section takes up the full width */
  .page__content .hero-section:first-child {
    margin-top: -2rem;
    margin-left: -3rem;
    margin-right: -3rem;
    margin-bottom: 2rem;
  }
  
  /* Adjust hero section margins for smaller screens */
  @media (max-width: 1439px) {
    .page__content .hero-section:first-child {
      margin-left: -2rem;
      margin-right: -2rem;
    }
  }
  
  @media (max-width: 1023px) {
    .page__content .hero-section:first-child {
      margin-left: -1rem;
      margin-right: -1rem;
      margin-top: -1rem;
    }
  }
  
  /* Additional enhancements for better visual hierarchy */
  .nav__list {
    padding: 0;
  }
  
  /* Sidebar background gradient for depth */
  .sidebar.sticky {
    background: linear-gradient(to bottom, #f8f9fa 0%, #f3f4f6 100%);
  }
  
  /* Content typography optimization for wide screens */
  @media (min-width: 1440px) {
    .page__content {
      font-size: 1.125rem;
      line-height: 1.7;
    }
    
    .page__content h1 { font-size: 2.5rem; }
    .page__content h2 { font-size: 2rem; }
    .page__content h3 { font-size: 1.5rem; }
  }
  
  /* Code blocks optimization */
  .page__content pre {
    max-width: 100%;
    overflow-x: auto;
  }
  
  /* Wide screen code improvements */
  @media (min-width: 1440px) {
    .page__content pre {
      font-size: 0.95rem;
    }
  }
  
  /* Syntax highlighted code blocks */
  .highlight {
    max-width: 100%;
    margin: 1rem 0;
  }
  
  /* Tables stretch to use available width */
  .page__content table {
    width: 100%;
    max-width: 100%;
  }
  
  /* Images and media use full available width */
  .page__content img,
  .page__content svg,
  .page__content figure,
  .page__content video,
  .page__content iframe {
    max-width: 100%;
    height: auto;
  }
  
  /* Allow certain elements to break out of paragraph width */
  .page__content .full-width {
    max-width: 100% !important;
    width: 100%;
  }
</style>

<!-- Mobile navigation toggle script and hero section detection -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Detect hero section and hide duplicate title
  const pageContent = document.querySelector('.page__content');
  const pageInnerWrap = document.querySelector('.page__inner-wrap');
  
  if (pageContent && pageInnerWrap) {
    const firstChild = pageContent.firstElementChild;
    
    // Check if the first element is a hero section
    if (firstChild && firstChild.classList.contains('hero-section')) {
      // Hero section exists, hide the title
      pageInnerWrap.classList.remove('no-hero');
    } else {
      // No hero section, show the title
      pageInnerWrap.classList.add('no-hero');
    }
  }
  
  // Create mobile menu toggle button if it doesn't exist
  if (window.innerWidth <= 1023) {
    if (!document.querySelector('.nav-toggle')) {
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'nav-toggle';
      toggleBtn.innerHTML = '☰ Menu';
      toggleBtn.setAttribute('aria-label', 'Toggle navigation menu');
      document.body.appendChild(toggleBtn);
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'sidebar-overlay';
      document.body.appendChild(overlay);
      
      // Toggle functionality
      toggleBtn.addEventListener('click', function() {
        const sidebar = document.querySelector('.sidebar.sticky');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
      });
      
      // Close on overlay click
      overlay.addEventListener('click', function() {
        const sidebar = document.querySelector('.sidebar.sticky');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
      });
    }
  }
  
  // Remove mobile elements on resize to desktop
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      if (window.innerWidth > 1023) {
        const sidebar = document.querySelector('.sidebar.sticky');
        const overlay = document.querySelector('.sidebar-overlay');
        const toggle = document.querySelector('.nav-toggle');
        
        if (sidebar) sidebar.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
        if (toggle) toggle.style.display = 'none';
      } else {
        const toggle = document.querySelector('.nav-toggle');
        if (toggle) toggle.style.display = 'block';
      }
    }, 250);
  });
});
</script>


  
    <script src="/Documentation/assets/js/custom.js"></script>
  

    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--docs wide with-sidebar">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/Documentation/">
          Andrews Notebook
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/Documentation/docs/technology/">Technology</a>
            </li>
<li class="masthead__menu-item">
              <a href="/Documentation/docs/ai-ml/">AI/ML</a>
            </li>
<li class="masthead__menu-item">
              <a href="/Documentation/docs/physics/">Physics</a>
            </li>
<li class="masthead__menu-item">
              <a href="/Documentation/search.html">Search</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://andrewaltimit.github.io/Documentation/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/Documentation/docs" itemprop="item"><span itemprop="name">Docs</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/Documentation/technology" itemprop="item"><span itemprop="name">Technology</span></a>
          <meta itemprop="position" content="3">
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">AWS Developer's Guide</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="AWS Developer’s Guide">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">AWS Developer’s Guide
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-cog"></i> On This Page</h4></header>
              <ul class="toc__menu">
<li><a href="#amazon-ec2---virtual-servers">Amazon EC2 - Virtual Servers</a></li>
<li><a href="#aws-lambda---serverless-computing">AWS Lambda - Serverless Computing</a></li>
<li><a href="#amazon-s3---object-storage">Amazon S3 - Object Storage</a></li>
<li><a href="#amazon-ebs---block-storage">Amazon EBS - Block Storage</a></li>
<li><a href="#amazon-rds---managed-relational-databases">Amazon RDS - Managed Relational Databases</a></li>
<li><a href="#amazon-dynamodb---nosql-at-scale">Amazon DynamoDB - NoSQL at Scale</a></li>
<li><a href="#amazon-vpc---your-private-cloud-network">Amazon VPC - Your Private Cloud Network</a></li>
<li><a href="#learning-resources">Learning Resources</a></li>
<li><a href="#developer-tools">Developer Tools</a></li>
<li><a href="#stay-connected">Stay Connected</a></li>
<li><a href="#understanding-aws-organizations">Understanding AWS Organizations</a></li>
<li><a href="#control-tower-landing-zone">Control Tower Landing Zone</a></li>
<li><a href="#why-events-matter">Why Events Matter</a></li>
<li><a href="#eventbridge-your-event-router">EventBridge: Your Event Router</a></li>
<li><a href="#lambda-with-container-images">Lambda with Container Images</a></li>
<li><a href="#single-table-design">Single Table Design</a></li>
<li><a href="#rest-api-with-request-validation">REST API with Request Validation</a></li>
<li><a href="#principle-of-least-privilege">Principle of Least Privilege</a></li>
<li><a href="#encryption-everywhere">Encryption Everywhere</a></li>
<li><a href="#compute-costs">Compute Costs</a></li>
<li><a href="#storage-costs">Storage Costs</a></li>
<li><a href="#data-transfer-costs">Data Transfer Costs</a></li>
<li><a href="#when-quantum-computing-matters">When Quantum Computing Matters</a></li>
<li><a href="#the-ml-journey-simplified">The ML Journey Simplified</a></li>
<li><a href="#cloudformation-aws-native">CloudFormation (AWS Native)</a></li>
<li><a href="#terraform-multi-cloud">Terraform (Multi-Cloud)</a></li>
<li><a href="#aws-cdk-developer-friendly">AWS CDK (Developer-Friendly)</a></li>
<li><a href="#next-30-days-build-your-foundation">Next 30 Days: Build Your Foundation</a></li>
<li><a href="#next-90-days-develop-expertise">Next 90 Days: Develop Expertise</a></li>
<li><a href="#next-year-achieve-mastery">Next Year: Achieve Mastery</a></li>
</ul>

            </nav>
          </aside>
        
        


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://andrewaltimit.github.io/Documentation/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/Documentation/docs" itemprop="item"><span itemprop="name">Docs</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/Documentation/technology" itemprop="item"><span itemprop="name">Technology</span></a>
          <meta itemprop="position" content="3">
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">AWS Developer's Guide</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  <aside class="sidebar sticky">
    <nav class="nav__list">
      
        
          <h3 class="nav__title">Technology</h3>
          
            <ul class="nav__items">
              
                <li>
                  <a href="/Documentation/docs/technology/index.html">
                    <span class="nav__sub-title">Technology Overview</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/terraform.html">
                    <span class="nav__sub-title">Terraform</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/docker.html">
                    <span class="nav__sub-title">Docker Containers</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/aws.html" class="active">
                    <span class="nav__sub-title">AWS</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/kubernetes.html">
                    <span class="nav__sub-title">Kubernetes</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/database-design.html">
                    <span class="nav__sub-title">Database Design</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/networking.html">
                    <span class="nav__sub-title">Networking</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/cybersecurity.html">
                    <span class="nav__sub-title">Cybersecurity</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/git.html">
                    <span class="nav__sub-title">Git Version Control</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/branching.html">
                    <span class="nav__sub-title">Branching Strategies</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/unreal.html">
                    <span class="nav__sub-title">Unreal Engine</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/quantumcomputing.html">
                    <span class="nav__sub-title">Quantum Computing</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/ai.html">
                    <span class="nav__sub-title">Artificial Intelligence</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/ai-lecture-2023.html">
                    <span class="nav__sub-title">AI Lecture 2023</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/technology/please-build.html">
                    <span class="nav__sub-title">Please Build</span>
                  </a>
                </li>
              
            </ul>
          
        
          <h3 class="nav__title">AI/ML - Generative AI</h3>
          
            <ul class="nav__items">
              
                <li>
                  <a href="/Documentation/docs/ai-ml/index.html">
                    <span class="nav__sub-title">AI/ML Overview</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/stable-diffusion-fundamentals.html">
                    <span class="nav__sub-title">Stable Diffusion Fundamentals</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/base-models-comparison.html">
                    <span class="nav__sub-title">Base Models Comparison</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/model-types.html">
                    <span class="nav__sub-title">Model Types</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/lora-training.html">
                    <span class="nav__sub-title">LoRA Training</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/controlnet.html">
                    <span class="nav__sub-title">ControlNet Guide</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/comfyui-guide.html">
                    <span class="nav__sub-title">ComfyUI Guide</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/output-formats.html">
                    <span class="nav__sub-title">Output Formats</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/ai-ml/advanced-techniques.html">
                    <span class="nav__sub-title">Advanced Techniques</span>
                  </a>
                </li>
              
            </ul>
          
        
          <h3 class="nav__title">Physics</h3>
          
            <ul class="nav__items">
              
                <li>
                  <a href="/Documentation/docs/physics/index.html">
                    <span class="nav__sub-title">Physics Overview</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/classical-mechanics.html">
                    <span class="nav__sub-title">Classical Mechanics</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/thermodynamics.html">
                    <span class="nav__sub-title">Thermodynamics</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/statistical-mechanics.html">
                    <span class="nav__sub-title">Statistical Mechanics</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/relativity.html">
                    <span class="nav__sub-title">Relativity</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/quantum-mechanics.html">
                    <span class="nav__sub-title">Quantum Mechanics</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/condensed-matter.html">
                    <span class="nav__sub-title">Condensed Matter Physics</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/quantum-field-theory.html">
                    <span class="nav__sub-title">Quantum Field Theory</span>
                  </a>
                </li>
              
                <li>
                  <a href="/Documentation/docs/physics/string-theory.html">
                    <span class="nav__sub-title">String Theory</span>
                  </a>
                </li>
              
            </ul>
          
        
      
    </nav>
  </aside>

  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="AWS Developer’s Guide">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://andrewaltimit.github.io/Documentation/docs/technology/aws.html" class="u-url" itemprop="url">AWS Developer’s Guide
</a>
          </h1>
          


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-cog"></i> On This Page</h4></header>
              <ul class="toc__menu">
<li>
<a href="#core-concepts-to-master-first">Core Concepts to Master First</a><ul>
<li><a href="#the-cloud-mental-model">The Cloud Mental Model</a></li>
<li><a href="#regions-and-availability-zones">Regions and Availability Zones</a></li>
<li><a href="#the-pay-as-you-go-model">The Pay-as-You-Go Model</a></li>
<li><a href="#security-as-a-shared-responsibility">Security as a Shared Responsibility</a></li>
<li><a href="#identity-and-access-management-iam">Identity and Access Management (IAM)</a></li>
</ul>
</li>
<li>
<a href="#your-first-steps-with-aws">Your First Steps with AWS</a><ul><li><a href="#getting-your-hands-dirty">Getting Your Hands Dirty</a></li></ul>
</li>
<li>
<a href="#essential-services-for-every-developer">Essential Services for Every Developer</a><ul>
<li>
<a href="#compute-services-your-applications-brain">Compute Services: Your Application’s Brain</a><ul>
<li><a href="#amazon-ec2---virtual-servers">Amazon EC2 - Virtual Servers</a></li>
<li><a href="#aws-lambda---serverless-computing">AWS Lambda - Serverless Computing</a></li>
</ul>
</li>
<li>
<a href="#storage-services-your-applications-memory">Storage Services: Your Application’s Memory</a><ul>
<li><a href="#amazon-s3---object-storage">Amazon S3 - Object Storage</a></li>
<li><a href="#amazon-ebs---block-storage">Amazon EBS - Block Storage</a></li>
</ul>
</li>
<li>
<a href="#database-services-your-applications-long-term-memory">Database Services: Your Application’s Long-term Memory</a><ul>
<li><a href="#amazon-rds---managed-relational-databases">Amazon RDS - Managed Relational Databases</a></li>
<li><a href="#amazon-dynamodb---nosql-at-scale">Amazon DynamoDB - NoSQL at Scale</a></li>
</ul>
</li>
<li>
<a href="#networking-connecting-your-application">Networking: Connecting Your Application</a><ul><li><a href="#amazon-vpc---your-private-cloud-network">Amazon VPC - Your Private Cloud Network</a></li></ul>
</li>
<li>
<a href="#essential-resources-for-your-journey">Essential Resources for Your Journey</a><ul>
<li><a href="#learning-resources">Learning Resources</a></li>
<li><a href="#developer-tools">Developer Tools</a></li>
<li><a href="#stay-connected">Stay Connected</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#building-real-applications-architecture-patterns">Building Real Applications: Architecture Patterns</a><ul>
<li><a href="#pattern-1-static-website-hosting-beginner">Pattern 1: Static Website Hosting (Beginner)</a></li>
<li><a href="#pattern-2-traditional-web-application-intermediate">Pattern 2: Traditional Web Application (Intermediate)</a></li>
<li><a href="#pattern-3-serverless-microservices-advanced">Pattern 3: Serverless Microservices (Advanced)</a></li>
<li><a href="#pattern-4-data-analytics-pipeline-advanced">Pattern 4: Data Analytics Pipeline (Advanced)</a></li>
<li><a href="#pattern-5-container-based-microservices-expert">Pattern 5: Container-Based Microservices (Expert)</a></li>
<li><a href="#pattern-6-multi-region-global-application-expert">Pattern 6: Multi-Region Global Application (Expert)</a></li>
</ul>
</li>
<li>
<a href="#progressive-learning-path-from-zero-to-cloud-architect">Progressive Learning Path: From Zero to Cloud Architect</a><ul>
<li><a href="#tier-1-foundation-services-weeks-1-4">Tier 1: Foundation Services (Weeks 1-4)</a></li>
<li><a href="#tier-2-production-essentials-weeks-5-8">Tier 2: Production Essentials (Weeks 5-8)</a></li>
<li><a href="#tier-3-scaling-and-resilience-weeks-9-12">Tier 3: Scaling and Resilience (Weeks 9-12)</a></li>
<li><a href="#tier-4-enterprise-patterns-months-4-6">Tier 4: Enterprise Patterns (Months 4-6)</a></li>
<li><a href="#tier-5-specialized-services-months-6">Tier 5: Specialized Services (Months 6+)</a></li>
</ul>
</li>
<li>
<a href="#complete-service-reference">Complete Service Reference</a><ul>
<li><a href="#compute-services">Compute Services</a></li>
<li><a href="#storage-services">Storage Services</a></li>
<li><a href="#database-services">Database Services</a></li>
<li><a href="#networking-and-content-delivery">Networking and Content Delivery</a></li>
<li><a href="#security-identity-and-compliance">Security, Identity, and Compliance</a></li>
<li><a href="#application-integration">Application Integration</a></li>
<li><a href="#analytics-services">Analytics Services</a></li>
<li><a href="#machine-learning-and-ai">Machine Learning and AI</a></li>
<li><a href="#developer-tools-1">Developer Tools</a></li>
<li><a href="#management-and-governance">Management and Governance</a></li>
<li><a href="#migration-and-transfer-services">Migration and Transfer Services</a></li>
</ul>
</li>
<li>
<a href="#advanced-cloud-architecture-building-at-scale">Advanced Cloud Architecture: Building at Scale</a><ul>
<li>
<a href="#why-multi-account-architecture">Why Multi-Account Architecture?</a><ul>
<li><a href="#understanding-aws-organizations">Understanding AWS Organizations</a></li>
<li><a href="#control-tower-landing-zone">Control Tower Landing Zone</a></li>
</ul>
</li>
<li>
<a href="#event-driven-architecture-building-reactive-systems">Event-Driven Architecture: Building Reactive Systems</a><ul>
<li><a href="#why-events-matter">Why Events Matter</a></li>
<li><a href="#eventbridge-your-event-router">EventBridge: Your Event Router</a></li>
</ul>
</li>
<li>
<a href="#advanced-lambda-patterns">Advanced Lambda Patterns</a><ul><li><a href="#lambda-with-container-images">Lambda with Container Images</a></li></ul>
</li>
<li>
<a href="#dynamodb-advanced-patterns">DynamoDB Advanced Patterns</a><ul><li><a href="#single-table-design">Single Table Design</a></li></ul>
</li>
<li>
<a href="#api-gateway-advanced-patterns">API Gateway Advanced Patterns</a><ul><li><a href="#rest-api-with-request-validation">REST API with Request Validation</a></li></ul>
</li>
<li><a href="#step-functions-advanced-workflows">Step Functions Advanced Workflows</a></li>
<li><a href="#container-orchestration-with-ecsfargate">Container Orchestration with ECS/Fargate</a></li>
</ul>
</li>
<li>
<a href="#performance-at-scale-making-applications-fast">Performance at Scale: Making Applications Fast</a><ul>
<li><a href="#the-performance-journey">The Performance Journey</a></li>
<li><a href="#cloudfront-your-global-accelerator">CloudFront: Your Global Accelerator</a></li>
<li><a href="#rds-performance-insights">RDS Performance Insights</a></li>
</ul>
</li>
<li>
<a href="#security-your-first-and-constant-priority">Security: Your First and Constant Priority</a><ul>
<li><a href="#the-security-mindset-evolution">The Security Mindset Evolution</a></li>
<li>
<a href="#core-security-principles-that-save-you-later">Core Security Principles That Save You Later</a><ul>
<li><a href="#principle-of-least-privilege">Principle of Least Privilege</a></li>
<li><a href="#encryption-everywhere">Encryption Everywhere</a></li>
</ul>
</li>
<li><a href="#security-hub-your-compliance-command-center">Security Hub: Your Compliance Command Center</a></li>
</ul>
</li>
<li>
<a href="#cost-optimization-spending-smart-in-the-cloud">Cost Optimization: Spending Smart in the Cloud</a><ul>
<li><a href="#the-cost-evolution-pattern">The Cost Evolution Pattern</a></li>
<li>
<a href="#understanding-your-bill">Understanding Your Bill</a><ul>
<li><a href="#compute-costs">Compute Costs</a></li>
<li><a href="#storage-costs">Storage Costs</a></li>
<li><a href="#data-transfer-costs">Data Transfer Costs</a></li>
</ul>
</li>
<li><a href="#advanced-cost-management-tools">Advanced Cost Management Tools</a></li>
</ul>
</li>
<li>
<a href="#the-future-of-cloud-emerging-technologies">The Future of Cloud: Emerging Technologies</a><ul>
<li>
<a href="#quantum-computing-from-science-fiction-to-reality">Quantum Computing: From Science Fiction to Reality</a><ul><li><a href="#when-quantum-computing-matters">When Quantum Computing Matters</a></li></ul>
</li>
<li>
<a href="#machine-learning-ai-for-every-developer">Machine Learning: AI for Every Developer</a><ul><li><a href="#the-ml-journey-simplified">The ML Journey Simplified</a></li></ul>
</li>
</ul>
</li>
<li>
<a href="#infrastructure-as-code-never-click-again">Infrastructure as Code: Never Click Again</a><ul>
<li><a href="#why-infrastructure-as-code-changes-everything">Why Infrastructure as Code Changes Everything</a></li>
<li>
<a href="#choosing-your-iac-tool">Choosing Your IaC Tool</a><ul>
<li><a href="#cloudformation-aws-native">CloudFormation (AWS Native)</a></li>
<li><a href="#terraform-multi-cloud">Terraform (Multi-Cloud)</a></li>
<li><a href="#aws-cdk-developer-friendly">AWS CDK (Developer-Friendly)</a></li>
</ul>
</li>
<li><a href="#real-world-iac-evolution">Real-World IaC Evolution</a></li>
<li><a href="#advanced-patterns-that-save-your-sanity">Advanced Patterns That Save Your Sanity</a></li>
</ul>
</li>
<li>
<a href="#your-cloud-journey-from-here-to-mastery">Your Cloud Journey: From Here to Mastery</a><ul>
<li>
<a href="#the-path-forward">The Path Forward</a><ul>
<li><a href="#next-30-days-build-your-foundation">Next 30 Days: Build Your Foundation</a></li>
<li><a href="#next-90-days-develop-expertise">Next 90 Days: Develop Expertise</a></li>
<li><a href="#next-year-achieve-mastery">Next Year: Achieve Mastery</a></li>
</ul>
</li>
<li><a href="#emerging-trends-to-watch">Emerging Trends to Watch</a></li>
<li><a href="#remember-cloud-is-a-journey-not-a-destination">Remember: Cloud is a Journey, Not a Destination</a></li>
</ul>
</li>
</ul>

            </nav>
          </aside>
        
        <!-- Custom styles are now loaded via main.scss -->

<p>Think of AWS as a massive technology toolkit in the cloud. Instead of buying and maintaining your own servers, you rent computing power, storage, and dozens of other services from Amazon’s data centers around the world. It’s like having access to an entire IT department that scales with your needs - you only pay for what you use, and you can start small and grow as big as you need.</p>

<p>Why does this matter? Because it transforms how we build applications. You can launch a startup from your laptop, scale to millions of users, and only pay for the resources you actually use. No more guessing how many servers you’ll need or waiting weeks for hardware to arrive.</p>

<h2 id="core-concepts-to-master-first">Core Concepts to Master First</h2>

<p>Before diving into specific services, let’s understand the fundamental concepts that make cloud computing powerful:</p>

<h3 id="the-cloud-mental-model">The Cloud Mental Model</h3>
<p>Traditional IT requires you to predict capacity, buy hardware, and maintain everything yourself. Cloud computing flips this model - you provision resources on-demand, scale instantly, and let AWS handle the infrastructure complexity.</p>

<h3 id="regions-and-availability-zones">Regions and Availability Zones</h3>
<p>AWS operates in multiple geographic regions worldwide. Each region contains multiple Availability Zones (AZs) - essentially separate data centers with independent power, cooling, and networking. This geographic distribution is your foundation for building resilient applications that can survive failures.</p>

<h3 id="the-pay-as-you-go-model">The Pay-as-You-Go Model</h3>
<p>Unlike traditional IT where you pay upfront for capacity you might not use, AWS charges based on actual consumption. Launch 100 servers for an hour? You pay for 100 server-hours. This model enables experimentation and scaling without massive capital investment.</p>

<h3 id="security-as-a-shared-responsibility">Security as a Shared Responsibility</h3>
<p>AWS secures the infrastructure (the “security of the cloud”), while you secure your data and applications (“security in the cloud”). Understanding this division helps you build secure systems from day one.</p>

<h3 id="identity-and-access-management-iam">Identity and Access Management (IAM)</h3>
<p>Before creating any resources, understand IAM - it’s the foundation of AWS security. IAM controls who can do what in your AWS account. Start with these principles:</p>
<ul>
  <li>Never use your root account for daily work</li>
  <li>Create individual users with specific permissions</li>
  <li>Use roles for applications, not hardcoded credentials</li>
  <li>Enable MFA (Multi-Factor Authentication) everywhere</li>
</ul>

<h2 id="your-first-steps-with-aws">Your First Steps with AWS</h2>

<p>Now that you understand the core concepts, let’s get practical. AWS can feel overwhelming with its 200+ services, but you don’t need to learn them all at once. Here’s a progressive path from beginner to advanced cloud architect.</p>

<h3 id="getting-your-hands-dirty">Getting Your Hands Dirty</h3>

<p>Start with the AWS Free Tier - it gives you 12 months of free access to core services with generous limits. This is your playground for learning without worrying about costs.</p>

<ol>
  <li>
<strong>Create an AWS Account</strong>: Set up billing alerts immediately (even on free tier)</li>
  <li>
<strong>Secure Your Account</strong>: Enable MFA on your root account and create an IAM user for daily work</li>
  <li>
<strong>Launch Your First EC2 Instance</strong>: Think of it as renting a computer in the cloud</li>
  <li>
<strong>Store Files in S3</strong>: Upload some files and understand object storage</li>
  <li>
<strong>Set Up a Simple Website</strong>: Combine EC2 and S3 to host a basic web application</li>
</ol>

<p>Each step builds on the previous one, gradually introducing you to how AWS services work together.</p>

<h2 id="essential-services-for-every-developer">Essential Services for Every Developer</h2>

<p>Let’s explore the services you’ll use most often, understanding not just what they do, but why they matter for real applications.</p>

<h3 id="compute-services-your-applications-brain">Compute Services: Your Application’s Brain</h3>

<h4 id="amazon-ec2---virtual-servers">Amazon EC2 - Virtual Servers</h4>
<p>EC2 (Elastic Compute Cloud) is like renting computers in the cloud. You choose the operating system, processing power, memory, and storage. Need a small server for testing? Launch a t2.micro. Building a data processing pipeline? Spin up a compute-optimized instance.</p>

<p><strong>Real-world example</strong>: A startup begins with one EC2 instance running their web application. As traffic grows, they add more instances behind a load balancer. During Black Friday, they scale to 50 instances, then scale back down afterward.</p>

<h4 id="aws-lambda---serverless-computing">AWS Lambda - Serverless Computing</h4>
<p>Lambda represents a paradigm shift. Instead of managing servers, you upload your code and AWS runs it in response to events. You pay only for the milliseconds your code executes.</p>

<p><strong>Real-world example</strong>: An e-commerce site uses Lambda to resize product images. When a seller uploads a photo, Lambda automatically creates multiple sizes for different devices. No servers to manage, automatic scaling, and you only pay when images are processed.</p>

<h3 id="storage-services-your-applications-memory">Storage Services: Your Application’s Memory</h3>

<h4 id="amazon-s3---object-storage">Amazon S3 - Object Storage</h4>
<p>S3 (Simple Storage Service) stores files (called objects) in buckets. Unlike traditional file systems, S3 is designed for the internet age - accessible from anywhere, virtually unlimited capacity, and extremely durable.</p>

<p><strong>Real-world example</strong>: Netflix stores its entire video library in S3. When you stream a movie, it’s delivered from S3 through CloudFront (CDN) to your device. S3’s durability ensures those files won’t disappear, while its scalability handles millions of concurrent viewers.</p>

<h4 id="amazon-ebs---block-storage">Amazon EBS - Block Storage</h4>
<p>EBS provides traditional hard drives for your EC2 instances. Unlike S3, EBS acts like a normal disk drive attached to your server.</p>

<p><strong>Real-world example</strong>: A database server uses EBS volumes for storing data files. The volumes can be backed up as snapshots, resized on demand, and moved between instances.</p>

<h3 id="database-services-your-applications-long-term-memory">Database Services: Your Application’s Long-term Memory</h3>

<h4 id="amazon-rds---managed-relational-databases">Amazon RDS - Managed Relational Databases</h4>
<p>RDS runs traditional databases (MySQL, PostgreSQL, etc.) but handles the tedious parts - backups, patching, replication. You focus on your schema and queries while AWS keeps the database running smoothly.</p>

<p><strong>Real-world example</strong>: A SaaS application uses RDS PostgreSQL for customer data. RDS automatically backs up the database nightly, replicates to a standby instance for high availability, and can scale up during busy periods.</p>

<h4 id="amazon-dynamodb---nosql-at-scale">Amazon DynamoDB - NoSQL at Scale</h4>
<p>DynamoDB is a NoSQL database designed for applications that need consistent performance at any scale. It can handle millions of requests per second with single-digit millisecond latency.</p>

<p><strong>Real-world example</strong>: A mobile game uses DynamoDB to store player profiles and game state. Whether 100 or 10 million players are online, DynamoDB maintains consistent performance.</p>

<h3 id="networking-connecting-your-application">Networking: Connecting Your Application</h3>

<h4 id="amazon-vpc---your-private-cloud-network">Amazon VPC - Your Private Cloud Network</h4>
<p>VPC (Virtual Private Cloud) lets you create isolated networks in AWS. Think of it as your own private data center in the cloud, complete with subnets, routing rules, and security controls.</p>

<p>This is where things get more complex, but understanding VPC is crucial for production applications. Let’s build up gradually:</p>

<ol>
  <li>
<strong>Basic VPC</strong>: A simple network with public and private subnets</li>
  <li>
<strong>Internet Access</strong>: Add an Internet Gateway for public-facing resources</li>
  <li>
<strong>Security Groups</strong>: Virtual firewalls controlling traffic to your resources</li>
  <li>
<strong>Multi-AZ Design</strong>: Spread resources across Availability Zones for resilience</li>
</ol>

<p><strong>Real-world example</strong>: An enterprise application runs web servers in public subnets (accessible from internet) and databases in private subnets (only accessible from web servers). This layered security approach protects sensitive data while serving public traffic.</p>

<h3 id="essential-resources-for-your-journey">Essential Resources for Your Journey</h3>

<p>As you progress through your AWS learning journey, these resources will accelerate your growth:</p>

<h4 id="learning-resources">Learning Resources</h4>
<ul>
  <li>
<strong><a href="https://aws.amazon.com/free/">AWS Free Tier</a></strong>: Your risk-free playground with 12 months of free services</li>
  <li>
<strong><a href="https://aws.amazon.com/architecture/well-architected/">AWS Well-Architected Framework</a></strong>: Learn how AWS experts design systems</li>
  <li>
<strong><a href="https://aws.amazon.com/architecture/">AWS Architecture Center</a></strong>: Real-world reference architectures and patterns</li>
  <li>
<strong><a href="https://aws.amazon.com/training/">AWS Training and Certification</a></strong>: Structured learning paths from beginner to expert</li>
</ul>

<h4 id="developer-tools">Developer Tools</h4>
<ul>
  <li>
<strong><a href="https://aws.amazon.com/tools/">AWS SDKs</a></strong>: Integrate AWS services into your applications</li>
  <li>
<strong><a href="https://aws.amazon.com/cdk/">AWS CDK</a></strong>: Define infrastructure using TypeScript, Python, or Java</li>
  <li>
<strong><a href="https://aws.amazon.com/amplify/">AWS Amplify</a></strong>: Fastest way to build full-stack applications</li>
</ul>

<h4 id="stay-connected">Stay Connected</h4>
<ul>
  <li>
<strong><a href="https://aws.amazon.com/blogs/aws/">AWS Blog</a></strong>: Daily updates on new features and best practices</li>
  <li>
<strong><a href="https://forums.aws.amazon.com/index.jspa">AWS Developer Forums</a></strong>: Get help from the community</li>
  <li>
<strong><a href="https://reinvent.awsevents.com/">AWS re:Invent Videos</a></strong>: Hundreds of free technical sessions</li>
</ul>

<p>Pro tip: Start with the Free Tier and Well-Architected Framework. These two resources alone will accelerate your learning by months.</p>

<h2 id="building-real-applications-architecture-patterns">Building Real Applications: Architecture Patterns</h2>

<p>Now that you understand individual services, let’s see how they work together to solve real problems. These patterns progress from simple to complex, each building on concepts from the previous ones.</p>

<h3 id="pattern-1-static-website-hosting-beginner">Pattern 1: Static Website Hosting (Beginner)</h3>

<p>Let’s start with the simplest cloud architecture - hosting a static website. This pattern introduces core concepts with minimal complexity.</p>

<p><strong>Components:</strong></p>
<ul>
  <li>
<strong>S3</strong>: Stores your HTML, CSS, and JavaScript files</li>
  <li>
<strong>CloudFront</strong>: Delivers content globally with low latency</li>
  <li>
<strong>Route 53</strong>: Manages your domain name</li>
</ul>

<p><strong>Why this architecture?</strong> It’s serverless (no EC2 instances to manage), globally distributed (CloudFront edge locations), and costs pennies per month for most sites. Perfect for portfolios, documentation, or marketing sites.</p>

<p><strong>Evolution path</strong>: Add API Gateway and Lambda for dynamic features, turning your static site into a full serverless application.</p>

<h3 id="pattern-2-traditional-web-application-intermediate">Pattern 2: Traditional Web Application (Intermediate)</h3>

<p>The classic three-tier architecture, modernized for the cloud. This pattern teaches you networking, security, and scaling concepts.</p>

<p><strong>Components:</strong></p>
<ul>
  <li>
<strong>VPC</strong>: Your isolated network with public/private subnets</li>
  <li>
<strong>EC2 + Auto Scaling</strong>: Web servers that scale based on traffic</li>
  <li>
<strong>Application Load Balancer</strong>: Distributes traffic across instances</li>
  <li>
<strong>RDS Multi-AZ</strong>: Managed database with automatic failover</li>
  <li>
<strong>ElastiCache</strong>: Redis/Memcached for session storage and caching</li>
</ul>

<p><strong>Why this architecture?</strong> It mirrors traditional on-premise setups but with cloud benefits - automatic scaling, managed databases, and high availability across multiple data centers.</p>

<p><strong>Real-world example</strong>: An e-commerce platform starts with 2 EC2 instances. During sales events, Auto Scaling launches up to 20 instances. RDS handles thousands of concurrent transactions while ElastiCache reduces database load by caching product catalogs.</p>

<h3 id="pattern-3-serverless-microservices-advanced">Pattern 3: Serverless Microservices (Advanced)</h3>

<p>Embrace modern cloud-native development. No servers to manage, automatic scaling, and pay-per-request pricing.</p>

<p><strong>Components:</strong></p>
<ul>
  <li>
<strong>API Gateway</strong>: RESTful API endpoint management</li>
  <li>
<strong>Lambda</strong>: Individual functions for each microservice</li>
  <li>
<strong>DynamoDB</strong>: NoSQL database with single-digit millisecond performance</li>
  <li>
<strong>Step Functions</strong>: Orchestrate complex workflows</li>
  <li>
<strong>EventBridge</strong>: Decouple services with event-driven architecture</li>
</ul>

<p><strong>Why this architecture?</strong> Each microservice scales independently, deploys separately, and costs nothing when idle. Perfect for variable workloads and rapid development.</p>

<p><strong>Real-world example</strong>: A food delivery app uses Lambda functions for order processing, restaurant notifications, and driver assignments. DynamoDB stores order data with automatic scaling. Step Functions coordinate the entire delivery workflow. During lunch rush, the system handles 10,000 orders per minute without any manual scaling.</p>

<h3 id="pattern-4-data-analytics-pipeline-advanced">Pattern 4: Data Analytics Pipeline (Advanced)</h3>

<p>Process massive amounts of data in real-time and batch modes. This pattern introduces big data concepts and tools.</p>

<p><strong>Components:</strong></p>
<ul>
  <li>
<strong>Kinesis Data Streams</strong>: Ingest real-time data from thousands of sources</li>
  <li>
<strong>Kinesis Data Firehose</strong>: Load streaming data into data stores</li>
  <li>
<strong>S3 Data Lake</strong>: Central repository for all your data</li>
  <li>
<strong>AWS Glue</strong>: ETL service for data preparation</li>
  <li>
<strong>Athena</strong>: Query data directly in S3 using SQL</li>
  <li>
<strong>QuickSight</strong>: Create dashboards and visualizations</li>
</ul>

<p><strong>Why this architecture?</strong> It separates data ingestion, storage, processing, and analysis into specialized services. Each component scales independently and you only pay for what you process.</p>

<p><strong>Real-world example</strong>: An IoT company collects sensor data from millions of devices. Kinesis ingests 1TB per hour, Glue transforms it for analysis, and data scientists query historical data with Athena. Business users create real-time dashboards in QuickSight showing device health and usage patterns.</p>

<h3 id="pattern-5-container-based-microservices-expert">Pattern 5: Container-Based Microservices (Expert)</h3>

<p>For teams needing more control than serverless offers. Containers provide consistency across development and production.</p>

<p><strong>Components:</strong></p>
<ul>
  <li>
<strong>ECS or EKS</strong>: Container orchestration (ECS for simplicity, EKS for Kubernetes)</li>
  <li>
<strong>Fargate</strong>: Serverless compute for containers</li>
  <li>
<strong>ECR</strong>: Container registry for your Docker images</li>
  <li>
<strong>App Mesh</strong>: Service mesh for microservice communication</li>
  <li>
<strong>CloudMap</strong>: Service discovery for dynamic environments</li>
</ul>

<p><strong>Why this architecture?</strong> Containers offer portability, consistency, and fine-grained resource control. Service mesh provides advanced traffic management and observability.</p>

<p><strong>Real-world example</strong>: A fintech platform runs 50+ microservices in EKS. Each team owns their services, deploying independently. App Mesh handles service-to-service authentication and implements canary deployments. During market hours, critical services auto-scale based on trading volume.</p>

<h3 id="pattern-6-multi-region-global-application-expert">Pattern 6: Multi-Region Global Application (Expert)</h3>

<p>For applications requiring global presence, low latency, and extreme availability.</p>

<p><strong>Components:</strong></p>
<ul>
  <li>
<strong>Route 53</strong>: Geolocation and latency-based routing</li>
  <li>
<strong>CloudFront</strong>: Global content delivery</li>
  <li>
<strong>DynamoDB Global Tables</strong>: Multi-region replication</li>
  <li>
<strong>Aurora Global Database</strong>: Cross-region read replicas</li>
  <li>
<strong>AWS Global Accelerator</strong>: Improve global application availability</li>
</ul>

<p><strong>Why this architecture?</strong> Users get low latency regardless of location. The application survives entire region failures. Data replicates globally in seconds.</p>

<p><strong>Real-world example</strong>: A social media platform serves users across continents. Route 53 directs users to the nearest region. DynamoDB Global Tables replicate user posts worldwide in under a second. If the US-East region fails, traffic automatically routes to US-West with minimal disruption.</p>

<h2 id="progressive-learning-path-from-zero-to-cloud-architect">Progressive Learning Path: From Zero to Cloud Architect</h2>

<p>AWS offers 200+ services, but you don’t need to learn them all. Here’s a curated learning path that builds your skills progressively. Each tier assumes mastery of the previous one.</p>

<h3 id="tier-1-foundation-services-weeks-1-4">Tier 1: Foundation Services (Weeks 1-4)</h3>
<p>Master these first. Every AWS architect uses these daily.</p>

<p><strong>Compute</strong></p>
<ul>
  <li>
<strong>EC2</strong>: Virtual servers - learn instance types, AMIs, and basic networking</li>
  <li>
<strong>Lambda</strong>: Serverless functions - start with simple Python/Node.js functions</li>
</ul>

<p><strong>Storage</strong></p>
<ul>
  <li>
<strong>S3</strong>: Object storage - understand buckets, objects, and basic permissions</li>
  <li>
<strong>EBS</strong>: Block storage for EC2 - learn volume types and snapshots</li>
</ul>

<p><strong>Networking</strong></p>
<ul>
  <li>
<strong>VPC</strong>: Virtual networks - grasp subnets, routing, and security groups</li>
  <li>
<strong>CloudFront</strong>: CDN basics - cache static content from S3</li>
</ul>

<p><strong>Security</strong></p>
<ul>
  <li>
<strong>IAM</strong>: Identity management - users, roles, and policies</li>
</ul>

<h3 id="tier-2-production-essentials-weeks-5-8">Tier 2: Production Essentials (Weeks 5-8)</h3>
<p>Services that make applications production-ready.</p>

<p><strong>Databases</strong></p>
<ul>
  <li>
<strong>RDS</strong>: Managed SQL databases - focus on MySQL or PostgreSQL</li>
  <li>
<strong>DynamoDB</strong>: NoSQL basics - understand partition keys and queries</li>
</ul>

<p><strong>Application Integration</strong></p>
<ul>
  <li>
<strong>SQS</strong>: Message queuing - decouple application components</li>
  <li>
<strong>SNS</strong>: Notifications - email and SMS alerts</li>
</ul>

<p><strong>Monitoring</strong></p>
<ul>
  <li>
<strong>CloudWatch</strong>: Metrics, logs, and alarms</li>
  <li>
<strong>X-Ray</strong>: Distributed tracing basics</li>
</ul>

<p><strong>Developer Tools</strong></p>
<ul>
  <li>
<strong>CodeDeploy</strong>: Automated deployments</li>
  <li>
<strong>Systems Manager</strong>: Parameter Store for configuration</li>
</ul>

<h3 id="tier-3-scaling-and-resilience-weeks-9-12">Tier 3: Scaling and Resilience (Weeks 9-12)</h3>
<p>Build applications that scale and survive failures.</p>

<p><strong>Advanced Compute</strong></p>
<ul>
  <li>
<strong>Auto Scaling</strong>: Dynamic capacity management</li>
  <li>
<strong>ECS</strong>: Container orchestration basics</li>
  <li>
<strong>Elastic Load Balancing</strong>: ALB for HTTP/HTTPS traffic</li>
</ul>

<p><strong>Advanced Storage</strong></p>
<ul>
  <li>
<strong>EFS</strong>: Shared file storage across EC2 instances</li>
  <li>
<strong>S3 Lifecycle Policies</strong>: Automated data archiving</li>
</ul>

<p><strong>Advanced Networking</strong></p>
<ul>
  <li>
<strong>Route 53</strong>: DNS management and health checks</li>
  <li>
<strong>API Gateway</strong>: RESTful API development</li>
</ul>

<p><strong>Data Processing</strong></p>
<ul>
  <li>
<strong>Kinesis</strong>: Real-time data streaming</li>
  <li>
<strong>Athena</strong>: Query data in S3 with SQL</li>
</ul>

<h3 id="tier-4-enterprise-patterns-months-4-6">Tier 4: Enterprise Patterns (Months 4-6)</h3>
<p>Services for complex, enterprise-grade applications.</p>

<p><strong>Container Orchestration</strong></p>
<ul>
  <li>
<strong>EKS</strong>: Kubernetes on AWS</li>
  <li>
<strong>Fargate</strong>: Serverless containers</li>
  <li>
<strong>ECR</strong>: Container registry</li>
</ul>

<p><strong>Advanced Data</strong></p>
<ul>
  <li>
<strong>Redshift</strong>: Data warehousing</li>
  <li>
<strong>EMR</strong>: Big data processing with Spark/Hadoop</li>
  <li>
<strong>Glue</strong>: ETL and data cataloging</li>
</ul>

<p><strong>Machine Learning</strong></p>
<ul>
  <li>
<strong>SageMaker</strong>: ML model training and deployment</li>
  <li>
<strong>Rekognition</strong>: Image and video analysis</li>
</ul>

<p><strong>Enterprise Integration</strong></p>
<ul>
  <li>
<strong>Step Functions</strong>: Complex workflow orchestration</li>
  <li>
<strong>EventBridge</strong>: Event-driven architectures</li>
  <li>
<strong>AppSync</strong>: Managed GraphQL</li>
</ul>

<h3 id="tier-5-specialized-services-months-6">Tier 5: Specialized Services (Months 6+)</h3>
<p>Domain-specific services for specialized use cases.</p>

<p><strong>IoT and Edge</strong></p>
<ul>
  <li>
<strong>IoT Core</strong>: Device connectivity and management</li>
  <li>
<strong>Greengrass</strong>: Edge computing</li>
</ul>

<p><strong>Media Services</strong></p>
<ul>
  <li>
<strong>Elemental MediaConvert</strong>: Video transcoding</li>
  <li>
<strong>Kinesis Video Streams</strong>: Video ingestion</li>
</ul>

<p><strong>Quantum Computing</strong></p>
<ul>
  <li>
<strong>Braket</strong>: Quantum computing experiments</li>
</ul>

<p><strong>Game Development</strong></p>
<ul>
  <li>
<strong>GameLift</strong>: Game server hosting</li>
  <li>
<strong>Lumberyard</strong>: Game engine integration</li>
</ul>

<h2 id="complete-service-reference">Complete Service Reference</h2>

<p>Here’s a comprehensive reference of AWS services organized by category. Use this as a lookup guide as you encounter services in architectures and documentation.</p>

<h3 id="compute-services">Compute Services</h3>

<p><strong>Virtual Servers and Containers</strong></p>
<ul>
  <li>
<strong>EC2 (Elastic Compute Cloud)</strong>: Rent virtual servers with full control over the operating system</li>
  <li>
<strong>ECS (Elastic Container Service)</strong>: Run Docker containers with AWS-native orchestration</li>
  <li>
<strong>EKS (Elastic Kubernetes Service)</strong>: Managed Kubernetes for teams already using K8s</li>
  <li>
<strong>Fargate</strong>: Run containers without managing servers (serverless containers)</li>
</ul>

<p><strong>Serverless Compute</strong></p>
<ul>
  <li>
<strong>Lambda</strong>: Run code in response to events, pay only for compute time used</li>
  <li>
<strong>Batch</strong>: Run batch computing workloads at any scale</li>
  <li>
<strong>Lightsail</strong>: Simple virtual private servers for basic workloads</li>
</ul>

<h3 id="storage-services">Storage Services</h3>

<p><strong>Object Storage</strong></p>
<ul>
  <li>
<strong>S3 (Simple Storage Service)</strong>: Store and retrieve any amount of data from anywhere</li>
  <li>
<strong>S3 Glacier</strong>: Long-term archive storage at extremely low cost</li>
</ul>

<p><strong>Block Storage</strong></p>
<ul>
  <li>
<strong>EBS (Elastic Block Store)</strong>: Persistent block storage for EC2 instances</li>
  <li>
<strong>Instance Store</strong>: Temporary block storage physically attached to EC2 host</li>
</ul>

<p><strong>File Storage</strong></p>
<ul>
  <li>
<strong>EFS (Elastic File System)</strong>: Managed NFS for EC2 instances</li>
  <li>
<strong>FSx</strong>: Fully managed Windows file servers and high-performance computing file systems</li>
</ul>

<p><strong>Hybrid Storage</strong></p>
<ul>
  <li>
<strong>Storage Gateway</strong>: Connect on-premises applications to AWS storage</li>
  <li>
<strong>AWS Backup</strong>: Centralized backup across AWS services</li>
</ul>

<h3 id="database-services">Database Services</h3>

<p><strong>Relational Databases</strong></p>
<ul>
  <li>
<strong>RDS (Relational Database Service)</strong>: Managed MySQL, PostgreSQL, Oracle, SQL Server, MariaDB</li>
  <li>
<strong>Aurora</strong>: AWS-built MySQL/PostgreSQL compatible database with 5x performance</li>
  <li>
<strong>Aurora Serverless</strong>: Auto-scaling version of Aurora for variable workloads</li>
</ul>

<p><strong>NoSQL Databases</strong></p>
<ul>
  <li>
<strong>DynamoDB</strong>: Fast, flexible NoSQL database with single-digit millisecond latency</li>
  <li>
<strong>DocumentDB</strong>: MongoDB-compatible document database</li>
  <li>
<strong>Keyspaces</strong>: Managed Apache Cassandra-compatible database</li>
</ul>

<p><strong>In-Memory Databases</strong></p>
<ul>
  <li>
<strong>ElastiCache</strong>: Managed Redis and Memcached for microsecond latency</li>
  <li>
<strong>MemoryDB for Redis</strong>: Redis-compatible, durable in-memory database</li>
</ul>

<p><strong>Specialty Databases</strong></p>
<ul>
  <li>
<strong>Neptune</strong>: Graph database for highly connected datasets</li>
  <li>
<strong>Timestream</strong>: Time series database for IoT and operational applications</li>
  <li>
<strong>QLDB</strong>: Ledger database with immutable transaction log</li>
</ul>

<h3 id="networking-and-content-delivery">Networking and Content Delivery</h3>

<p><strong>Core Networking</strong></p>
<ul>
  <li>
<strong>VPC (Virtual Private Cloud)</strong>: Isolated cloud resources in a virtual network</li>
  <li>
<strong>Route 53</strong>: Scalable DNS and domain registration</li>
  <li>
<strong>CloudFront</strong>: Global content delivery network (CDN)</li>
</ul>

<p><strong>Network Connectivity</strong></p>
<ul>
  <li>
<strong>Direct Connect</strong>: Dedicated network connection to AWS</li>
  <li>
<strong>VPN</strong>: Secure connections between on-premises networks and VPC</li>
  <li>
<strong>Transit Gateway</strong>: Connect VPCs and on-premises networks through a central hub</li>
</ul>

<p><strong>Load Balancing</strong></p>
<ul>
  <li>
<strong>Elastic Load Balancing</strong>: Distribute traffic across multiple targets</li>
  <li>
<strong>Application Load Balancer</strong>: HTTP/HTTPS traffic with advanced routing</li>
  <li>
<strong>Network Load Balancer</strong>: Ultra-high performance for TCP/UDP traffic</li>
</ul>

<h3 id="security-identity-and-compliance">Security, Identity, and Compliance</h3>

<p><strong>Identity and Access</strong></p>
<ul>
  <li>
<strong>IAM (Identity and Access Management)</strong>: Control access to AWS resources</li>
  <li>
<strong>Cognito</strong>: User authentication for mobile and web apps</li>
  <li>
<strong>SSO</strong>: Centralized access to multiple AWS accounts and applications</li>
</ul>

<p><strong>Detection and Response</strong></p>
<ul>
  <li>
<strong>GuardDuty</strong>: Threat detection using machine learning</li>
  <li>
<strong>Security Hub</strong>: Unified view of security alerts and compliance status</li>
  <li>
<strong>Detective</strong>: Analyze and visualize security data to investigate incidents</li>
</ul>

<p><strong>Data Protection</strong></p>
<ul>
  <li>
<strong>KMS (Key Management Service)</strong>: Create and control encryption keys</li>
  <li>
<strong>Secrets Manager</strong>: Rotate, manage, and retrieve secrets</li>
  <li>
<strong>Certificate Manager</strong>: Provision and manage SSL/TLS certificates</li>
</ul>

<h3 id="application-integration">Application Integration</h3>

<p><strong>Messaging</strong></p>
<ul>
  <li>
<strong>SQS (Simple Queue Service)</strong>: Managed message queuing service</li>
  <li>
<strong>SNS (Simple Notification Service)</strong>: Pub/sub messaging and mobile notifications</li>
  <li>
<strong>EventBridge</strong>: Serverless event bus connecting applications</li>
</ul>

<p><strong>Workflow Orchestration</strong></p>
<ul>
  <li>
<strong>Step Functions</strong>: Coordinate distributed applications using visual workflows</li>
  <li>
<strong>SWF (Simple Workflow)</strong>: Build scalable, resilient applications (legacy, use Step Functions)</li>
</ul>

<p><strong>API Management</strong></p>
<ul>
  <li>
<strong>API Gateway</strong>: Create, publish, and manage APIs at any scale</li>
  <li>
<strong>AppSync</strong>: Managed GraphQL service with real-time data sync</li>
</ul>

<h3 id="analytics-services">Analytics Services</h3>

<p><strong>Data Streaming and Processing</strong></p>
<ul>
  <li>
<strong>Kinesis Data Streams</strong>: Real-time data streaming at scale</li>
  <li>
<strong>Kinesis Data Firehose</strong>: Load streaming data into data stores</li>
  <li>
<strong>Kinesis Data Analytics</strong>: Process streaming data with SQL or Apache Flink</li>
</ul>

<p><strong>Big Data Processing</strong></p>
<ul>
  <li>
<strong>EMR (Elastic MapReduce)</strong>: Managed Hadoop, Spark, HBase, and Presto</li>
  <li>
<strong>Glue</strong>: Serverless ETL service for data preparation</li>
  <li>
<strong>Data Pipeline</strong>: Orchestrate data movement and transformation</li>
</ul>

<p><strong>Data Warehousing and Query</strong></p>
<ul>
  <li>
<strong>Redshift</strong>: Petabyte-scale data warehouse</li>
  <li>
<strong>Athena</strong>: Query data in S3 using standard SQL</li>
  <li>
<strong>Lake Formation</strong>: Build secure data lakes in days instead of months</li>
</ul>

<p><strong>Business Intelligence</strong></p>
<ul>
  <li>
<strong>QuickSight</strong>: Scalable business intelligence service</li>
  <li>
<strong>DataZone</strong>: Discover, share, and govern data at scale</li>
</ul>

<h3 id="machine-learning-and-ai">Machine Learning and AI</h3>

<p><strong>ML Platform</strong></p>
<ul>
  <li>
<strong>SageMaker</strong>: Build, train, and deploy machine learning models</li>
  <li>
<strong>SageMaker Studio</strong>: Integrated development environment for ML</li>
  <li>
<strong>SageMaker Feature Store</strong>: Store and share ML features</li>
</ul>

<p><strong>AI Services (Pre-trained Models)</strong></p>
<ul>
  <li>
<strong>Rekognition</strong>: Image and video analysis</li>
  <li>
<strong>Textract</strong>: Extract text and data from documents</li>
  <li>
<strong>Comprehend</strong>: Natural language processing</li>
  <li>
<strong>Translate</strong>: Neural machine translation</li>
  <li>
<strong>Polly</strong>: Text-to-speech</li>
  <li>
<strong>Transcribe</strong>: Speech-to-text</li>
  <li>
<strong>Lex</strong>: Build conversational interfaces</li>
  <li>
<strong>Personalize</strong>: Real-time personalization and recommendations</li>
  <li>
<strong>Forecast</strong>: Time-series forecasting</li>
</ul>

<h3 id="developer-tools-1">Developer Tools</h3>

<p><strong>CI/CD Pipeline</strong></p>
<ul>
  <li>
<strong>CodeCommit</strong>: Git-based source control</li>
  <li>
<strong>CodeBuild</strong>: Compile and test code</li>
  <li>
<strong>CodeDeploy</strong>: Automated code deployment</li>
  <li>
<strong>CodePipeline</strong>: Continuous delivery service</li>
  <li>
<strong>CodeStar</strong>: Unified interface for DevOps</li>
</ul>

<p><strong>Development Productivity</strong></p>
<ul>
  <li>
<strong>Cloud9</strong>: Cloud-based IDE</li>
  <li>
<strong>CloudShell</strong>: Browser-based shell with AWS CLI</li>
  <li>
<strong>CodeGuru</strong>: ML-powered code reviews</li>
  <li>
<strong>CodeWhisperer</strong>: AI coding companion</li>
</ul>

<h3 id="management-and-governance">Management and Governance</h3>

<p><strong>Monitoring and Observability</strong></p>
<ul>
  <li>
<strong>CloudWatch</strong>: Metrics, logs, and alarms</li>
  <li>
<strong>X-Ray</strong>: Distributed application tracing</li>
  <li>
<strong>CloudTrail</strong>: API activity logging</li>
  <li>
<strong>Systems Manager</strong>: Operational insights and actions</li>
</ul>

<p><strong>Resource Management</strong></p>
<ul>
  <li>
<strong>CloudFormation</strong>: Infrastructure as code</li>
  <li>
<strong>Service Catalog</strong>: Create and manage approved products</li>
  <li>
<strong>Control Tower</strong>: Set up multi-account environments</li>
  <li>
<strong>Config</strong>: Track resource configurations</li>
</ul>

<p><strong>Cost Management</strong></p>
<ul>
  <li>
<strong>Cost Explorer</strong>: Visualize and manage costs</li>
  <li>
<strong>Budgets</strong>: Set custom cost and usage budgets</li>
  <li>
<strong>Trusted Advisor</strong>: Best practice recommendations</li>
</ul>

<h3 id="migration-and-transfer-services">Migration and Transfer Services</h3>

<p><strong>Database Migration</strong></p>
<ul>
  <li>
<strong>Database Migration Service (DMS)</strong>: Migrate databases with minimal downtime</li>
  <li>
<strong>Schema Conversion Tool</strong>: Convert database schemas between engines</li>
</ul>

<p><strong>Data Transfer</strong></p>
<ul>
  <li>
<strong>DataSync</strong>: Transfer data between on-premises and AWS</li>
  <li>
<strong>Transfer Family</strong>: Managed file transfers (SFTP, FTPS, FTP)</li>
  <li>
<strong>Snow Family</strong>: Physical devices for petabyte-scale data transfer</li>
</ul>

<p><strong>Application Migration</strong></p>
<ul>
  <li>
<strong>Application Migration Service</strong>: Lift-and-shift applications to AWS</li>
  <li>
<strong>Application Discovery Service</strong>: Plan migration projects</li>
</ul>

<h2 id="advanced-cloud-architecture-building-at-scale">Advanced Cloud Architecture: Building at Scale</h2>

<p>Once you’ve mastered the basics, these advanced patterns help you build enterprise-grade systems. Each pattern solves specific challenges that emerge as applications grow.</p>

<h3 id="why-multi-account-architecture">Why Multi-Account Architecture?</h3>

<p>As your AWS usage grows, managing everything in a single account becomes risky and complex. Imagine running development experiments in the same account as production customer data - one mistake could be catastrophic. Multi-account architecture solves this by creating boundaries.</p>

<h4 id="understanding-aws-organizations">Understanding AWS Organizations</h4>

<p>Think of AWS Organizations as a company structure for your cloud resources. Just as companies have departments (Engineering, Finance, HR), you create separate AWS accounts for different purposes:</p>

<p><strong>Account Structure That Makes Sense:</strong></p>
<ul>
  <li>
<strong>Production Account</strong>: Customer-facing applications only</li>
  <li>
<strong>Development Account</strong>: Safe playground for experiments</li>
  <li>
<strong>Security Account</strong>: Centralized logging and compliance tools</li>
  <li>
<strong>Shared Services Account</strong>: Common resources like CI/CD pipelines</li>
</ul>

<p><strong>Real-world example</strong>: A startup begins with one AWS account. After a developer accidentally deletes production data while testing, they implement Organizations. Now developers can’t even access production resources without explicit permission. The security team monitors all accounts from a central location.</p>

<p><strong>Service Control Policies (SCPs)</strong>: These are like company-wide rules. For example, “No one can launch EC2 instances outside approved regions” or “All S3 buckets must be encrypted.” SCPs enforce these rules across all accounts, preventing costly mistakes.</p>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/organizations-setup.tf">organizations-setup.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"organization"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/organization"</span>
  
  <span class="nx">external_id</span> <span class="o">=</span> <span class="s2">"unique-external-id"</span>
  
  <span class="c1"># Reference outputs</span>
  <span class="nx">organization_id</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">organization</span><span class="p">.</span><span class="nx">organization_id</span>
  <span class="nx">account_ids</span>    <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">organization</span><span class="p">.</span><span class="nx">account_ids</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="control-tower-landing-zone">Control Tower Landing Zone</h4>

<p><strong>AWS Control Tower provides automated multi-account governance:</strong></p>

<ul>
  <li>
<strong>Account Factory for Terraform (AFT)</strong>: GitOps-based account provisioning</li>
  <li>
<strong>Security Baseline</strong>: Automated security service deployment</li>
  <li>
<strong>Guardrails</strong>: Preventive and detective controls</li>
  <li>
<strong>Landing Zone</strong>: Well-architected multi-account environment</li>
</ul>

<p><strong>Key components implemented:</strong></p>
<ul>
  <li>Organizational structure with Security, Production, and Development OUs</li>
  <li>Automated security services (CloudTrail, Config, GuardDuty, SecurityHub)</li>
  <li>Strict IAM password policies across all accounts</li>
  <li>Integration with Terraform Cloud for infrastructure management</li>
</ul>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/control-tower-landing-zone.tf">control-tower-landing-zone.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"landing_zone"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/control-tower"</span>
  
  <span class="nx">aws_region</span>             <span class="o">=</span> <span class="s2">"us-east-1"</span>
  <span class="nx">terraform_cloud_token</span>  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">tfc_token</span>
  <span class="nx">terraform_cloud_org</span>    <span class="o">=</span> <span class="s2">"myorg"</span>
  <span class="nx">github_org</span>            <span class="o">=</span> <span class="s2">"mycompany"</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="event-driven-architecture-building-reactive-systems">Event-Driven Architecture: Building Reactive Systems</h3>

<p>Traditional applications work like phone calls - one service directly calls another and waits for a response. Event-driven architecture works like text messages - services broadcast events and interested parties respond when ready. This decoupling transforms how we build scalable systems.</p>

<h4 id="why-events-matter">Why Events Matter</h4>

<p>Imagine an e-commerce order: payment processing, inventory updates, shipping notifications, and analytics all need to happen. In traditional architecture, your order service would call each system sequentially. If shipping is slow, the entire order process slows down. With events, the order service simply announces “Order Placed!” and each system reacts independently.</p>

<h4 id="eventbridge-your-event-router">EventBridge: Your Event Router</h4>

<p>EventBridge acts as the central nervous system of your application. Services publish events without knowing who consumes them. New features can listen to existing events without changing the publishers.</p>

<p><strong>Pattern in Action: Order Processing</strong></p>

<ol>
  <li>
<strong>Order Service</strong> publishes “OrderCreated” event</li>
  <li>
<strong>Payment Service</strong> processes payment and publishes “PaymentCompleted”</li>
  <li>
<strong>Inventory Service</strong> reserves items and publishes “ItemsReserved”</li>
  <li>
<strong>Shipping Service</strong> creates labels when all prerequisites are met</li>
  <li>
<strong>Analytics Service</strong> updates dashboards with each event</li>
</ol>

<p><strong>Resilience Built-In:</strong></p>
<ul>
  <li>
<strong>Dead Letter Queues</strong>: Failed events aren’t lost, they’re queued for investigation</li>
  <li>
<strong>Event Replay</strong>: Replay historical events to recover from failures or test new features</li>
  <li>
<strong>Error Notifications</strong>: Get alerted when event processing fails</li>
</ul>

<p><strong>Real-world example</strong>: A food delivery platform uses EventBridge to coordinate restaurants, drivers, and customers. When an order is placed, events trigger kitchen notifications, driver assignments, and customer updates. Each service scales independently - during lunch rush, driver assignment might process 1000 events/second while payment processing handles 100/second.</p>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/eventbridge-pattern.tf">eventbridge-pattern.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"event_driven_system"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/eventbridge"</span>
  
  <span class="nx">environment</span> <span class="o">=</span> <span class="s2">"production"</span>
  <span class="nx">aws_region</span>  <span class="o">=</span> <span class="s2">"us-east-1"</span>
  
  <span class="c1"># Connect to existing resources</span>
  <span class="nx">orders_table_arn</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">kms_key_id</span>      <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="advanced-lambda-patterns">Advanced Lambda Patterns</h3>

<h4 id="lambda-with-container-images">Lambda with Container Images</h4>

<p><strong>Advanced Lambda patterns with containers and enterprise features:</strong></p>

<ul>
  <li>
<strong>Container Images</strong>: Package Lambda functions as OCI images up to 10GB</li>
  <li>
<strong>Lambda Layers</strong>: Share code and dependencies across functions</li>
  <li>
<strong>Extensions</strong>: Integrate monitoring and security tools</li>
  <li>
<strong>Auto-scaling</strong>: Provisioned concurrency with automatic scaling</li>
</ul>

<p><strong>Key features implemented:</strong></p>
<ul>
  <li>ECR repository with lifecycle policies</li>
  <li>Container-based Lambda with 10GB ephemeral storage</li>
  <li>AWS Lambda Powertools and OpenTelemetry integration</li>
  <li>Function URLs with CORS configuration</li>
  <li>Traffic shifting with weighted aliases</li>
  <li>X-Ray tracing and CloudWatch Insights</li>
  <li>Provisioned concurrency with auto-scaling</li>
  <li>Async invocation destinations</li>
</ul>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/lambda-container-patterns.tf">lambda-container-patterns.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"lambda_advanced"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/lambda-patterns"</span>
  
  <span class="nx">environment</span>        <span class="o">=</span> <span class="s2">"production"</span>
  <span class="nx">aws_region</span>        <span class="o">=</span> <span class="s2">"us-east-1"</span>
  <span class="nx">private_subnet_ids</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">private_subnets</span>
  
  <span class="c1"># Container image configuration</span>
  <span class="nx">ecr_repository_url</span> <span class="o">=</span> <span class="nx">aws_ecr_repository</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">repository_url</span>
  <span class="nx">image_tag</span>         <span class="o">=</span> <span class="s2">"v1.2.3"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>resource “aws_appautoscaling_policy” “lambda_concurrency” {
  name               = “${var.environment}-lambda-concurrency-scaling”
  policy_type        = “TargetTrackingScaling”
  resource_id        = aws_appautoscaling_target.lambda_concurrency.resource_id
  scalable_dimension = aws_appautoscaling_target.lambda_concurrency.scalable_dimension
  service_namespace  = aws_appautoscaling_target.lambda_concurrency.service_namespace</p>

<p>target_tracking_scaling_policy_configuration {
    target_value = 0.7</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>predefined_metric_specification {
  predefined_metric_type = "LambdaProvisionedConcurrencyUtilization"
}

scale_in_cooldown  = 180
scale_out_cooldown = 0   } } ```
</code></pre></div></div>

<h3 id="dynamodb-advanced-patterns">DynamoDB Advanced Patterns</h3>

<h4 id="single-table-design">Single Table Design</h4>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># dynamodb-single-table.tf - Advanced DynamoDB single table design</span>

<span class="c1"># Single table for all entities</span>
<span class="nx">resource</span> <span class="s2">"aws_dynamodb_table"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>           <span class="o">=</span> <span class="s2">"${var.environment}-main-table"</span>
  <span class="nx">billing_mode</span>   <span class="o">=</span> <span class="s2">"PAY_PER_REQUEST"</span>  <span class="c1"># On-demand billing</span>
  <span class="nx">hash_key</span>       <span class="o">=</span> <span class="s2">"PK"</span>
  <span class="nx">range_key</span>      <span class="o">=</span> <span class="s2">"SK"</span>
  
  <span class="c1"># Enable streams for event processing</span>
  <span class="nx">stream_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">stream_view_type</span> <span class="o">=</span> <span class="s2">"NEW_AND_OLD_IMAGES"</span>
  
  <span class="c1"># Point-in-time recovery</span>
  <span class="nx">point_in_time_recovery</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Server-side encryption</span>
  <span class="nx">server_side_encryption</span> <span class="p">{</span>
    <span class="nx">enabled</span>     <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">kms_key_arn</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">dynamodb</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
  
  <span class="c1"># Primary key attributes</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"SK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># GSI1 attributes</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI1PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI1SK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># GSI2 attributes</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI2PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI2SK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># GSI3 attributes for time-based queries</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI3PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"CreatedAt"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># Global Secondary Index 1 - Entity lookups</span>
  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>            <span class="o">=</span> <span class="s2">"GSI1"</span>
    <span class="nx">hash_key</span>        <span class="o">=</span> <span class="s2">"GSI1PK"</span>
    <span class="nx">range_key</span>       <span class="o">=</span> <span class="s2">"GSI1SK"</span>
    <span class="nx">projection_type</span> <span class="o">=</span> <span class="s2">"ALL"</span>
  <span class="p">}</span>
  
  <span class="c1"># Global Secondary Index 2 - Date-based queries</span>
  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>            <span class="o">=</span> <span class="s2">"GSI2"</span>
    <span class="nx">hash_key</span>        <span class="o">=</span> <span class="s2">"GSI2PK"</span>
    <span class="nx">range_key</span>       <span class="o">=</span> <span class="s2">"GSI2SK"</span>
    <span class="nx">projection_type</span> <span class="o">=</span> <span class="s2">"ALL"</span>
  <span class="p">}</span>
  
  <span class="c1"># Global Secondary Index 3 - Time-series data</span>
  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>            <span class="o">=</span> <span class="s2">"GSI3"</span>
    <span class="nx">hash_key</span>        <span class="o">=</span> <span class="s2">"GSI3PK"</span>
    <span class="nx">range_key</span>       <span class="o">=</span> <span class="s2">"CreatedAt"</span>
    <span class="nx">projection_type</span> <span class="o">=</span> <span class="s2">"INCLUDE"</span>
    <span class="nx">non_key_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"EntityType"</span><span class="p">,</span> <span class="s2">"Status"</span><span class="p">,</span> <span class="s2">"UpdatedAt"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="c1"># TTL for temporary data</span>
  <span class="nx">ttl</span> <span class="p">{</span>
    <span class="nx">attribute_name</span> <span class="o">=</span> <span class="s2">"ExpiresAt"</span>
    <span class="nx">enabled</span>        <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="nx">Purpose</span>     <span class="o">=</span> <span class="s2">"Single table design"</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># DynamoDB autoscaling for provisioned mode (if needed)</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_target"</span> <span class="s2">"dynamodb_table_read"</span> <span class="p">{</span>
  <span class="nx">count</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_autoscaling</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">max_capacity</span>       <span class="o">=</span> <span class="mi">40000</span>
  <span class="nx">min_capacity</span>       <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="s2">"table/${aws_dynamodb_table.main.name}"</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="s2">"dynamodb:table:ReadCapacityUnits"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="s2">"dynamodb"</span>
<span class="err">}</span>

<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"dynamodb_table_read"</span> <span class="p">{</span>
  <span class="nx">count</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_autoscaling</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"DynamoDBReadCapacityUtilization:${aws_appautoscaling_target.dynamodb_table_read[0].resource_id}"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">dynamodb_table_read</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">dynamodb_table_read</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">dynamodb_table_read</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"DynamoDBReadCapacityUtilization"</span>
    <span class="p">}</span>
    <span class="nx">target_value</span> <span class="o">=</span> <span class="mi">70</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Lambda function for DynamoDB streams processing</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"stream_processor"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"stream_processor.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-dynamodb-stream-processor"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">stream_processor</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">60</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">512</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ENVIRONMENT</span>    <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">EVENT_BUS_NAME</span> <span class="o">=</span> <span class="nx">aws_cloudwatch_event_bus</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tracing_config</span> <span class="p">{</span>
    <span class="nx">mode</span> <span class="o">=</span> <span class="s2">"Active"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Event source mapping for DynamoDB streams</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_event_source_mapping"</span> <span class="s2">"dynamodb_stream"</span> <span class="p">{</span>
  <span class="nx">event_source_arn</span>  <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">stream_arn</span>
  <span class="nx">function_name</span>     <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">stream_processor</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">starting_position</span> <span class="o">=</span> <span class="s2">"LATEST"</span>
  
  <span class="nx">maximum_batching_window_in_seconds</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="nx">parallelization_factor</span>             <span class="o">=</span> <span class="mi">10</span>
  <span class="nx">maximum_retry_attempts</span>             <span class="o">=</span> <span class="mi">3</span>
  <span class="nx">maximum_record_age_in_seconds</span>      <span class="o">=</span> <span class="mi">3600</span>
  
  <span class="c1"># Error handling</span>
  <span class="nx">destination_config</span> <span class="p">{</span>
    <span class="nx">on_failure</span> <span class="p">{</span>
      <span class="nx">destination_arn</span> <span class="o">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">dlq</span><span class="p">.</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Filter criteria</span>
  <span class="nx">filter_criteria</span> <span class="p">{</span>
    <span class="nx">filter</span> <span class="p">{</span>
      <span class="nx">pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
        <span class="nx">eventName</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"INSERT"</span><span class="p">,</span> <span class="s2">"MODIFY"</span><span class="p">]</span>
        <span class="nx">dynamodb</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">NewImage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">EntityType</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">S</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Order"</span><span class="p">]</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># DynamoDB global tables for multi-region</span>
<span class="nx">resource</span> <span class="s2">"aws_dynamodb_global_table"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_global_tables</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  
  <span class="nx">name</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="nx">dynamic</span> <span class="s2">"replica"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">global_table_regions</span>
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">region_name</span> <span class="o">=</span> <span class="nx">replica</span><span class="p">.</span><span class="nx">value</span>
      
      <span class="c1"># KMS key for each region</span>
      <span class="nx">kms_key_arn</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">regional</span><span class="p">[</span><span class="nx">replica</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># DynamoDB Accelerator (DAX) cluster</span>
<span class="nx">resource</span> <span class="s2">"aws_dax_cluster"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_dax</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  
  <span class="nx">cluster_name</span>       <span class="o">=</span> <span class="s2">"${var.environment}-dax-cluster"</span>
  <span class="nx">iam_role_arn</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">dax</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">node_type</span>          <span class="o">=</span> <span class="s2">"dax.r4.large"</span>
  <span class="nx">replication_factor</span> <span class="o">=</span> <span class="mi">3</span>
  
  <span class="c1"># Encryption</span>
  <span class="nx">server_side_encryption</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Parameter group</span>
  <span class="nx">parameter_group_name</span> <span class="o">=</span> <span class="nx">aws_dax_parameter_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="c1"># Subnet group</span>
  <span class="nx">subnet_group_name</span> <span class="o">=</span> <span class="nx">aws_dax_subnet_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="c1"># Security</span>
  <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">dax</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  
  <span class="c1"># Maintenance window</span>
  <span class="nx">maintenance_window</span> <span class="o">=</span> <span class="s2">"sun:05:00-sun:06:00"</span>
  
  <span class="c1"># Notifications</span>
  <span class="nx">notification_topic_arn</span> <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">dax_notifications</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># DAX parameter group</span>
<span class="nx">resource</span> <span class="s2">"aws_dax_parameter_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_dax</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"${var.environment}-dax-params"</span>
  
  <span class="nx">parameters</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"query-ttl-millis"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"600000"</span>  <span class="c1"># 10 minutes</span>
  <span class="p">}</span>
  
  <span class="nx">parameters</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"record-ttl-millis"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"300000"</span>  <span class="c1"># 5 minutes</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Contributor Insights for monitoring</span>
<span class="nx">resource</span> <span class="s2">"aws_dynamodb_contributor_insights"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">table_name</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span>

<span class="c1"># CloudWatch alarms for DynamoDB</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"user_errors"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-dynamodb-user-errors"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"UserErrors"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/DynamoDB"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Sum"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"10"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors DynamoDB user errors"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"throttled_requests"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-dynamodb-throttled-requests"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"UserErrors"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/DynamoDB"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Sum"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"5"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors DynamoDB throttled requests"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span>          <span class="o">=</span> <span class="s2">"throttled"</span>
    <span class="nx">return_data</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">metric</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"UserErrors"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"AWS/DynamoDB"</span>
      <span class="nx">period</span>      <span class="o">=</span> <span class="mi">300</span>
      <span class="nx">stat</span>        <span class="o">=</span> <span class="s2">"Sum"</span>
      
      <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="err">}</span>
</code></pre></div></div>

<h3 id="api-gateway-advanced-patterns">API Gateway Advanced Patterns</h3>

<h4 id="rest-api-with-request-validation">REST API with Request Validation</h4>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># api-gateway.tf - Advanced API Gateway with request validation</span>

<span class="c1"># REST API</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_rest_api"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-advanced-api"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Advanced REST API with validation and security"</span>
  
  <span class="nx">endpoint_configuration</span> <span class="p">{</span>
    <span class="nx">types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"REGIONAL"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="c1"># API Policy for resource limits</span>
  <span class="nx">policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="s2">"*"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"execute-api:Invoke"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"*"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Deny"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="s2">"*"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"execute-api:Invoke"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"*"</span>
        <span class="nx">Condition</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">IpAddressNotEquals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"aws:SourceIp"</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">allowed_ip_ranges</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Request validator</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_request_validator"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                        <span class="o">=</span> <span class="s2">"${var.environment}-validator"</span>
  <span class="nx">rest_api_id</span>                 <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">validate_request_body</span>       <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">validate_request_parameters</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1"># API Models for request/response validation</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_model"</span> <span class="s2">"user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">name</span>         <span class="o">=</span> <span class="s2">"User"</span>
  <span class="nx">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>
  
  <span class="nx">schema</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="s2">"$schema"</span> <span class="p">=</span> <span class="s2">"http://json-schema.org/draft-04/schema#"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"object"</span>
    <span class="nx">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"email"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">]</span>
    <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">email</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
        <span class="nx">format</span> <span class="o">=</span> <span class="s2">"email"</span>
        <span class="nx">pattern</span> <span class="o">=</span> <span class="s2">"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+</span><span class="err">\\</span><span class="s2">.[a-zA-Z]{2,}$"</span>
      <span class="p">}</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
        <span class="nx">minLength</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nx">maxLength</span> <span class="o">=</span> <span class="mi">100</span>
      <span class="p">}</span>
      <span class="nx">age</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"integer"</span>
        <span class="nx">minimum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nx">maximum</span> <span class="o">=</span> <span class="mi">150</span>
      <span class="p">}</span>
      <span class="nx">preferences</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"object"</span>
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">notifications</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="s2">"boolean"</span>
          <span class="p">}</span>
          <span class="nx">theme</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
            <span class="nx">enum</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"light"</span><span class="p">,</span> <span class="s2">"dark"</span><span class="p">,</span> <span class="s2">"auto"</span><span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_model"</span> <span class="s2">"error"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">name</span>         <span class="o">=</span> <span class="s2">"Error"</span>
  <span class="nx">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>
  
  <span class="nx">schema</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="s2">"$schema"</span> <span class="p">=</span> <span class="s2">"http://json-schema.org/draft-04/schema#"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"object"</span>
    <span class="nx">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"message"</span><span class="p">]</span>
    <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
      <span class="p">}</span>
      <span class="nx">code</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
      <span class="p">}</span>
      <span class="nx">requestId</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># API Resources</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_resource"</span> <span class="s2">"v1"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">parent_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">root_resource_id</span>
  <span class="nx">path_part</span>   <span class="o">=</span> <span class="s2">"v1"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_resource"</span> <span class="s2">"users"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">parent_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">path_part</span>   <span class="o">=</span> <span class="s2">"users"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_resource"</span> <span class="s2">"user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">parent_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">path_part</span>   <span class="o">=</span> <span class="s2">"{userId}"</span>
<span class="p">}</span>

<span class="c1"># OPTIONS method for CORS</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span>   <span class="o">=</span> <span class="s2">"OPTIONS"</span>
  <span class="nx">authorization</span> <span class="o">=</span> <span class="s2">"NONE"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_integration"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"MOCK"</span>
  
  <span class="nx">request_templates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">statusCode</span><span class="se">\"</span><span class="s2">: 200}"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_response"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="s2">"200"</span>
  
  <span class="nx">response_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Headers"</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Methods"</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Origin"</span>  <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">response_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="s2">"Empty"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_integration_response"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method_response</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">status_code</span>
  
  <span class="nx">response_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Headers"</span> <span class="p">=</span> <span class="s2">"'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Methods"</span> <span class="p">=</span> <span class="s2">"'GET,OPTIONS,POST,PUT,DELETE'"</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Origin"</span>  <span class="p">=</span> <span class="s2">"'*'"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># POST method with validation</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method"</span> <span class="s2">"create_user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>          <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span>          <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span>          <span class="o">=</span> <span class="s2">"POST"</span>
  <span class="nx">authorization</span>        <span class="o">=</span> <span class="s2">"CUSTOM"</span>
  <span class="nx">authorizer_id</span>        <span class="o">=</span> <span class="nx">aws_api_gateway_authorizer</span><span class="p">.</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">request_validator_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_request_validator</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">request_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">aws_api_gateway_model</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
  
  <span class="nx">request_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.request.header.X-Correlation-ID"</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Lambda integration</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_integration"</span> <span class="s2">"create_user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">http_method</span>
  
  <span class="nx">integration_http_method</span> <span class="o">=</span> <span class="s2">"POST"</span>
  <span class="nx">type</span>                    <span class="o">=</span> <span class="s2">"AWS_PROXY"</span>
  <span class="nx">uri</span>                     <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">invoke_arn</span>
  
  <span class="nx">timeout_milliseconds</span> <span class="o">=</span> <span class="mi">29000</span>
  
  <span class="nx">request_templates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Method responses</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_response"</span> <span class="s2">"create_user_200"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="s2">"200"</span>
  
  <span class="nx">response_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">aws_api_gateway_model</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
  
  <span class="nx">response_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.response.header.X-Correlation-ID"</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_response"</span> <span class="s2">"create_user_400"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="s2">"400"</span>
  
  <span class="nx">response_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">aws_api_gateway_model</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Custom authorizer</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_authorizer"</span> <span class="s2">"jwt"</span> <span class="p">{</span>
  <span class="nx">name</span>                   <span class="o">=</span> <span class="s2">"${var.environment}-jwt-authorizer"</span>
  <span class="nx">rest_api_id</span>            <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">type</span>                   <span class="o">=</span> <span class="s2">"TOKEN"</span>
  <span class="nx">authorizer_uri</span>         <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">authorizer</span><span class="p">.</span><span class="nx">invoke_arn</span>
  <span class="nx">authorizer_credentials</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">api_gateway_authorizer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">identity_source</span>        <span class="o">=</span> <span class="s2">"method.request.header.Authorization"</span>
  
  <span class="c1"># Cache auth results</span>
  <span class="nx">authorizer_result_ttl_in_seconds</span> <span class="o">=</span> <span class="mi">300</span>
<span class="p">}</span>

<span class="c1"># Lambda authorizer function</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"authorizer"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"authorizer.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-api-authorizer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_authorizer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">256</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">JWT_SECRET</span>        <span class="o">=</span> <span class="nx">aws_secretsmanager_secret_version</span><span class="p">.</span><span class="nx">jwt_secret</span><span class="p">.</span><span class="nx">secret_string</span>
      <span class="nx">ENVIRONMENT</span>       <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">USER_POOL_ID</span>      <span class="o">=</span> <span class="nx">aws_cognito_user_pool</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">TOKEN_USE</span>         <span class="o">=</span> <span class="s2">"access"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># API deployment</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_deployment"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">triggers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">redeployment</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">jsonencode</span><span class="p">([</span>
      <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="nx">aws_api_gateway_integration</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
    <span class="p">]))</span>
  <span class="p">}</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">create_before_destroy</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">,</span>
    <span class="nx">aws_api_gateway_integration</span><span class="p">.</span><span class="nx">create_user</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># API stages</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_stage"</span> <span class="s2">"prod"</span> <span class="p">{</span>
  <span class="nx">deployment_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_deployment</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">rest_api_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">stage_name</span>    <span class="o">=</span> <span class="s2">"prod"</span>
  
  <span class="c1"># Enable logging</span>
  <span class="nx">access_log_settings</span> <span class="p">{</span>
    <span class="nx">destination_arn</span> <span class="o">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">api_gateway</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">format</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="nx">requestId</span>               <span class="o">=</span> <span class="s2">"$context.requestId"</span>
      <span class="nx">extendedRequestId</span>       <span class="o">=</span> <span class="s2">"$context.extendedRequestId"</span>
      <span class="nx">ip</span>                      <span class="o">=</span> <span class="s2">"$context.identity.sourceIp"</span>
      <span class="nx">caller</span>                  <span class="o">=</span> <span class="s2">"$context.identity.caller"</span>
      <span class="nx">user</span>                    <span class="o">=</span> <span class="s2">"$context.identity.user"</span>
      <span class="nx">requestTime</span>             <span class="o">=</span> <span class="s2">"$context.requestTime"</span>
      <span class="nx">httpMethod</span>              <span class="o">=</span> <span class="s2">"$context.httpMethod"</span>
      <span class="nx">resourcePath</span>            <span class="o">=</span> <span class="s2">"$context.resourcePath"</span>
      <span class="nx">status</span>                  <span class="o">=</span> <span class="s2">"$context.status"</span>
      <span class="nx">protocol</span>                <span class="o">=</span> <span class="s2">"$context.protocol"</span>
      <span class="nx">responseLength</span>          <span class="o">=</span> <span class="s2">"$context.responseLength"</span>
      <span class="nx">error</span>                   <span class="o">=</span> <span class="s2">"$context.error.message"</span>
      <span class="nx">integrationLatency</span>      <span class="o">=</span> <span class="s2">"$context.integration.latency"</span>
      <span class="nx">integrationStatus</span>       <span class="o">=</span> <span class="s2">"$context.integration.status"</span>
      <span class="nx">integrationErrorMessage</span> <span class="o">=</span> <span class="s2">"$context.integrationErrorMessage"</span>
      <span class="nx">authorizerError</span>         <span class="o">=</span> <span class="s2">"$context.authorizer.error"</span>
    <span class="err">})</span>
  <span class="err">}</span>
  
  <span class="c1"># Caching</span>
  <span class="nx">cache_cluster_enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">cache_cluster_size</span>    <span class="o">=</span> <span class="s2">"0.5"</span>
  
  <span class="c1"># Throttling</span>
  <span class="nx">throttle_burst_limit</span> <span class="o">=</span> <span class="mi">5000</span>
  <span class="nx">throttle_rate_limit</span>  <span class="o">=</span> <span class="mi">10000</span>
  
  <span class="c1"># X-Ray tracing</span>
  <span class="nx">xray_tracing_enabled</span> <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">deployed_at</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">()</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Method settings for all methods</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_settings"</span> <span class="s2">"all"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">stage_name</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">stage_name</span>
  <span class="nx">method_path</span> <span class="o">=</span> <span class="s2">"*/*"</span>
  
  <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">metrics_enabled</span>        <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">logging_level</span>          <span class="o">=</span> <span class="s2">"INFO"</span>
    <span class="nx">data_trace_enabled</span>     <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">throttling_burst_limit</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="nx">throttling_rate_limit</span>  <span class="o">=</span> <span class="mi">1000</span>
    <span class="nx">caching_enabled</span>        <span class="o">=</span> <span class="kc">false</span>
  <span class="err">}</span>
<span class="p">}</span>

<span class="c1"># API key and usage plan</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_api_key"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-api-key"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_usage_plan"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>         <span class="o">=</span> <span class="s2">"${var.environment}-usage-plan"</span>
  <span class="nx">description</span>  <span class="o">=</span> <span class="s2">"Usage plan for API clients"</span>
  
  <span class="nx">api_stages</span> <span class="p">{</span>
    <span class="nx">api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">stage</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">stage_name</span>
  <span class="p">}</span>
  
  <span class="nx">quota_settings</span> <span class="p">{</span>
    <span class="nx">limit</span>  <span class="o">=</span> <span class="mi">10000</span>
    <span class="nx">period</span> <span class="o">=</span> <span class="s2">"DAY"</span>
  <span class="p">}</span>
  
  <span class="nx">throttle_settings</span> <span class="p">{</span>
    <span class="nx">rate_limit</span>  <span class="o">=</span> <span class="mi">500</span>
    <span class="nx">burst_limit</span> <span class="o">=</span> <span class="mi">1000</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_usage_plan_key"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">key_id</span>        <span class="o">=</span> <span class="nx">aws_api_gateway_api_key</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">key_type</span>      <span class="o">=</span> <span class="s2">"API_KEY"</span>
  <span class="nx">usage_plan_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_usage_plan</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="c1"># Custom domain</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_domain_name"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">domain_name</span>              <span class="o">=</span> <span class="s2">"api.${var.domain_name}"</span>
  <span class="nx">regional_certificate_arn</span> <span class="o">=</span> <span class="nx">aws_acm_certificate_validation</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">certificate_arn</span>
  
  <span class="nx">endpoint_configuration</span> <span class="p">{</span>
    <span class="nx">types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"REGIONAL"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">security_policy</span> <span class="o">=</span> <span class="s2">"TLS_1_2"</span>
  
  <span class="nx">mutual_tls_authentication</span> <span class="p">{</span>
    <span class="nx">truststore_uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.truststore.bucket}/truststore.pem"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_base_path_mapping"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">api_id</span>      <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">stage_name</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">stage_name</span>
  <span class="nx">domain_name</span> <span class="o">=</span> <span class="nx">aws_api_gateway_domain_name</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">domain_name</span>
  <span class="nx">base_path</span>   <span class="o">=</span> <span class="s2">"v1"</span>
<span class="p">}</span>

<span class="c1"># WAF for API Gateway</span>
<span class="nx">resource</span> <span class="s2">"aws_wafv2_web_acl_association"</span> <span class="s2">"api_gateway"</span> <span class="p">{</span>
  <span class="nx">resource_arn</span> <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">web_acl_arn</span>  <span class="o">=</span> <span class="nx">aws_wafv2_web_acl</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="step-functions-advanced-workflows">Step Functions Advanced Workflows</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># step-functions.tf - Advanced Step Functions workflows</span>

<span class="c1"># Step Functions state machine for order processing</span>
<span class="nx">resource</span> <span class="s2">"aws_sfn_state_machine"</span> <span class="s2">"order_processing"</span> <span class="p">{</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-order-processing"</span>
  <span class="nx">role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">step_functions</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Comment</span> <span class="o">=</span> <span class="s2">"Advanced order processing workflow with error handling"</span>
    <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"ValidateOrder"</span>
    <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ValidateOrder</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::lambda:invoke"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">validate_order</span><span class="p">.</span><span class="nx">arn</span>
          <span class="s2">"Payload.$"</span> <span class="o">=</span> <span class="s2">"$"</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.validation"</span>
        <span class="nx">Retry</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Lambda.ServiceException"</span><span class="p">,</span> <span class="s2">"Lambda.AWSLambdaException"</span><span class="p">]</span>
            <span class="nx">IntervalSeconds</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="nx">MaxAttempts</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="nx">BackoffRate</span> <span class="o">=</span> <span class="mi">2</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Catch</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ValidationError"</span><span class="p">]</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleValidationError"</span>
            <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.error"</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"States.ALL"</span><span class="p">]</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleGeneralError"</span>
            <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.error"</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"CheckInventory"</span>
      <span class="p">}</span>
      
      <span class="nx">CheckInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:dynamodb:query"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">inventory</span><span class="p">.</span><span class="nx">name</span>
          <span class="nx">KeyConditionExpression</span> <span class="o">=</span> <span class="s2">"ProductId = :productId"</span>
          <span class="nx">ExpressionAttributeValues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">":productId"</span> <span class="p">=</span> <span class="p">{</span>
              <span class="s2">"S.$"</span> <span class="p">=</span> <span class="s2">"$.order.productId"</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.inventory"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"EvaluateInventory"</span>
      <span class="p">}</span>
      
      <span class="nx">EvaluateInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Choice"</span>
        <span class="nx">Choices</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">Variable</span> <span class="o">=</span> <span class="s2">"$.inventory.Items[0].Stock.N"</span>
            <span class="nx">NumericGreaterThanEquals</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"ProcessPayment"</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Default</span> <span class="o">=</span> <span class="s2">"InsufficientInventory"</span>
      <span class="p">}</span>
      
      <span class="nx">InsufficientInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::sns:publish"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">TopicArn</span> <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">inventory_alerts</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">Message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
            <span class="s2">"productId.$"</span> <span class="p">=</span> <span class="s2">"$.order.productId"</span>
            <span class="s2">"message"</span> <span class="p">=</span> <span class="s2">"Insufficient inventory"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
      
      <span class="nx">ProcessPayment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Parallel"</span>
        <span class="nx">Branches</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"ChargePayment"</span>
            <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">ChargePayment</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
                <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::lambda:invoke.waitForTaskToken"</span>
                <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">process_payment</span><span class="p">.</span><span class="nx">arn</span>
                  <span class="nx">Payload</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
                    <span class="s2">"taskToken.$"</span> <span class="p">=</span> <span class="s2">"$$.Task.Token"</span>
                  <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">TimeoutSeconds</span> <span class="o">=</span> <span class="mi">300</span>
                <span class="nx">HeartbeatSeconds</span> <span class="o">=</span> <span class="mi">30</span>
                <span class="nx">Retry</span> <span class="o">=</span> <span class="p">[</span>
                  <span class="p">{</span>
                    <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"PaymentDeclined"</span><span class="p">]</span>
                    <span class="nx">MaxAttempts</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="nx">IntervalSeconds</span> <span class="o">=</span> <span class="mi">5</span>
                  <span class="p">}</span>
                <span class="p">]</span>
                <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"SendConfirmationEmail"</span>
            <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">SendConfirmationEmail</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
                <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:ses:sendEmail"</span>
                <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">Destination</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">ToAddresses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"$.order.customerEmail"</span><span class="p">]</span>
                  <span class="p">}</span>
                  <span class="nx">Message</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">Body</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="nx">Html</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="nx">Data</span> <span class="o">=</span> <span class="s2">"Order confirmation email body"</span>
                      <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="nx">Subject</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="nx">Data</span> <span class="o">=</span> <span class="s2">"Order Confirmation"</span>
                    <span class="p">}</span>
                  <span class="p">}</span>
                  <span class="nx">Source</span> <span class="o">=</span> <span class="s2">"noreply@example.com"</span>
                <span class="p">}</span>
                <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.emailResult"</span>
                <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"LogAnalytics"</span>
            <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">LogAnalytics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
                <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:firehose:putRecordBatch"</span>
                <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">DeliveryStreamName</span> <span class="o">=</span> <span class="nx">aws_kinesis_firehose_delivery_stream</span><span class="p">.</span><span class="nx">analytics</span><span class="p">.</span><span class="nx">name</span>
                  <span class="nx">Records</span> <span class="o">=</span> <span class="p">[{</span>
                    <span class="nx">Data</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
                      <span class="s2">"amount.$"</span> <span class="p">=</span> <span class="s2">"$.order.amount"</span>
                      <span class="s2">"timestamp.$"</span> <span class="p">=</span> <span class="s2">"$$.State.EnteredTime"</span>
                      <span class="s2">"eventType"</span> <span class="p">=</span> <span class="s2">"order_placed"</span>
                    <span class="p">}</span>
                  <span class="p">}]</span>
                <span class="p">}</span>
                <span class="nx">ResultPath</span> <span class="o">=</span> <span class="kc">null</span>
                <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"UpdateInventory"</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.paymentResults"</span>
      <span class="p">}</span>
      
      <span class="nx">UpdateInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Map"</span>
        <span class="nx">ItemsPath</span> <span class="o">=</span> <span class="s2">"$.order.items"</span>
        <span class="nx">MaxConcurrency</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"item.$"</span> <span class="p">=</span> <span class="s2">"$$.Map.Item.Value"</span>
          <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
        <span class="p">}</span>
        <span class="nx">Iterator</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"DecrementStock"</span>
          <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">DecrementStock</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
              <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::dynamodb:updateItem"</span>
              <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">inventory</span><span class="p">.</span><span class="nx">name</span>
                <span class="nx">Key</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">ProductId</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">"S.$"</span> <span class="p">=</span> <span class="s2">"$.item.productId"</span>
                  <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">UpdateExpression</span> <span class="o">=</span> <span class="s2">"SET #stock = #stock - :quantity, #updated = :timestamp"</span>
                <span class="nx">ExpressionAttributeNames</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s2">"#stock"</span> <span class="p">=</span> <span class="s2">"Stock"</span>
                  <span class="s2">"#updated"</span> <span class="p">=</span> <span class="s2">"LastUpdated"</span>
                <span class="p">}</span>
                <span class="nx">ExpressionAttributeValues</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s2">":quantity"</span> <span class="p">=</span> <span class="p">{</span>
                    <span class="s2">"N.$"</span> <span class="p">=</span> <span class="s2">"$.item.quantity"</span>
                  <span class="p">}</span>
                  <span class="s2">":timestamp"</span> <span class="p">=</span> <span class="p">{</span>
                    <span class="s2">"S.$"</span> <span class="p">=</span> <span class="s2">"$$.State.EnteredTime"</span>
                  <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">ConditionExpression</span> <span class="o">=</span> <span class="s2">"#stock &gt;= :quantity"</span>
                <span class="nx">ReturnValues</span> <span class="o">=</span> <span class="s2">"ALL_NEW"</span>
              <span class="p">}</span>
              <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.updateResult"</span>
              <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"CompleteOrder"</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.inventoryUpdates"</span>
        <span class="nx">Catch</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"DynamoDB.ConditionalCheckFailedException"</span><span class="p">]</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleInventoryError"</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
      
      <span class="nx">CompleteOrder</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::batch:submitJob.sync"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">JobName</span> <span class="o">=</span> <span class="s2">"CompleteOrderJob"</span>
          <span class="nx">JobQueue</span> <span class="o">=</span> <span class="nx">aws_batch_job_queue</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
          <span class="nx">JobDefinition</span> <span class="o">=</span> <span class="nx">aws_batch_job_definition</span><span class="p">.</span><span class="nx">complete_order</span><span class="p">.</span><span class="nx">name</span>
          <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderSuccess"</span>
      <span class="p">}</span>
      
      <span class="nx">OrderSuccess</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Succeed"</span>
      <span class="p">}</span>
      
      <span class="nx">OrderFailed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Fail"</span>
        <span class="nx">Cause</span> <span class="o">=</span> <span class="s2">"Order processing failed"</span>
      <span class="p">}</span>
      
      <span class="nx">HandleValidationError</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">handle_error</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"error.$"</span> <span class="p">=</span> <span class="s2">"$.error"</span>
          <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
          <span class="s2">"errorType"</span> <span class="p">=</span> <span class="s2">"validation"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
      
      <span class="nx">HandleInventoryError</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">handle_error</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"error.$"</span> <span class="p">=</span> <span class="s2">"$.error"</span>
          <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
          <span class="s2">"errorType"</span> <span class="p">=</span> <span class="s2">"inventory"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
      
      <span class="nx">HandleGeneralError</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">handle_error</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"error.$"</span> <span class="p">=</span> <span class="s2">"$.error"</span>
          <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
          <span class="s2">"errorType"</span> <span class="p">=</span> <span class="s2">"general"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
  
  <span class="nx">logging_configuration</span> <span class="p">{</span>
    <span class="nx">log_destination</span>        <span class="o">=</span> <span class="s2">"${aws_cloudwatch_log_group.step_functions.arn}:*"</span>
    <span class="nx">include_execution_data</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">level</span>                  <span class="o">=</span> <span class="s2">"ALL"</span>
  <span class="p">}</span>
  
  <span class="nx">tracing_configuration</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="nx">Purpose</span>     <span class="o">=</span> <span class="s2">"Order processing workflow"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Express workflow for synchronous execution</span>
<span class="nx">resource</span> <span class="s2">"aws_sfn_state_machine"</span> <span class="s2">"express_workflow"</span> <span class="p">{</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-express-workflow"</span>
  <span class="nx">role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">step_functions</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">type</span>     <span class="o">=</span> <span class="s2">"EXPRESS"</span>
  
  <span class="nx">definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Comment</span> <span class="o">=</span> <span class="s2">"Express workflow for fast synchronous execution"</span>
    <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"TransformData"</span>
    <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">TransformData</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:lambda:invoke"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">transform_data</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">Payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"input.$"</span> <span class="p">=</span> <span class="s2">"$"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">OutputPath</span> <span class="o">=</span> <span class="s2">"$.Payload"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"EnrichData"</span>
      <span class="p">}</span>
      
      <span class="nx">EnrichData</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">enrich_data</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">TimeoutSeconds</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"ReturnResult"</span>
      <span class="p">}</span>
      
      <span class="nx">ReturnResult</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Pass"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"transformedData.$"</span> <span class="p">=</span> <span class="s2">"$"</span>
          <span class="s2">"processedAt.$"</span> <span class="p">=</span> <span class="s2">"$$.State.EnteredTime"</span>
          <span class="s2">"executionName.$"</span> <span class="p">=</span> <span class="s2">"$$.Execution.Name"</span>
        <span class="p">}</span>
        <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># CloudWatch Logs for Step Functions</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"step_functions"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/aws/vendedlogs/states/${var.environment}-order-processing"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># CloudWatch alarms for Step Functions</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"step_functions_failed"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-step-functions-executions-failed"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"1"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"ExecutionsFailed"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/States"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Sum"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"5"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors failed Step Functions executions"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">StateMachineArn</span> <span class="o">=</span> <span class="nx">aws_sfn_state_machine</span><span class="p">.</span><span class="nx">order_processing</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># EventBridge rule to trigger Step Functions</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"trigger_workflow"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-trigger-order-workflow"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Trigger order processing workflow"</span>
  
  <span class="nx">event_pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">source</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"order.service"</span><span class="p">]</span>
    <span class="nx">detail-type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Order Placed"</span><span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"step_functions"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">trigger_workflow</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"StepFunctionsTarget"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_sfn_state_machine</span><span class="p">.</span><span class="nx">order_processing</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">role_arn</span>  <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">events_step_functions</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">input_transformer</span> <span class="p">{</span>
    <span class="nx">input_paths</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">order</span> <span class="o">=</span> <span class="s2">"$.detail.order"</span>
    <span class="p">}</span>
    <span class="nx">input_template</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="nx">order</span> <span class="o">=</span> <span class="s2">"&lt;order&gt;"</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="container-orchestration-with-ecsfargate">Container Orchestration with ECS/Fargate</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ecs-fargate.tf - Container orchestration with ECS and Fargate</span>

<span class="c1"># ECS Cluster</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_cluster"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-cluster"</span>
  
  <span class="nx">configuration</span> <span class="p">{</span>
    <span class="nx">execute_command_configuration</span> <span class="p">{</span>
      <span class="nx">kms_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">ecs</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">logging</span>    <span class="o">=</span> <span class="s2">"OVERRIDE"</span>
      
      <span class="nx">log_configuration</span> <span class="p">{</span>
        <span class="nx">cloud_watch_encryption_enabled</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">cloud_watch_log_group_name</span>     <span class="o">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">ecs_exec</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">setting</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"containerInsights"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"enabled"</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Capacity providers for mixing Fargate and Fargate Spot</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_cluster_capacity_providers"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">cluster_name</span> <span class="o">=</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="nx">capacity_providers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"FARGATE"</span><span class="p">,</span>
    <span class="s2">"FARGATE_SPOT"</span>
  <span class="p">]</span>
  
  <span class="nx">default_capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">100</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE"</span>
  <span class="p">}</span>
  
  <span class="nx">default_capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">50</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE_SPOT"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Task Definition</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_task_definition"</span> <span class="s2">"app"</span> <span class="p">{</span>
  <span class="nx">family</span>                   <span class="o">=</span> <span class="s2">"${var.environment}-app"</span>
  <span class="nx">network_mode</span>             <span class="o">=</span> <span class="s2">"awsvpc"</span>
  <span class="nx">requires_compatibilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"FARGATE"</span><span class="p">]</span>
  <span class="nx">cpu</span>                      <span class="o">=</span> <span class="s2">"512"</span>
  <span class="nx">memory</span>                   <span class="o">=</span> <span class="s2">"1024"</span>
  <span class="nx">execution_role_arn</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">ecs_execution</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">task_role_arn</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">ecs_task</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">runtime_platform</span> <span class="p">{</span>
    <span class="nx">operating_system_family</span> <span class="o">=</span> <span class="s2">"LINUX"</span>
    <span class="nx">cpu_architecture</span>        <span class="o">=</span> <span class="s2">"X86_64"</span>  <span class="c1"># or "ARM64" for Graviton2</span>
  <span class="p">}</span>
  
  <span class="nx">container_definitions</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">([</span>
    <span class="p">{</span>
      <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"app"</span>
      <span class="nx">image</span>     <span class="o">=</span> <span class="s2">"${aws_ecr_repository.app.repository_url}:latest"</span>
      <span class="nx">essential</span> <span class="o">=</span> <span class="kc">true</span>
      
      <span class="nx">portMappings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="o">=</span> <span class="mi">8080</span>
          <span class="nx">protocol</span>      <span class="o">=</span> <span class="s2">"tcp"</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">environment</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"ENVIRONMENT"</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"AWS_REGION"</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">secrets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"DB_PASSWORD"</span>
          <span class="nx">valueFrom</span> <span class="o">=</span> <span class="nx">aws_secretsmanager_secret</span><span class="p">.</span><span class="nx">db_password</span><span class="p">.</span><span class="nx">arn</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"API_KEY"</span>
          <span class="nx">valueFrom</span> <span class="o">=</span> <span class="nx">aws_ssm_parameter</span><span class="p">.</span><span class="nx">api_key</span><span class="p">.</span><span class="nx">arn</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">logConfiguration</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">logDriver</span> <span class="o">=</span> <span class="s2">"awslogs"</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"awslogs-group"</span>         <span class="p">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">ecs_app</span><span class="p">.</span><span class="nx">name</span>
          <span class="s2">"awslogs-region"</span>        <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="s2">"awslogs-stream-prefix"</span> <span class="o">=</span> <span class="s2">"ecs"</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">healthCheck</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">command</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"CMD-SHELL"</span><span class="p">,</span> <span class="s2">"curl -f http://localhost:8080/health || exit 1"</span><span class="p">]</span>
        <span class="nx">interval</span>    <span class="o">=</span> <span class="mi">30</span>
        <span class="nx">timeout</span>     <span class="o">=</span> <span class="mi">5</span>
        <span class="nx">retries</span>     <span class="o">=</span> <span class="mi">3</span>
        <span class="nx">startPeriod</span> <span class="o">=</span> <span class="mi">60</span>
      <span class="p">}</span>
      
      <span class="nx">linuxParameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">initProcessEnabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      
      <span class="c1"># FireLens logging</span>
      <span class="nx">firelensConfiguration</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"fluentbit"</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">enable-ecs-log-metadata</span> <span class="o">=</span> <span class="s2">"true"</span>
          <span class="nx">config-file-type</span>        <span class="o">=</span> <span class="s2">"file"</span>
          <span class="nx">config-file-value</span>       <span class="o">=</span> <span class="s2">"/fluent-bit/configs/parse-json.conf"</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1"># ECS Exec</span>
      <span class="nx">linuxParameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">initProcessEnabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      
      <span class="c1"># Resource limits</span>
      <span class="nx">ulimits</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"nofile"</span>
          <span class="nx">softLimit</span> <span class="o">=</span> <span class="mi">65536</span>
          <span class="nx">hardLimit</span> <span class="o">=</span> <span class="mi">65536</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="c1"># Mount points for EFS</span>
      <span class="nx">mountPoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">sourceVolume</span>  <span class="o">=</span> <span class="s2">"efs-storage"</span>
          <span class="nx">containerPath</span> <span class="o">=</span> <span class="s2">"/data"</span>
          <span class="nx">readOnly</span>      <span class="o">=</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span>             <span class="o">=</span> <span class="s2">"xray-daemon"</span>
      <span class="nx">image</span>            <span class="o">=</span> <span class="s2">"public.ecr.aws/xray/aws-xray-daemon:latest"</span>
      <span class="nx">essential</span>        <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">memoryReservation</span> <span class="o">=</span> <span class="mi">256</span>
      
      <span class="nx">portMappings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="o">=</span> <span class="mi">2000</span>
          <span class="nx">protocol</span>      <span class="o">=</span> <span class="s2">"udp"</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">logConfiguration</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">logDriver</span> <span class="o">=</span> <span class="s2">"awslogs"</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"awslogs-group"</span>         <span class="p">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">ecs_xray</span><span class="p">.</span><span class="nx">name</span>
          <span class="s2">"awslogs-region"</span>        <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="s2">"awslogs-stream-prefix"</span> <span class="o">=</span> <span class="s2">"xray"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">])</span>
  
  <span class="c1"># EFS volume</span>
  <span class="nx">volume</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"efs-storage"</span>
    
    <span class="nx">efs_volume_configuration</span> <span class="p">{</span>
      <span class="nx">file_system_id</span>          <span class="o">=</span> <span class="nx">aws_efs_file_system</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">root_directory</span>          <span class="o">=</span> <span class="s2">"/"</span>
      <span class="nx">transit_encryption</span>      <span class="o">=</span> <span class="s2">"ENABLED"</span>
      <span class="nx">transit_encryption_port</span> <span class="o">=</span> <span class="mi">2999</span>
      
      <span class="nx">authorization_config</span> <span class="p">{</span>
        <span class="nx">access_point_id</span> <span class="o">=</span> <span class="nx">aws_efs_access_point</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">id</span>
        <span class="nx">iam</span>             <span class="o">=</span> <span class="s2">"ENABLED"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Ephemeral storage</span>
  <span class="nx">ephemeral_storage</span> <span class="p">{</span>
    <span class="nx">size_in_gib</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ECS Service</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_service"</span> <span class="s2">"app"</span> <span class="p">{</span>
  <span class="nx">name</span>                               <span class="o">=</span> <span class="s2">"${var.environment}-app-service"</span>
  <span class="nx">cluster</span>                            <span class="o">=</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">task_definition</span>                    <span class="o">=</span> <span class="nx">aws_ecs_task_definition</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">desired_count</span>                      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">app_count</span>
  <span class="nx">deployment_minimum_healthy_percent</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="nx">deployment_maximum_percent</span>         <span class="o">=</span> <span class="mi">200</span>
  <span class="nx">health_check_grace_period_seconds</span>  <span class="o">=</span> <span class="mi">60</span>
  <span class="nx">launch_type</span>                        <span class="o">=</span> <span class="s2">"FARGATE"</span>
  <span class="nx">platform_version</span>                   <span class="o">=</span> <span class="s2">"LATEST"</span>
  
  <span class="nx">deployment_controller</span> <span class="p">{</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"ECS"</span>  <span class="c1"># or "CODE_DEPLOY" for blue/green</span>
  <span class="p">}</span>
  
  <span class="nx">deployment_circuit_breaker</span> <span class="p">{</span>
    <span class="nx">enable</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">rollback</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">network_configuration</span> <span class="p">{</span>
    <span class="nx">subnets</span>          <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_groups</span>  <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">ecs_service</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
    <span class="nx">assign_public_ip</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
  
  <span class="nx">load_balancer</span> <span class="p">{</span>
    <span class="nx">target_group_arn</span> <span class="o">=</span> <span class="nx">aws_lb_target_group</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">container_name</span>   <span class="o">=</span> <span class="s2">"app"</span>
    <span class="nx">container_port</span>   <span class="o">=</span> <span class="mi">8080</span>
  <span class="p">}</span>
  
  <span class="nx">service_registries</span> <span class="p">{</span>
    <span class="nx">registry_arn</span> <span class="o">=</span> <span class="nx">aws_service_discovery_service</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
  
  <span class="c1"># Capacity provider strategy to use Fargate Spot</span>
  <span class="nx">capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE"</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">1</span>
  <span class="p">}</span>
  
  <span class="nx">capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE_SPOT"</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">4</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">0</span>
  <span class="p">}</span>
  
  <span class="nx">enable_ecs_managed_tags</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">propagate_tags</span>          <span class="o">=</span> <span class="s2">"SERVICE"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="o">=</span> <span class="p">[</span><span class="nx">desired_count</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_lb_listener</span><span class="p">.</span><span class="nx">app</span><span class="p">,</span>
    <span class="nx">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="nx">ecs_task</span>
  <span class="p">]</span>
<span class="err">}</span>

<span class="c1"># Auto Scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_target"</span> <span class="s2">"ecs_target"</span> <span class="p">{</span>
  <span class="nx">max_capacity</span>       <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">max_capacity</span>
  <span class="nx">min_capacity</span>       <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">min_capacity</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="s2">"service/${aws_ecs_cluster.main.name}/${aws_ecs_service.app.name}"</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="s2">"ecs:service:DesiredCount"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="s2">"ecs"</span>
<span class="p">}</span>

<span class="c1"># CPU-based auto scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"ecs_cpu"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-ecs-cpu-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"ECSServiceAverageCPUUtilization"</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span>       <span class="o">=</span> <span class="mf">70.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">180</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Memory-based auto scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"ecs_memory"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-ecs-memory-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"ECSServiceAverageMemoryUtilization"</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span>       <span class="o">=</span> <span class="mf">75.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">180</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Custom metric scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"ecs_requests"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-ecs-requests-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">customized_metric_specification</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"RequestsPerTask"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"${var.environment}/Application"</span>
      <span class="nx">statistic</span>   <span class="o">=</span> <span class="s2">"Average"</span>
      <span class="nx">unit</span>        <span class="o">=</span> <span class="s2">"Count"</span>
      
      <span class="nx">dimensions</span> <span class="p">{</span>
        <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"ServiceName"</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">aws_ecs_service</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span>       <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">180</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Scheduled scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_scheduled_action"</span> <span class="s2">"scale_up_morning"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-scale-up-morning"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">schedule</span>           <span class="o">=</span> <span class="s2">"cron(0 8 * * ? *)"</span>  <span class="c1"># 8 AM UTC daily</span>
  <span class="nx">timezone</span>           <span class="o">=</span> <span class="s2">"America/New_York"</span>
  
  <span class="nx">scalable_target_action</span> <span class="p">{</span>
    <span class="nx">min_capacity</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="nx">max_capacity</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Service Discovery</span>
<span class="nx">resource</span> <span class="s2">"aws_service_discovery_private_dns_namespace"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}.local"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Private DNS namespace for service discovery"</span>
  <span class="nx">vpc</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">vpc_id</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_service_discovery_service"</span> <span class="s2">"app"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app"</span>
  
  <span class="nx">dns_config</span> <span class="p">{</span>
    <span class="nx">namespace_id</span> <span class="o">=</span> <span class="nx">aws_service_discovery_private_dns_namespace</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
    
    <span class="nx">dns_records</span> <span class="p">{</span>
      <span class="nx">ttl</span>  <span class="o">=</span> <span class="mi">10</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="s2">"A"</span>
    <span class="p">}</span>
    
    <span class="nx">routing_policy</span> <span class="o">=</span> <span class="s2">"MULTIVALUE"</span>
  <span class="p">}</span>
  
  <span class="nx">health_check_custom_config</span> <span class="p">{</span>
    <span class="nx">failure_threshold</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudWatch Logs</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"ecs_app"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/ecs/${var.environment}/app"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"ecs_xray"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/ecs/${var.environment}/xray"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">7</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"ecs_exec"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/ecs/${var.environment}/exec"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">7</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># CloudWatch Dashboard</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_dashboard"</span> <span class="s2">"ecs"</span> <span class="p">{</span>
  <span class="nx">dashboard_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-ecs-dashboard"</span>
  
  <span class="nx">dashboard_body</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">widgets</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/ECS"</span><span class="p">,</span> <span class="s2">"CPUUtilization"</span><span class="p">,</span> <span class="s2">"ServiceName"</span><span class="p">,</span> <span class="nx">aws_ecs_service</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">"ClusterName"</span><span class="p">,</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"MemoryUtilization"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"ECS Service Utilization"</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/ApplicationELB"</span><span class="p">,</span> <span class="s2">"TargetResponseTime"</span><span class="p">,</span> <span class="s2">"LoadBalancer"</span><span class="p">,</span> <span class="nx">aws_lb</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn_suffix</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"RequestCount"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"HTTPCode_Target_4XX_Count"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"HTTPCode_Target_5XX_Count"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"Load Balancer Metrics"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="performance-at-scale-making-applications-fast">Performance at Scale: Making Applications Fast</h2>

<p>Performance isn’t just about speed - it’s about delivering consistent experiences whether you have 10 or 10 million users. AWS provides tools to optimize every layer of your application.</p>

<h3 id="the-performance-journey">The Performance Journey</h3>

<p>Most applications follow a predictable performance evolution:</p>

<ol>
  <li>
<strong>Single Region, Basic Setup</strong>: Works fine for hundreds of users</li>
  <li>
<strong>Caching Added</strong>: Handles thousands without breaking a sweat</li>
  <li>
<strong>Multi-Region Deployment</strong>: Serves millions with low latency globally</li>
  <li>
<strong>Edge Optimization</strong>: Delivers content in milliseconds worldwide</li>
</ol>

<p>Let’s explore each optimization technique and when to apply it.</p>

<h3 id="cloudfront-your-global-accelerator">CloudFront: Your Global Accelerator</h3>

<p>CloudFront is AWS’s content delivery network (CDN). Instead of users fetching data from your servers in Virginia, CloudFront caches content at 400+ edge locations worldwide. Users get data from the nearest location, reducing latency from seconds to milliseconds.</p>

<p><strong>When to Use CloudFront:</strong></p>
<ul>
  <li>Static assets (images, CSS, JavaScript) - immediate 10x performance boost</li>
  <li>API responses that don’t change frequently</li>
  <li>Video streaming - adaptive bitrate based on user connection</li>
  <li>Global applications - consistent performance worldwide</li>
</ul>

<p><strong>Real-world impact</strong>: A news website serving images from S3 in US-East to users in Australia saw 2-second load times. After adding CloudFront, Australian users get 200ms load times from the Sydney edge location.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cloudfront.tf - CloudFront distribution with Lambda@Edge</span>

<span class="c1"># S3 bucket for static content</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"static_content"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-static-content-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_versioning"</span> <span class="s2">"static_content"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">static_content</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">versioning_configuration</span> <span class="p">{</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_server_side_encryption_configuration"</span> <span class="s2">"static_content"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">static_content</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">apply_server_side_encryption_by_default</span> <span class="p">{</span>
      <span class="nx">sse_algorithm</span>     <span class="o">=</span> <span class="s2">"aws:kms"</span>
      <span class="nx">kms_master_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudFront Origin Access Control</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_origin_access_control"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                              <span class="o">=</span> <span class="s2">"${var.environment}-oac"</span>
  <span class="nx">description</span>                       <span class="o">=</span> <span class="s2">"Origin Access Control for S3"</span>
  <span class="nx">origin_access_control_origin_type</span> <span class="o">=</span> <span class="s2">"s3"</span>
  <span class="nx">signing_behavior</span>                  <span class="o">=</span> <span class="s2">"always"</span>
  <span class="nx">signing_protocol</span>                  <span class="o">=</span> <span class="s2">"sigv4"</span>
<span class="p">}</span>

<span class="c1"># Lambda@Edge functions</span>
<span class="nx">data</span> <span class="s2">"archive_file"</span> <span class="s2">"lambda_edge_viewer_request"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"zip"</span>
  <span class="nx">source_file</span> <span class="o">=</span> <span class="s2">"lambda-edge/viewer-request.js"</span>
  <span class="nx">output_path</span> <span class="o">=</span> <span class="s2">"lambda-edge-viewer-request.zip"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"edge_viewer_request"</span> <span class="p">{</span>
  <span class="nx">provider</span>         <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">us_east_1</span>  <span class="c1"># Lambda@Edge must be in us-east-1</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_viewer_request</span><span class="p">.</span><span class="nx">output_path</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-edge-viewer-request"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_edge</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"viewer-request.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"nodejs18.x"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">128</span>
  <span class="nx">publish</span>         <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">source_code_hash</span> <span class="o">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_viewer_request</span><span class="p">.</span><span class="nx">output_base64sha256</span>
<span class="p">}</span>

<span class="nx">data</span> <span class="s2">"archive_file"</span> <span class="s2">"lambda_edge_origin_response"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"zip"</span>
  <span class="nx">source_file</span> <span class="o">=</span> <span class="s2">"lambda-edge/origin-response.js"</span>
  <span class="nx">output_path</span> <span class="o">=</span> <span class="s2">"lambda-edge-origin-response.zip"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"edge_origin_response"</span> <span class="p">{</span>
  <span class="nx">provider</span>         <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">us_east_1</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_origin_response</span><span class="p">.</span><span class="nx">output_path</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-edge-origin-response"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_edge</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"origin-response.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"nodejs18.x"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">128</span>
  <span class="nx">publish</span>         <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">source_code_hash</span> <span class="o">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_origin_response</span><span class="p">.</span><span class="nx">output_base64sha256</span>
<span class="p">}</span>

<span class="c1"># CloudFront Distribution</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">enabled</span>             <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">is_ipv6_enabled</span>     <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">comment</span>             <span class="o">=</span> <span class="s2">"${var.environment} CloudFront distribution"</span>
  <span class="nx">default_root_object</span> <span class="o">=</span> <span class="s2">"index.html"</span>
  <span class="nx">aliases</span>             <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">domain_name</span><span class="p">,</span> <span class="s2">"www.${var.domain_name}"</span><span class="p">]</span>
  <span class="nx">price_class</span>         <span class="o">=</span> <span class="s2">"PriceClass_200"</span>  <span class="c1"># US, Canada, Europe, Asia</span>
  
  <span class="c1"># S3 origin</span>
  <span class="nx">origin</span> <span class="p">{</span>
    <span class="nx">domain_name</span>              <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">static_content</span><span class="p">.</span><span class="nx">bucket_regional_domain_name</span>
    <span class="nx">origin_access_control_id</span> <span class="o">=</span> <span class="nx">aws_cloudfront_origin_access_control</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">origin_id</span>                <span class="o">=</span> <span class="s2">"S3-${aws_s3_bucket.static_content.id}"</span>
    
    <span class="nx">origin_shield</span> <span class="p">{</span>
      <span class="nx">enabled</span>              <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">origin_shield_region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># ALB origin for dynamic content</span>
  <span class="nx">origin</span> <span class="p">{</span>
    <span class="nx">domain_name</span> <span class="o">=</span> <span class="nx">aws_lb</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">dns_name</span>
    <span class="nx">origin_id</span>   <span class="o">=</span> <span class="s2">"ALB-${aws_lb.main.id}"</span>
    
    <span class="nx">custom_origin_config</span> <span class="p">{</span>
      <span class="nx">http_port</span>              <span class="o">=</span> <span class="mi">80</span>
      <span class="nx">https_port</span>             <span class="o">=</span> <span class="mi">443</span>
      <span class="nx">origin_protocol_policy</span> <span class="o">=</span> <span class="s2">"https-only"</span>
      <span class="nx">origin_ssl_protocols</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"TLSv1.2"</span><span class="p">]</span>
      
      <span class="nx">origin_keepalive_timeout</span> <span class="o">=</span> <span class="mi">60</span>
      <span class="nx">origin_read_timeout</span>      <span class="o">=</span> <span class="mi">60</span>
    <span class="p">}</span>
    
    <span class="nx">custom_header</span> <span class="p">{</span>
      <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"X-Origin-Verify"</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">random_password</span><span class="p">.</span><span class="nx">origin_verify</span><span class="p">.</span><span class="nx">result</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Origin group for failover</span>
  <span class="nx">origin_group</span> <span class="p">{</span>
    <span class="nx">origin_id</span> <span class="o">=</span> <span class="s2">"origin-group-1"</span>
    
    <span class="nx">failover_criteria</span> <span class="p">{</span>
      <span class="nx">status_codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">member</span> <span class="p">{</span>
      <span class="nx">origin_id</span> <span class="o">=</span> <span class="s2">"ALB-${aws_lb.main.id}"</span>
    <span class="p">}</span>
    
    <span class="nx">member</span> <span class="p">{</span>
      <span class="nx">origin_id</span> <span class="o">=</span> <span class="s2">"ALB-${aws_lb.secondary.id}"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Default cache behavior</span>
  <span class="nx">default_cache_behavior</span> <span class="p">{</span>
    <span class="nx">allowed_methods</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">"DELETE"</span><span class="p">,</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">,</span> <span class="s2">"PATCH"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span> <span class="o">=</span> <span class="s2">"S3-${aws_s3_bucket.static_content.id}"</span>
    
    <span class="nx">forwarded_values</span> <span class="p">{</span>
      <span class="nx">query_string</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">headers</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"Origin"</span><span class="p">,</span> <span class="s2">"Access-Control-Request-Method"</span><span class="p">,</span> <span class="s2">"Access-Control-Request-Headers"</span><span class="p">]</span>
      
      <span class="nx">cookies</span> <span class="p">{</span>
        <span class="nx">forward</span> <span class="o">=</span> <span class="s2">"none"</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"redirect-to-https"</span>
    <span class="nx">min_ttl</span>                <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">default_ttl</span>            <span class="o">=</span> <span class="mi">86400</span>
    <span class="nx">max_ttl</span>                <span class="o">=</span> <span class="mi">31536000</span>
    <span class="nx">compress</span>               <span class="o">=</span> <span class="kc">true</span>
    
    <span class="c1"># Lambda@Edge associations</span>
    <span class="nx">lambda_function_association</span> <span class="p">{</span>
      <span class="nx">event_type</span>   <span class="o">=</span> <span class="s2">"viewer-request"</span>
      <span class="nx">lambda_arn</span>   <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">edge_viewer_request</span><span class="p">.</span><span class="nx">qualified_arn</span>
      <span class="nx">include_body</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    
    <span class="nx">lambda_function_association</span> <span class="p">{</span>
      <span class="nx">event_type</span>   <span class="o">=</span> <span class="s2">"origin-response"</span>
      <span class="nx">lambda_arn</span>   <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">edge_origin_response</span><span class="p">.</span><span class="nx">qualified_arn</span>
      <span class="nx">include_body</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="err">}</span>
  
  <span class="c1"># Cache behavior for API</span>
  <span class="nx">ordered_cache_behavior</span> <span class="p">{</span>
    <span class="nx">path_pattern</span>     <span class="o">=</span> <span class="s2">"/api/*"</span>
    <span class="nx">allowed_methods</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">"DELETE"</span><span class="p">,</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">,</span> <span class="s2">"PATCH"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span> <span class="o">=</span> <span class="s2">"origin-group-1"</span>
    
    <span class="nx">cache_policy_id</span>            <span class="o">=</span> <span class="nx">aws_cloudfront_cache_policy</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">origin_request_policy_id</span>   <span class="o">=</span> <span class="nx">aws_cloudfront_origin_request_policy</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">response_headers_policy_id</span> <span class="o">=</span> <span class="nx">aws_cloudfront_response_headers_policy</span><span class="p">.</span><span class="nx">security</span><span class="p">.</span><span class="nx">id</span>
    
    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"https-only"</span>
    <span class="nx">compress</span>               <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Cache behavior for static assets</span>
  <span class="nx">ordered_cache_behavior</span> <span class="p">{</span>
    <span class="nx">path_pattern</span>     <span class="o">=</span> <span class="s2">"/static/*"</span>
    <span class="nx">allowed_methods</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span> <span class="o">=</span> <span class="s2">"S3-${aws_s3_bucket.static_content.id}"</span>
    
    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"redirect-to-https"</span>
    <span class="nx">min_ttl</span>                <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">default_ttl</span>            <span class="o">=</span> <span class="mi">604800</span>   <span class="c1"># 7 days</span>
    <span class="nx">max_ttl</span>                <span class="o">=</span> <span class="mi">31536000</span>  <span class="c1"># 1 year</span>
    <span class="nx">compress</span>               <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">forwarded_values</span> <span class="p">{</span>
      <span class="nx">query_string</span> <span class="o">=</span> <span class="kc">false</span>
      
      <span class="nx">cookies</span> <span class="p">{</span>
        <span class="nx">forward</span> <span class="o">=</span> <span class="s2">"none"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="err">}</span>
  
  <span class="nx">restrictions</span> <span class="p">{</span>
    <span class="nx">geo_restriction</span> <span class="p">{</span>
      <span class="nx">restriction_type</span> <span class="o">=</span> <span class="s2">"none"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">viewer_certificate</span> <span class="p">{</span>
    <span class="nx">acm_certificate_arn</span>      <span class="o">=</span> <span class="nx">aws_acm_certificate_validation</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">certificate_arn</span>
    <span class="nx">minimum_protocol_version</span> <span class="o">=</span> <span class="s2">"TLSv1.2_2021"</span>
    <span class="nx">ssl_support_method</span>       <span class="o">=</span> <span class="s2">"sni-only"</span>
  <span class="p">}</span>
  
  <span class="nx">web_acl_id</span> <span class="o">=</span> <span class="nx">aws_wafv2_web_acl</span><span class="p">.</span><span class="nx">cloudfront</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">logging_config</span> <span class="p">{</span>
    <span class="nx">include_cookies</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">bucket</span>          <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cloudfront_logs</span><span class="p">.</span><span class="nx">bucket_domain_name</span>
    <span class="nx">prefix</span>          <span class="o">=</span> <span class="s2">"cloudfront/"</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_s3_bucket_policy</span><span class="p">.</span><span class="nx">static_content</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Cache policy for API</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_cache_policy"</span> <span class="s2">"api"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-api-cache-policy"</span>
  <span class="nx">comment</span>     <span class="o">=</span> <span class="s2">"Cache policy for API endpoints"</span>
  <span class="nx">default_ttl</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">max_ttl</span>     <span class="o">=</span> <span class="mi">3600</span>
  <span class="nx">min_ttl</span>     <span class="o">=</span> <span class="mi">0</span>
  
  <span class="nx">parameters_in_cache_key_and_forwarded_to_origin</span> <span class="p">{</span>
    <span class="nx">enable_accept_encoding_gzip</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">enable_accept_encoding_brotli</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">cookies_config</span> <span class="p">{</span>
      <span class="nx">cookie_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
    <span class="p">}</span>
    
    <span class="nx">headers_config</span> <span class="p">{</span>
      <span class="nx">header_behavior</span> <span class="o">=</span> <span class="s2">"whitelist"</span>
      <span class="nx">headers</span> <span class="p">{</span>
        <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s2">"Authorization"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Viewer-Country"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Is-Mobile-Viewer"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Is-Tablet-Viewer"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Is-Desktop-Viewer"</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">query_strings_config</span> <span class="p">{</span>
      <span class="nx">query_string_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Origin request policy</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_origin_request_policy"</span> <span class="s2">"api"</span> <span class="p">{</span>
  <span class="nx">name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-api-origin-request-policy"</span>
  <span class="nx">comment</span> <span class="o">=</span> <span class="s2">"Origin request policy for API"</span>
  
  <span class="nx">cookies_config</span> <span class="p">{</span>
    <span class="nx">cookie_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
  <span class="p">}</span>
  
  <span class="nx">headers_config</span> <span class="p">{</span>
    <span class="nx">header_behavior</span> <span class="o">=</span> <span class="s2">"allViewer"</span>
  <span class="p">}</span>
  
  <span class="nx">query_strings_config</span> <span class="p">{</span>
    <span class="nx">query_string_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Response headers policy</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_response_headers_policy"</span> <span class="s2">"security"</span> <span class="p">{</span>
  <span class="nx">name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-security-headers-policy"</span>
  <span class="nx">comment</span> <span class="o">=</span> <span class="s2">"Security headers policy"</span>
  
  <span class="nx">security_headers_config</span> <span class="p">{</span>
    <span class="nx">content_type_options</span> <span class="p">{</span>
      <span class="nx">override</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">frame_options</span> <span class="p">{</span>
      <span class="nx">frame_option</span> <span class="o">=</span> <span class="s2">"DENY"</span>
      <span class="nx">override</span>     <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">referrer_policy</span> <span class="p">{</span>
      <span class="nx">referrer_policy</span> <span class="o">=</span> <span class="s2">"strict-origin-when-cross-origin"</span>
      <span class="nx">override</span>        <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">xss_protection</span> <span class="p">{</span>
      <span class="nx">mode_block</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">protection</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">override</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">strict_transport_security</span> <span class="p">{</span>
      <span class="nx">access_control_max_age_sec</span> <span class="o">=</span> <span class="mi">63072000</span>
      <span class="nx">include_subdomains</span>         <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">preload</span>                    <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">override</span>                   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">content_security_policy</span> <span class="p">{</span>
      <span class="nx">content_security_policy</span> <span class="o">=</span> <span class="s2">"default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"</span>
      <span class="nx">override</span>                <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">cors_config</span> <span class="p">{</span>
    <span class="nx">access_control_allow_credentials</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">access_control_allow_headers</span> <span class="p">{</span>
      <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">access_control_allow_methods</span> <span class="p">{</span>
      <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"DELETE"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">access_control_allow_origins</span> <span class="p">{</span>
      <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"https://${var.domain_name}"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">access_control_max_age_sec</span> <span class="o">=</span> <span class="mi">86400</span>
    <span class="nx">origin_override</span>            <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">custom_headers_config</span> <span class="p">{</span>
    <span class="nx">items</span> <span class="p">{</span>
      <span class="nx">header</span>   <span class="o">=</span> <span class="s2">"X-Environment"</span>
      <span class="nx">value</span>    <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">override</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudFront monitoring</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"4xx_errors"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-cloudfront-4xx-errors"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"4xxErrorRate"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/CloudFront"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"5"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors CloudFront 4xx error rate"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">DistributionId</span> <span class="o">=</span> <span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Real-time logs</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_realtime_log_config"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-realtime-logs"</span>
  
  <span class="nx">endpoint</span> <span class="p">{</span>
    <span class="nx">stream_type</span> <span class="o">=</span> <span class="s2">"Kinesis"</span>
    
    <span class="nx">kinesis_stream_config</span> <span class="p">{</span>
      <span class="nx">role_arn</span>   <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">cloudfront_logs</span><span class="p">.</span><span class="nx">arn</span>
      <span class="nx">stream_arn</span> <span class="o">=</span> <span class="nx">aws_kinesis_stream</span><span class="p">.</span><span class="nx">cloudfront_logs</span><span class="p">.</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">fields</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"timestamp"</span><span class="p">,</span>
    <span class="s2">"c-ip"</span><span class="p">,</span>
    <span class="s2">"sc-status"</span><span class="p">,</span>
    <span class="s2">"cs-uri-stem"</span><span class="p">,</span>
    <span class="s2">"cs-user-agent"</span><span class="p">,</span>
    <span class="s2">"cs-referer"</span><span class="p">,</span>
    <span class="s2">"x-edge-location"</span><span class="p">,</span>
    <span class="s2">"x-edge-request-id"</span><span class="p">,</span>
    <span class="s2">"x-edge-response-result-type"</span><span class="p">,</span>
    <span class="s2">"time-taken"</span>
  <span class="p">]</span>
  
  <span class="nx">sampling_rate</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1% sampling</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="rds-performance-insights">RDS Performance Insights</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># rds-performance.tf - RDS with Performance Insights and monitoring</span>

<span class="c1"># RDS subnet group</span>
<span class="nx">resource</span> <span class="s2">"aws_db_subnet_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>       <span class="o">=</span> <span class="s2">"${var.environment}-db-subnet-group"</span>
  <span class="nx">subnet_ids</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS parameter group with performance optimizations</span>
<span class="nx">resource</span> <span class="s2">"aws_db_parameter_group"</span> <span class="s2">"optimized"</span> <span class="p">{</span>
  <span class="nx">name</span>   <span class="o">=</span> <span class="s2">"${var.environment}-mysql-optimized"</span>
  <span class="nx">family</span> <span class="o">=</span> <span class="s2">"mysql8.0"</span>
  
  <span class="c1"># Query performance parameters</span>
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"slow_query_log"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"long_query_time"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"log_queries_not_using_indexes"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"performance_schema"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="c1"># InnoDB optimization</span>
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_buffer_pool_size"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"{DBInstanceClassMemory*3/4}"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_log_file_size"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1073741824"</span>  <span class="c1"># 1GB</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_flush_log_at_trx_commit"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"2"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_flush_method"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"O_DIRECT"</span>
  <span class="p">}</span>
  
  <span class="c1"># Connection optimization</span>
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"max_connections"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1000"</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS instance with Performance Insights</span>
<span class="nx">resource</span> <span class="s2">"aws_db_instance"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">identifier</span> <span class="o">=</span> <span class="s2">"${var.environment}-database"</span>
  
  <span class="c1"># Engine configuration</span>
  <span class="nx">engine</span>                      <span class="o">=</span> <span class="s2">"mysql"</span>
  <span class="nx">engine_version</span>              <span class="o">=</span> <span class="s2">"8.0.33"</span>
  <span class="nx">auto_minor_version_upgrade</span>  <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">allow_major_version_upgrade</span> <span class="o">=</span> <span class="kc">false</span>
  
  <span class="c1"># Instance configuration</span>
  <span class="nx">instance_class</span>    <span class="o">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">db_instance_class</span>
  <span class="nx">allocated_storage</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_allocated_storage</span>
  <span class="nx">storage_encrypted</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">rds</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">storage_type</span>      <span class="o">=</span> <span class="s2">"gp3"</span>
  <span class="nx">iops</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_iops</span>
  
  <span class="c1"># Database configuration</span>
  <span class="nx">db_name</span>  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_name</span>
  <span class="nx">username</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_username</span>
  <span class="nx">password</span> <span class="o">=</span> <span class="nx">aws_secretsmanager_secret_version</span><span class="p">.</span><span class="nx">db_password</span><span class="p">.</span><span class="nx">secret_string</span>
  <span class="nx">port</span>     <span class="o">=</span> <span class="mi">3306</span>
  
  <span class="c1"># Network configuration</span>
  <span class="nx">db_subnet_group_name</span>   <span class="o">=</span> <span class="nx">aws_db_subnet_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">rds</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="nx">publicly_accessible</span>    <span class="o">=</span> <span class="kc">false</span>
  
  <span class="c1"># Parameter and option groups</span>
  <span class="nx">parameter_group_name</span> <span class="o">=</span> <span class="nx">aws_db_parameter_group</span><span class="p">.</span><span class="nx">optimized</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">option_group_name</span>    <span class="o">=</span> <span class="nx">aws_db_option_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="c1"># Backup configuration</span>
  <span class="nx">backup_retention_period</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">backup_window</span>          <span class="o">=</span> <span class="s2">"03:00-04:00"</span>
  <span class="nx">maintenance_window</span>     <span class="o">=</span> <span class="s2">"sun:04:00-sun:05:00"</span>
  
  <span class="c1"># High availability</span>
  <span class="nx">multi_az</span>               <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">deletion_protection</span>    <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">skip_final_snapshot</span>    <span class="o">=</span> <span class="kc">false</span>
  <span class="nx">final_snapshot_identifier</span> <span class="o">=</span> <span class="s2">"${var.environment}-database-final-snapshot-${formatdate("</span><span class="nx">YYYY-MM-DD-hhmm</span><span class="s2">", timestamp())}"</span>
  
  <span class="c1"># Performance Insights</span>
  <span class="nx">enabled_cloudwatch_logs_exports</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"error"</span><span class="p">,</span> <span class="s2">"general"</span><span class="p">,</span> <span class="s2">"slowquery"</span><span class="p">]</span>
  
  <span class="nx">performance_insights_enabled</span>          <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">performance_insights_kms_key_id</span>       <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="err">.</span><span class="nx">rds</span><span class="err">.</span><span class="nx">arn</span>
  <span class="nx">performance_insights_retention_period</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># days</span>
  
  <span class="c1"># Enhanced monitoring</span>
  <span class="nx">monitoring_interval</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="nx">monitoring_role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">rds_monitoring</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS Proxy for connection pooling</span>
<span class="nx">resource</span> <span class="s2">"aws_db_proxy"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                   <span class="o">=</span> <span class="s2">"${var.environment}-rds-proxy"</span>
  <span class="nx">engine_family</span>          <span class="o">=</span> <span class="s2">"MYSQL"</span>
  <span class="nx">auth</span> <span class="p">{</span>
    <span class="nx">auth_scheme</span> <span class="o">=</span> <span class="s2">"SECRETS"</span>
    <span class="nx">secret_arn</span>  <span class="o">=</span> <span class="nx">aws_secretsmanager_secret</span><span class="p">.</span><span class="nx">db_password</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
  
  <span class="nx">role_arn</span>               <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">rds_proxy</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">vpc_subnet_ids</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
  
  <span class="nx">require_tls</span>                    <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">idle_client_timeout</span>            <span class="o">=</span> <span class="mi">1800</span>
  <span class="nx">max_connections_percent</span>        <span class="o">=</span> <span class="mi">100</span>
  <span class="nx">max_idle_connections_percent</span>   <span class="o">=</span> <span class="mi">50</span>
  <span class="nx">connection_borrow_timeout</span>      <span class="o">=</span> <span class="mi">120</span>
  
  <span class="nx">target</span> <span class="p">{</span>
    <span class="nx">db_instance_identifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># CloudWatch dashboard for RDS Performance Insights</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_dashboard"</span> <span class="s2">"rds_performance"</span> <span class="p">{</span>
  <span class="nx">dashboard_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-rds-performance-insights"</span>
  
  <span class="nx">dashboard_body</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">widgets</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/RDS"</span><span class="p">,</span> <span class="s2">"CPUUtilization"</span><span class="p">,</span> <span class="s2">"DBInstanceIdentifier"</span><span class="p">,</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"DatabaseConnections"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"FreeableMemory"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Average"</span> <span class="p">}]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"RDS Resource Utilization"</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/RDS"</span><span class="p">,</span> <span class="s2">"ReadLatency"</span><span class="p">,</span> <span class="s2">"DBInstanceIdentifier"</span><span class="p">,</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"WriteLatency"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"ReadThroughput"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"WriteThroughput"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"RDS I/O Performance"</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">24</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/RDS"</span><span class="p">,</span> <span class="s2">"DBLoad"</span><span class="p">,</span> <span class="s2">"DBInstanceIdentifier"</span><span class="p">,</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"DBLoadCPU"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"DBLoadNonCPU"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">60</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"Performance Insights - Database Load"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># CloudWatch alarms for RDS</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"rds_cpu"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-rds-high-cpu"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"CPUUtilization"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/RDS"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"80"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors RDS CPU utilization"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">DBInstanceIdentifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"rds_connections"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-rds-high-connections"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span>          <span class="o">=</span> <span class="s2">"connections_percentage"</span>
    <span class="nx">expression</span>  <span class="o">=</span> <span class="s2">"(connections / max_connections) * 100"</span>
    <span class="nx">label</span>       <span class="o">=</span> <span class="s2">"Connection Percentage"</span>
    <span class="nx">return_data</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="s2">"connections"</span>
    
    <span class="nx">metric</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"DatabaseConnections"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"AWS/RDS"</span>
      <span class="nx">period</span>      <span class="o">=</span> <span class="mi">300</span>
      <span class="nx">stat</span>        <span class="o">=</span> <span class="s2">"Average"</span>
      
      <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">DBInstanceIdentifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="s2">"max_connections"</span>
    
    <span class="nx">metric</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"MaxConnections"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"AWS/RDS"</span>
      <span class="nx">period</span>      <span class="o">=</span> <span class="mi">300</span>
      <span class="nx">stat</span>        <span class="o">=</span> <span class="s2">"Average"</span>
      
      <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">DBInstanceIdentifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="mi">80</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"RDS connection usage above 80%"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Lambda function for Performance Insights analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"pi_analyzer"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"pi_analyzer.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-performance-insights-analyzer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">pi_analyzer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">300</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">1024</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">DB_INSTANCE_ID</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">SNS_TOPIC_ARN</span>  <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:lambda:${var.aws_region}:336392948345:layer:AWSSDKPandas-Python39:1"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule to trigger Performance Insights analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"pi_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-pi-analysis"</span>
  <span class="nx">description</span>         <span class="o">=</span> <span class="s2">"Trigger Performance Insights analysis"</span>
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"rate(1 hour)"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"pi_analyzer"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">pi_analysis</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"PIAnalyzer"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">pi_analyzer</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_permission"</span> <span class="s2">"pi_analyzer"</span> <span class="p">{</span>
  <span class="nx">statement_id</span>  <span class="o">=</span> <span class="s2">"AllowExecutionFromCloudWatch"</span>
  <span class="nx">action</span>        <span class="o">=</span> <span class="s2">"lambda:InvokeFunction"</span>
  <span class="nx">function_name</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">pi_analyzer</span><span class="p">.</span><span class="nx">function_name</span>
  <span class="nx">principal</span>     <span class="o">=</span> <span class="s2">"events.amazonaws.com"</span>
  <span class="nx">source_arn</span>    <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">pi_analysis</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># RDS automated backups to another region</span>
<span class="nx">resource</span> <span class="s2">"aws_db_instance_automated_backups_replication"</span> <span class="s2">"cross_region"</span> <span class="p">{</span>
  <span class="nx">count</span>                      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_cross_region_backup</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">source_db_instance_arn</span>     <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">kms_key_id</span>                 <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">backup_region</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">retention_period</span>           <span class="o">=</span> <span class="mi">7</span>
  
  <span class="nx">provider</span> <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">backup_region</span>
<span class="p">}</span>

<span class="c1"># Database Activity Streams</span>
<span class="nx">resource</span> <span class="s2">"aws_db_activity_stream"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_activity_stream</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  
  <span class="nx">resource_arn</span>                        <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">mode</span>                                <span class="o">=</span> <span class="s2">"async"</span>
  <span class="nx">kms_key_id</span>                          <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">activity_stream</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">engine_native_audit_fields_included</span> <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-your-first-and-constant-priority">Security: Your First and Constant Priority</h2>

<p>Security in AWS isn’t a feature you add later - it’s woven into every decision from day one. The good news? AWS provides powerful tools that make security easier than traditional on-premise setups.</p>

<h3 id="the-security-mindset-evolution">The Security Mindset Evolution</h3>

<p>Your security journey typically progresses through these stages:</p>

<ol>
  <li>
<strong>Basic Protection</strong>: Strong passwords, MFA, and basic IAM policies</li>
  <li>
<strong>Defense in Depth</strong>: Network isolation, encryption, and logging</li>
  <li>
<strong>Automated Compliance</strong>: Continuous monitoring and automated remediation</li>
  <li>
<strong>Zero Trust Architecture</strong>: Assume breach, verify everything</li>
</ol>

<h3 id="core-security-principles-that-save-you-later">Core Security Principles That Save You Later</h3>

<h4 id="principle-of-least-privilege">Principle of Least Privilege</h4>
<p>Give users and services only the permissions they need, nothing more. It’s tempting to grant broad permissions for convenience, but this creates massive risk.</p>

<p><strong>Example progression</strong>:</p>
<ul>
  <li>Bad: Give developers AdministratorAccess</li>
  <li>Better: Create a PowerUserAccess role without IAM permissions</li>
  <li>Best: Custom policies granting exactly what each team needs</li>
</ul>

<h4 id="encryption-everywhere">Encryption Everywhere</h4>
<p>AWS makes encryption easy - use it for everything:</p>
<ul>
  <li>
<strong>At Rest</strong>: S3, EBS, RDS all support transparent encryption</li>
  <li>
<strong>In Transit</strong>: TLS/SSL for all communications</li>
  <li>
<strong>Key Management</strong>: AWS KMS handles the complexity of key rotation</li>
</ul>

<p><strong>Real-world scenario</strong>: A healthcare startup encrypts patient data by default. When they undergo HIPAA compliance audit, encryption is already in place, saving months of remediation work.</p>

<h3 id="security-hub-your-compliance-command-center">Security Hub: Your Compliance Command Center</h3>

<p>Security Hub continuously monitors your AWS environment against industry standards (CIS, PCI-DSS, HIPAA). Instead of manual security reviews, you get real-time compliance scores.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># security-hub.tf - Security Hub configuration and custom checks</span>

<span class="c1"># Enable Security Hub</span>
<span class="nx">resource</span> <span class="s2">"aws_securityhub_account"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_organizations_organization</span><span class="p">.</span><span class="nx">main</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Enable security standards</span>
<span class="nx">resource</span> <span class="s2">"aws_securityhub_standards_subscription"</span> <span class="s2">"cis"</span> <span class="p">{</span>
  <span class="nx">standards_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}::standards/cis-aws-foundations-benchmark/v/1.4.0"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_securityhub_standards_subscription"</span> <span class="s2">"pci_dss"</span> <span class="p">{</span>
  <span class="nx">standards_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}::standards/pci-dss/v/3.2.1"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_securityhub_standards_subscription"</span> <span class="s2">"aws_foundational"</span> <span class="p">{</span>
  <span class="nx">standards_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}::standards/aws-foundational-security-best-practices/v/1.0.0"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Custom Security Hub action</span>
<span class="nx">resource</span> <span class="s2">"aws_securityhub_action_target"</span> <span class="s2">"remediate"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"Remediate"</span>
  <span class="nx">identifier</span>  <span class="o">=</span> <span class="s2">"Remediate"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Trigger automated remediation"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Lambda for custom security checks</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"security_checker"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"security_checker.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-custom-security-checks"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">security_checker</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">3008</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">SECURITY_HUB_PRODUCT_ARN</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}:${data.aws_caller_identity.current.account_id}:product/${data.aws_caller_identity.current.account_id}/default"</span>
      <span class="nx">ENVIRONMENT</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">vpc_config</span> <span class="p">{</span>
    <span class="nx">subnet_ids</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">lambda</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule to trigger security checks</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"security_checks"</span> <span class="p">{</span>
  <span class="nx">name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-security-checks"</span>
  <span class="nx">description</span>         <span class="o">=</span> <span class="s2">"Trigger custom security checks"</span>
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"rate(6 hours)"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"security_checker"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">security_checks</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"SecurityChecker"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">security_checker</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># Config Rules for compliance</span>
<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"encrypted_volumes"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-encrypted-volumes"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"AWS"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="s2">"ENCRYPTED_VOLUMES"</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"restricted_ssh"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-restricted-ssh"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"AWS"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="s2">"INCOMING_SSH_DISABLED"</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"s3_bucket_encryption"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-s3-bucket-encryption"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"AWS"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="s2">"S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Custom Config rule with Lambda</span>
<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"custom_security_check"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-custom-security-check"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"LAMBDA"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">config_rule_evaluator</span><span class="p">.</span><span class="nx">arn</span>
    
    <span class="nx">source_detail</span> <span class="p">{</span>
      <span class="nx">message_type</span> <span class="o">=</span> <span class="s2">"ConfigurationItemChangeNotification"</span>
    <span class="p">}</span>
    
    <span class="nx">source_detail</span> <span class="p">{</span>
      <span class="nx">message_type</span> <span class="o">=</span> <span class="s2">"OversizedConfigurationItemChangeNotification"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># GuardDuty configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_guardduty_detector"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">enable</span>                       <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">finding_publishing_frequency</span> <span class="o">=</span> <span class="s2">"FIFTEEN_MINUTES"</span>
  
  <span class="nx">datasources</span> <span class="p">{</span>
    <span class="nx">s3_logs</span> <span class="p">{</span>
      <span class="nx">enable</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="nx">kubernetes</span> <span class="p">{</span>
      <span class="nx">audit_logs</span> <span class="p">{</span>
        <span class="nx">enable</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">malware_protection</span> <span class="p">{</span>
      <span class="nx">scan_ec2_instance_with_findings</span> <span class="p">{</span>
        <span class="nx">ebs_volumes</span> <span class="p">{</span>
          <span class="nx">enable</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># GuardDuty threat intelligence sets</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"threat_intel"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-threat-intel-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_versioning"</span> <span class="s2">"threat_intel"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">threat_intel</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">versioning_configuration</span> <span class="p">{</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_object"</span> <span class="s2">"threat_list"</span> <span class="p">{</span>
  <span class="nx">bucket</span>  <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">threat_intel</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">key</span>     <span class="o">=</span> <span class="s2">"threat-lists/malicious-ips.txt"</span>
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">file</span><span class="p">(</span><span class="s2">"${path.module}/threat-lists/malicious-ips.txt"</span><span class="p">)</span>
  <span class="nx">etag</span>    <span class="o">=</span> <span class="nx">filemd5</span><span class="p">(</span><span class="s2">"${path.module}/threat-lists/malicious-ips.txt"</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_guardduty_threatintelset"</span> <span class="s2">"malicious_ips"</span> <span class="p">{</span>
  <span class="nx">activate</span>    <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">detector_id</span> <span class="o">=</span> <span class="nx">aws_guardduty_detector</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">format</span>      <span class="o">=</span> <span class="s2">"TXT"</span>
  <span class="nx">location</span>    <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.threat_intel.id}/${aws_s3_object.threat_list.key}"</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"malicious-ips"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_s3_object</span><span class="p">.</span><span class="nx">threat_list</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># GuardDuty member accounts</span>
<span class="nx">resource</span> <span class="s2">"aws_guardduty_member"</span> <span class="s2">"member_accounts"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">member_accounts</span>
  
  <span class="nx">account_id</span>                 <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">account_id</span>
  <span class="nx">detector_id</span>                <span class="o">=</span> <span class="nx">aws_guardduty_detector</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">email</span>                      <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">email</span>
  <span class="nx">invite</span>                     <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">invitation_message</span>         <span class="o">=</span> <span class="s2">"You are invited to join GuardDuty"</span>
  <span class="nx">disable_email_notification</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1"># Inspector v2</span>
<span class="nx">resource</span> <span class="s2">"aws_inspector2_enabler"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">account_ids</span>    <span class="o">=</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">aws_caller_identity</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">account_id</span><span class="p">]</span>
  <span class="nx">resource_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"EC2"</span><span class="p">,</span> <span class="s2">"ECR"</span><span class="p">,</span> <span class="s2">"LAMBDA"</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Macie for S3 data protection</span>
<span class="nx">resource</span> <span class="s2">"aws_macie2_account"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">finding_publishing_frequency</span> <span class="o">=</span> <span class="s2">"FIFTEEN_MINUTES"</span>
  <span class="nx">status</span>                       <span class="o">=</span> <span class="s2">"ENABLED"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_macie2_classification_job"</span> <span class="s2">"s3_scan"</span> <span class="p">{</span>
  <span class="nx">job_type</span> <span class="o">=</span> <span class="s2">"ONE_TIME"</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-s3-sensitive-data-scan"</span>
  
  <span class="nx">s3_job_definition</span> <span class="p">{</span>
    <span class="nx">bucket_definitions</span> <span class="p">{</span>
      <span class="nx">account_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_caller_identity</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">account_id</span>
      <span class="nx">buckets</span>    <span class="o">=</span> <span class="p">[</span><span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_macie2_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Access Analyzer</span>
<span class="nx">resource</span> <span class="s2">"aws_accessanalyzer_analyzer"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">analyzer_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-access-analyzer"</span>
  <span class="nx">type</span>          <span class="o">=</span> <span class="s2">"ACCOUNT"</span>  <span class="c1"># or "ORGANIZATION"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Systems Manager compliance</span>
<span class="nx">resource</span> <span class="s2">"aws_ssm_association"</span> <span class="s2">"patch_baseline"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"AWS-RunPatchBaseline"</span>
  
  <span class="nx">targets</span> <span class="p">{</span>
    <span class="nx">key</span>    <span class="o">=</span> <span class="s2">"tag:Environment"</span>
    <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">environment</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"cron(0 2 ? * SUN *)"</span>
  
  <span class="nx">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Operation</span>    <span class="o">=</span> <span class="s2">"Install"</span>
    <span class="nx">RebootOption</span> <span class="o">=</span> <span class="s2">"RebootIfNeeded"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># KMS key policies for security</span>
<span class="nx">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"kms_key_policy"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">sid</span>    <span class="o">=</span> <span class="s2">"Enable IAM User Permissions"</span>
    <span class="nx">effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
    
    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"AWS"</span>
      <span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">actions</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"kms:*"</span><span class="p">]</span>
    <span class="nx">resources</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">sid</span>    <span class="o">=</span> <span class="s2">"Allow use of the key for encryption"</span>
    <span class="nx">effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
    
    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"Service"</span>
      <span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"logs.${var.aws_region}.amazonaws.com"</span><span class="p">,</span>
        <span class="s2">"s3.amazonaws.com"</span><span class="p">,</span>
        <span class="s2">"rds.amazonaws.com"</span>
      <span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">actions</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">"kms:Decrypt"</span><span class="p">,</span>
      <span class="s2">"kms:GenerateDataKey"</span><span class="p">,</span>
      <span class="s2">"kms:CreateGrant"</span><span class="p">,</span>
      <span class="s2">"kms:DescribeKey"</span>
    <span class="p">]</span>
    
    <span class="nx">resources</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">]</span>
    
    <span class="nx">condition</span> <span class="p">{</span>
      <span class="nx">test</span>     <span class="o">=</span> <span class="s2">"StringEquals"</span>
      <span class="nx">variable</span> <span class="o">=</span> <span class="s2">"kms:ViaService"</span>
      <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"s3.${var.aws_region}.amazonaws.com"</span><span class="p">,</span>
        <span class="s2">"rds.${var.aws_region}.amazonaws.com"</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_kms_key"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">description</span>             <span class="o">=</span> <span class="s2">"${var.environment} master key"</span>
  <span class="nx">deletion_window_in_days</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">enable_key_rotation</span>     <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">policy</span>                  <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_iam_policy_document</span><span class="p">.</span><span class="nx">kms_key_policy</span><span class="p">.</span><span class="nx">json</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Security automation with EventBridge and Lambda</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"security_findings"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-security-findings"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Capture Security Hub findings for automated remediation"</span>
  
  <span class="nx">event_pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">source</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"aws.securityhub"</span><span class="p">]</span>
    <span class="nx">detail-type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Security Hub Findings - Imported"</span><span class="p">]</span>
    <span class="nx">detail</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">findings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Severity</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"CRITICAL"</span><span class="p">,</span> <span class="s2">"HIGH"</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">Workflow</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Status</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"NEW"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"remediation"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">security_findings</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"RemediationFunction"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">auto_remediation</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"auto_remediation"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"auto_remediation.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-security-auto-remediation"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">remediation</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">300</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ENVIRONMENT</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># WAF rules for application protection</span>
<span class="nx">resource</span> <span class="s2">"aws_wafv2_web_acl"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"${var.environment}-waf-acl"</span>
  <span class="nx">scope</span> <span class="o">=</span> <span class="s2">"REGIONAL"</span>  <span class="c1"># or "CLOUDFRONT"</span>
  
  <span class="nx">default_action</span> <span class="p">{</span>
    <span class="nx">allow</span> <span class="p">{}</span>
  <span class="p">}</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"RateLimitRule"</span>
    <span class="nx">priority</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="nx">statement</span> <span class="p">{</span>
      <span class="nx">rate_based_statement</span> <span class="p">{</span>
        <span class="nx">limit</span>              <span class="o">=</span> <span class="mi">2000</span>
        <span class="nx">aggregate_key_type</span> <span class="o">=</span> <span class="s2">"IP"</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">action</span> <span class="p">{</span>
      <span class="nx">block</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="nx">visibility_config</span> <span class="p">{</span>
      <span class="nx">cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">metric_name</span>                <span class="o">=</span> <span class="s2">"RateLimitRule"</span>
      <span class="nx">sampled_requests_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"ManagedRuleGroup"</span>
    <span class="nx">priority</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="nx">override_action</span> <span class="p">{</span>
      <span class="nx">none</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="nx">statement</span> <span class="p">{</span>
      <span class="nx">managed_rule_group_statement</span> <span class="p">{</span>
        <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"AWSManagedRulesKnownBadInputsRuleSet"</span>
        <span class="nx">vendor_name</span> <span class="o">=</span> <span class="s2">"AWS"</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">visibility_config</span> <span class="p">{</span>
      <span class="nx">cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">metric_name</span>                <span class="o">=</span> <span class="s2">"ManagedRuleGroup"</span>
      <span class="nx">sampled_requests_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">visibility_config</span> <span class="p">{</span>
    <span class="nx">cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">metric_name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-waf-acl"</span>
    <span class="nx">sampled_requests_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="cost-optimization-spending-smart-in-the-cloud">Cost Optimization: Spending Smart in the Cloud</h2>

<p>The cloud’s pay-as-you-go model is powerful, but without proper management, costs can spiral. The key is understanding how pricing works and implementing automated controls from the start.</p>

<h3 id="the-cost-evolution-pattern">The Cost Evolution Pattern</h3>

<p>Most teams follow this cost optimization journey:</p>

<ol>
  <li>
<strong>Shock Phase</strong>: First AWS bill surprises everyone</li>
  <li>
<strong>Panic Cuts</strong>: Turning off resources randomly</li>
  <li>
<strong>Understanding</strong>: Learning what actually drives costs</li>
  <li>
<strong>Optimization</strong>: Right-sizing and automated management</li>
  <li>
<strong>Mastery</strong>: Costs become predictable and optimized</li>
</ol>

<h3 id="understanding-your-bill">Understanding Your Bill</h3>

<p>AWS costs break down into three main categories:</p>

<h4 id="compute-costs">Compute Costs</h4>
<ul>
  <li>
<strong>On-Demand</strong>: Like hotel rooms - flexible but expensive</li>
  <li>
<strong>Reserved Instances</strong>: Like apartment leases - cheaper with commitment</li>
  <li>
<strong>Spot Instances</strong>: Like last-minute deals - up to 90% off but can be interrupted</li>
  <li>
<strong>Savings Plans</strong>: Flexible commitment across instance types</li>
</ul>

<p><strong>Real example</strong>: A startup’s API servers cost $5,000/month on-demand. After analyzing usage patterns, they buy Reserved Instances for baseline capacity and use Spot for batch processing, reducing costs to $2,000/month.</p>

<h4 id="storage-costs">Storage Costs</h4>
<ul>
  <li>
<strong>S3 Storage Classes</strong>: Match storage to access patterns
    <ul>
      <li>Standard: Frequently accessed data</li>
      <li>Infrequent Access: 50% cheaper for archived data</li>
      <li>Glacier: 90% cheaper for long-term archives</li>
    </ul>
  </li>
  <li>
<strong>Lifecycle Policies</strong>: Automatically move data to cheaper storage</li>
</ul>

<p><strong>Real example</strong>: A photo sharing app automatically moves photos older than 30 days to Infrequent Access, and after 1 year to Glacier. Storage costs drop 70% with no user impact.</p>

<h4 id="data-transfer-costs">Data Transfer Costs</h4>
<ul>
  <li>
<strong>Within Region</strong>: Free between services</li>
  <li>
<strong>Cross-Region</strong>: Charged per GB</li>
  <li>
<strong>Internet Egress</strong>: Most expensive</li>
</ul>

<h3 id="advanced-cost-management-tools">Advanced Cost Management Tools</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cost-optimization.tf - Cost management and optimization</span>

<span class="c1"># Cost anomaly detection</span>
<span class="nx">resource</span> <span class="s2">"aws_ce_anomaly_monitor"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"${var.environment}-cost-anomaly-monitor"</span>
  <span class="nx">monitor_type</span>      <span class="o">=</span> <span class="s2">"DIMENSIONAL"</span>
  <span class="nx">monitor_dimension</span> <span class="o">=</span> <span class="s2">"SERVICE"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_ce_anomaly_subscription"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"${var.environment}-cost-anomaly-subscription"</span>
  <span class="nx">threshold</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># USD</span>
  <span class="nx">frequency</span> <span class="o">=</span> <span class="s2">"DAILY"</span>
  
  <span class="nx">monitor_arn_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_ce_anomaly_monitor</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">]</span>
  
  <span class="nx">subscriber</span> <span class="p">{</span>
    <span class="nx">type</span>    <span class="o">=</span> <span class="s2">"EMAIL"</span>
    <span class="nx">address</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span>
  <span class="p">}</span>
  
  <span class="nx">subscriber</span> <span class="p">{</span>
    <span class="nx">type</span>    <span class="o">=</span> <span class="s2">"SNS"</span>
    <span class="nx">address</span> <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Budget alerts</span>
<span class="nx">resource</span> <span class="s2">"aws_budgets_budget"</span> <span class="s2">"monthly"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"${var.environment}-monthly-budget"</span>
  <span class="nx">budget_type</span>       <span class="o">=</span> <span class="s2">"COST"</span>
  <span class="nx">limit_amount</span>      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">monthly_budget_limit</span>
  <span class="nx">limit_unit</span>        <span class="o">=</span> <span class="s2">"USD"</span>
  <span class="nx">time_unit</span>         <span class="o">=</span> <span class="s2">"MONTHLY"</span>
  <span class="nx">time_period_start</span> <span class="o">=</span> <span class="s2">"2024-01-01_00:00"</span>
  
  <span class="nx">cost_types</span> <span class="p">{</span>
    <span class="nx">include_credit</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_discount</span>           <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_other_subscription</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_recurring</span>          <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_refund</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_subscription</span>       <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_support</span>            <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_tax</span>                <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_upfront</span>            <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">use_blended</span>                <span class="o">=</span> <span class="kc">false</span>
  <span class="err">}</span>
  
  <span class="nx">notification</span> <span class="p">{</span>
    <span class="nx">comparison_operator</span>        <span class="o">=</span> <span class="s2">"GREATER_THAN"</span>
    <span class="nx">threshold</span>                  <span class="o">=</span> <span class="mi">80</span>
    <span class="nx">threshold_type</span>             <span class="o">=</span> <span class="s2">"PERCENTAGE"</span>
    <span class="nx">notification_type</span>          <span class="o">=</span> <span class="s2">"FORECASTED"</span>
    <span class="nx">subscriber_email_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span><span class="p">]</span>
    <span class="nx">subscriber_sns_topic_arns</span>  <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">notification</span> <span class="p">{</span>
    <span class="nx">comparison_operator</span>        <span class="o">=</span> <span class="s2">"GREATER_THAN"</span>
    <span class="nx">threshold</span>                  <span class="o">=</span> <span class="mi">100</span>
    <span class="nx">threshold_type</span>             <span class="o">=</span> <span class="s2">"PERCENTAGE"</span>
    <span class="nx">notification_type</span>          <span class="o">=</span> <span class="s2">"ACTUAL"</span>
    <span class="nx">subscriber_email_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span><span class="p">]</span>
    <span class="nx">subscriber_sns_topic_arns</span>  <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Service-specific budgets</span>
<span class="nx">resource</span> <span class="s2">"aws_budgets_budget"</span> <span class="s2">"service_budgets"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">service_budgets</span>
  
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"${var.environment}-${each.key}-budget"</span>
  <span class="nx">budget_type</span>       <span class="o">=</span> <span class="s2">"COST"</span>
  <span class="nx">limit_amount</span>      <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">limit</span>
  <span class="nx">limit_unit</span>        <span class="o">=</span> <span class="s2">"USD"</span>
  <span class="nx">time_unit</span>         <span class="o">=</span> <span class="s2">"MONTHLY"</span>
  <span class="nx">time_period_start</span> <span class="o">=</span> <span class="s2">"2024-01-01_00:00"</span>
  
  <span class="nx">cost_filter</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"Service"</span>
    <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span><span class="nx">each</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">cost_types</span> <span class="p">{</span>
    <span class="nx">include_credit</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_discount</span>           <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_other_subscription</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_recurring</span>          <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_refund</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_subscription</span>       <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_support</span>            <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_tax</span>                <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_upfront</span>            <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">use_blended</span>                <span class="o">=</span> <span class="kc">false</span>
  <span class="err">}</span>
  
  <span class="nx">notification</span> <span class="p">{</span>
    <span class="nx">comparison_operator</span>        <span class="o">=</span> <span class="s2">"GREATER_THAN"</span>
    <span class="nx">threshold</span>                  <span class="o">=</span> <span class="mi">90</span>
    <span class="nx">threshold_type</span>             <span class="o">=</span> <span class="s2">"PERCENTAGE"</span>
    <span class="nx">notification_type</span>          <span class="o">=</span> <span class="s2">"ACTUAL"</span>
    <span class="nx">subscriber_email_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Compute Optimizer enrollment</span>
<span class="nx">resource</span> <span class="s2">"aws_organizations_policy"</span> <span class="s2">"compute_optimizer"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"ComputeOptimizerEnrollment"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Enable Compute Optimizer for all accounts"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"SERVICE_CONTROL_POLICY"</span>
  
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"compute-optimizer:*"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"*"</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Lambda for cost optimization recommendations</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"cost_optimizer"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"cost_optimizer.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-cost-optimizer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">cost_optimizer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">3008</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">SNS_TOPIC_ARN</span>    <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_recommendations</span><span class="p">.</span><span class="nx">arn</span>
      <span class="nx">S3_BUCKET</span>        <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">ENVIRONMENT</span>      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:lambda:${var.aws_region}:336392948345:layer:AWSSDKPandas-Python39:1"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule for weekly cost analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"cost_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-weekly-cost-analysis"</span>
  <span class="nx">description</span>         <span class="o">=</span> <span class="s2">"Trigger weekly cost analysis"</span>
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"cron(0 9 ? * MON *)"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"cost_optimizer"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">cost_analysis</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"CostOptimizer"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">cost_optimizer</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># Cost and Usage Report</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"cost_reports"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-cost-reports-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_policy"</span> <span class="s2">"cost_reports"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"billingreports.amazonaws.com"</span>
        <span class="p">}</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s2">"s3:GetBucketAcl"</span><span class="p">,</span>
          <span class="s2">"s3:GetBucketPolicy"</span>
        <span class="p">]</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">arn</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"billingreports.amazonaws.com"</span>
        <span class="p">}</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"s3:PutObject"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"${aws_s3_bucket.cost_reports.arn}/*"</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cur_report_definition"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">report_name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-cost-usage-report"</span>
  <span class="nx">time_unit</span>                  <span class="o">=</span> <span class="s2">"DAILY"</span>
  <span class="nx">format</span>                     <span class="o">=</span> <span class="s2">"Parquet"</span>
  <span class="nx">compression</span>                <span class="o">=</span> <span class="s2">"Parquet"</span>
  <span class="nx">additional_schema_elements</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"RESOURCES"</span><span class="p">]</span>
  <span class="nx">s3_bucket</span>                  <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="err">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">s3_prefix</span>                  <span class="o">=</span> <span class="s2">"cur"</span>
  <span class="nx">s3_region</span>                  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
  <span class="nx">additional_artifacts</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">"QUICKSIGHT"</span><span class="p">]</span>
  <span class="nx">report_versioning</span>          <span class="o">=</span> <span class="s2">"OVERWRITE_REPORT"</span>
<span class="p">}</span>

<span class="c1"># Reserved Instance utilization alerts</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"ri_utilization"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-low-ri-utilization"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"LessThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"1"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"ReservedInstanceUtilization"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/CE"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"86400"</span>  <span class="c1"># 24 hours</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"75"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"Reserved Instance utilization below 75%"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Currency</span> <span class="o">=</span> <span class="s2">"USD"</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Savings Plans utilization alerts</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"sp_utilization"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-low-sp-utilization"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"LessThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"1"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"SavingsPlansUtilization"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/CE"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"86400"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"90"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"Savings Plans utilization below 90%"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
<span class="err">}</span>

<span class="c1"># Cost allocation tags</span>
<span class="nx">resource</span> <span class="s2">"aws_organizations_policy"</span> <span class="s2">"tagging"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"MandatoryTaggingPolicy"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Enforce cost allocation tags"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"TAG_POLICY"</span>
  
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">Environment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">tag_key</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="s2">"Environment"</span>
        <span class="p">}</span>
        <span class="nx">tag_value</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"Production"</span><span class="p">,</span> <span class="s2">"Staging"</span><span class="p">,</span> <span class="s2">"Development"</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">enforced_for</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ec2:instance"</span><span class="p">,</span> <span class="s2">"s3:bucket"</span><span class="p">,</span> <span class="s2">"rds:db"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">CostCenter</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">tag_key</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="s2">"CostCenter"</span>
        <span class="p">}</span>
        <span class="nx">enforced_for</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ec2:*"</span><span class="p">,</span> <span class="s2">"s3:*"</span><span class="p">,</span> <span class="s2">"rds:*"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">Project</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">tag_key</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="s2">"Project"</span>
        <span class="p">}</span>
        <span class="nx">enforced_for</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ec2:*"</span><span class="p">,</span> <span class="s2">"s3:*"</span><span class="p">,</span> <span class="s2">"rds:*"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Attach tagging policy to organization</span>
<span class="nx">resource</span> <span class="s2">"aws_organizations_policy_attachment"</span> <span class="s2">"tagging"</span> <span class="p">{</span>
  <span class="nx">policy_id</span> <span class="o">=</span> <span class="nx">aws_organizations_policy</span><span class="p">.</span><span class="nx">tagging</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="nx">aws_organizations_organization</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span>
<span class="p">}</span>

<span class="c1"># Instance Scheduler for non-production environments</span>
<span class="nx">module</span> <span class="s2">"instance_scheduler"</span> <span class="p">{</span>
  <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"aws-ia/instance-scheduler/aws"</span>
  <span class="nx">version</span> <span class="o">=</span> <span class="s2">"2.0.0"</span>
  
  <span class="nx">scheduler_frequency</span> <span class="o">=</span> <span class="s2">"5"</span>
  
  <span class="nx">schedules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"business-hours"</span>
      <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Run instances during business hours only"</span>
      <span class="nx">timezone</span>    <span class="o">=</span> <span class="s2">"America/New_York"</span>
      
      <span class="nx">periods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"weekdays"</span>
          <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Monday to Friday"</span>
          <span class="nx">begintime</span>   <span class="o">=</span> <span class="s2">"08:00"</span>
          <span class="nx">endtime</span>     <span class="o">=</span> <span class="s2">"18:00"</span>
          <span class="nx">weekdays</span>    <span class="o">=</span> <span class="s2">"mon-fri"</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
  
  <span class="nx">tag_name</span> <span class="o">=</span> <span class="s2">"Schedule"</span>
<span class="p">}</span>

<span class="c1"># Spot Instance configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_launch_template"</span> <span class="s2">"spot"</span> <span class="p">{</span>
  <span class="nx">name_prefix</span> <span class="o">=</span> <span class="s2">"${var.environment}-spot-"</span>
  
  <span class="nx">instance_market_options</span> <span class="p">{</span>
    <span class="nx">market_type</span> <span class="o">=</span> <span class="s2">"spot"</span>
    
    <span class="nx">spot_options</span> <span class="p">{</span>
      <span class="nx">max_price</span>                      <span class="o">=</span> <span class="s2">"0.5"</span>  <span class="c1"># 50% of on-demand price</span>
      <span class="nx">spot_instance_type</span>             <span class="o">=</span> <span class="s2">"persistent"</span>
      <span class="nx">instance_interruption_behavior</span> <span class="o">=</span> <span class="s2">"stop"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tag_specifications</span> <span class="p">{</span>
    <span class="nx">resource_type</span> <span class="o">=</span> <span class="s2">"instance"</span>
    
    <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">InstanceType</span> <span class="o">=</span> <span class="s2">"spot"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># S3 lifecycle policies for cost optimization</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_lifecycle_configuration"</span> <span class="s2">"logs"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">id</span>     <span class="o">=</span> <span class="s2">"transition-old-logs"</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
    
    <span class="nx">transition</span> <span class="p">{</span>
      <span class="nx">days</span>          <span class="o">=</span> <span class="mi">30</span>
      <span class="nx">storage_class</span> <span class="o">=</span> <span class="s2">"STANDARD_IA"</span>
    <span class="p">}</span>
    
    <span class="nx">transition</span> <span class="p">{</span>
      <span class="nx">days</span>          <span class="o">=</span> <span class="mi">90</span>
      <span class="nx">storage_class</span> <span class="o">=</span> <span class="s2">"GLACIER"</span>
    <span class="p">}</span>
    
    <span class="nx">transition</span> <span class="p">{</span>
      <span class="nx">days</span>          <span class="o">=</span> <span class="mi">180</span>
      <span class="nx">storage_class</span> <span class="o">=</span> <span class="s2">"DEEP_ARCHIVE"</span>
    <span class="p">}</span>
    
    <span class="nx">expiration</span> <span class="p">{</span>
      <span class="nx">days</span> <span class="o">=</span> <span class="mi">365</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">id</span>     <span class="o">=</span> <span class="s2">"delete-incomplete-uploads"</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
    
    <span class="nx">abort_incomplete_multipart_upload</span> <span class="p">{</span>
      <span class="nx">days_after_initiation</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Athena for cost analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_athena_database"</span> <span class="s2">"cost_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span>   <span class="o">=</span> <span class="s2">"${var.environment}_cost_analysis"</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_athena_workgroup"</span> <span class="s2">"cost_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-cost-analysis"</span>
  
  <span class="nx">configuration</span> <span class="p">{</span>
    <span class="nx">enforce_workgroup_configuration</span>    <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">publish_cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">result_configuration</span> <span class="p">{</span>
      <span class="nx">output_location</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.cost_reports.id}/athena-results/"</span>
      
      <span class="nx">encryption_configuration</span> <span class="p">{</span>
        <span class="nx">encryption_option</span> <span class="o">=</span> <span class="s2">"SSE_S3"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># QuickSight for cost visualization</span>
<span class="nx">resource</span> <span class="s2">"aws_quicksight_data_source"</span> <span class="s2">"cost_data"</span> <span class="p">{</span>
  <span class="nx">data_source_id</span> <span class="o">=</span> <span class="s2">"${var.environment}-cost-data"</span>
  <span class="nx">name</span>           <span class="o">=</span> <span class="s2">"Cost and Usage Report"</span>
  
  <span class="nx">parameters</span> <span class="p">{</span>
    <span class="nx">athena</span> <span class="p">{</span>
      <span class="nx">work_group</span> <span class="o">=</span> <span class="nx">aws_athena_workgroup</span><span class="p">.</span><span class="nx">cost_analysis</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">type</span> <span class="o">=</span> <span class="s2">"ATHENA"</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    for key in tag_schema.keys():
        self.ce_client.create_cost_category_definition(
            Name=f'CostCategory-{key}',
            Rules=[
                {
                    'Value': value,
                    'Rule': {
                        'Tags': {
                            'Key': key,
                            'Values': [value]
                        }
                    }
                } for value in tag_schema[key]
            ]
        )
</code></pre></div></div>

<h1 id="spot-instance-management">Spot Instance management</h1>
<p>class SpotInstanceManager:
    def <strong>init</strong>(self):
        self.ec2 = boto3.client(‘ec2’)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def create_spot_fleet(self,
                     target_capacity: int,
                     instance_types: List[str],
                     max_price: str,
                     subnets: List[str]) -&gt; str:
    """Create diversified Spot Fleet"""
    
    # Build launch specifications for each instance type
    launch_specs = []
    
    for instance_type in instance_types:
        for subnet in subnets:
            launch_specs.append({
                'InstanceType': instance_type,
                'ImageId': 'ami-12345678',  # Your AMI
                'KeyName': 'your-key-pair',
                'SecurityGroups': [{'GroupId': 'sg-12345678'}],
                'SubnetId': subnet,
                'IamInstanceProfile': {
                    'Arn': 'arn:aws:iam::account:instance-profile/role'
                },
                'TagSpecifications': [
                    {
                        'ResourceType': 'instance',
                        'Tags': [
                            {'Key': 'Name', 'Value': 'SpotFleet-Instance'},
                            {'Key': 'Type', 'Value': 'Spot'}
                        ]
                    }
                ]
            })
    
    response = self.ec2.request_spot_fleet(
        SpotFleetRequestConfig={
            'AllocationStrategy': 'diversified',
            'TargetCapacity': target_capacity,
            'SpotPrice': max_price,
            'IamFleetRole': 'arn:aws:iam::account:role/aws-ec2-spot-fleet-role',
            'LaunchSpecifications': launch_specs,
            'TerminateInstancesWithExpiration': True,
            'Type': 'maintain',
            'ReplaceUnhealthyInstances': True,
            'InstanceInterruptionBehavior': 'terminate',
            'TagSpecifications': [
                {
                    'ResourceType': 'spot-fleet-request',
                    'Tags': [
                        {'Key': 'Name', 'Value': 'MySpotFleet'}
                    ]
                }
            ]
        }
    )
    
    return response['SpotFleetRequestId'] ```
</code></pre></div></div>

<h2 id="the-future-of-cloud-emerging-technologies">The Future of Cloud: Emerging Technologies</h2>

<p>AWS continuously launches new services that push the boundaries of what’s possible. While you don’t need these for most applications, understanding emerging technologies helps you prepare for the future.</p>

<h3 id="quantum-computing-from-science-fiction-to-reality">Quantum Computing: From Science Fiction to Reality</h3>

<p>AWS Braket makes quantum computing accessible to developers. Instead of building a quantum computer (which requires near-absolute-zero temperatures), you can run quantum algorithms on actual quantum hardware through AWS.</p>

<h4 id="when-quantum-computing-matters">When Quantum Computing Matters</h4>

<p>Quantum computers excel at specific problems:</p>
<ul>
  <li>
<strong>Optimization</strong>: Finding the best route among millions of possibilities</li>
  <li>
<strong>Simulation</strong>: Modeling molecular interactions for drug discovery</li>
  <li>
<strong>Cryptography</strong>: Breaking and creating unbreakable codes</li>
  <li>
<strong>Machine Learning</strong>: Training models on complex patterns</li>
</ul>

<p><strong>Real-world example</strong>: A logistics company uses Braket to optimize delivery routes across 1,000 cities. Classical computers would take years to find the optimal solution; quantum algorithms explore multiple possibilities simultaneously, finding near-optimal routes in hours.</p>

<p><strong>Getting Started with Quantum</strong>:</p>
<ol>
  <li>Start with quantum simulators (free) to learn quantum programming</li>
  <li>Test algorithms on actual quantum hardware (pay per task)</li>
  <li>Compare results with classical computing to understand advantages</li>
</ol>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># quantum-computing.tf - AWS Braket quantum computing resources</span>

<span class="c1"># S3 bucket for quantum task results</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"quantum_results"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-quantum-results-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_versioning"</span> <span class="s2">"quantum_results"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">versioning_configuration</span> <span class="p">{</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_server_side_encryption_configuration"</span> <span class="s2">"quantum_results"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">apply_server_side_encryption_by_default</span> <span class="p">{</span>
      <span class="nx">sse_algorithm</span> <span class="o">=</span> <span class="s2">"AES256"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># IAM role for Braket</span>
<span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"braket"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-braket-role"</span>
  
  <span class="nx">assume_role_policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"sts:AssumeRole"</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"braket.amazonaws.com"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy"</span> <span class="s2">"braket"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-braket-policy"</span>
  <span class="nx">role</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">braket</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s2">"s3:PutObject"</span><span class="p">,</span>
          <span class="s2">"s3:GetObject"</span><span class="p">,</span>
          <span class="s2">"s3:ListBucket"</span>
        <span class="p">]</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="p">[</span>
          <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">arn</span><span class="p">,</span>
          <span class="s2">"${aws_s3_bucket.quantum_results.arn}/*"</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Lambda function for quantum circuit execution</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"quantum_processor"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"quantum_processor.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-quantum-processor"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">quantum_lambda</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">3008</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">QUANTUM_RESULTS_BUCKET</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">ENVIRONMENT</span>           <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:lambda:${var.aws_region}:${data.aws_caller_identity.current.account_id}:layer:AmazonBraket:1"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule for quantum task monitoring</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"quantum_task_state_change"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-quantum-task-state-change"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Capture Braket quantum task state changes"</span>
  
  <span class="nx">event_pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">source</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"aws.braket"</span><span class="p">]</span>
    <span class="nx">detail-type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Braket Task State Change"</span><span class="p">]</span>
    <span class="nx">detail</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">status</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"COMPLETED"</span><span class="p">,</span> <span class="s2">"FAILED"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"quantum_notification"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">quantum_task_state_change</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"QuantumNotification"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">quantum_notifications</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># SNS topic for quantum task notifications</span>
<span class="nx">resource</span> <span class="s2">"aws_sns_topic"</span> <span class="s2">"quantum_notifications"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-quantum-notifications"</span>
  
  <span class="nx">kms_master_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sns</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="c1"># Lambda for quantum-classical hybrid algorithms</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"quantum_hybrid"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"quantum_hybrid.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-quantum-hybrid-optimizer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">quantum_lambda</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"vqe_optimizer.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">10240</span>  <span class="c1"># 10GB for optimization tasks</span>
  
  <span class="nx">ephemeral_storage</span> <span class="p">{</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="mi">10240</span>  <span class="c1"># 10GB</span>
  <span class="p">}</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">QUANTUM_DEVICE_ARN</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">quantum_device_arn</span>
      <span class="nx">S3_BUCKET</span>         <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">MAX_ITERATIONS</span>    <span class="o">=</span> <span class="s2">"100"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">vpc_config</span> <span class="p">{</span>
    <span class="nx">subnet_ids</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">lambda</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Step Functions for quantum workflow orchestration</span>
<span class="nx">resource</span> <span class="s2">"aws_sfn_state_machine"</span> <span class="s2">"quantum_workflow"</span> <span class="p">{</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-quantum-workflow"</span>
  <span class="nx">role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">step_functions</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Comment</span> <span class="o">=</span> <span class="s2">"Quantum-Classical Hybrid Workflow"</span>
    <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"PrepareQuantumCircuit"</span>
    <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">PrepareQuantumCircuit</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::lambda:invoke"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">quantum_processor</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">Payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"action"</span> <span class="p">=</span> <span class="s2">"prepare_circuit"</span>
            <span class="s2">"parameters.$"</span> <span class="p">=</span> <span class="s2">"$.circuit_params"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.circuit"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"SubmitQuantumTask"</span>
      <span class="p">}</span>
      
      <span class="nx">SubmitQuantumTask</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:braket:createQuantumTask"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">DeviceArn</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">quantum_device_arn</span>
          <span class="nx">OutputS3Bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
          <span class="nx">OutputS3KeyPrefix</span> <span class="o">=</span> <span class="s2">"tasks/"</span>
          <span class="nx">Shots</span> <span class="o">=</span> <span class="mi">1000</span>
          <span class="nx">Action</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"BraketSchemaHeader"</span> <span class="p">=</span> <span class="p">{</span>
              <span class="s2">"name"</span> <span class="p">=</span> <span class="s2">"braket.ir.jaqcd.program"</span>
              <span class="s2">"version"</span> <span class="p">=</span> <span class="s2">"1.0"</span>
            <span class="p">}</span>
            <span class="s2">"instructions.$"</span> <span class="p">=</span> <span class="s2">"$.circuit.instructions"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.quantumTask"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"WaitForQuantumTask"</span>
      <span class="p">}</span>
      
      <span class="nx">WaitForQuantumTask</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Wait"</span>
        <span class="nx">Seconds</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"GetQuantumTaskStatus"</span>
      <span class="p">}</span>
      
      <span class="nx">GetQuantumTaskStatus</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:braket:getQuantumTask"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"QuantumTaskArn.$"</span> <span class="p">=</span> <span class="s2">"$.quantumTask.QuantumTaskArn"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"CheckTaskComplete"</span>
      <span class="p">}</span>
      
      <span class="nx">CheckTaskComplete</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Choice"</span>
        <span class="nx">Choices</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">Variable</span> <span class="o">=</span> <span class="s2">"$.Status"</span>
            <span class="nx">StringEquals</span> <span class="o">=</span> <span class="s2">"COMPLETED"</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"ProcessResults"</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">Variable</span> <span class="o">=</span> <span class="s2">"$.Status"</span>
            <span class="nx">StringEquals</span> <span class="o">=</span> <span class="s2">"FAILED"</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleFailure"</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Default</span> <span class="o">=</span> <span class="s2">"WaitForQuantumTask"</span>
      <span class="p">}</span>
      
      <span class="nx">ProcessResults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">quantum_hybrid</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"action"</span> <span class="p">=</span> <span class="s2">"process_results"</span>
          <span class="s2">"results.$"</span> <span class="p">=</span> <span class="s2">"$.OutputS3Uri"</span>
        <span class="p">}</span>
        <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      
      <span class="nx">HandleFailure</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Fail"</span>
        <span class="nx">Cause</span> <span class="o">=</span> <span class="s2">"Quantum task failed"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="machine-learning-ai-for-every-developer">Machine Learning: AI for Every Developer</h3>

<p>Machine learning used to require PhD-level expertise and massive infrastructure. AWS SageMaker democratizes ML, letting any developer build, train, and deploy models.</p>

<h4 id="the-ml-journey-simplified">The ML Journey Simplified</h4>

<ol>
  <li>
<strong>Data Preparation</strong>: Clean and organize your training data</li>
  <li>
<strong>Model Selection</strong>: Choose from pre-built models or create custom ones</li>
  <li>
<strong>Training</strong>: SageMaker handles the compute infrastructure</li>
  <li>
<strong>Deployment</strong>: One-click deployment with automatic scaling</li>
  <li>
<strong>Monitoring</strong>: Track model performance and retrain as needed</li>
</ol>

<p><strong>From Weeks to Hours</strong>: What traditionally took weeks of infrastructure setup now takes hours. SageMaker provides Jupyter notebooks for experimentation, distributed training for large datasets, and managed endpoints for serving predictions.</p>

<p><strong>Real-world example</strong>: An e-commerce company builds a recommendation engine:</p>
<ul>
  <li>Upload purchase history to S3</li>
  <li>Use SageMaker’s built-in recommendation algorithm</li>
  <li>Train on historical data (SageMaker provisions GPU instances automatically)</li>
  <li>Deploy model to an endpoint</li>
  <li>Call the endpoint from their app to get real-time recommendations</li>
</ul>

<p>Total time: 2 days instead of 2 months.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sagemaker.tf - SageMaker MLOps infrastructure</span>

<span class="c1"># SageMaker execution role</span>
<span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"sagemaker_execution"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-sagemaker-execution-role"</span>
  
  <span class="nx">assume_role_policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"sts:AssumeRole"</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"sagemaker.amazonaws.com"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
  
  <span class="nx">managed_policy_arns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Feature Store</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_feature_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">feature_group_name</span>             <span class="o">=</span> <span class="s2">"${var.environment}-feature-group"</span>
  <span class="nx">record_identifier_feature_name</span> <span class="o">=</span> <span class="s2">"record_id"</span>
  <span class="nx">event_time_feature_name</span>        <span class="o">=</span> <span class="s2">"event_time"</span>
  <span class="nx">role_arn</span>                       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"record_id"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"String"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"event_time"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"String"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"user_id"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"String"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"feature_1"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"Fractional"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"feature_2"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"Fractional"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"label"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"Integral"</span>
  <span class="p">}</span>
  
  <span class="nx">online_store_config</span> <span class="p">{</span>
    <span class="nx">enable_online_store</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">security_config</span> <span class="p">{</span>
      <span class="nx">kms_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sagemaker</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">offline_store_config</span> <span class="p">{</span>
    <span class="nx">s3_storage_config</span> <span class="p">{</span>
      <span class="nx">s3_uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.feature_store.id}/offline-store"</span>
      
      <span class="nx">kms_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}</span>
    
    <span class="nx">data_catalog_config</span> <span class="p">{</span>
      <span class="nx">database</span>   <span class="o">=</span> <span class="nx">aws_glue_catalog_database</span><span class="p">.</span><span class="nx">feature_store</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">table_name</span> <span class="o">=</span> <span class="s2">"${var.environment}_features"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Model registry</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_model_package_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">model_package_group_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-model-registry"</span>
  <span class="nx">model_package_group_description</span> <span class="o">=</span> <span class="s2">"Model registry for ML models"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># SageMaker model</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_model"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-model"</span>
  <span class="nx">execution_role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">primary_container</span> <span class="p">{</span>
    <span class="nx">image</span>          <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/ml-model:latest"</span>
    <span class="nx">model_data_url</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/model.tar.gz"</span>
    
    <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">SAGEMAKER_PROGRAM</span>           <span class="o">=</span> <span class="s2">"inference.py"</span>
      <span class="nx">SAGEMAKER_SUBMIT_DIRECTORY</span>  <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/code"</span>
      <span class="nx">SAGEMAKER_ENABLE_CLOUDWATCH_METRICS</span> <span class="o">=</span> <span class="s2">"true"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">vpc_config</span> <span class="p">{</span>
    <span class="nx">subnets</span>            <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">sagemaker</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Multi-model endpoint configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_endpoint_configuration"</span> <span class="s2">"multi_model"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-multi-model-config"</span>
  
  <span class="nx">production_variants</span> <span class="p">{</span>
    <span class="nx">variant_name</span>           <span class="o">=</span> <span class="s2">"AllTraffic"</span>
    <span class="nx">model_name</span>            <span class="o">=</span> <span class="nx">aws_sagemaker_model</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">initial_instance_count</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">instance_type</span>         <span class="o">=</span> <span class="s2">"ml.m5.xlarge"</span>
    <span class="nx">initial_variant_weight</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># Enable multi-model</span>
    <span class="nx">model_data_download_timeout_in_seconds</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="nx">container_startup_health_check_timeout_in_seconds</span> <span class="o">=</span> <span class="mi">600</span>
  <span class="err">}</span>
  
  <span class="nx">data_capture_config</span> <span class="p">{</span>
    <span class="nx">enable_capture</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">initial_sampling_percentage</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="nx">destination_s3_uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.model_data_capture.id}/"</span>
    
    <span class="nx">capture_options</span> <span class="p">{</span>
      <span class="nx">capture_mode</span> <span class="o">=</span> <span class="s2">"Input"</span>
    <span class="p">}</span>
    
    <span class="nx">capture_options</span> <span class="p">{</span>
      <span class="nx">capture_mode</span> <span class="o">=</span> <span class="s2">"Output"</span>
    <span class="p">}</span>
    
    <span class="nx">capture_content_type_header</span> <span class="p">{</span>
      <span class="nx">json_content_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application/json"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># SageMaker endpoint</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_endpoint"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                 <span class="o">=</span> <span class="s2">"${var.environment}-endpoint"</span>
  <span class="nx">endpoint_config_name</span> <span class="o">=</span> <span class="nx">aws_sagemaker_endpoint_configuration</span><span class="p">.</span><span class="nx">multi_model</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="nx">deployment_config</span> <span class="p">{</span>
    <span class="nx">blue_green_update_policy</span> <span class="p">{</span>
      <span class="nx">traffic_routing_configuration</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"LINEAR"</span>
        <span class="nx">wait_interval_in_seconds</span> <span class="o">=</span> <span class="mi">300</span>
        
        <span class="nx">linear_step_size</span> <span class="p">{</span>
          <span class="nx">type</span>  <span class="o">=</span> <span class="s2">"INSTANCE_COUNT"</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">maximum_execution_timeout_in_seconds</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="p">}</span>
    
    <span class="nx">auto_rollback_configuration</span> <span class="p">{</span>
      <span class="nx">alarms</span> <span class="p">{</span>
        <span class="nx">alarm_name</span> <span class="o">=</span> <span class="nx">aws_cloudwatch_metric_alarm</span><span class="p">.</span><span class="nx">endpoint_error_rate</span><span class="p">.</span><span class="nx">alarm_name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Auto-scaling for SageMaker endpoint</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_target"</span> <span class="s2">"sagemaker_target"</span> <span class="p">{</span>
  <span class="nx">max_capacity</span>       <span class="o">=</span> <span class="mi">10</span>
  <span class="nx">min_capacity</span>       <span class="o">=</span> <span class="mi">2</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="s2">"endpoint/${aws_sagemaker_endpoint.main.name}/variant/AllTraffic"</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="s2">"sagemaker:variant:DesiredInstanceCount"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="s2">"sagemaker"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"sagemaker_target_tracking"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-sagemaker-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sagemaker_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sagemaker_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sagemaker_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"SageMakerVariantInvocationsPerInstance"</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span> <span class="o">=</span> <span class="mf">70.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">300</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># SageMaker Pipeline</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_pipeline"</span> <span class="s2">"ml_pipeline"</span> <span class="p">{</span>
  <span class="nx">pipeline_name</span>         <span class="o">=</span> <span class="s2">"${var.environment}-ml-pipeline"</span>
  <span class="nx">pipeline_display_name</span> <span class="o">=</span> <span class="s2">"ML Training Pipeline"</span>
  <span class="nx">role_arn</span>             <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">pipeline_definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2020-12-01"</span>
    <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"ProcessingInstanceCount"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Integer"</span>
        <span class="nx">DefaultValue</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"TrainingInstanceType"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"String"</span>
        <span class="nx">DefaultValue</span> <span class="o">=</span> <span class="s2">"ml.m5.xlarge"</span>
      <span class="p">}</span>
    <span class="p">]</span>
    <span class="nx">Steps</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"DataProcessing"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Processing"</span>
        <span class="nx">Arguments</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">ProcessingResources</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">ClusterConfig</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">InstanceCount</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Parameters.ProcessingInstanceCount"</span> <span class="p">}</span>
              <span class="nx">InstanceType</span> <span class="o">=</span> <span class="s2">"ml.m5.xlarge"</span>
              <span class="nx">VolumeSizeInGB</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">AppSpecification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">ImageUri</span> <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/processing:latest"</span>
          <span class="p">}</span>
          <span class="nx">RoleArn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">ProcessingInputs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">InputName</span> <span class="o">=</span> <span class="s2">"input-data"</span>
              <span class="nx">S3Input</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">S3Uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.training_data.id}/raw/"</span>
                <span class="nx">LocalPath</span> <span class="o">=</span> <span class="s2">"/opt/ml/processing/input"</span>
                <span class="nx">S3DataType</span> <span class="o">=</span> <span class="s2">"S3Prefix"</span>
                <span class="nx">S3InputMode</span> <span class="o">=</span> <span class="s2">"File"</span>
                <span class="nx">S3DataDistributionType</span> <span class="o">=</span> <span class="s2">"FullyReplicated"</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">]</span>
          <span class="nx">ProcessingOutputConfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">Outputs</span> <span class="o">=</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="nx">OutputName</span> <span class="o">=</span> <span class="s2">"processed-data"</span>
                <span class="nx">S3Output</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">S3Uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.training_data.id}/processed/"</span>
                  <span class="nx">LocalPath</span> <span class="o">=</span> <span class="s2">"/opt/ml/processing/output"</span>
                  <span class="nx">S3UploadMode</span> <span class="o">=</span> <span class="s2">"EndOfJob"</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"ModelTraining"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Training"</span>
        <span class="nx">Arguments</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">AlgorithmSpecification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">TrainingImage</span> <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/training:latest"</span>
            <span class="nx">TrainingInputMode</span> <span class="o">=</span> <span class="s2">"File"</span>
            <span class="nx">EnableSageMakerMetricsTimeSeries</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="p">}</span>
          <span class="nx">RoleArn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">OutputDataConfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">S3OutputPath</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/"</span>
            <span class="nx">KmsKeyId</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">id</span>
          <span class="p">}</span>
          <span class="nx">ResourceConfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">InstanceCount</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nx">InstanceType</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Parameters.TrainingInstanceType"</span> <span class="p">}</span>
            <span class="nx">VolumeSizeInGB</span> <span class="o">=</span> <span class="mi">30</span>
          <span class="p">}</span>
          <span class="nx">StoppingCondition</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">MaxRuntimeInSeconds</span> <span class="o">=</span> <span class="mi">86400</span>
          <span class="p">}</span>
          <span class="nx">HyperParameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">epochs</span> <span class="o">=</span> <span class="s2">"10"</span>
            <span class="nx">batch_size</span> <span class="o">=</span> <span class="s2">"32"</span>
            <span class="nx">learning_rate</span> <span class="o">=</span> <span class="s2">"0.001"</span>
          <span class="p">}</span>
          <span class="nx">InputDataConfig</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">ChannelName</span> <span class="o">=</span> <span class="s2">"training"</span>
              <span class="nx">DataSource</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">S3DataSource</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">S3DataType</span> <span class="o">=</span> <span class="s2">"S3Prefix"</span>
                  <span class="nx">S3Uri</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Steps.DataProcessing.ProcessingOutputConfig.Outputs[0].S3Output.S3Uri"</span> <span class="p">}</span>
                  <span class="nx">S3DataDistributionType</span> <span class="o">=</span> <span class="s2">"FullyReplicated"</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="nx">ContentType</span> <span class="o">=</span> <span class="s2">"application/x-parquet"</span>
              <span class="nx">CompressionType</span> <span class="o">=</span> <span class="s2">"None"</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">DependsOn</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"DataProcessing"</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"RegisterModel"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"RegisterModel"</span>
        <span class="nx">Arguments</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">ModelPackageGroupName</span> <span class="o">=</span> <span class="nx">aws_sagemaker_model_package_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">model_package_group_name</span>
          <span class="nx">ModelMetrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">ModelQuality</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">Statistics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">ContentType</span> <span class="o">=</span> <span class="s2">"application/json"</span>
                <span class="nx">S3Uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/evaluation/statistics.json"</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">InferenceSpecification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">Containers</span> <span class="o">=</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="nx">Image</span> <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/inference:latest"</span>
                <span class="nx">ModelDataUrl</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Steps.ModelTraining.ModelArtifacts.S3ModelArtifacts"</span> <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">]</span>
            <span class="nx">SupportedContentTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application/json"</span><span class="p">]</span>
            <span class="nx">SupportedResponseMIMETypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application/json"</span><span class="p">]</span>
          <span class="p">}</span>
          <span class="nx">ModelApprovalStatus</span> <span class="o">=</span> <span class="s2">"PendingManualApproval"</span>
        <span class="p">}</span>
        <span class="nx">DependsOn</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ModelTraining"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudWatch monitoring for ML endpoints</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"endpoint_error_rate"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-endpoint-error-rate"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"ModelInvocation4XXErrors"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/SageMaker"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"0.05"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors endpoint error rate"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">ml_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">EndpointName</span> <span class="o">=</span> <span class="nx">aws_sagemaker_endpoint</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">VariantName</span>  <span class="o">=</span> <span class="s2">"AllTraffic"</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Model monitoring schedule</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_monitoring_schedule"</span> <span class="s2">"model_quality"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-model-quality-monitor"</span>
  
  <span class="nx">monitoring_schedule_config</span> <span class="p">{</span>
    <span class="nx">monitoring_job_definition_name</span> <span class="o">=</span> <span class="nx">aws_sagemaker_data_quality_job_definition</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">monitoring_type</span>                <span class="o">=</span> <span class="s2">"DataQuality"</span>
    
    <span class="nx">schedule_config</span> <span class="p">{</span>
      <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"cron(0 * ? * * *)"</span>  <span class="c1"># Every hour</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="infrastructure-as-code-never-click-again">Infrastructure as Code: Never Click Again</h2>

<p>The biggest shift in cloud operations? Treating infrastructure like software. Instead of clicking through the AWS console, you define infrastructure in code. This enables version control, peer review, and automated deployments.</p>

<h3 id="why-infrastructure-as-code-changes-everything">Why Infrastructure as Code Changes Everything</h3>

<p><strong>The Old Way</strong>:</p>
<ul>
  <li>Click through AWS console to create resources</li>
  <li>Document steps in a wiki (that nobody updates)</li>
  <li>Hope you can recreate it in another region</li>
  <li>Fear making changes that might break production</li>
</ul>

<p><strong>The IaC Way</strong>:</p>
<ul>
  <li>Define infrastructure in configuration files</li>
  <li>Version control shows exactly what changed and when</li>
  <li>Deploy identical environments with one command</li>
  <li>Test changes in staging before production</li>
</ul>

<h3 id="choosing-your-iac-tool">Choosing Your IaC Tool</h3>

<h4 id="cloudformation-aws-native">CloudFormation (AWS Native)</h4>
<ul>
  <li>
<strong>Pros</strong>: Deep AWS integration, no extra tools needed</li>
  <li>
<strong>Cons</strong>: Verbose syntax, AWS-only</li>
  <li>
<strong>Best for</strong>: Teams fully committed to AWS</li>
</ul>

<h4 id="terraform-multi-cloud">Terraform (Multi-Cloud)</h4>
<ul>
  <li>
<strong>Pros</strong>: Works across cloud providers, huge community</li>
  <li>
<strong>Cons</strong>: Requires learning HCL syntax</li>
  <li>
<strong>Best for</strong>: Multi-cloud strategies or teams wanting flexibility</li>
</ul>

<h4 id="aws-cdk-developer-friendly">AWS CDK (Developer-Friendly)</h4>
<ul>
  <li>
<strong>Pros</strong>: Use familiar programming languages (Python, TypeScript)</li>
  <li>
<strong>Cons</strong>: Newer tool, smaller community</li>
  <li>
<strong>Best for</strong>: Development teams wanting to use existing skills</li>
</ul>

<h3 id="real-world-iac-evolution">Real-World IaC Evolution</h3>

<p>A startup’s infrastructure journey:</p>

<ol>
  <li>
<strong>Month 1</strong>: Everything created via console clicks</li>
  <li>
<strong>Month 3</strong>: Production breaks, nobody remembers how to rebuild</li>
  <li>
<strong>Month 4</strong>: Team adopts Terraform, documents existing infrastructure</li>
  <li>
<strong>Month 6</strong>: All changes go through pull requests</li>
  <li>
<strong>Year 1</strong>: Disaster recovery test - entire production rebuilt in 30 minutes</li>
</ol>

<h3 id="advanced-patterns-that-save-your-sanity">Advanced Patterns That Save Your Sanity</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">from</span> <span class="nx">aws_cdk</span> <span class="nx">import</span> <span class="err">(</span>
    <span class="nx">core</span> <span class="nx">as</span> <span class="nx">cdk</span><span class="err">,</span>
    <span class="nx">aws_ec2</span> <span class="nx">as</span> <span class="nx">ec2</span><span class="err">,</span>
    <span class="nx">aws_ecs</span> <span class="nx">as</span> <span class="nx">ecs</span><span class="err">,</span>
    <span class="nx">aws_ecs_patterns</span> <span class="nx">as</span> <span class="nx">ecs_patterns</span><span class="err">,</span>
    <span class="nx">aws_elasticloadbalancingv2</span> <span class="nx">as</span> <span class="nx">elbv2</span><span class="err">,</span>
    <span class="nx">aws_rds</span> <span class="nx">as</span> <span class="nx">rds</span><span class="err">,</span>
    <span class="nx">aws_secretsmanager</span> <span class="nx">as</span> <span class="nx">sm</span><span class="err">,</span>
    <span class="nx">aws_cloudwatch</span> <span class="nx">as</span> <span class="nx">cloudwatch</span><span class="err">,</span>
    <span class="nx">aws_cloudwatch_actions</span> <span class="nx">as</span> <span class="nx">cw_actions</span><span class="err">,</span>
    <span class="nx">aws_sns</span> <span class="nx">as</span> <span class="nx">sns</span><span class="err">,</span>
    <span class="nx">aws_lambda</span> <span class="nx">as</span> <span class="nx">lambda_</span><span class="err">,</span>
    <span class="nx">aws_apigateway</span> <span class="nx">as</span> <span class="nx">apigw</span><span class="err">,</span>
    <span class="nx">custom_resources</span> <span class="nx">as</span> <span class="nx">cr</span>
<span class="err">)</span>
<span class="nx">from</span> <span class="nx">constructs</span> <span class="nx">import</span> <span class="nx">Construct</span>
<span class="nx">import</span> <span class="nx">json</span>

<span class="nx">class</span> <span class="nx">MicroservicesStack</span><span class="err">(</span><span class="nx">cdk</span><span class="err">.</span><span class="nx">Stack</span><span class="err">)</span><span class="o">:</span>
    <span class="nx">def</span> <span class="nx">__init__</span><span class="err">(</span><span class="nx">self</span><span class="err">,</span> <span class="nx">scope</span><span class="o">:</span> <span class="nx">Construct</span><span class="err">,</span> <span class="nx">construct_id</span><span class="o">:</span> <span class="nx">str</span><span class="err">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="err">)</span> <span class="o">-&gt;</span> <span class="nx">None</span><span class="o">:</span>
        <span class="nx">super</span><span class="err">().</span><span class="nx">__init__</span><span class="err">(</span><span class="nx">scope</span><span class="err">,</span> <span class="nx">construct_id</span><span class="err">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="err">)</span>
        
        <span class="c1"># Create VPC with custom configuration</span>
        <span class="nx">vpc</span> <span class="o">=</span> <span class="nx">ec2</span><span class="err">.</span><span class="nx">Vpc</span><span class="err">(</span>
            <span class="nx">self</span><span class="err">,</span> <span class="s2">"MicroservicesVPC"</span><span class="err">,</span>
            <span class="nx">max_azs</span><span class="o">=</span><span class="mi">3</span><span class="err">,</span>
            <span class="nx">nat_gateways</span><span class="o">=</span><span class="mi">2</span><span class="err">,</span>
            <span class="nx">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
                <span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetConfiguration</span><span class="p">(</span>
                    <span class="nx">name</span><span class="o">=</span><span class="s2">"Public"</span><span class="p">,</span>
                    <span class="nx">subnet_type</span><span class="o">=</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetType</span><span class="p">.</span><span class="nx">PUBLIC</span><span class="p">,</span>
                    <span class="nx">cidr_mask</span><span class="o">=</span><span class="mi">24</span>
                <span class="p">),</span>
                <span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetConfiguration</span><span class="p">(</span>
                    <span class="nx">name</span><span class="o">=</span><span class="s2">"Private"</span><span class="p">,</span>
                    <span class="nx">subnet_type</span><span class="o">=</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetType</span><span class="p">.</span><span class="nx">PRIVATE</span><span class="p">,</span>
                    <span class="nx">cidr_mask</span><span class="o">=</span><span class="mi">24</span>
                <span class="p">),</span>
                <span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetConfiguration</span><span class="p">(</span>
                    <span class="nx">name</span><span class="o">=</span><span class="s2">"Isolated"</span><span class="p">,</span>
                    <span class="nx">subnet_type</span><span class="o">=</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetType</span><span class="p">.</span><span class="nx">ISOLATED</span><span class="p">,</span>
                    <span class="nx">cidr_mask</span><span class="o">=</span><span class="mi">24</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="err">)</span>
        
        <span class="c1"># Create ECS Cluster with capacity providers</span>
        <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">ecs</span><span class="err">.</span><span class="nx">Cluster</span><span class="err">(</span>
            <span class="nx">self</span><span class="err">,</span> <span class="s2">"Cluster"</span><span class="err">,</span>
            <span class="nx">vpc</span><span class="o">=</span><span class="nx">vpc</span><span class="err">,</span>
            <span class="nx">container_insights</span><span class="o">=</span><span class="nx">True</span>
        <span class="err">)</span>
        
        <span class="c1"># Add Fargate Spot capacity provider</span>
        <span class="nx">cluster</span><span class="err">.</span><span class="nx">add_capacity_provider</span><span class="err">(</span>
            <span class="nx">ecs</span><span class="err">.</span><span class="nx">FargateCapacityProvider</span><span class="err">(</span>
                <span class="nx">self</span><span class="err">,</span> <span class="s2">"FargateSpotProvider"</span><span class="err">,</span>
                <span class="nx">spot</span><span class="o">=</span><span class="nx">True</span>
            <span class="err">)</span>
        <span class="err">)</span>
        
        <span class="c1"># Create RDS Aurora Serverless v2</span>
        <span class="nx">db_secret</span> <span class="o">=</span> <span class="nx">sm</span><span class="err">.</span><span class="nx">Secret</span><span class="err">(</span>
            <span class="nx">self</span><span class="err">,</span> <span class="s2">"DBSecret"</span><span class="err">,</span>
            <span class="nx">generate_secret_string</span><span class="o">=</span><span class="nx">sm</span><span class="err">.</span><span class="nx">SecretStringGenerator</span><span class="err">(</span>
                <span class="nx">secret_string_template</span><span class="o">=</span><span class="nx">json</span><span class="err">.</span><span class="nx">dumps</span><span class="err">(</span><span class="p">{</span><span class="s2">"username"</span><span class="o">:</span> <span class="s2">"admin"</span><span class="p">}</span><span class="err">),</span>
                <span class="nx">generate_string_key</span><span class="o">=</span><span class="s2">"password"</span><span class="err">,</span>
                <span class="nx">exclude_characters</span><span class="o">=</span><span class="s2">" %+~`#$&amp;*()|[]{}:;&lt;&gt;?!'/</span><span class="err">\</span><span class="se">\"</span><span class="s2">
            )
        )
        
        db_cluster = rds.DatabaseCluster(
            self, "</span><span class="nx">AuroraCluster</span><span class="s2">",
            engine=rds.DatabaseClusterEngine.aurora_mysql(
                version=rds.AuroraMysqlEngineVersion.VER_3_01_0
            ),
            serverless_v2_scaling_configuration=rds.ServerlessV2ScalingConfiguration(
                min_capacity=0.5,
                max_capacity=2
            ),
            credentials=rds.Credentials.from_secret(db_secret),
            vpc=vpc,
            vpc_subnets=ec2.SubnetSelection(
                subnet_type=ec2.SubnetType.ISOLATED
            ),
            backup=rds.BackupProps(
                retention=cdk.Duration.days(7)
            ),
            deletion_protection=True
        )
        
        # Create shared ALB
        alb = elbv2.ApplicationLoadBalancer(
            self, "</span><span class="nx">ALB</span><span class="s2">",
            vpc=vpc,
            internet_facing=True,
            http2_enabled=True
        )
        
        # Add CloudWatch alarms
        alarm = cloudwatch.Alarm(
            self, "</span><span class="nx">HighErrorRate</span><span class="s2">",
            metric=alb.metric_target_response_time(),
            threshold=1000,
            evaluation_periods=2
        )
        
        # SNS topic for alarms
        alarm_topic = sns.Topic(
            self, "</span><span class="nx">AlarmTopic</span><span class="s2">",
            display_name="</span><span class="nx">Microservices</span> <span class="nx">Alarms</span><span class="s2">"
        )
        
        alarm.add_alarm_action(cw_actions.SnsAction(alarm_topic))
        
        # Deploy microservices
        self.deploy_microservice(
            cluster=cluster,
            alb=alb,
            service_name="</span><span class="nx">users</span><span class="s2">",
            image="</span><span class="nx">users-service</span><span class="o">:</span><span class="nx">latest</span><span class="s2">",
            port=8080,
            priority=1,
            path_pattern="</span><span class="o">/</span><span class="nx">users</span><span class="cm">/*",
            environment={
                "DB_SECRET_ARN": db_secret.secret_arn,
                "DB_CLUSTER_ARN": db_cluster.cluster_arn
            }
        )
        
        self.deploy_microservice(
            cluster=cluster,
            alb=alb,
            service_name="orders",
            image="orders-service:latest",
            port=8081,
            priority=2,
            path_pattern="/orders/*",
            environment={
                "DB_SECRET_ARN": db_secret.secret_arn,
                "DB_CLUSTER_ARN": db_cluster.cluster_arn
            }
        )
        
        # Create API Gateway for serverless endpoints
        api = apigw.RestApi(
            self, "MicroservicesAPI",
            deploy_options=apigw.StageOptions(
                logging_level=apigw.MethodLoggingLevel.INFO,
                data_trace_enabled=True,
                tracing_enabled=True
            )
        )
        
        # Lambda function for async processing
        async_processor = lambda_.Function(
            self, "AsyncProcessor",
            runtime=lambda_.Runtime.PYTHON_3_9,
            handler="index.handler",
            code=lambda_.Code.from_asset("lambda"),
            vpc=vpc,
            environment={
                "DB_SECRET_ARN": db_secret.secret_arn
            },
            reserved_concurrent_executions=100,
            tracing=lambda_.Tracing.ACTIVE
        )
        
        # Grant permissions
        db_secret.grant_read(async_processor)
        db_cluster.grant_connect(async_processor)
        
        # Custom resource for database initialization
        db_init = cr.AwsCustomResource(
            self, "DBInit",
            on_create=cr.AwsSdkCall(
                service="RDS",
                action="executeStatement",
                parameters={
                    "resourceArn": db_cluster.cluster_arn,
                    "secretArn": db_secret.secret_arn,
                    "database": "mysql",
                    "sql": "CREATE DATABASE IF NOT EXISTS microservices;"
                },
                physical_resource_id=cr.PhysicalResourceId.of("DBInit")
            ),
            policy=cr.AwsCustomResourcePolicy.from_sdk_calls(
                resources=[db_cluster.cluster_arn]
            )
        )
        
        # Output values
        cdk.CfnOutput(
            self, "ALBDNSName",
            value=alb.load_balancer_dns_name,
            description="ALB DNS Name"
        )
        
        cdk.CfnOutput(
            self, "APIEndpoint",
            value=api.url,
            description="API Gateway Endpoint"
        )
    
    def deploy_microservice(self,
                           cluster: ecs.Cluster,
                           alb: elbv2.ApplicationLoadBalancer,
                           service_name: str,
                           image: str,
                           port: int,
                           priority: int,
                           path_pattern: str,
                           environment: dict):
        """Deploy a microservice to ECS"""
        
        # Create task definition
        task_definition = ecs.FargateTaskDefinition(
            self, f"{service_name}TaskDef",
            memory_limit_mib=512,
            cpu=256
        )
        
        # Add container
        container = task_definition.add_container(
            f"{service_name}Container",
            image=ecs.ContainerImage.from_registry(image),
            logging=ecs.LogDrivers.aws_logs(
                stream_prefix=service_name
            ),
            environment=environment,
            health_check=ecs.HealthCheck(
                command=["CMD-SHELL", f"curl -f http://localhost:{port}/health || exit 1"],
                interval=cdk.Duration.seconds(30),
                timeout=cdk.Duration.seconds(5),
                retries=3
            )
        )
        
        container.add_port_mappings(
            ecs.PortMapping(
                container_port=port,
                protocol=ecs.Protocol.TCP
            )
        )
        
        # Create service
        service = ecs.FargateService(
            self, f"{service_name}Service",
            cluster=cluster,
            task_definition=task_definition,
            desired_count=2,
            capacity_provider_strategies=[
                ecs.CapacityProviderStrategy(
                    capacity_provider="FARGATE_SPOT",
                    weight=2
                ),
                ecs.CapacityProviderStrategy(
                    capacity_provider="FARGATE",
                    weight=1
                )
            ],
            circuit_breaker=ecs.DeploymentCircuitBreaker(
                rollback=True
            )
        )
        
        # Configure auto-scaling
        scaling = service.auto_scale_task_count(
            min_capacity=2,
            max_capacity=10
        )
        
        scaling.scale_on_cpu_utilization(
            "CpuScaling",
            target_utilization_percent=70,
            scale_in_cooldown=cdk.Duration.seconds(60),
            scale_out_cooldown=cdk.Duration.seconds(60)
        )
        
        scaling.scale_on_request_count(
            "RequestScaling",
            requests_per_target=1000,
            target_group=alb.add_targets(
                f"{service_name}TG",
                port=port,
                targets=[service],
                health_check=elbv2.HealthCheck(
                    path=f"/{service_name}/health",
                    interval=cdk.Duration.seconds(30)
                )
            )
        )
        
        # Add ALB listener rule
        alb.add_listener(
            f"{service_name}Listener",
            port=80
        ).add_targets(
            f"{service_name}Targets",
            port=port,
            targets=[service],
            priority=priority,
            conditions=[
                elbv2.ListenerCondition.path_patterns([path_pattern])
            ]
        )
</span></code></pre></div></div>

<h2 id="your-cloud-journey-from-here-to-mastery">Your Cloud Journey: From Here to Mastery</h2>

<p>You’ve learned the core concepts, explored architecture patterns, and understand optimization strategies. Where do you go from here?</p>

<h3 id="the-path-forward">The Path Forward</h3>

<h4 id="next-30-days-build-your-foundation">Next 30 Days: Build Your Foundation</h4>
<ol>
  <li>
<strong>Get Hands-On</strong>: Launch your first EC2 instance, create an S3 bucket, set up a simple website</li>
  <li>
<strong>Break Things</strong>: Experiment in a sandbox account - failure is the best teacher</li>
  <li>
<strong>Automate One Thing</strong>: Convert a manual process to Lambda or use CloudFormation</li>
  <li>
<strong>Monitor Costs</strong>: Set up billing alerts and understand your first bill</li>
</ol>

<h4 id="next-90-days-develop-expertise">Next 90 Days: Develop Expertise</h4>
<ol>
  <li>
<strong>Build a Real Project</strong>: Create something you’ll actually use</li>
  <li>
<strong>Master One Service Deeply</strong>: Whether it’s Lambda, DynamoDB, or ECS</li>
  <li>
<strong>Practice Troubleshooting</strong>: Learn to read CloudWatch logs and traces</li>
  <li>
<strong>Join the Community</strong>: AWS user groups, re:Invent videos, forums</li>
</ol>

<h4 id="next-year-achieve-mastery">Next Year: Achieve Mastery</h4>
<ol>
  <li>
<strong>Design for Scale</strong>: Build systems that can grow 100x</li>
  <li>
<strong>Optimize Everything</strong>: Cost, performance, security, operations</li>
  <li>
<strong>Share Knowledge</strong>: Blog, speak, mentor others</li>
  <li>
<strong>Stay Current</strong>: AWS releases new features daily - follow what matters to you</li>
</ol>

<h3 id="emerging-trends-to-watch">Emerging Trends to Watch</h3>

<p><strong>Serverless Everything</strong>: The trend toward managed services accelerates. Focus on business logic, not infrastructure.</p>

<p><strong>AI-Powered Operations</strong>: From cost optimization to security, AI will automate routine cloud management tasks.</p>

<p><strong>Edge Computing</strong>: Processing moves closer to users. 5G and IoT drive computing to the edge.</p>

<p><strong>Sustainability Focus</strong>: Carbon-aware computing becomes standard. Green architectures will be the default.</p>

<h3 id="remember-cloud-is-a-journey-not-a-destination">Remember: Cloud is a Journey, Not a Destination</h3>

<p>AWS evolves constantly. The services you master today will have new features tomorrow. The architectures you build will need to adapt. That’s not a bug - it’s the feature that makes cloud computing exciting.</p>

<p>Start small, think big, and build amazing things. The cloud is your platform for innovation. What will you create?</p>


        
      </section>

      <footer class="page__meta">
        
        


        


      </footer>

      

      
    </div>

    
  </article>

  
  
</div>
        
      </section>

      <footer class="page__meta">
        
        


        


      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/Documentation/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">© 2025 Andrews Notebook. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/Documentation/assets/js/main.min.js"></script>










  </body>
</html>
