{% comment %}
  Topic Map Visualization Component
  Interactive visualization showing relationships between topics
  
  Usage: {% include topic-map.html topics=site.data.topic_map %}
  
  Parameters:
  - topics: Array of topics with relationships
  - current_topic: Current topic ID to highlight
{% endcomment %}

<div class="topic-map-container">
  <div class="topic-map-header">
    <h3>Knowledge Map</h3>
    <div class="map-controls">
      <button class="control-btn" onclick="resetMapView()">Reset View</button>
      <button class="control-btn" onclick="toggleFullscreen()">Fullscreen</button>
      <div class="difficulty-filter">
        <label>Filter by level:</label>
        <select onchange="filterByDifficulty(this.value)">
          <option value="all">All Levels</option>
          <option value="beginner">Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>
      </div>
    </div>
  </div>
  
  <div class="topic-map-canvas" id="topic-map-canvas">
    <svg id="topic-map-svg" width="100%" height="600">
      <!-- SVG content will be generated by JavaScript -->
    </svg>
    
    <div class="map-legend">
      <h4>Legend</h4>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-color beginner"></span>
          <span class="legend-label">Beginner</span>
        </div>
        <div class="legend-item">
          <span class="legend-color intermediate"></span>
          <span class="legend-label">Intermediate</span>
        </div>
        <div class="legend-item">
          <span class="legend-color advanced"></span>
          <span class="legend-label">Advanced</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="topic-details-panel" id="topic-details-panel" style="display: none;">
    <button class="close-details" onclick="closeTopicDetails()">×</button>
    <h3 id="topic-title">Topic Title</h3>
    <div class="topic-metadata">
      <span class="difficulty-badge" id="topic-difficulty">Intermediate</span>
      <span class="time-estimate" id="topic-time">~30 min</span>
    </div>
    <p id="topic-description">Topic description goes here...</p>
    
    <div class="topic-links">
      <h4>Related Topics</h4>
      <ul id="related-topics-list"></ul>
    </div>
    
    <div class="topic-actions">
      <a href="#" class="action-link" id="topic-link">Go to Topic →</a>
    </div>
  </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Topic map data structure
const topicMapData = {
  nodes: [
    // Technology topics
    { id: "git-basics", label: "Git Basics", difficulty: "beginner", category: "technology", x: 100, y: 200 },
    { id: "git-branching", label: "Git Branching", difficulty: "intermediate", category: "technology", x: 250, y: 200 },
    { id: "git-internals", label: "Git Internals", difficulty: "advanced", category: "technology", x: 400, y: 200 },
    
    { id: "docker-intro", label: "Docker Introduction", difficulty: "beginner", category: "technology", x: 100, y: 350 },
    { id: "docker-compose", label: "Docker Compose", difficulty: "intermediate", category: "technology", x: 250, y: 350 },
    { id: "docker-advanced", label: "Docker Advanced", difficulty: "advanced", category: "technology", x: 400, y: 350 },
    
    { id: "ai-fundamentals", label: "AI Fundamentals", difficulty: "beginner", category: "ai", x: 550, y: 100 },
    { id: "machine-learning", label: "Machine Learning", difficulty: "intermediate", category: "ai", x: 700, y: 100 },
    { id: "deep-learning", label: "Deep Learning", difficulty: "advanced", category: "ai", x: 850, y: 100 },
    
    { id: "database-basics", label: "Database Basics", difficulty: "beginner", category: "technology", x: 100, y: 500 },
    { id: "sql-advanced", label: "Advanced SQL", difficulty: "intermediate", category: "technology", x: 250, y: 500 },
    { id: "database-design", label: "Database Design", difficulty: "advanced", category: "technology", x: 400, y: 500 },
    
    // Physics topics
    { id: "classical-mechanics", label: "Classical Mechanics", difficulty: "beginner", category: "physics", x: 550, y: 300 },
    { id: "quantum-mechanics", label: "Quantum Mechanics", difficulty: "intermediate", category: "physics", x: 700, y: 300 },
    { id: "quantum-field-theory", label: "Quantum Field Theory", difficulty: "advanced", category: "physics", x: 850, y: 300 },
    
    { id: "thermodynamics", label: "Thermodynamics", difficulty: "intermediate", category: "physics", x: 550, y: 450 },
    { id: "statistical-mechanics", label: "Statistical Mechanics", difficulty: "advanced", category: "physics", x: 700, y: 450 }
  ],
  
  links: [
    // Git progression
    { source: "git-basics", target: "git-branching", type: "progression" },
    { source: "git-branching", target: "git-internals", type: "progression" },
    
    // Docker progression
    { source: "docker-intro", target: "docker-compose", type: "progression" },
    { source: "docker-compose", target: "docker-advanced", type: "progression" },
    
    // AI progression
    { source: "ai-fundamentals", target: "machine-learning", type: "progression" },
    { source: "machine-learning", target: "deep-learning", type: "progression" },
    
    // Database progression
    { source: "database-basics", target: "sql-advanced", type: "progression" },
    { source: "sql-advanced", target: "database-design", type: "progression" },
    
    // Physics progression
    { source: "classical-mechanics", target: "quantum-mechanics", type: "progression" },
    { source: "quantum-mechanics", target: "quantum-field-theory", type: "progression" },
    { source: "thermodynamics", target: "statistical-mechanics", type: "progression" },
    
    // Cross-topic relationships
    { source: "docker-advanced", target: "database-design", type: "related" },
    { source: "machine-learning", target: "statistical-mechanics", type: "related" },
    { source: "deep-learning", target: "quantum-mechanics", type: "related" }
  ]
};

// Initialize the topic map
let svg, simulation, link, node, zoom;

function initializeTopicMap() {
  const width = document.getElementById('topic-map-canvas').offsetWidth;
  const height = 600;
  
  // Create SVG
  svg = d3.select("#topic-map-svg")
    .attr("width", width)
    .attr("height", height);
  
  // Create zoom behavior
  zoom = d3.zoom()
    .scaleExtent([0.5, 3])
    .on("zoom", (event) => {
      svg.select(".map-content").attr("transform", event.transform);
    });
  
  svg.call(zoom);
  
  // Create container for map content
  const g = svg.append("g").attr("class", "map-content");
  
  // Create arrow markers for links
  svg.append("defs").selectAll("marker")
    .data(["progression", "related"])
    .enter().append("marker")
    .attr("id", d => `arrow-${d}`)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 25)
    .attr("refY", 0)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
    .append("path")
    .attr("d", "M0,-5L10,0L0,5")
    .attr("fill", d => d === "progression" ? "#0066cc" : "#999");
  
  // Create force simulation
  simulation = d3.forceSimulation(topicMapData.nodes)
    .force("link", d3.forceLink(topicMapData.links).id(d => d.id).distance(150))
    .force("charge", d3.forceManyBody().strength(-300))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("collision", d3.forceCollide().radius(40));
  
  // Create links
  link = g.append("g")
    .attr("class", "links")
    .selectAll("line")
    .data(topicMapData.links)
    .enter().append("line")
    .attr("class", d => `link ${d.type}`)
    .attr("marker-end", d => `url(#arrow-${d.type})`);
  
  // Create nodes
  node = g.append("g")
    .attr("class", "nodes")
    .selectAll("g")
    .data(topicMapData.nodes)
    .enter().append("g")
    .attr("class", "node")
    .call(drag(simulation));
  
  // Add circles to nodes
  node.append("circle")
    .attr("r", 30)
    .attr("class", d => `node-circle ${d.difficulty}`)
    .on("click", showTopicDetails);
  
  // Add labels to nodes
  node.append("text")
    .text(d => d.label)
    .attr("text-anchor", "middle")
    .attr("dy", ".35em")
    .attr("class", "node-label")
    .style("pointer-events", "none");
  
  // Add difficulty indicators
  node.append("text")
    .text(d => d.difficulty.charAt(0).toUpperCase())
    .attr("x", 20)
    .attr("y", -20)
    .attr("class", "difficulty-indicator")
    .style("pointer-events", "none");
  
  // Update positions on tick
  simulation.on("tick", () => {
    link
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);
    
    node.attr("transform", d => `translate(${d.x},${d.y})`);
  });
  
  // Highlight current topic if specified
  const currentTopic = "{{ include.current_topic }}";
  if (currentTopic) {
    highlightTopic(currentTopic);
  }
}

// Drag behavior
function drag(simulation) {
  function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }
  
  function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
  }
  
  function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
  
  return d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended);
}

// Show topic details
function showTopicDetails(event, d) {
  const panel = document.getElementById('topic-details-panel');
  
  // Update panel content
  document.getElementById('topic-title').textContent = d.label;
  document.getElementById('topic-difficulty').textContent = d.difficulty;
  document.getElementById('topic-difficulty').className = `difficulty-badge ${d.difficulty}`;
  document.getElementById('topic-time').textContent = getTimeEstimate(d.difficulty);
  document.getElementById('topic-description').textContent = getTopicDescription(d);
  document.getElementById('topic-link').href = getTopicUrl(d);
  
  // Update related topics
  updateRelatedTopics(d);
  
  // Show panel
  panel.style.display = 'block';
  
  // Highlight connected nodes
  highlightConnections(d);
}

// Close topic details
function closeTopicDetails() {
  document.getElementById('topic-details-panel').style.display = 'none';
  resetHighlights();
}

// Highlight topic and its connections
function highlightConnections(selectedNode) {
  // Fade out all nodes and links
  node.style("opacity", 0.3);
  link.style("opacity", 0.1);
  
  // Find connected nodes
  const connectedNodes = new Set([selectedNode.id]);
  topicMapData.links.forEach(l => {
    if (l.source.id === selectedNode.id) connectedNodes.add(l.target.id);
    if (l.target.id === selectedNode.id) connectedNodes.add(l.source.id);
  });
  
  // Highlight connected nodes
  node.style("opacity", d => connectedNodes.has(d.id) ? 1 : 0.3);
  
  // Highlight connected links
  link.style("opacity", d => 
    (d.source.id === selectedNode.id || d.target.id === selectedNode.id) ? 1 : 0.1
  );
}

// Reset highlights
function resetHighlights() {
  node.style("opacity", 1);
  link.style("opacity", 1);
}

// Filter by difficulty
function filterByDifficulty(difficulty) {
  if (difficulty === 'all') {
    node.style("display", "block");
    link.style("display", "block");
  } else {
    node.style("display", d => d.difficulty === difficulty ? "block" : "none");
    
    // Hide links that don't connect visible nodes
    link.style("display", d => {
      const sourceVisible = d.source.difficulty === difficulty;
      const targetVisible = d.target.difficulty === difficulty;
      return sourceVisible || targetVisible ? "block" : "none";
    });
  }
}

// Reset map view
function resetMapView() {
  svg.transition().duration(750).call(
    zoom.transform,
    d3.zoomIdentity
  );
  resetHighlights();
}

// Toggle fullscreen
function toggleFullscreen() {
  const container = document.querySelector('.topic-map-container');
  if (!document.fullscreenElement) {
    container.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}

// Helper functions
function getTimeEstimate(difficulty) {
  const estimates = {
    beginner: "~30 min",
    intermediate: "~45 min",
    advanced: "~60 min"
  };
  return estimates[difficulty] || "~45 min";
}

function getTopicDescription(topic) {
  // In a real implementation, this would fetch from data
  return `Learn about ${topic.label} at the ${topic.difficulty} level. This topic covers essential concepts and practical applications.`;
}

function getTopicUrl(topic) {
  // Map topic IDs to actual URLs
  const urlMap = {
    "git-basics": "/docs/technology/git-crash-course/",
    "git-branching": "/docs/technology/branching/",
    "git-internals": "/docs/technology/git/",
    "docker-intro": "/docs/technology/docker-crash-course/",
    "docker-compose": "/docs/technology/docker/",
    "ai-fundamentals": "/docs/technology/ai-fundamentals-simple/",
    "machine-learning": "/docs/technology/ai/",
    "deep-learning": "/docs/ai-ml/advanced-techniques/",
    "database-basics": "/docs/technology/database-crash-course/",
    "database-design": "/docs/technology/database-design/",
    "classical-mechanics": "/docs/physics/classical-mechanics/",
    "quantum-mechanics": "/docs/physics/quantum-mechanics/",
    "quantum-field-theory": "/docs/physics/quantum-field-theory/"
  };
  return urlMap[topic.id] || "#";
}

function updateRelatedTopics(topic) {
  const relatedList = document.getElementById('related-topics-list');
  const related = topicMapData.links
    .filter(l => l.source.id === topic.id || l.target.id === topic.id)
    .map(l => l.source.id === topic.id ? l.target : l.source);
  
  relatedList.innerHTML = related.map(r => `
    <li>
      <a href="${getTopicUrl(r)}" class="related-topic-link">
        ${r.label}
        <span class="difficulty-tag ${r.difficulty}">${r.difficulty}</span>
      </a>
    </li>
  `).join('');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', initializeTopicMap);

// Handle window resize
window.addEventListener('resize', () => {
  const width = document.getElementById('topic-map-canvas').offsetWidth;
  svg.attr("width", width);
  simulation.force("center", d3.forceCenter(width / 2, 300));
  simulation.alpha(0.3).restart();
});
</script>

<style>
.topic-map-container {
  margin: 2rem 0;
  border: 1px solid var(--map-border, #e0e0e0);
  border-radius: 12px;
  overflow: hidden;
  background: var(--map-bg, #fff);
}

.topic-map-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  background: var(--header-bg, #f8f9fa);
  border-bottom: 1px solid var(--map-border, #e0e0e0);
}

.topic-map-header h3 {
  margin: 0;
}

.map-controls {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.control-btn {
  padding: 0.5rem 1rem;
  background: white;
  border: 1px solid var(--btn-border, #dee2e6);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.control-btn:hover {
  background: var(--btn-hover-bg, #e9ecef);
  border-color: var(--btn-hover-border, #adb5bd);
}

.difficulty-filter select {
  padding: 0.5rem;
  border: 1px solid var(--select-border, #dee2e6);
  border-radius: 4px;
  background: white;
}

.topic-map-canvas {
  position: relative;
  background: var(--canvas-bg, #fafbfc);
}

#topic-map-svg {
  cursor: move;
}

/* Node styles */
.node-circle {
  fill: var(--node-fill, #fff);
  stroke-width: 3px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.node-circle:hover {
  stroke-width: 4px;
  filter: brightness(1.1);
}

.node-circle.beginner {
  stroke: #28a745;
}

.node-circle.intermediate {
  stroke: #17a2b8;
}

.node-circle.advanced {
  stroke: #dc3545;
}

.node-label {
  font-size: 12px;
  font-weight: 500;
  fill: var(--label-color, #212529);
}

.difficulty-indicator {
  font-size: 10px;
  font-weight: bold;
  fill: var(--indicator-color, #6c757d);
}

/* Link styles */
.link {
  stroke-width: 2px;
}

.link.progression {
  stroke: #0066cc;
}

.link.related {
  stroke: #999;
  stroke-dasharray: 5, 5;
}

/* Map legend */
.map-legend {
  position: absolute;
  bottom: 1rem;
  left: 1rem;
  background: white;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.map-legend h4 {
  margin: 0 0 0.5rem 0;
  font-size: 0.875rem;
  color: var(--legend-title, #495057);
}

.legend-items {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 3px solid;
}

.legend-color.beginner {
  border-color: #28a745;
}

.legend-color.intermediate {
  border-color: #17a2b8;
}

.legend-color.advanced {
  border-color: #dc3545;
}

.legend-label {
  font-size: 0.875rem;
  color: var(--legend-label, #6c757d);
}

/* Topic details panel */
.topic-details-panel {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 300px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  padding: 1.5rem;
  z-index: 10;
}

.close-details {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  width: 30px;
  height: 30px;
  background: transparent;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--close-color, #6c757d);
  border-radius: 4px;
  transition: all 0.2s ease;
}

.close-details:hover {
  background: var(--close-hover-bg, #e9ecef);
  color: var(--close-hover-color, #000);
}

.topic-metadata {
  display: flex;
  gap: 1rem;
  margin: 0.5rem 0 1rem 0;
}

.difficulty-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: capitalize;
}

.difficulty-badge.beginner {
  background: #d4edda;
  color: #155724;
}

.difficulty-badge.intermediate {
  background: #cce5ff;
  color: #004085;
}

.difficulty-badge.advanced {
  background: #f8d7da;
  color: #721c24;
}

.time-estimate {
  display: flex;
  align-items: center;
  font-size: 0.875rem;
  color: var(--time-color, #6c757d);
}

.topic-links h4 {
  margin: 1.5rem 0 0.5rem 0;
  font-size: 1rem;
}

#related-topics-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.related-topic-link {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  color: var(--link-color, #0066cc);
  text-decoration: none;
}

.related-topic-link:hover {
  text-decoration: underline;
}

.difficulty-tag {
  font-size: 0.75rem;
  padding: 0.125rem 0.5rem;
  border-radius: 10px;
  text-transform: capitalize;
}

.difficulty-tag.beginner {
  background: #d4edda;
  color: #155724;
}

.difficulty-tag.intermediate {
  background: #cce5ff;
  color: #004085;
}

.difficulty-tag.advanced {
  background: #f8d7da;
  color: #721c24;
}

.action-link {
  display: inline-block;
  margin-top: 1rem;
  padding: 0.5rem 1rem;
  background: var(--action-bg, #0066cc);
  color: white;
  text-decoration: none;
  border-radius: 4px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.action-link:hover {
  background: var(--action-hover-bg, #0052a3);
  transform: translateX(2px);
}

/* Fullscreen styles */
.topic-map-container:fullscreen {
  background: white;
}

.topic-map-container:fullscreen .topic-map-canvas {
  height: calc(100vh - 60px);
}

.topic-map-container:fullscreen #topic-map-svg {
  height: 100%;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .topic-map-container {
    --map-bg: #1a1a1a;
    --map-border: #333;
    --header-bg: #2a2a2a;
    --canvas-bg: #1a1a1a;
    --node-fill: #2a2a2a;
    --label-color: #f0f0f0;
    --indicator-color: #999;
    --legend-title: #b0b0b0;
    --legend-label: #999;
    --btn-border: #444;
    --btn-hover-bg: #333;
    --btn-hover-border: #555;
    --select-border: #444;
    --close-color: #999;
    --close-hover-bg: #333;
    --time-color: #999;
    --link-color: #4d94ff;
    --action-bg: #0066cc;
    --action-hover-bg: #0052a3;
  }
  
  .control-btn,
  .difficulty-filter select,
  .map-legend,
  .topic-details-panel {
    background: #2a2a2a;
    color: #f0f0f0;
  }
}

/* Responsive design */
@media (max-width: 768px) {
  .topic-map-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .map-controls {
    flex-wrap: wrap;
  }
  
  .topic-details-panel {
    width: calc(100% - 2rem);
    left: 1rem;
    right: 1rem;
  }
  
  #topic-map-svg {
    height: 400px;
  }
}
</style>