<h1 id="aws-developers-guide">AWS Developer’s Guide</h1>

<header><link rel="stylesheet" href="https://andrewaltimit.github.io/Documentation/style.css"></header>

<p>Amazon Web Services (AWS) is a comprehensive cloud services platform that offers a wide range of services to help developers build, deploy, and manage applications. AWS provides everything from compute and storage resources to machine learning and analytics services. With over 200 fully featured services, AWS enables organizations to build sophisticated applications with increased flexibility, scalability, and reliability.</p>

<h2 id="best-practices">Best Practices</h2>

<ul>
  <li>
<strong>Security</strong>: Implement the principle of least privilege with IAM, use encryption, and follow AWS security best practices.</li>
  <li>
<strong>Cost Optimization</strong>: Leverage auto-scaling, spot instances, and other cost-saving techniques.</li>
  <li>
<strong>Backup and Recovery</strong>: Regularly create and test backups to ensure data durability and recoverability.</li>
  <li>
<strong>Monitoring and Logging</strong>: Use Amazon CloudWatch, AWS X-Ray, and other monitoring tools to track application performance and diagnose issues.</li>
  <li>
<strong>Performance</strong>: Optimize performance by using caching, Content Delivery Networks (CDNs), and other performance-enhancing techniques.</li>
  <li>
<strong>Infrastructure as Code</strong>: Use AWS CloudFormation or Terraform to manage your infrastructure as code and maintain version control.</li>
</ul>

<h2 id="resources-and-tools">Resources and Tools</h2>

<h3 id="documentation">Documentation</h3>

<ul>
  <li><a href="https://aws.amazon.com/architecture/well-architected/">AWS Well-Architected Framework</a></li>
  <li><a href="https://aws.amazon.com/architecture/">AWS Architecture Center</a></li>
  <li><a href="https://aws.amazon.com/whitepapers/">AWS Whitepapers</a></li>
  <li><a href="https://aws.amazon.com/documentation/">AWS Documentation</a></li>
</ul>

<h3 id="getting-started">Getting Started</h3>

<ul>
  <li>
<a href="https://aws.amazon.com/free/">AWS Free Tier</a>: Get started with AWS using the free tier, which includes limited access to many AWS services.</li>
  <li>
<a href="https://aws.amazon.com/training/">AWS Training and Certification</a>: Access AWS training resources and certification programs to build and validate your AWS knowledge.</li>
  <li>
<a href="https://aws.amazon.com/blogs/aws/">AWS Blog</a>: Stay up to date with AWS news, announcements, and best practices.</li>
  <li>
<a href="https://aws.amazon.com/marketplace/">AWS Marketplace</a>: Find and deploy pre-built software solutions on AWS.</li>
</ul>

<h3 id="sdks-and-libraries">SDKs and Libraries</h3>

<ul>
  <li>
<a href="https://aws.amazon.com/tools/">AWS SDKs</a>: Use AWS SDKs to interact with AWS services in your preferred programming language.</li>
  <li>
<a href="https://aws.amazon.com/amplify/">AWS Amplify</a>: Utilize the Amplify library to simplify building cloud-powered mobile and web applications.</li>
  <li>
<a href="https://aws.amazon.com/cdk/">AWS CDK</a>: Use the Cloud Development Kit (CDK) to define cloud infrastructure using familiar programming languages.</li>
</ul>

<h3 id="aws-partner-network">AWS Partner Network</h3>

<p>Leverage the <a href="https://aws.amazon.com/partners/">AWS Partner Network (APN)</a> to find and collaborate with AWS Consulting and Technology Partners who offer a wide range of solutions and expertise to help you get the most out of AWS.</p>

<h3 id="community">Community</h3>

<ul>
  <li>
<a href="https://forums.aws.amazon.com/index.jspa">AWS Developer Forums</a>: Engage with the AWS developer community to ask questions and share knowledge.</li>
  <li>
<a href="https://aws.amazon.com/usergroups/">AWS User Groups</a>: Connect with other AWS users at local events and meetups.</li>
  <li>
<a href="https://reinvent.awsevents.com/">AWS re:Invent</a>: Attend AWS’s annual global conference for learning, networking, and discovering new services and features.</li>
</ul>

<h2 id="common-solutions">Common Solutions</h2>

<h3 id="serverless-architecture">Serverless Architecture</h3>

<ul>
  <li>Utilize AWS Lambda for compute and Amazon API Gateway for handling HTTP requests.</li>
  <li>Leverage Amazon S3 for static website hosting and object storage.</li>
  <li>Use Amazon DynamoDB for serverless databases.</li>
</ul>

<h3 id="microservices-architecture">Microservices Architecture</h3>

<ul>
  <li>Implement containerized microservices using Amazon ECS or EKS.</li>
  <li>Use Amazon API Gateway for service-to-service communication and API management.</li>
  <li>Leverage Amazon RDS or DynamoDB for database services.</li>
</ul>

<h3 id="big-data-and-analytics">Big Data and Analytics</h3>

<ul>
  <li>Ingest and process real-time data using Amazon Kinesis Data Streams and Kinesis Data Analytics.</li>
  <li>Use Amazon EMR for batch processing and Amazon Redshift for data warehousing.</li>
  <li>Visualize and analyze data using Amazon QuickSight.</li>
</ul>

<h3 id="machine-learning-pipeline">Machine Learning Pipeline</h3>

<ul>
  <li>Train, deploy, and manage ML models using Amazon SageMaker.</li>
  <li>Use Amazon S3 for storing training datasets and model artifacts.</li>
  <li>Integrate with other AWS services like Lambda, API Gateway, and Kinesis for real-time processing and predictions.</li>
</ul>

<h3 id="high-availability-and-disaster-recovery">High Availability and Disaster Recovery</h3>

<ul>
  <li>Design your architecture for high availability by deploying resources across multiple Availability Zones (AZs).</li>
  <li>Use Amazon RDS Multi-AZ deployments, Amazon EFS, and Amazon S3 for durable and highly available storage.</li>
  <li>Leverage AWS services like Amazon Route 53, Elastic Load Balancing (ELB), and Auto Scaling Groups to ensure fault tolerance and load distribution.</li>
</ul>

<h3 id="web-application-hosting">Web Application Hosting</h3>

<ul>
  <li>Host web applications using Amazon EC2 instances behind an Application Load Balancer (ALB).</li>
  <li>Store static assets in Amazon S3 and use Amazon CloudFront for content delivery.</li>
  <li>Utilize Amazon RDS or DynamoDB for database storage.</li>
</ul>

<h3 id="data-processing-and-etl">Data Processing and ETL</h3>

<ul>
  <li>Ingest data using Amazon Kinesis Data Streams or Firehose.</li>
  <li>Process and transform data using AWS Glue, AWS Data Pipeline, or AWS Step Functions.</li>
  <li>Store processed data in Amazon S3, Amazon RDS, Amazon Redshift, or Amazon Elasticsearch Service.</li>
</ul>

<h3 id="hybrid-cloud-solutions">Hybrid Cloud Solutions</h3>

<ul>
  <li>Extend your on-premises data center to AWS using AWS Direct Connect or VPN connections.</li>
  <li>Use AWS Storage Gateway and AWS Outposts for hybrid cloud storage and compute solutions.</li>
  <li>Leverage AWS services like Amazon RDS, Amazon WorkSpaces, and Amazon Connect to extend your on-premises solutions to the cloud.</li>
</ul>

<h2 id="list-of-services">List of Services</h2>

<h3 id="compute">Compute</h3>

<ul>
  <li>
<strong>Amazon EC2</strong>: Elastic Compute Cloud (EC2) provides scalable virtual servers.</li>
  <li>
<strong>AWS Lambda</strong>: Serverless compute service for running code without provisioning servers.</li>
  <li>
<strong>Amazon ECS</strong>: Elastic Container Service (ECS) is a container orchestration service.</li>
  <li>
<strong>Amazon EKS</strong>: Elastic Kubernetes Service (EKS) is a managed Kubernetes service.</li>
</ul>

<h3 id="storage">Storage</h3>

<ul>
  <li>
<strong>Amazon S3</strong>: Simple Storage Service (S3) is an object storage service.</li>
  <li>
<strong>Amazon EBS</strong>: Elastic Block Store (EBS) provides block-level storage volumes for EC2 instances.</li>
  <li>
<strong>Amazon EFS</strong>: Elastic File System (EFS) is a managed file storage service.</li>
  <li>
<strong>AWS Storage Gateway</strong>: Hybrid storage service connecting on-premises environments to AWS storage.</li>
</ul>

<h3 id="databases">Databases</h3>

<ul>
  <li>
<strong>Amazon RDS</strong>: Relational Database Service (RDS) is a managed relational database service.</li>
  <li>
<strong>Amazon DynamoDB</strong>: Managed NoSQL database service.</li>
  <li>
<strong>Amazon ElastiCache</strong>: In-memory data store and cache service.</li>
  <li>
<strong>Amazon Redshift</strong>: Managed data warehouse service.</li>
</ul>

<h3 id="networking">Networking</h3>

<ul>
  <li>
<strong>Amazon VPC</strong>: Virtual Private Cloud (VPC) provides an isolated virtual network within AWS.</li>
  <li>
<strong>Amazon Route 53</strong>: Scalable Domain Name System (DNS) web service.</li>
  <li>
<strong>AWS Direct Connect</strong>: Dedicated network connection between your on-premises environment and AWS.</li>
</ul>

<h3 id="security">Security</h3>

<ul>
  <li>
<strong>AWS Identity and Access Management (IAM)</strong>: Manage user access and permissions.</li>
  <li>
<strong>Amazon Cognito</strong>: User authentication and authorization service.</li>
  <li>
<strong>AWS Security Hub</strong>: Centralized security management and monitoring.</li>
</ul>

<h3 id="developer-tools">Developer Tools</h3>

<ul>
  <li>
<strong>AWS CodeCommit</strong>: Managed source control service.</li>
  <li>
<strong>AWS CodeBuild</strong>: Managed build service.</li>
  <li>
<strong>AWS CodeDeploy</strong>: Managed deployment service.</li>
  <li>
<strong>AWS CodePipeline</strong>: Continuous delivery pipeline service.</li>
</ul>

<h3 id="analytics">Analytics</h3>

<ul>
  <li>
<strong>Amazon Kinesis</strong>: Real-time data streaming and processing service.</li>
  <li>
<strong>Amazon EMR</strong>: Managed Hadoop framework.</li>
  <li>
<strong>Amazon Elasticsearch Service</strong>: Managed Elasticsearch service.</li>
  <li>
<strong>Amazon QuickSight</strong>: Business intelligence and data visualization service.</li>
</ul>

<h3 id="machine-learning">Machine Learning</h3>

<ul>
  <li>
<strong>Amazon SageMaker</strong>: Managed machine learning platform.</li>
  <li>
<strong>Amazon Rekognition</strong>: Image and video analysis service.</li>
  <li>
<strong>Amazon Comprehend</strong>: Natural language processing (NLP) service.</li>
  <li>
<strong>Amazon Lex</strong>: Conversational interfaces and chatbot service.</li>
</ul>

<h3 id="application-integration">Application Integration</h3>

<ul>
  <li>
<strong>Amazon SNS</strong>: Simple Notification Service (SNS) is a publish-subscribe messaging service.</li>
  <li>
<strong>Amazon SQS</strong>: Simple Queue Service (SQS) is a fully managed message queuing service.</li>
  <li>
<strong>AWS Step Functions</strong>: Coordinate distributed applications and microservices using visual workflows.</li>
</ul>

<h3 id="iot-and-edge-computing">IoT and Edge Computing</h3>

<ul>
  <li>
<strong>AWS IoT Core</strong>: Managed cloud platform for IoT devices.</li>
  <li>
<strong>AWS Greengrass</strong>: Extend AWS services to edge devices for local processing and data management.</li>
  <li>
<strong>Amazon FreeRTOS</strong>: IoT operating system for microcontrollers.</li>
</ul>

<h3 id="mobile-and-web-development">Mobile and Web Development</h3>

<ul>
  <li>
<strong>AWS Amplify</strong>: Development platform for building mobile and web applications with built-in authentication, API, storage, and more.</li>
  <li>
<strong>AWS App Runner</strong>: Service for building, deploying, and scaling containerized applications quickly.</li>
  <li>
<strong>Amazon AppStream 2.0</strong>: Fully managed application streaming service.</li>
</ul>

<h3 id="management-and-monitoring">Management and Monitoring</h3>

<ul>
  <li>
<strong>Amazon CloudWatch</strong>: Monitor and manage your AWS resources and applications, and set up alarms for specific events.</li>
  <li>
<strong>AWS Trusted Advisor</strong>: Optimize your AWS infrastructure with automated best practice checks for cost, performance, security, and fault tolerance.</li>
  <li>
<strong>AWS Organizations</strong>: Centrally manage and govern your AWS environment across multiple accounts.</li>
</ul>

<h3 id="migration-and-transfer">Migration and Transfer</h3>

<ul>
  <li>
<strong>AWS Database Migration Service</strong>: Migrate databases to AWS with minimal downtime.</li>
  <li>
<strong>AWS DataSync</strong>: Transfer data to and from AWS quickly and securely.</li>
  <li>
<strong>AWS Snow Family</strong>: Use physical devices to transport large amounts of data to and from AWS.</li>
</ul>

<h2 id="advanced-implementation-patterns">Advanced Implementation Patterns</h2>

<h3 id="multi-account-architecture">Multi-Account Architecture</h3>

<h4 id="aws-organizations-setup">AWS Organizations Setup</h4>

<p><strong>AWS Organizations enables centralized management of multiple AWS accounts:</strong></p>

<ul>
  <li>
<strong>Organizational Units (OUs)</strong>: Hierarchical structure for account grouping</li>
  <li>
<strong>Service Control Policies (SCPs)</strong>: Preventive guardrails across accounts</li>
  <li>
<strong>Cross-Account Roles</strong>: Secure access management between accounts</li>
  <li>
<strong>Automated Account Creation</strong>: Programmatic account provisioning</li>
</ul>

<p><strong>Key features implemented:</strong></p>
<ul>
  <li>Security, Production, and Development OUs</li>
  <li>Encryption enforcement via SCPs</li>
  <li>Log Archive and Audit accounts</li>
  <li>Cross-account administrative access</li>
</ul>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/organizations-setup.tf">organizations-setup.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"organization"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/organization"</span>
  
  <span class="nx">external_id</span> <span class="o">=</span> <span class="s2">"unique-external-id"</span>
  
  <span class="c1"># Reference outputs</span>
  <span class="nx">organization_id</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">organization</span><span class="p">.</span><span class="nx">organization_id</span>
  <span class="nx">account_ids</span>    <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">organization</span><span class="p">.</span><span class="nx">account_ids</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="control-tower-landing-zone">Control Tower Landing Zone</h4>

<p><strong>AWS Control Tower provides automated multi-account governance:</strong></p>

<ul>
  <li>
<strong>Account Factory for Terraform (AFT)</strong>: GitOps-based account provisioning</li>
  <li>
<strong>Security Baseline</strong>: Automated security service deployment</li>
  <li>
<strong>Guardrails</strong>: Preventive and detective controls</li>
  <li>
<strong>Landing Zone</strong>: Well-architected multi-account environment</li>
</ul>

<p><strong>Key components implemented:</strong></p>
<ul>
  <li>Organizational structure with Security, Production, and Development OUs</li>
  <li>Automated security services (CloudTrail, Config, GuardDuty, SecurityHub)</li>
  <li>Strict IAM password policies across all accounts</li>
  <li>Integration with Terraform Cloud for infrastructure management</li>
</ul>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/control-tower-landing-zone.tf">control-tower-landing-zone.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"landing_zone"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/control-tower"</span>
  
  <span class="nx">aws_region</span>             <span class="o">=</span> <span class="s2">"us-east-1"</span>
  <span class="nx">terraform_cloud_token</span>  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">tfc_token</span>
  <span class="nx">terraform_cloud_org</span>    <span class="o">=</span> <span class="s2">"myorg"</span>
  <span class="nx">github_org</span>            <span class="o">=</span> <span class="s2">"mycompany"</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="event-driven-architecture">Event-Driven Architecture</h3>

<h4 id="eventbridge-pattern">EventBridge Pattern</h4>

<p><strong>EventBridge enables decoupled event-driven architectures:</strong></p>

<ul>
  <li>
<strong>Custom Event Bus</strong>: Domain-specific event routing</li>
  <li>
<strong>Event Archive</strong>: Replay capability for debugging and recovery</li>
  <li>
<strong>Error Handling</strong>: DLQ and SNS notifications for failures</li>
  <li>
<strong>Step Functions Integration</strong>: Complex workflow orchestration</li>
</ul>

<p><strong>Key components implemented:</strong></p>
<ul>
  <li>Order processing pipeline with Lambda functions</li>
  <li>Event filtering and transformation</li>
  <li>Dead letter queue for resilience</li>
  <li>Step Functions for multi-step workflows</li>
  <li>API Gateway integration for event publishing</li>
  <li>Comprehensive error handling and monitoring</li>
</ul>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/eventbridge-pattern.tf">eventbridge-pattern.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"event_driven_system"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/eventbridge"</span>
  
  <span class="nx">environment</span> <span class="o">=</span> <span class="s2">"production"</span>
  <span class="nx">aws_region</span>  <span class="o">=</span> <span class="s2">"us-east-1"</span>
  
  <span class="c1"># Connect to existing resources</span>
  <span class="nx">orders_table_arn</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">kms_key_id</span>      <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="advanced-lambda-patterns">Advanced Lambda Patterns</h3>

<h4 id="lambda-with-container-images">Lambda with Container Images</h4>

<p><strong>Advanced Lambda patterns with containers and enterprise features:</strong></p>

<ul>
  <li>
<strong>Container Images</strong>: Package Lambda functions as OCI images up to 10GB</li>
  <li>
<strong>Lambda Layers</strong>: Share code and dependencies across functions</li>
  <li>
<strong>Extensions</strong>: Integrate monitoring and security tools</li>
  <li>
<strong>Auto-scaling</strong>: Provisioned concurrency with automatic scaling</li>
</ul>

<p><strong>Key features implemented:</strong></p>
<ul>
  <li>ECR repository with lifecycle policies</li>
  <li>Container-based Lambda with 10GB ephemeral storage</li>
  <li>AWS Lambda Powertools and OpenTelemetry integration</li>
  <li>Function URLs with CORS configuration</li>
  <li>Traffic shifting with weighted aliases</li>
  <li>X-Ray tracing and CloudWatch Insights</li>
  <li>Provisioned concurrency with auto-scaling</li>
  <li>Async invocation destinations</li>
</ul>

<div class="code-reference">
<i class="fas fa-code"></i> Full implementation: <a href="https://github.com/andrewaltimit/Documentation/blob/main/github-pages/code-examples/technology/aws/lambda-container-patterns.tf">lambda-container-patterns.tf</a>
</div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="nx">module</span> <span class="s2">"lambda_advanced"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/lambda-patterns"</span>
  
  <span class="nx">environment</span>        <span class="o">=</span> <span class="s2">"production"</span>
  <span class="nx">aws_region</span>        <span class="o">=</span> <span class="s2">"us-east-1"</span>
  <span class="nx">private_subnet_ids</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">private_subnets</span>
  
  <span class="c1"># Container image configuration</span>
  <span class="nx">ecr_repository_url</span> <span class="o">=</span> <span class="nx">aws_ecr_repository</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">repository_url</span>
  <span class="nx">image_tag</span>         <span class="o">=</span> <span class="s2">"v1.2.3"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>resource “aws_appautoscaling_policy” “lambda_concurrency” {
  name               = “${var.environment}-lambda-concurrency-scaling”
  policy_type        = “TargetTrackingScaling”
  resource_id        = aws_appautoscaling_target.lambda_concurrency.resource_id
  scalable_dimension = aws_appautoscaling_target.lambda_concurrency.scalable_dimension
  service_namespace  = aws_appautoscaling_target.lambda_concurrency.service_namespace</p>

<p>target_tracking_scaling_policy_configuration {
    target_value = 0.7</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>predefined_metric_specification {
  predefined_metric_type = "LambdaProvisionedConcurrencyUtilization"
}

scale_in_cooldown  = 180
scale_out_cooldown = 0   } } ```
</code></pre></div></div>

<h3 id="dynamodb-advanced-patterns">DynamoDB Advanced Patterns</h3>

<h4 id="single-table-design">Single Table Design</h4>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># dynamodb-single-table.tf - Advanced DynamoDB single table design</span>

<span class="c1"># Single table for all entities</span>
<span class="nx">resource</span> <span class="s2">"aws_dynamodb_table"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>           <span class="o">=</span> <span class="s2">"${var.environment}-main-table"</span>
  <span class="nx">billing_mode</span>   <span class="o">=</span> <span class="s2">"PAY_PER_REQUEST"</span>  <span class="c1"># On-demand billing</span>
  <span class="nx">hash_key</span>       <span class="o">=</span> <span class="s2">"PK"</span>
  <span class="nx">range_key</span>      <span class="o">=</span> <span class="s2">"SK"</span>
  
  <span class="c1"># Enable streams for event processing</span>
  <span class="nx">stream_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">stream_view_type</span> <span class="o">=</span> <span class="s2">"NEW_AND_OLD_IMAGES"</span>
  
  <span class="c1"># Point-in-time recovery</span>
  <span class="nx">point_in_time_recovery</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Server-side encryption</span>
  <span class="nx">server_side_encryption</span> <span class="p">{</span>
    <span class="nx">enabled</span>     <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">kms_key_arn</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">dynamodb</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
  
  <span class="c1"># Primary key attributes</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"SK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># GSI1 attributes</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI1PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI1SK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># GSI2 attributes</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI2PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI2SK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># GSI3 attributes for time-based queries</span>
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"GSI3PK"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"CreatedAt"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>
  
  <span class="c1"># Global Secondary Index 1 - Entity lookups</span>
  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>            <span class="o">=</span> <span class="s2">"GSI1"</span>
    <span class="nx">hash_key</span>        <span class="o">=</span> <span class="s2">"GSI1PK"</span>
    <span class="nx">range_key</span>       <span class="o">=</span> <span class="s2">"GSI1SK"</span>
    <span class="nx">projection_type</span> <span class="o">=</span> <span class="s2">"ALL"</span>
  <span class="p">}</span>
  
  <span class="c1"># Global Secondary Index 2 - Date-based queries</span>
  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>            <span class="o">=</span> <span class="s2">"GSI2"</span>
    <span class="nx">hash_key</span>        <span class="o">=</span> <span class="s2">"GSI2PK"</span>
    <span class="nx">range_key</span>       <span class="o">=</span> <span class="s2">"GSI2SK"</span>
    <span class="nx">projection_type</span> <span class="o">=</span> <span class="s2">"ALL"</span>
  <span class="p">}</span>
  
  <span class="c1"># Global Secondary Index 3 - Time-series data</span>
  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>            <span class="o">=</span> <span class="s2">"GSI3"</span>
    <span class="nx">hash_key</span>        <span class="o">=</span> <span class="s2">"GSI3PK"</span>
    <span class="nx">range_key</span>       <span class="o">=</span> <span class="s2">"CreatedAt"</span>
    <span class="nx">projection_type</span> <span class="o">=</span> <span class="s2">"INCLUDE"</span>
    <span class="nx">non_key_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"EntityType"</span><span class="p">,</span> <span class="s2">"Status"</span><span class="p">,</span> <span class="s2">"UpdatedAt"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="c1"># TTL for temporary data</span>
  <span class="nx">ttl</span> <span class="p">{</span>
    <span class="nx">attribute_name</span> <span class="o">=</span> <span class="s2">"ExpiresAt"</span>
    <span class="nx">enabled</span>        <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="nx">Purpose</span>     <span class="o">=</span> <span class="s2">"Single table design"</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># DynamoDB autoscaling for provisioned mode (if needed)</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_target"</span> <span class="s2">"dynamodb_table_read"</span> <span class="p">{</span>
  <span class="nx">count</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_autoscaling</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">max_capacity</span>       <span class="o">=</span> <span class="mi">40000</span>
  <span class="nx">min_capacity</span>       <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="s2">"table/${aws_dynamodb_table.main.name}"</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="s2">"dynamodb:table:ReadCapacityUnits"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="s2">"dynamodb"</span>
<span class="err">}</span>

<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"dynamodb_table_read"</span> <span class="p">{</span>
  <span class="nx">count</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_autoscaling</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"DynamoDBReadCapacityUtilization:${aws_appautoscaling_target.dynamodb_table_read[0].resource_id}"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">dynamodb_table_read</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">dynamodb_table_read</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">dynamodb_table_read</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"DynamoDBReadCapacityUtilization"</span>
    <span class="p">}</span>
    <span class="nx">target_value</span> <span class="o">=</span> <span class="mi">70</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Lambda function for DynamoDB streams processing</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"stream_processor"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"stream_processor.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-dynamodb-stream-processor"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">stream_processor</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">60</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">512</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ENVIRONMENT</span>    <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">EVENT_BUS_NAME</span> <span class="o">=</span> <span class="nx">aws_cloudwatch_event_bus</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tracing_config</span> <span class="p">{</span>
    <span class="nx">mode</span> <span class="o">=</span> <span class="s2">"Active"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Event source mapping for DynamoDB streams</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_event_source_mapping"</span> <span class="s2">"dynamodb_stream"</span> <span class="p">{</span>
  <span class="nx">event_source_arn</span>  <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">stream_arn</span>
  <span class="nx">function_name</span>     <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">stream_processor</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">starting_position</span> <span class="o">=</span> <span class="s2">"LATEST"</span>
  
  <span class="nx">maximum_batching_window_in_seconds</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="nx">parallelization_factor</span>             <span class="o">=</span> <span class="mi">10</span>
  <span class="nx">maximum_retry_attempts</span>             <span class="o">=</span> <span class="mi">3</span>
  <span class="nx">maximum_record_age_in_seconds</span>      <span class="o">=</span> <span class="mi">3600</span>
  
  <span class="c1"># Error handling</span>
  <span class="nx">destination_config</span> <span class="p">{</span>
    <span class="nx">on_failure</span> <span class="p">{</span>
      <span class="nx">destination_arn</span> <span class="o">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">dlq</span><span class="p">.</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Filter criteria</span>
  <span class="nx">filter_criteria</span> <span class="p">{</span>
    <span class="nx">filter</span> <span class="p">{</span>
      <span class="nx">pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
        <span class="nx">eventName</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"INSERT"</span><span class="p">,</span> <span class="s2">"MODIFY"</span><span class="p">]</span>
        <span class="nx">dynamodb</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">NewImage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">EntityType</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">S</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Order"</span><span class="p">]</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># DynamoDB global tables for multi-region</span>
<span class="nx">resource</span> <span class="s2">"aws_dynamodb_global_table"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_global_tables</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  
  <span class="nx">name</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="nx">dynamic</span> <span class="s2">"replica"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">global_table_regions</span>
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">region_name</span> <span class="o">=</span> <span class="nx">replica</span><span class="p">.</span><span class="nx">value</span>
      
      <span class="c1"># KMS key for each region</span>
      <span class="nx">kms_key_arn</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">regional</span><span class="p">[</span><span class="nx">replica</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># DynamoDB Accelerator (DAX) cluster</span>
<span class="nx">resource</span> <span class="s2">"aws_dax_cluster"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_dax</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  
  <span class="nx">cluster_name</span>       <span class="o">=</span> <span class="s2">"${var.environment}-dax-cluster"</span>
  <span class="nx">iam_role_arn</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">dax</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">node_type</span>          <span class="o">=</span> <span class="s2">"dax.r4.large"</span>
  <span class="nx">replication_factor</span> <span class="o">=</span> <span class="mi">3</span>
  
  <span class="c1"># Encryption</span>
  <span class="nx">server_side_encryption</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Parameter group</span>
  <span class="nx">parameter_group_name</span> <span class="o">=</span> <span class="nx">aws_dax_parameter_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="c1"># Subnet group</span>
  <span class="nx">subnet_group_name</span> <span class="o">=</span> <span class="nx">aws_dax_subnet_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="c1"># Security</span>
  <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">dax</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  
  <span class="c1"># Maintenance window</span>
  <span class="nx">maintenance_window</span> <span class="o">=</span> <span class="s2">"sun:05:00-sun:06:00"</span>
  
  <span class="c1"># Notifications</span>
  <span class="nx">notification_topic_arn</span> <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">dax_notifications</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># DAX parameter group</span>
<span class="nx">resource</span> <span class="s2">"aws_dax_parameter_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_dax</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"${var.environment}-dax-params"</span>
  
  <span class="nx">parameters</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"query-ttl-millis"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"600000"</span>  <span class="c1"># 10 minutes</span>
  <span class="p">}</span>
  
  <span class="nx">parameters</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"record-ttl-millis"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"300000"</span>  <span class="c1"># 5 minutes</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Contributor Insights for monitoring</span>
<span class="nx">resource</span> <span class="s2">"aws_dynamodb_contributor_insights"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">table_name</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span>

<span class="c1"># CloudWatch alarms for DynamoDB</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"user_errors"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-dynamodb-user-errors"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"UserErrors"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/DynamoDB"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Sum"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"10"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors DynamoDB user errors"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"throttled_requests"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-dynamodb-throttled-requests"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"UserErrors"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/DynamoDB"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Sum"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"5"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors DynamoDB throttled requests"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span>          <span class="o">=</span> <span class="s2">"throttled"</span>
    <span class="nx">return_data</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">metric</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"UserErrors"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"AWS/DynamoDB"</span>
      <span class="nx">period</span>      <span class="o">=</span> <span class="mi">300</span>
      <span class="nx">stat</span>        <span class="o">=</span> <span class="s2">"Sum"</span>
      
      <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="err">}</span>
</code></pre></div></div>

<h3 id="api-gateway-advanced-patterns">API Gateway Advanced Patterns</h3>

<h4 id="rest-api-with-request-validation">REST API with Request Validation</h4>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># api-gateway.tf - Advanced API Gateway with request validation</span>

<span class="c1"># REST API</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_rest_api"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-advanced-api"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Advanced REST API with validation and security"</span>
  
  <span class="nx">endpoint_configuration</span> <span class="p">{</span>
    <span class="nx">types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"REGIONAL"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="c1"># API Policy for resource limits</span>
  <span class="nx">policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="s2">"*"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"execute-api:Invoke"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"*"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Deny"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="s2">"*"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"execute-api:Invoke"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"*"</span>
        <span class="nx">Condition</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">IpAddressNotEquals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"aws:SourceIp"</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">allowed_ip_ranges</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Request validator</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_request_validator"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                        <span class="o">=</span> <span class="s2">"${var.environment}-validator"</span>
  <span class="nx">rest_api_id</span>                 <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">validate_request_body</span>       <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">validate_request_parameters</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1"># API Models for request/response validation</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_model"</span> <span class="s2">"user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">name</span>         <span class="o">=</span> <span class="s2">"User"</span>
  <span class="nx">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>
  
  <span class="nx">schema</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="s2">"$schema"</span> <span class="p">=</span> <span class="s2">"http://json-schema.org/draft-04/schema#"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"object"</span>
    <span class="nx">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"email"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">]</span>
    <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">email</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
        <span class="nx">format</span> <span class="o">=</span> <span class="s2">"email"</span>
        <span class="nx">pattern</span> <span class="o">=</span> <span class="s2">"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+</span><span class="err">\\</span><span class="s2">.[a-zA-Z]{2,}$"</span>
      <span class="p">}</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
        <span class="nx">minLength</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nx">maxLength</span> <span class="o">=</span> <span class="mi">100</span>
      <span class="p">}</span>
      <span class="nx">age</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"integer"</span>
        <span class="nx">minimum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nx">maximum</span> <span class="o">=</span> <span class="mi">150</span>
      <span class="p">}</span>
      <span class="nx">preferences</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"object"</span>
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">notifications</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="s2">"boolean"</span>
          <span class="p">}</span>
          <span class="nx">theme</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
            <span class="nx">enum</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"light"</span><span class="p">,</span> <span class="s2">"dark"</span><span class="p">,</span> <span class="s2">"auto"</span><span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_model"</span> <span class="s2">"error"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">name</span>         <span class="o">=</span> <span class="s2">"Error"</span>
  <span class="nx">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>
  
  <span class="nx">schema</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="s2">"$schema"</span> <span class="p">=</span> <span class="s2">"http://json-schema.org/draft-04/schema#"</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"object"</span>
    <span class="nx">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"message"</span><span class="p">]</span>
    <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
      <span class="p">}</span>
      <span class="nx">code</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
      <span class="p">}</span>
      <span class="nx">requestId</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"string"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># API Resources</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_resource"</span> <span class="s2">"v1"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">parent_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">root_resource_id</span>
  <span class="nx">path_part</span>   <span class="o">=</span> <span class="s2">"v1"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_resource"</span> <span class="s2">"users"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">parent_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">path_part</span>   <span class="o">=</span> <span class="s2">"users"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_resource"</span> <span class="s2">"user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">parent_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">path_part</span>   <span class="o">=</span> <span class="s2">"{userId}"</span>
<span class="p">}</span>

<span class="c1"># OPTIONS method for CORS</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span>   <span class="o">=</span> <span class="s2">"OPTIONS"</span>
  <span class="nx">authorization</span> <span class="o">=</span> <span class="s2">"NONE"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_integration"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"MOCK"</span>
  
  <span class="nx">request_templates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">statusCode</span><span class="se">\"</span><span class="s2">: 200}"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_response"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="s2">"200"</span>
  
  <span class="nx">response_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Headers"</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Methods"</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Origin"</span>  <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">response_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="s2">"Empty"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_integration_response"</span> <span class="s2">"users_options"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method_response</span><span class="p">.</span><span class="nx">users_options</span><span class="p">.</span><span class="nx">status_code</span>
  
  <span class="nx">response_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Headers"</span> <span class="p">=</span> <span class="s2">"'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Methods"</span> <span class="p">=</span> <span class="s2">"'GET,OPTIONS,POST,PUT,DELETE'"</span>
    <span class="s2">"method.response.header.Access-Control-Allow-Origin"</span>  <span class="p">=</span> <span class="s2">"'*'"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># POST method with validation</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method"</span> <span class="s2">"create_user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span>          <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span>          <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span>          <span class="o">=</span> <span class="s2">"POST"</span>
  <span class="nx">authorization</span>        <span class="o">=</span> <span class="s2">"CUSTOM"</span>
  <span class="nx">authorizer_id</span>        <span class="o">=</span> <span class="nx">aws_api_gateway_authorizer</span><span class="p">.</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">request_validator_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_request_validator</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">request_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">aws_api_gateway_model</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
  
  <span class="nx">request_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.request.header.X-Correlation-ID"</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Lambda integration</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_integration"</span> <span class="s2">"create_user"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">http_method</span>
  
  <span class="nx">integration_http_method</span> <span class="o">=</span> <span class="s2">"POST"</span>
  <span class="nx">type</span>                    <span class="o">=</span> <span class="s2">"AWS_PROXY"</span>
  <span class="nx">uri</span>                     <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">invoke_arn</span>
  
  <span class="nx">timeout_milliseconds</span> <span class="o">=</span> <span class="mi">29000</span>
  
  <span class="nx">request_templates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Method responses</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_response"</span> <span class="s2">"create_user_200"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="s2">"200"</span>
  
  <span class="nx">response_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">aws_api_gateway_model</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
  
  <span class="nx">response_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"method.response.header.X-Correlation-ID"</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_response"</span> <span class="s2">"create_user_400"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">resource_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">http_method</span> <span class="o">=</span> <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">http_method</span>
  <span class="nx">status_code</span> <span class="o">=</span> <span class="s2">"400"</span>
  
  <span class="nx">response_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"application/json"</span> <span class="p">=</span> <span class="nx">aws_api_gateway_model</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Custom authorizer</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_authorizer"</span> <span class="s2">"jwt"</span> <span class="p">{</span>
  <span class="nx">name</span>                   <span class="o">=</span> <span class="s2">"${var.environment}-jwt-authorizer"</span>
  <span class="nx">rest_api_id</span>            <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">type</span>                   <span class="o">=</span> <span class="s2">"TOKEN"</span>
  <span class="nx">authorizer_uri</span>         <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">authorizer</span><span class="p">.</span><span class="nx">invoke_arn</span>
  <span class="nx">authorizer_credentials</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">api_gateway_authorizer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">identity_source</span>        <span class="o">=</span> <span class="s2">"method.request.header.Authorization"</span>
  
  <span class="c1"># Cache auth results</span>
  <span class="nx">authorizer_result_ttl_in_seconds</span> <span class="o">=</span> <span class="mi">300</span>
<span class="p">}</span>

<span class="c1"># Lambda authorizer function</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"authorizer"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"authorizer.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-api-authorizer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_authorizer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">256</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">JWT_SECRET</span>        <span class="o">=</span> <span class="nx">aws_secretsmanager_secret_version</span><span class="p">.</span><span class="nx">jwt_secret</span><span class="p">.</span><span class="nx">secret_string</span>
      <span class="nx">ENVIRONMENT</span>       <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">USER_POOL_ID</span>      <span class="o">=</span> <span class="nx">aws_cognito_user_pool</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">TOKEN_USE</span>         <span class="o">=</span> <span class="s2">"access"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># API deployment</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_deployment"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">triggers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">redeployment</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">jsonencode</span><span class="p">([</span>
      <span class="nx">aws_api_gateway_resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="nx">aws_api_gateway_integration</span><span class="p">.</span><span class="nx">create_user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
    <span class="p">]))</span>
  <span class="p">}</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">create_before_destroy</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_api_gateway_method</span><span class="p">.</span><span class="nx">create_user</span><span class="p">,</span>
    <span class="nx">aws_api_gateway_integration</span><span class="p">.</span><span class="nx">create_user</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># API stages</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_stage"</span> <span class="s2">"prod"</span> <span class="p">{</span>
  <span class="nx">deployment_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_deployment</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">rest_api_id</span>   <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">stage_name</span>    <span class="o">=</span> <span class="s2">"prod"</span>
  
  <span class="c1"># Enable logging</span>
  <span class="nx">access_log_settings</span> <span class="p">{</span>
    <span class="nx">destination_arn</span> <span class="o">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">api_gateway</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">format</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="nx">requestId</span>               <span class="o">=</span> <span class="s2">"$context.requestId"</span>
      <span class="nx">extendedRequestId</span>       <span class="o">=</span> <span class="s2">"$context.extendedRequestId"</span>
      <span class="nx">ip</span>                      <span class="o">=</span> <span class="s2">"$context.identity.sourceIp"</span>
      <span class="nx">caller</span>                  <span class="o">=</span> <span class="s2">"$context.identity.caller"</span>
      <span class="nx">user</span>                    <span class="o">=</span> <span class="s2">"$context.identity.user"</span>
      <span class="nx">requestTime</span>             <span class="o">=</span> <span class="s2">"$context.requestTime"</span>
      <span class="nx">httpMethod</span>              <span class="o">=</span> <span class="s2">"$context.httpMethod"</span>
      <span class="nx">resourcePath</span>            <span class="o">=</span> <span class="s2">"$context.resourcePath"</span>
      <span class="nx">status</span>                  <span class="o">=</span> <span class="s2">"$context.status"</span>
      <span class="nx">protocol</span>                <span class="o">=</span> <span class="s2">"$context.protocol"</span>
      <span class="nx">responseLength</span>          <span class="o">=</span> <span class="s2">"$context.responseLength"</span>
      <span class="nx">error</span>                   <span class="o">=</span> <span class="s2">"$context.error.message"</span>
      <span class="nx">integrationLatency</span>      <span class="o">=</span> <span class="s2">"$context.integration.latency"</span>
      <span class="nx">integrationStatus</span>       <span class="o">=</span> <span class="s2">"$context.integration.status"</span>
      <span class="nx">integrationErrorMessage</span> <span class="o">=</span> <span class="s2">"$context.integrationErrorMessage"</span>
      <span class="nx">authorizerError</span>         <span class="o">=</span> <span class="s2">"$context.authorizer.error"</span>
    <span class="err">})</span>
  <span class="err">}</span>
  
  <span class="c1"># Caching</span>
  <span class="nx">cache_cluster_enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">cache_cluster_size</span>    <span class="o">=</span> <span class="s2">"0.5"</span>
  
  <span class="c1"># Throttling</span>
  <span class="nx">throttle_burst_limit</span> <span class="o">=</span> <span class="mi">5000</span>
  <span class="nx">throttle_rate_limit</span>  <span class="o">=</span> <span class="mi">10000</span>
  
  <span class="c1"># X-Ray tracing</span>
  <span class="nx">xray_tracing_enabled</span> <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">deployed_at</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">()</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Method settings for all methods</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_method_settings"</span> <span class="s2">"all"</span> <span class="p">{</span>
  <span class="nx">rest_api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">stage_name</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">stage_name</span>
  <span class="nx">method_path</span> <span class="o">=</span> <span class="s2">"*/*"</span>
  
  <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">metrics_enabled</span>        <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">logging_level</span>          <span class="o">=</span> <span class="s2">"INFO"</span>
    <span class="nx">data_trace_enabled</span>     <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">throttling_burst_limit</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="nx">throttling_rate_limit</span>  <span class="o">=</span> <span class="mi">1000</span>
    <span class="nx">caching_enabled</span>        <span class="o">=</span> <span class="kc">false</span>
  <span class="err">}</span>
<span class="p">}</span>

<span class="c1"># API key and usage plan</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_api_key"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-api-key"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_usage_plan"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>         <span class="o">=</span> <span class="s2">"${var.environment}-usage-plan"</span>
  <span class="nx">description</span>  <span class="o">=</span> <span class="s2">"Usage plan for API clients"</span>
  
  <span class="nx">api_stages</span> <span class="p">{</span>
    <span class="nx">api_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">stage</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">stage_name</span>
  <span class="p">}</span>
  
  <span class="nx">quota_settings</span> <span class="p">{</span>
    <span class="nx">limit</span>  <span class="o">=</span> <span class="mi">10000</span>
    <span class="nx">period</span> <span class="o">=</span> <span class="s2">"DAY"</span>
  <span class="p">}</span>
  
  <span class="nx">throttle_settings</span> <span class="p">{</span>
    <span class="nx">rate_limit</span>  <span class="o">=</span> <span class="mi">500</span>
    <span class="nx">burst_limit</span> <span class="o">=</span> <span class="mi">1000</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_usage_plan_key"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">key_id</span>        <span class="o">=</span> <span class="nx">aws_api_gateway_api_key</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">key_type</span>      <span class="o">=</span> <span class="s2">"API_KEY"</span>
  <span class="nx">usage_plan_id</span> <span class="o">=</span> <span class="nx">aws_api_gateway_usage_plan</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="c1"># Custom domain</span>
<span class="nx">resource</span> <span class="s2">"aws_api_gateway_domain_name"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">domain_name</span>              <span class="o">=</span> <span class="s2">"api.${var.domain_name}"</span>
  <span class="nx">regional_certificate_arn</span> <span class="o">=</span> <span class="nx">aws_acm_certificate_validation</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">certificate_arn</span>
  
  <span class="nx">endpoint_configuration</span> <span class="p">{</span>
    <span class="nx">types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"REGIONAL"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">security_policy</span> <span class="o">=</span> <span class="s2">"TLS_1_2"</span>
  
  <span class="nx">mutual_tls_authentication</span> <span class="p">{</span>
    <span class="nx">truststore_uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.truststore.bucket}/truststore.pem"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_api_gateway_base_path_mapping"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">api_id</span>      <span class="o">=</span> <span class="nx">aws_api_gateway_rest_api</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">stage_name</span>  <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">stage_name</span>
  <span class="nx">domain_name</span> <span class="o">=</span> <span class="nx">aws_api_gateway_domain_name</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">domain_name</span>
  <span class="nx">base_path</span>   <span class="o">=</span> <span class="s2">"v1"</span>
<span class="p">}</span>

<span class="c1"># WAF for API Gateway</span>
<span class="nx">resource</span> <span class="s2">"aws_wafv2_web_acl_association"</span> <span class="s2">"api_gateway"</span> <span class="p">{</span>
  <span class="nx">resource_arn</span> <span class="o">=</span> <span class="nx">aws_api_gateway_stage</span><span class="p">.</span><span class="nx">prod</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">web_acl_arn</span>  <span class="o">=</span> <span class="nx">aws_wafv2_web_acl</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="step-functions-advanced-workflows">Step Functions Advanced Workflows</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># step-functions.tf - Advanced Step Functions workflows</span>

<span class="c1"># Step Functions state machine for order processing</span>
<span class="nx">resource</span> <span class="s2">"aws_sfn_state_machine"</span> <span class="s2">"order_processing"</span> <span class="p">{</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-order-processing"</span>
  <span class="nx">role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">step_functions</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Comment</span> <span class="o">=</span> <span class="s2">"Advanced order processing workflow with error handling"</span>
    <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"ValidateOrder"</span>
    <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ValidateOrder</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::lambda:invoke"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">validate_order</span><span class="p">.</span><span class="nx">arn</span>
          <span class="s2">"Payload.$"</span> <span class="o">=</span> <span class="s2">"$"</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.validation"</span>
        <span class="nx">Retry</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Lambda.ServiceException"</span><span class="p">,</span> <span class="s2">"Lambda.AWSLambdaException"</span><span class="p">]</span>
            <span class="nx">IntervalSeconds</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="nx">MaxAttempts</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="nx">BackoffRate</span> <span class="o">=</span> <span class="mi">2</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Catch</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ValidationError"</span><span class="p">]</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleValidationError"</span>
            <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.error"</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"States.ALL"</span><span class="p">]</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleGeneralError"</span>
            <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.error"</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"CheckInventory"</span>
      <span class="p">}</span>
      
      <span class="nx">CheckInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:dynamodb:query"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">inventory</span><span class="p">.</span><span class="nx">name</span>
          <span class="nx">KeyConditionExpression</span> <span class="o">=</span> <span class="s2">"ProductId = :productId"</span>
          <span class="nx">ExpressionAttributeValues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">":productId"</span> <span class="p">=</span> <span class="p">{</span>
              <span class="s2">"S.$"</span> <span class="p">=</span> <span class="s2">"$.order.productId"</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.inventory"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"EvaluateInventory"</span>
      <span class="p">}</span>
      
      <span class="nx">EvaluateInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Choice"</span>
        <span class="nx">Choices</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">Variable</span> <span class="o">=</span> <span class="s2">"$.inventory.Items[0].Stock.N"</span>
            <span class="nx">NumericGreaterThanEquals</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"ProcessPayment"</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Default</span> <span class="o">=</span> <span class="s2">"InsufficientInventory"</span>
      <span class="p">}</span>
      
      <span class="nx">InsufficientInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::sns:publish"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">TopicArn</span> <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">inventory_alerts</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">Message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
            <span class="s2">"productId.$"</span> <span class="p">=</span> <span class="s2">"$.order.productId"</span>
            <span class="s2">"message"</span> <span class="p">=</span> <span class="s2">"Insufficient inventory"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
      
      <span class="nx">ProcessPayment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Parallel"</span>
        <span class="nx">Branches</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"ChargePayment"</span>
            <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">ChargePayment</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
                <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::lambda:invoke.waitForTaskToken"</span>
                <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">process_payment</span><span class="p">.</span><span class="nx">arn</span>
                  <span class="nx">Payload</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
                    <span class="s2">"taskToken.$"</span> <span class="p">=</span> <span class="s2">"$$.Task.Token"</span>
                  <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">TimeoutSeconds</span> <span class="o">=</span> <span class="mi">300</span>
                <span class="nx">HeartbeatSeconds</span> <span class="o">=</span> <span class="mi">30</span>
                <span class="nx">Retry</span> <span class="o">=</span> <span class="p">[</span>
                  <span class="p">{</span>
                    <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"PaymentDeclined"</span><span class="p">]</span>
                    <span class="nx">MaxAttempts</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="nx">IntervalSeconds</span> <span class="o">=</span> <span class="mi">5</span>
                  <span class="p">}</span>
                <span class="p">]</span>
                <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"SendConfirmationEmail"</span>
            <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">SendConfirmationEmail</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
                <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:ses:sendEmail"</span>
                <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">Destination</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">ToAddresses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"$.order.customerEmail"</span><span class="p">]</span>
                  <span class="p">}</span>
                  <span class="nx">Message</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">Body</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="nx">Html</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="nx">Data</span> <span class="o">=</span> <span class="s2">"Order confirmation email body"</span>
                      <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="nx">Subject</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="nx">Data</span> <span class="o">=</span> <span class="s2">"Order Confirmation"</span>
                    <span class="p">}</span>
                  <span class="p">}</span>
                  <span class="nx">Source</span> <span class="o">=</span> <span class="s2">"noreply@example.com"</span>
                <span class="p">}</span>
                <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.emailResult"</span>
                <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"LogAnalytics"</span>
            <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">LogAnalytics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
                <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:firehose:putRecordBatch"</span>
                <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">DeliveryStreamName</span> <span class="o">=</span> <span class="nx">aws_kinesis_firehose_delivery_stream</span><span class="p">.</span><span class="nx">analytics</span><span class="p">.</span><span class="nx">name</span>
                  <span class="nx">Records</span> <span class="o">=</span> <span class="p">[{</span>
                    <span class="nx">Data</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
                      <span class="s2">"amount.$"</span> <span class="p">=</span> <span class="s2">"$.order.amount"</span>
                      <span class="s2">"timestamp.$"</span> <span class="p">=</span> <span class="s2">"$$.State.EnteredTime"</span>
                      <span class="s2">"eventType"</span> <span class="p">=</span> <span class="s2">"order_placed"</span>
                    <span class="p">}</span>
                  <span class="p">}]</span>
                <span class="p">}</span>
                <span class="nx">ResultPath</span> <span class="o">=</span> <span class="kc">null</span>
                <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"UpdateInventory"</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.paymentResults"</span>
      <span class="p">}</span>
      
      <span class="nx">UpdateInventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Map"</span>
        <span class="nx">ItemsPath</span> <span class="o">=</span> <span class="s2">"$.order.items"</span>
        <span class="nx">MaxConcurrency</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"item.$"</span> <span class="p">=</span> <span class="s2">"$$.Map.Item.Value"</span>
          <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
        <span class="p">}</span>
        <span class="nx">Iterator</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"DecrementStock"</span>
          <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">DecrementStock</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
              <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::dynamodb:updateItem"</span>
              <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">TableName</span> <span class="o">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">inventory</span><span class="p">.</span><span class="nx">name</span>
                <span class="nx">Key</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">ProductId</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">"S.$"</span> <span class="p">=</span> <span class="s2">"$.item.productId"</span>
                  <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">UpdateExpression</span> <span class="o">=</span> <span class="s2">"SET #stock = #stock - :quantity, #updated = :timestamp"</span>
                <span class="nx">ExpressionAttributeNames</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s2">"#stock"</span> <span class="p">=</span> <span class="s2">"Stock"</span>
                  <span class="s2">"#updated"</span> <span class="p">=</span> <span class="s2">"LastUpdated"</span>
                <span class="p">}</span>
                <span class="nx">ExpressionAttributeValues</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s2">":quantity"</span> <span class="p">=</span> <span class="p">{</span>
                    <span class="s2">"N.$"</span> <span class="p">=</span> <span class="s2">"$.item.quantity"</span>
                  <span class="p">}</span>
                  <span class="s2">":timestamp"</span> <span class="p">=</span> <span class="p">{</span>
                    <span class="s2">"S.$"</span> <span class="p">=</span> <span class="s2">"$$.State.EnteredTime"</span>
                  <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">ConditionExpression</span> <span class="o">=</span> <span class="s2">"#stock &gt;= :quantity"</span>
                <span class="nx">ReturnValues</span> <span class="o">=</span> <span class="s2">"ALL_NEW"</span>
              <span class="p">}</span>
              <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.updateResult"</span>
              <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"CompleteOrder"</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.inventoryUpdates"</span>
        <span class="nx">Catch</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">ErrorEquals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"DynamoDB.ConditionalCheckFailedException"</span><span class="p">]</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleInventoryError"</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
      
      <span class="nx">CompleteOrder</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::batch:submitJob.sync"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">JobName</span> <span class="o">=</span> <span class="s2">"CompleteOrderJob"</span>
          <span class="nx">JobQueue</span> <span class="o">=</span> <span class="nx">aws_batch_job_queue</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
          <span class="nx">JobDefinition</span> <span class="o">=</span> <span class="nx">aws_batch_job_definition</span><span class="p">.</span><span class="nx">complete_order</span><span class="p">.</span><span class="nx">name</span>
          <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"orderId.$"</span> <span class="p">=</span> <span class="s2">"$.order.orderId"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderSuccess"</span>
      <span class="p">}</span>
      
      <span class="nx">OrderSuccess</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Succeed"</span>
      <span class="p">}</span>
      
      <span class="nx">OrderFailed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Fail"</span>
        <span class="nx">Cause</span> <span class="o">=</span> <span class="s2">"Order processing failed"</span>
      <span class="p">}</span>
      
      <span class="nx">HandleValidationError</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">handle_error</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"error.$"</span> <span class="p">=</span> <span class="s2">"$.error"</span>
          <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
          <span class="s2">"errorType"</span> <span class="p">=</span> <span class="s2">"validation"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
      
      <span class="nx">HandleInventoryError</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">handle_error</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"error.$"</span> <span class="p">=</span> <span class="s2">"$.error"</span>
          <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
          <span class="s2">"errorType"</span> <span class="p">=</span> <span class="s2">"inventory"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
      
      <span class="nx">HandleGeneralError</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">handle_error</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"error.$"</span> <span class="p">=</span> <span class="s2">"$.error"</span>
          <span class="s2">"order.$"</span> <span class="p">=</span> <span class="s2">"$.order"</span>
          <span class="s2">"errorType"</span> <span class="p">=</span> <span class="s2">"general"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"OrderFailed"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
  
  <span class="nx">logging_configuration</span> <span class="p">{</span>
    <span class="nx">log_destination</span>        <span class="o">=</span> <span class="s2">"${aws_cloudwatch_log_group.step_functions.arn}:*"</span>
    <span class="nx">include_execution_data</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">level</span>                  <span class="o">=</span> <span class="s2">"ALL"</span>
  <span class="p">}</span>
  
  <span class="nx">tracing_configuration</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="nx">Purpose</span>     <span class="o">=</span> <span class="s2">"Order processing workflow"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Express workflow for synchronous execution</span>
<span class="nx">resource</span> <span class="s2">"aws_sfn_state_machine"</span> <span class="s2">"express_workflow"</span> <span class="p">{</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-express-workflow"</span>
  <span class="nx">role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">step_functions</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">type</span>     <span class="o">=</span> <span class="s2">"EXPRESS"</span>
  
  <span class="nx">definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Comment</span> <span class="o">=</span> <span class="s2">"Express workflow for fast synchronous execution"</span>
    <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"TransformData"</span>
    <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">TransformData</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:lambda:invoke"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">transform_data</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">Payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"input.$"</span> <span class="p">=</span> <span class="s2">"$"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">OutputPath</span> <span class="o">=</span> <span class="s2">"$.Payload"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"EnrichData"</span>
      <span class="p">}</span>
      
      <span class="nx">EnrichData</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">enrich_data</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">TimeoutSeconds</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"ReturnResult"</span>
      <span class="p">}</span>
      
      <span class="nx">ReturnResult</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Pass"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"transformedData.$"</span> <span class="p">=</span> <span class="s2">"$"</span>
          <span class="s2">"processedAt.$"</span> <span class="p">=</span> <span class="s2">"$$.State.EnteredTime"</span>
          <span class="s2">"executionName.$"</span> <span class="p">=</span> <span class="s2">"$$.Execution.Name"</span>
        <span class="p">}</span>
        <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># CloudWatch Logs for Step Functions</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"step_functions"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/aws/vendedlogs/states/${var.environment}-order-processing"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># CloudWatch alarms for Step Functions</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"step_functions_failed"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-step-functions-executions-failed"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"1"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"ExecutionsFailed"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/States"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Sum"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"5"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors failed Step Functions executions"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">StateMachineArn</span> <span class="o">=</span> <span class="nx">aws_sfn_state_machine</span><span class="p">.</span><span class="nx">order_processing</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># EventBridge rule to trigger Step Functions</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"trigger_workflow"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-trigger-order-workflow"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Trigger order processing workflow"</span>
  
  <span class="nx">event_pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">source</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"order.service"</span><span class="p">]</span>
    <span class="nx">detail-type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Order Placed"</span><span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"step_functions"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">trigger_workflow</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"StepFunctionsTarget"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_sfn_state_machine</span><span class="p">.</span><span class="nx">order_processing</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">role_arn</span>  <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">events_step_functions</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">input_transformer</span> <span class="p">{</span>
    <span class="nx">input_paths</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">order</span> <span class="o">=</span> <span class="s2">"$.detail.order"</span>
    <span class="p">}</span>
    <span class="nx">input_template</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="nx">order</span> <span class="o">=</span> <span class="s2">"&lt;order&gt;"</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="container-orchestration-with-ecsfargate">Container Orchestration with ECS/Fargate</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ecs-fargate.tf - Container orchestration with ECS and Fargate</span>

<span class="c1"># ECS Cluster</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_cluster"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-cluster"</span>
  
  <span class="nx">configuration</span> <span class="p">{</span>
    <span class="nx">execute_command_configuration</span> <span class="p">{</span>
      <span class="nx">kms_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">ecs</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">logging</span>    <span class="o">=</span> <span class="s2">"OVERRIDE"</span>
      
      <span class="nx">log_configuration</span> <span class="p">{</span>
        <span class="nx">cloud_watch_encryption_enabled</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">cloud_watch_log_group_name</span>     <span class="o">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">ecs_exec</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">setting</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"containerInsights"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"enabled"</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Capacity providers for mixing Fargate and Fargate Spot</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_cluster_capacity_providers"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">cluster_name</span> <span class="o">=</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="nx">capacity_providers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"FARGATE"</span><span class="p">,</span>
    <span class="s2">"FARGATE_SPOT"</span>
  <span class="p">]</span>
  
  <span class="nx">default_capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">100</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE"</span>
  <span class="p">}</span>
  
  <span class="nx">default_capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">50</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE_SPOT"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Task Definition</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_task_definition"</span> <span class="s2">"app"</span> <span class="p">{</span>
  <span class="nx">family</span>                   <span class="o">=</span> <span class="s2">"${var.environment}-app"</span>
  <span class="nx">network_mode</span>             <span class="o">=</span> <span class="s2">"awsvpc"</span>
  <span class="nx">requires_compatibilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"FARGATE"</span><span class="p">]</span>
  <span class="nx">cpu</span>                      <span class="o">=</span> <span class="s2">"512"</span>
  <span class="nx">memory</span>                   <span class="o">=</span> <span class="s2">"1024"</span>
  <span class="nx">execution_role_arn</span>       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">ecs_execution</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">task_role_arn</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">ecs_task</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">runtime_platform</span> <span class="p">{</span>
    <span class="nx">operating_system_family</span> <span class="o">=</span> <span class="s2">"LINUX"</span>
    <span class="nx">cpu_architecture</span>        <span class="o">=</span> <span class="s2">"X86_64"</span>  <span class="c1"># or "ARM64" for Graviton2</span>
  <span class="p">}</span>
  
  <span class="nx">container_definitions</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">([</span>
    <span class="p">{</span>
      <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"app"</span>
      <span class="nx">image</span>     <span class="o">=</span> <span class="s2">"${aws_ecr_repository.app.repository_url}:latest"</span>
      <span class="nx">essential</span> <span class="o">=</span> <span class="kc">true</span>
      
      <span class="nx">portMappings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="o">=</span> <span class="mi">8080</span>
          <span class="nx">protocol</span>      <span class="o">=</span> <span class="s2">"tcp"</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">environment</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"ENVIRONMENT"</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"AWS_REGION"</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">secrets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"DB_PASSWORD"</span>
          <span class="nx">valueFrom</span> <span class="o">=</span> <span class="nx">aws_secretsmanager_secret</span><span class="p">.</span><span class="nx">db_password</span><span class="p">.</span><span class="nx">arn</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"API_KEY"</span>
          <span class="nx">valueFrom</span> <span class="o">=</span> <span class="nx">aws_ssm_parameter</span><span class="p">.</span><span class="nx">api_key</span><span class="p">.</span><span class="nx">arn</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">logConfiguration</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">logDriver</span> <span class="o">=</span> <span class="s2">"awslogs"</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"awslogs-group"</span>         <span class="p">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">ecs_app</span><span class="p">.</span><span class="nx">name</span>
          <span class="s2">"awslogs-region"</span>        <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="s2">"awslogs-stream-prefix"</span> <span class="o">=</span> <span class="s2">"ecs"</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">healthCheck</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">command</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">"CMD-SHELL"</span><span class="p">,</span> <span class="s2">"curl -f http://localhost:8080/health || exit 1"</span><span class="p">]</span>
        <span class="nx">interval</span>    <span class="o">=</span> <span class="mi">30</span>
        <span class="nx">timeout</span>     <span class="o">=</span> <span class="mi">5</span>
        <span class="nx">retries</span>     <span class="o">=</span> <span class="mi">3</span>
        <span class="nx">startPeriod</span> <span class="o">=</span> <span class="mi">60</span>
      <span class="p">}</span>
      
      <span class="nx">linuxParameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">initProcessEnabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      
      <span class="c1"># FireLens logging</span>
      <span class="nx">firelensConfiguration</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"fluentbit"</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">enable-ecs-log-metadata</span> <span class="o">=</span> <span class="s2">"true"</span>
          <span class="nx">config-file-type</span>        <span class="o">=</span> <span class="s2">"file"</span>
          <span class="nx">config-file-value</span>       <span class="o">=</span> <span class="s2">"/fluent-bit/configs/parse-json.conf"</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1"># ECS Exec</span>
      <span class="nx">linuxParameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">initProcessEnabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      
      <span class="c1"># Resource limits</span>
      <span class="nx">ulimits</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"nofile"</span>
          <span class="nx">softLimit</span> <span class="o">=</span> <span class="mi">65536</span>
          <span class="nx">hardLimit</span> <span class="o">=</span> <span class="mi">65536</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="c1"># Mount points for EFS</span>
      <span class="nx">mountPoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">sourceVolume</span>  <span class="o">=</span> <span class="s2">"efs-storage"</span>
          <span class="nx">containerPath</span> <span class="o">=</span> <span class="s2">"/data"</span>
          <span class="nx">readOnly</span>      <span class="o">=</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span>             <span class="o">=</span> <span class="s2">"xray-daemon"</span>
      <span class="nx">image</span>            <span class="o">=</span> <span class="s2">"public.ecr.aws/xray/aws-xray-daemon:latest"</span>
      <span class="nx">essential</span>        <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">memoryReservation</span> <span class="o">=</span> <span class="mi">256</span>
      
      <span class="nx">portMappings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="o">=</span> <span class="mi">2000</span>
          <span class="nx">protocol</span>      <span class="o">=</span> <span class="s2">"udp"</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">logConfiguration</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">logDriver</span> <span class="o">=</span> <span class="s2">"awslogs"</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"awslogs-group"</span>         <span class="p">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">ecs_xray</span><span class="p">.</span><span class="nx">name</span>
          <span class="s2">"awslogs-region"</span>        <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="s2">"awslogs-stream-prefix"</span> <span class="o">=</span> <span class="s2">"xray"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">])</span>
  
  <span class="c1"># EFS volume</span>
  <span class="nx">volume</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"efs-storage"</span>
    
    <span class="nx">efs_volume_configuration</span> <span class="p">{</span>
      <span class="nx">file_system_id</span>          <span class="o">=</span> <span class="nx">aws_efs_file_system</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">root_directory</span>          <span class="o">=</span> <span class="s2">"/"</span>
      <span class="nx">transit_encryption</span>      <span class="o">=</span> <span class="s2">"ENABLED"</span>
      <span class="nx">transit_encryption_port</span> <span class="o">=</span> <span class="mi">2999</span>
      
      <span class="nx">authorization_config</span> <span class="p">{</span>
        <span class="nx">access_point_id</span> <span class="o">=</span> <span class="nx">aws_efs_access_point</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">id</span>
        <span class="nx">iam</span>             <span class="o">=</span> <span class="s2">"ENABLED"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Ephemeral storage</span>
  <span class="nx">ephemeral_storage</span> <span class="p">{</span>
    <span class="nx">size_in_gib</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ECS Service</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_service"</span> <span class="s2">"app"</span> <span class="p">{</span>
  <span class="nx">name</span>                               <span class="o">=</span> <span class="s2">"${var.environment}-app-service"</span>
  <span class="nx">cluster</span>                            <span class="o">=</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">task_definition</span>                    <span class="o">=</span> <span class="nx">aws_ecs_task_definition</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">desired_count</span>                      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">app_count</span>
  <span class="nx">deployment_minimum_healthy_percent</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="nx">deployment_maximum_percent</span>         <span class="o">=</span> <span class="mi">200</span>
  <span class="nx">health_check_grace_period_seconds</span>  <span class="o">=</span> <span class="mi">60</span>
  <span class="nx">launch_type</span>                        <span class="o">=</span> <span class="s2">"FARGATE"</span>
  <span class="nx">platform_version</span>                   <span class="o">=</span> <span class="s2">"LATEST"</span>
  
  <span class="nx">deployment_controller</span> <span class="p">{</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="s2">"ECS"</span>  <span class="c1"># or "CODE_DEPLOY" for blue/green</span>
  <span class="p">}</span>
  
  <span class="nx">deployment_circuit_breaker</span> <span class="p">{</span>
    <span class="nx">enable</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">rollback</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">network_configuration</span> <span class="p">{</span>
    <span class="nx">subnets</span>          <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_groups</span>  <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">ecs_service</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
    <span class="nx">assign_public_ip</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
  
  <span class="nx">load_balancer</span> <span class="p">{</span>
    <span class="nx">target_group_arn</span> <span class="o">=</span> <span class="nx">aws_lb_target_group</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">container_name</span>   <span class="o">=</span> <span class="s2">"app"</span>
    <span class="nx">container_port</span>   <span class="o">=</span> <span class="mi">8080</span>
  <span class="p">}</span>
  
  <span class="nx">service_registries</span> <span class="p">{</span>
    <span class="nx">registry_arn</span> <span class="o">=</span> <span class="nx">aws_service_discovery_service</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
  
  <span class="c1"># Capacity provider strategy to use Fargate Spot</span>
  <span class="nx">capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE"</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">1</span>
  <span class="p">}</span>
  
  <span class="nx">capacity_provider_strategy</span> <span class="p">{</span>
    <span class="nx">capacity_provider</span> <span class="o">=</span> <span class="s2">"FARGATE_SPOT"</span>
    <span class="nx">weight</span>            <span class="o">=</span> <span class="mi">4</span>
    <span class="nx">base</span>              <span class="o">=</span> <span class="mi">0</span>
  <span class="p">}</span>
  
  <span class="nx">enable_ecs_managed_tags</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">propagate_tags</span>          <span class="o">=</span> <span class="s2">"SERVICE"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="o">=</span> <span class="p">[</span><span class="nx">desired_count</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_lb_listener</span><span class="p">.</span><span class="nx">app</span><span class="p">,</span>
    <span class="nx">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="nx">ecs_task</span>
  <span class="p">]</span>
<span class="err">}</span>

<span class="c1"># Auto Scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_target"</span> <span class="s2">"ecs_target"</span> <span class="p">{</span>
  <span class="nx">max_capacity</span>       <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">max_capacity</span>
  <span class="nx">min_capacity</span>       <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">min_capacity</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="s2">"service/${aws_ecs_cluster.main.name}/${aws_ecs_service.app.name}"</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="s2">"ecs:service:DesiredCount"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="s2">"ecs"</span>
<span class="p">}</span>

<span class="c1"># CPU-based auto scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"ecs_cpu"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-ecs-cpu-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"ECSServiceAverageCPUUtilization"</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span>       <span class="o">=</span> <span class="mf">70.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">180</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Memory-based auto scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"ecs_memory"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-ecs-memory-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"ECSServiceAverageMemoryUtilization"</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span>       <span class="o">=</span> <span class="mf">75.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">180</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Custom metric scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"ecs_requests"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-ecs-requests-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">customized_metric_specification</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"RequestsPerTask"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"${var.environment}/Application"</span>
      <span class="nx">statistic</span>   <span class="o">=</span> <span class="s2">"Average"</span>
      <span class="nx">unit</span>        <span class="o">=</span> <span class="s2">"Count"</span>
      
      <span class="nx">dimensions</span> <span class="p">{</span>
        <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"ServiceName"</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">aws_ecs_service</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span>       <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">180</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Scheduled scaling</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_scheduled_action"</span> <span class="s2">"scale_up_morning"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-scale-up-morning"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">ecs_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">schedule</span>           <span class="o">=</span> <span class="s2">"cron(0 8 * * ? *)"</span>  <span class="c1"># 8 AM UTC daily</span>
  <span class="nx">timezone</span>           <span class="o">=</span> <span class="s2">"America/New_York"</span>
  
  <span class="nx">scalable_target_action</span> <span class="p">{</span>
    <span class="nx">min_capacity</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="nx">max_capacity</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Service Discovery</span>
<span class="nx">resource</span> <span class="s2">"aws_service_discovery_private_dns_namespace"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}.local"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Private DNS namespace for service discovery"</span>
  <span class="nx">vpc</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">vpc_id</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_service_discovery_service"</span> <span class="s2">"app"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"app"</span>
  
  <span class="nx">dns_config</span> <span class="p">{</span>
    <span class="nx">namespace_id</span> <span class="o">=</span> <span class="nx">aws_service_discovery_private_dns_namespace</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
    
    <span class="nx">dns_records</span> <span class="p">{</span>
      <span class="nx">ttl</span>  <span class="o">=</span> <span class="mi">10</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="s2">"A"</span>
    <span class="p">}</span>
    
    <span class="nx">routing_policy</span> <span class="o">=</span> <span class="s2">"MULTIVALUE"</span>
  <span class="p">}</span>
  
  <span class="nx">health_check_custom_config</span> <span class="p">{</span>
    <span class="nx">failure_threshold</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudWatch Logs</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"ecs_app"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/ecs/${var.environment}/app"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"ecs_xray"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/ecs/${var.environment}/xray"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">7</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"ecs_exec"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"/ecs/${var.environment}/exec"</span>
  <span class="nx">retention_in_days</span> <span class="o">=</span> <span class="mi">7</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># CloudWatch Dashboard</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_dashboard"</span> <span class="s2">"ecs"</span> <span class="p">{</span>
  <span class="nx">dashboard_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-ecs-dashboard"</span>
  
  <span class="nx">dashboard_body</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">widgets</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/ECS"</span><span class="p">,</span> <span class="s2">"CPUUtilization"</span><span class="p">,</span> <span class="s2">"ServiceName"</span><span class="p">,</span> <span class="nx">aws_ecs_service</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">"ClusterName"</span><span class="p">,</span> <span class="nx">aws_ecs_cluster</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"MemoryUtilization"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"ECS Service Utilization"</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/ApplicationELB"</span><span class="p">,</span> <span class="s2">"TargetResponseTime"</span><span class="p">,</span> <span class="s2">"LoadBalancer"</span><span class="p">,</span> <span class="nx">aws_lb</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn_suffix</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"RequestCount"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"HTTPCode_Target_4XX_Count"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"HTTPCode_Target_5XX_Count"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"Load Balancer Metrics"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="performance-optimization-strategies">Performance Optimization Strategies</h2>

<h3 id="cloudfront-and-edge-computing">CloudFront and Edge Computing</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cloudfront.tf - CloudFront distribution with Lambda@Edge</span>

<span class="c1"># S3 bucket for static content</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"static_content"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-static-content-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_versioning"</span> <span class="s2">"static_content"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">static_content</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">versioning_configuration</span> <span class="p">{</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_server_side_encryption_configuration"</span> <span class="s2">"static_content"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">static_content</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">apply_server_side_encryption_by_default</span> <span class="p">{</span>
      <span class="nx">sse_algorithm</span>     <span class="o">=</span> <span class="s2">"aws:kms"</span>
      <span class="nx">kms_master_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudFront Origin Access Control</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_origin_access_control"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                              <span class="o">=</span> <span class="s2">"${var.environment}-oac"</span>
  <span class="nx">description</span>                       <span class="o">=</span> <span class="s2">"Origin Access Control for S3"</span>
  <span class="nx">origin_access_control_origin_type</span> <span class="o">=</span> <span class="s2">"s3"</span>
  <span class="nx">signing_behavior</span>                  <span class="o">=</span> <span class="s2">"always"</span>
  <span class="nx">signing_protocol</span>                  <span class="o">=</span> <span class="s2">"sigv4"</span>
<span class="p">}</span>

<span class="c1"># Lambda@Edge functions</span>
<span class="nx">data</span> <span class="s2">"archive_file"</span> <span class="s2">"lambda_edge_viewer_request"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"zip"</span>
  <span class="nx">source_file</span> <span class="o">=</span> <span class="s2">"lambda-edge/viewer-request.js"</span>
  <span class="nx">output_path</span> <span class="o">=</span> <span class="s2">"lambda-edge-viewer-request.zip"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"edge_viewer_request"</span> <span class="p">{</span>
  <span class="nx">provider</span>         <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">us_east_1</span>  <span class="c1"># Lambda@Edge must be in us-east-1</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_viewer_request</span><span class="p">.</span><span class="nx">output_path</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-edge-viewer-request"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_edge</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"viewer-request.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"nodejs18.x"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">128</span>
  <span class="nx">publish</span>         <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">source_code_hash</span> <span class="o">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_viewer_request</span><span class="p">.</span><span class="nx">output_base64sha256</span>
<span class="p">}</span>

<span class="nx">data</span> <span class="s2">"archive_file"</span> <span class="s2">"lambda_edge_origin_response"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"zip"</span>
  <span class="nx">source_file</span> <span class="o">=</span> <span class="s2">"lambda-edge/origin-response.js"</span>
  <span class="nx">output_path</span> <span class="o">=</span> <span class="s2">"lambda-edge-origin-response.zip"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"edge_origin_response"</span> <span class="p">{</span>
  <span class="nx">provider</span>         <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">us_east_1</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_origin_response</span><span class="p">.</span><span class="nx">output_path</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-edge-origin-response"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_edge</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"origin-response.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"nodejs18.x"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">5</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">128</span>
  <span class="nx">publish</span>         <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">source_code_hash</span> <span class="o">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">lambda_edge_origin_response</span><span class="p">.</span><span class="nx">output_base64sha256</span>
<span class="p">}</span>

<span class="c1"># CloudFront Distribution</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">enabled</span>             <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">is_ipv6_enabled</span>     <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">comment</span>             <span class="o">=</span> <span class="s2">"${var.environment} CloudFront distribution"</span>
  <span class="nx">default_root_object</span> <span class="o">=</span> <span class="s2">"index.html"</span>
  <span class="nx">aliases</span>             <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">domain_name</span><span class="p">,</span> <span class="s2">"www.${var.domain_name}"</span><span class="p">]</span>
  <span class="nx">price_class</span>         <span class="o">=</span> <span class="s2">"PriceClass_200"</span>  <span class="c1"># US, Canada, Europe, Asia</span>
  
  <span class="c1"># S3 origin</span>
  <span class="nx">origin</span> <span class="p">{</span>
    <span class="nx">domain_name</span>              <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">static_content</span><span class="p">.</span><span class="nx">bucket_regional_domain_name</span>
    <span class="nx">origin_access_control_id</span> <span class="o">=</span> <span class="nx">aws_cloudfront_origin_access_control</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">origin_id</span>                <span class="o">=</span> <span class="s2">"S3-${aws_s3_bucket.static_content.id}"</span>
    
    <span class="nx">origin_shield</span> <span class="p">{</span>
      <span class="nx">enabled</span>              <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">origin_shield_region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># ALB origin for dynamic content</span>
  <span class="nx">origin</span> <span class="p">{</span>
    <span class="nx">domain_name</span> <span class="o">=</span> <span class="nx">aws_lb</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">dns_name</span>
    <span class="nx">origin_id</span>   <span class="o">=</span> <span class="s2">"ALB-${aws_lb.main.id}"</span>
    
    <span class="nx">custom_origin_config</span> <span class="p">{</span>
      <span class="nx">http_port</span>              <span class="o">=</span> <span class="mi">80</span>
      <span class="nx">https_port</span>             <span class="o">=</span> <span class="mi">443</span>
      <span class="nx">origin_protocol_policy</span> <span class="o">=</span> <span class="s2">"https-only"</span>
      <span class="nx">origin_ssl_protocols</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"TLSv1.2"</span><span class="p">]</span>
      
      <span class="nx">origin_keepalive_timeout</span> <span class="o">=</span> <span class="mi">60</span>
      <span class="nx">origin_read_timeout</span>      <span class="o">=</span> <span class="mi">60</span>
    <span class="p">}</span>
    
    <span class="nx">custom_header</span> <span class="p">{</span>
      <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"X-Origin-Verify"</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">random_password</span><span class="p">.</span><span class="nx">origin_verify</span><span class="p">.</span><span class="nx">result</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Origin group for failover</span>
  <span class="nx">origin_group</span> <span class="p">{</span>
    <span class="nx">origin_id</span> <span class="o">=</span> <span class="s2">"origin-group-1"</span>
    
    <span class="nx">failover_criteria</span> <span class="p">{</span>
      <span class="nx">status_codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">member</span> <span class="p">{</span>
      <span class="nx">origin_id</span> <span class="o">=</span> <span class="s2">"ALB-${aws_lb.main.id}"</span>
    <span class="p">}</span>
    
    <span class="nx">member</span> <span class="p">{</span>
      <span class="nx">origin_id</span> <span class="o">=</span> <span class="s2">"ALB-${aws_lb.secondary.id}"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Default cache behavior</span>
  <span class="nx">default_cache_behavior</span> <span class="p">{</span>
    <span class="nx">allowed_methods</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">"DELETE"</span><span class="p">,</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">,</span> <span class="s2">"PATCH"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span> <span class="o">=</span> <span class="s2">"S3-${aws_s3_bucket.static_content.id}"</span>
    
    <span class="nx">forwarded_values</span> <span class="p">{</span>
      <span class="nx">query_string</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">headers</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"Origin"</span><span class="p">,</span> <span class="s2">"Access-Control-Request-Method"</span><span class="p">,</span> <span class="s2">"Access-Control-Request-Headers"</span><span class="p">]</span>
      
      <span class="nx">cookies</span> <span class="p">{</span>
        <span class="nx">forward</span> <span class="o">=</span> <span class="s2">"none"</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"redirect-to-https"</span>
    <span class="nx">min_ttl</span>                <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">default_ttl</span>            <span class="o">=</span> <span class="mi">86400</span>
    <span class="nx">max_ttl</span>                <span class="o">=</span> <span class="mi">31536000</span>
    <span class="nx">compress</span>               <span class="o">=</span> <span class="kc">true</span>
    
    <span class="c1"># Lambda@Edge associations</span>
    <span class="nx">lambda_function_association</span> <span class="p">{</span>
      <span class="nx">event_type</span>   <span class="o">=</span> <span class="s2">"viewer-request"</span>
      <span class="nx">lambda_arn</span>   <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">edge_viewer_request</span><span class="p">.</span><span class="nx">qualified_arn</span>
      <span class="nx">include_body</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    
    <span class="nx">lambda_function_association</span> <span class="p">{</span>
      <span class="nx">event_type</span>   <span class="o">=</span> <span class="s2">"origin-response"</span>
      <span class="nx">lambda_arn</span>   <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">edge_origin_response</span><span class="p">.</span><span class="nx">qualified_arn</span>
      <span class="nx">include_body</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="err">}</span>
  
  <span class="c1"># Cache behavior for API</span>
  <span class="nx">ordered_cache_behavior</span> <span class="p">{</span>
    <span class="nx">path_pattern</span>     <span class="o">=</span> <span class="s2">"/api/*"</span>
    <span class="nx">allowed_methods</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">"DELETE"</span><span class="p">,</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">,</span> <span class="s2">"PATCH"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span> <span class="o">=</span> <span class="s2">"origin-group-1"</span>
    
    <span class="nx">cache_policy_id</span>            <span class="o">=</span> <span class="nx">aws_cloudfront_cache_policy</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">origin_request_policy_id</span>   <span class="o">=</span> <span class="nx">aws_cloudfront_origin_request_policy</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">response_headers_policy_id</span> <span class="o">=</span> <span class="nx">aws_cloudfront_response_headers_policy</span><span class="p">.</span><span class="nx">security</span><span class="p">.</span><span class="nx">id</span>
    
    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"https-only"</span>
    <span class="nx">compress</span>               <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Cache behavior for static assets</span>
  <span class="nx">ordered_cache_behavior</span> <span class="p">{</span>
    <span class="nx">path_pattern</span>     <span class="o">=</span> <span class="s2">"/static/*"</span>
    <span class="nx">allowed_methods</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">]</span>
    <span class="nx">cached_methods</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">]</span>
    <span class="nx">target_origin_id</span> <span class="o">=</span> <span class="s2">"S3-${aws_s3_bucket.static_content.id}"</span>
    
    <span class="nx">viewer_protocol_policy</span> <span class="o">=</span> <span class="s2">"redirect-to-https"</span>
    <span class="nx">min_ttl</span>                <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">default_ttl</span>            <span class="o">=</span> <span class="mi">604800</span>   <span class="c1"># 7 days</span>
    <span class="nx">max_ttl</span>                <span class="o">=</span> <span class="mi">31536000</span>  <span class="c1"># 1 year</span>
    <span class="nx">compress</span>               <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">forwarded_values</span> <span class="p">{</span>
      <span class="nx">query_string</span> <span class="o">=</span> <span class="kc">false</span>
      
      <span class="nx">cookies</span> <span class="p">{</span>
        <span class="nx">forward</span> <span class="o">=</span> <span class="s2">"none"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="err">}</span>
  
  <span class="nx">restrictions</span> <span class="p">{</span>
    <span class="nx">geo_restriction</span> <span class="p">{</span>
      <span class="nx">restriction_type</span> <span class="o">=</span> <span class="s2">"none"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">viewer_certificate</span> <span class="p">{</span>
    <span class="nx">acm_certificate_arn</span>      <span class="o">=</span> <span class="nx">aws_acm_certificate_validation</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">certificate_arn</span>
    <span class="nx">minimum_protocol_version</span> <span class="o">=</span> <span class="s2">"TLSv1.2_2021"</span>
    <span class="nx">ssl_support_method</span>       <span class="o">=</span> <span class="s2">"sni-only"</span>
  <span class="p">}</span>
  
  <span class="nx">web_acl_id</span> <span class="o">=</span> <span class="nx">aws_wafv2_web_acl</span><span class="p">.</span><span class="nx">cloudfront</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">logging_config</span> <span class="p">{</span>
    <span class="nx">include_cookies</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">bucket</span>          <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cloudfront_logs</span><span class="p">.</span><span class="nx">bucket_domain_name</span>
    <span class="nx">prefix</span>          <span class="o">=</span> <span class="s2">"cloudfront/"</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_s3_bucket_policy</span><span class="p">.</span><span class="nx">static_content</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Cache policy for API</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_cache_policy"</span> <span class="s2">"api"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-api-cache-policy"</span>
  <span class="nx">comment</span>     <span class="o">=</span> <span class="s2">"Cache policy for API endpoints"</span>
  <span class="nx">default_ttl</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">max_ttl</span>     <span class="o">=</span> <span class="mi">3600</span>
  <span class="nx">min_ttl</span>     <span class="o">=</span> <span class="mi">0</span>
  
  <span class="nx">parameters_in_cache_key_and_forwarded_to_origin</span> <span class="p">{</span>
    <span class="nx">enable_accept_encoding_gzip</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">enable_accept_encoding_brotli</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">cookies_config</span> <span class="p">{</span>
      <span class="nx">cookie_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
    <span class="p">}</span>
    
    <span class="nx">headers_config</span> <span class="p">{</span>
      <span class="nx">header_behavior</span> <span class="o">=</span> <span class="s2">"whitelist"</span>
      <span class="nx">headers</span> <span class="p">{</span>
        <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s2">"Authorization"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Viewer-Country"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Is-Mobile-Viewer"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Is-Tablet-Viewer"</span><span class="p">,</span>
          <span class="s2">"CloudFront-Is-Desktop-Viewer"</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">query_strings_config</span> <span class="p">{</span>
      <span class="nx">query_string_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Origin request policy</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_origin_request_policy"</span> <span class="s2">"api"</span> <span class="p">{</span>
  <span class="nx">name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-api-origin-request-policy"</span>
  <span class="nx">comment</span> <span class="o">=</span> <span class="s2">"Origin request policy for API"</span>
  
  <span class="nx">cookies_config</span> <span class="p">{</span>
    <span class="nx">cookie_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
  <span class="p">}</span>
  
  <span class="nx">headers_config</span> <span class="p">{</span>
    <span class="nx">header_behavior</span> <span class="o">=</span> <span class="s2">"allViewer"</span>
  <span class="p">}</span>
  
  <span class="nx">query_strings_config</span> <span class="p">{</span>
    <span class="nx">query_string_behavior</span> <span class="o">=</span> <span class="s2">"all"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Response headers policy</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_response_headers_policy"</span> <span class="s2">"security"</span> <span class="p">{</span>
  <span class="nx">name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-security-headers-policy"</span>
  <span class="nx">comment</span> <span class="o">=</span> <span class="s2">"Security headers policy"</span>
  
  <span class="nx">security_headers_config</span> <span class="p">{</span>
    <span class="nx">content_type_options</span> <span class="p">{</span>
      <span class="nx">override</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">frame_options</span> <span class="p">{</span>
      <span class="nx">frame_option</span> <span class="o">=</span> <span class="s2">"DENY"</span>
      <span class="nx">override</span>     <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">referrer_policy</span> <span class="p">{</span>
      <span class="nx">referrer_policy</span> <span class="o">=</span> <span class="s2">"strict-origin-when-cross-origin"</span>
      <span class="nx">override</span>        <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">xss_protection</span> <span class="p">{</span>
      <span class="nx">mode_block</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">protection</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">override</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">strict_transport_security</span> <span class="p">{</span>
      <span class="nx">access_control_max_age_sec</span> <span class="o">=</span> <span class="mi">63072000</span>
      <span class="nx">include_subdomains</span>         <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">preload</span>                    <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">override</span>                   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="nx">content_security_policy</span> <span class="p">{</span>
      <span class="nx">content_security_policy</span> <span class="o">=</span> <span class="s2">"default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"</span>
      <span class="nx">override</span>                <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">cors_config</span> <span class="p">{</span>
    <span class="nx">access_control_allow_credentials</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">access_control_allow_headers</span> <span class="p">{</span>
      <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">access_control_allow_methods</span> <span class="p">{</span>
      <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"DELETE"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">access_control_allow_origins</span> <span class="p">{</span>
      <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"https://${var.domain_name}"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">access_control_max_age_sec</span> <span class="o">=</span> <span class="mi">86400</span>
    <span class="nx">origin_override</span>            <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">custom_headers_config</span> <span class="p">{</span>
    <span class="nx">items</span> <span class="p">{</span>
      <span class="nx">header</span>   <span class="o">=</span> <span class="s2">"X-Environment"</span>
      <span class="nx">value</span>    <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">override</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudFront monitoring</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"4xx_errors"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-cloudfront-4xx-errors"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"4xxErrorRate"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/CloudFront"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"5"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors CloudFront 4xx error rate"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">DistributionId</span> <span class="o">=</span> <span class="nx">aws_cloudfront_distribution</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Real-time logs</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_realtime_log_config"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-realtime-logs"</span>
  
  <span class="nx">endpoint</span> <span class="p">{</span>
    <span class="nx">stream_type</span> <span class="o">=</span> <span class="s2">"Kinesis"</span>
    
    <span class="nx">kinesis_stream_config</span> <span class="p">{</span>
      <span class="nx">role_arn</span>   <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">cloudfront_logs</span><span class="p">.</span><span class="nx">arn</span>
      <span class="nx">stream_arn</span> <span class="o">=</span> <span class="nx">aws_kinesis_stream</span><span class="p">.</span><span class="nx">cloudfront_logs</span><span class="p">.</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">fields</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"timestamp"</span><span class="p">,</span>
    <span class="s2">"c-ip"</span><span class="p">,</span>
    <span class="s2">"sc-status"</span><span class="p">,</span>
    <span class="s2">"cs-uri-stem"</span><span class="p">,</span>
    <span class="s2">"cs-user-agent"</span><span class="p">,</span>
    <span class="s2">"cs-referer"</span><span class="p">,</span>
    <span class="s2">"x-edge-location"</span><span class="p">,</span>
    <span class="s2">"x-edge-request-id"</span><span class="p">,</span>
    <span class="s2">"x-edge-response-result-type"</span><span class="p">,</span>
    <span class="s2">"time-taken"</span>
  <span class="p">]</span>
  
  <span class="nx">sampling_rate</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1% sampling</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="rds-performance-insights">RDS Performance Insights</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># rds-performance.tf - RDS with Performance Insights and monitoring</span>

<span class="c1"># RDS subnet group</span>
<span class="nx">resource</span> <span class="s2">"aws_db_subnet_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>       <span class="o">=</span> <span class="s2">"${var.environment}-db-subnet-group"</span>
  <span class="nx">subnet_ids</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS parameter group with performance optimizations</span>
<span class="nx">resource</span> <span class="s2">"aws_db_parameter_group"</span> <span class="s2">"optimized"</span> <span class="p">{</span>
  <span class="nx">name</span>   <span class="o">=</span> <span class="s2">"${var.environment}-mysql-optimized"</span>
  <span class="nx">family</span> <span class="o">=</span> <span class="s2">"mysql8.0"</span>
  
  <span class="c1"># Query performance parameters</span>
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"slow_query_log"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"long_query_time"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"log_queries_not_using_indexes"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"performance_schema"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1"</span>
  <span class="p">}</span>
  
  <span class="c1"># InnoDB optimization</span>
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_buffer_pool_size"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"{DBInstanceClassMemory*3/4}"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_log_file_size"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1073741824"</span>  <span class="c1"># 1GB</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_flush_log_at_trx_commit"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"2"</span>
  <span class="p">}</span>
  
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"innodb_flush_method"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"O_DIRECT"</span>
  <span class="p">}</span>
  
  <span class="c1"># Connection optimization</span>
  <span class="nx">parameter</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"max_connections"</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="s2">"1000"</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS instance with Performance Insights</span>
<span class="nx">resource</span> <span class="s2">"aws_db_instance"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">identifier</span> <span class="o">=</span> <span class="s2">"${var.environment}-database"</span>
  
  <span class="c1"># Engine configuration</span>
  <span class="nx">engine</span>                      <span class="o">=</span> <span class="s2">"mysql"</span>
  <span class="nx">engine_version</span>              <span class="o">=</span> <span class="s2">"8.0.33"</span>
  <span class="nx">auto_minor_version_upgrade</span>  <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">allow_major_version_upgrade</span> <span class="o">=</span> <span class="kc">false</span>
  
  <span class="c1"># Instance configuration</span>
  <span class="nx">instance_class</span>    <span class="o">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">db_instance_class</span>
  <span class="nx">allocated_storage</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_allocated_storage</span>
  <span class="nx">storage_encrypted</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">kms_key_id</span>        <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">rds</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">storage_type</span>      <span class="o">=</span> <span class="s2">"gp3"</span>
  <span class="nx">iops</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_iops</span>
  
  <span class="c1"># Database configuration</span>
  <span class="nx">db_name</span>  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_name</span>
  <span class="nx">username</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">db_username</span>
  <span class="nx">password</span> <span class="o">=</span> <span class="nx">aws_secretsmanager_secret_version</span><span class="p">.</span><span class="nx">db_password</span><span class="p">.</span><span class="nx">secret_string</span>
  <span class="nx">port</span>     <span class="o">=</span> <span class="mi">3306</span>
  
  <span class="c1"># Network configuration</span>
  <span class="nx">db_subnet_group_name</span>   <span class="o">=</span> <span class="nx">aws_db_subnet_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">rds</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="nx">publicly_accessible</span>    <span class="o">=</span> <span class="kc">false</span>
  
  <span class="c1"># Parameter and option groups</span>
  <span class="nx">parameter_group_name</span> <span class="o">=</span> <span class="nx">aws_db_parameter_group</span><span class="p">.</span><span class="nx">optimized</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">option_group_name</span>    <span class="o">=</span> <span class="nx">aws_db_option_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="c1"># Backup configuration</span>
  <span class="nx">backup_retention_period</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">backup_window</span>          <span class="o">=</span> <span class="s2">"03:00-04:00"</span>
  <span class="nx">maintenance_window</span>     <span class="o">=</span> <span class="s2">"sun:04:00-sun:05:00"</span>
  
  <span class="c1"># High availability</span>
  <span class="nx">multi_az</span>               <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">deletion_protection</span>    <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">skip_final_snapshot</span>    <span class="o">=</span> <span class="kc">false</span>
  <span class="nx">final_snapshot_identifier</span> <span class="o">=</span> <span class="s2">"${var.environment}-database-final-snapshot-${formatdate("</span><span class="nx">YYYY-MM-DD-hhmm</span><span class="s2">", timestamp())}"</span>
  
  <span class="c1"># Performance Insights</span>
  <span class="nx">enabled_cloudwatch_logs_exports</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"error"</span><span class="p">,</span> <span class="s2">"general"</span><span class="p">,</span> <span class="s2">"slowquery"</span><span class="p">]</span>
  
  <span class="nx">performance_insights_enabled</span>          <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">performance_insights_kms_key_id</span>       <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="err">.</span><span class="nx">rds</span><span class="err">.</span><span class="nx">arn</span>
  <span class="nx">performance_insights_retention_period</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># days</span>
  
  <span class="c1"># Enhanced monitoring</span>
  <span class="nx">monitoring_interval</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="nx">monitoring_role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">rds_monitoring</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># RDS Proxy for connection pooling</span>
<span class="nx">resource</span> <span class="s2">"aws_db_proxy"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                   <span class="o">=</span> <span class="s2">"${var.environment}-rds-proxy"</span>
  <span class="nx">engine_family</span>          <span class="o">=</span> <span class="s2">"MYSQL"</span>
  <span class="nx">auth</span> <span class="p">{</span>
    <span class="nx">auth_scheme</span> <span class="o">=</span> <span class="s2">"SECRETS"</span>
    <span class="nx">secret_arn</span>  <span class="o">=</span> <span class="nx">aws_secretsmanager_secret</span><span class="p">.</span><span class="nx">db_password</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
  
  <span class="nx">role_arn</span>               <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">rds_proxy</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">vpc_subnet_ids</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
  
  <span class="nx">require_tls</span>                    <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">idle_client_timeout</span>            <span class="o">=</span> <span class="mi">1800</span>
  <span class="nx">max_connections_percent</span>        <span class="o">=</span> <span class="mi">100</span>
  <span class="nx">max_idle_connections_percent</span>   <span class="o">=</span> <span class="mi">50</span>
  <span class="nx">connection_borrow_timeout</span>      <span class="o">=</span> <span class="mi">120</span>
  
  <span class="nx">target</span> <span class="p">{</span>
    <span class="nx">db_instance_identifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># CloudWatch dashboard for RDS Performance Insights</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_dashboard"</span> <span class="s2">"rds_performance"</span> <span class="p">{</span>
  <span class="nx">dashboard_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-rds-performance-insights"</span>
  
  <span class="nx">dashboard_body</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">widgets</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/RDS"</span><span class="p">,</span> <span class="s2">"CPUUtilization"</span><span class="p">,</span> <span class="s2">"DBInstanceIdentifier"</span><span class="p">,</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"DatabaseConnections"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"FreeableMemory"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Average"</span> <span class="p">}]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"RDS Resource Utilization"</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">12</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/RDS"</span><span class="p">,</span> <span class="s2">"ReadLatency"</span><span class="p">,</span> <span class="s2">"DBInstanceIdentifier"</span><span class="p">,</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"WriteLatency"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"ReadThroughput"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"WriteThroughput"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stat</span> <span class="o">=</span> <span class="s2">"Sum"</span> <span class="p">}]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"RDS I/O Performance"</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">type</span>   <span class="o">=</span> <span class="s2">"metric"</span>
        <span class="nx">width</span>  <span class="o">=</span> <span class="mi">24</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="mi">6</span>
        
        <span class="nx">properties</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">"AWS/RDS"</span><span class="p">,</span> <span class="s2">"DBLoad"</span><span class="p">,</span> <span class="s2">"DBInstanceIdentifier"</span><span class="p">,</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"DBLoadCPU"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"DBLoadNonCPU"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"."</span><span class="p">]</span>
          <span class="p">]</span>
          <span class="nx">period</span> <span class="o">=</span> <span class="mi">60</span>
          <span class="nx">stat</span>   <span class="o">=</span> <span class="s2">"Average"</span>
          <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
          <span class="nx">title</span>  <span class="o">=</span> <span class="s2">"Performance Insights - Database Load"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># CloudWatch alarms for RDS</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"rds_cpu"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-rds-high-cpu"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"CPUUtilization"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/RDS"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"80"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors RDS CPU utilization"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">DBInstanceIdentifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"rds_connections"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-rds-high-connections"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span>          <span class="o">=</span> <span class="s2">"connections_percentage"</span>
    <span class="nx">expression</span>  <span class="o">=</span> <span class="s2">"(connections / max_connections) * 100"</span>
    <span class="nx">label</span>       <span class="o">=</span> <span class="s2">"Connection Percentage"</span>
    <span class="nx">return_data</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="s2">"connections"</span>
    
    <span class="nx">metric</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"DatabaseConnections"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"AWS/RDS"</span>
      <span class="nx">period</span>      <span class="o">=</span> <span class="mi">300</span>
      <span class="nx">stat</span>        <span class="o">=</span> <span class="s2">"Average"</span>
      
      <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">DBInstanceIdentifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">metric_query</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="s2">"max_connections"</span>
    
    <span class="nx">metric</span> <span class="p">{</span>
      <span class="nx">metric_name</span> <span class="o">=</span> <span class="s2">"MaxConnections"</span>
      <span class="nx">namespace</span>   <span class="o">=</span> <span class="s2">"AWS/RDS"</span>
      <span class="nx">period</span>      <span class="o">=</span> <span class="mi">300</span>
      <span class="nx">stat</span>        <span class="o">=</span> <span class="s2">"Average"</span>
      
      <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">DBInstanceIdentifier</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="mi">80</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"RDS connection usage above 80%"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Lambda function for Performance Insights analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"pi_analyzer"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"pi_analyzer.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-performance-insights-analyzer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">pi_analyzer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">300</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">1024</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">DB_INSTANCE_ID</span> <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">SNS_TOPIC_ARN</span>  <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">alerts</span><span class="p">.</span><span class="nx">arn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:lambda:${var.aws_region}:336392948345:layer:AWSSDKPandas-Python39:1"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule to trigger Performance Insights analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"pi_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-pi-analysis"</span>
  <span class="nx">description</span>         <span class="o">=</span> <span class="s2">"Trigger Performance Insights analysis"</span>
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"rate(1 hour)"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"pi_analyzer"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">pi_analysis</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"PIAnalyzer"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">pi_analyzer</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_permission"</span> <span class="s2">"pi_analyzer"</span> <span class="p">{</span>
  <span class="nx">statement_id</span>  <span class="o">=</span> <span class="s2">"AllowExecutionFromCloudWatch"</span>
  <span class="nx">action</span>        <span class="o">=</span> <span class="s2">"lambda:InvokeFunction"</span>
  <span class="nx">function_name</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">pi_analyzer</span><span class="p">.</span><span class="nx">function_name</span>
  <span class="nx">principal</span>     <span class="o">=</span> <span class="s2">"events.amazonaws.com"</span>
  <span class="nx">source_arn</span>    <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">pi_analysis</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># RDS automated backups to another region</span>
<span class="nx">resource</span> <span class="s2">"aws_db_instance_automated_backups_replication"</span> <span class="s2">"cross_region"</span> <span class="p">{</span>
  <span class="nx">count</span>                      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_cross_region_backup</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="nx">source_db_instance_arn</span>     <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">kms_key_id</span>                 <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">backup_region</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">retention_period</span>           <span class="o">=</span> <span class="mi">7</span>
  
  <span class="nx">provider</span> <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">backup_region</span>
<span class="p">}</span>

<span class="c1"># Database Activity Streams</span>
<span class="nx">resource</span> <span class="s2">"aws_db_activity_stream"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_activity_stream</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
  
  <span class="nx">resource_arn</span>                        <span class="o">=</span> <span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">mode</span>                                <span class="o">=</span> <span class="s2">"async"</span>
  <span class="nx">kms_key_id</span>                          <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">activity_stream</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">engine_native_audit_fields_included</span> <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_db_instance</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-best-practices">Security Best Practices</h2>

<h3 id="aws-security-hub-and-compliance">AWS Security Hub and Compliance</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># security-hub.tf - Security Hub configuration and custom checks</span>

<span class="c1"># Enable Security Hub</span>
<span class="nx">resource</span> <span class="s2">"aws_securityhub_account"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_organizations_organization</span><span class="p">.</span><span class="nx">main</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Enable security standards</span>
<span class="nx">resource</span> <span class="s2">"aws_securityhub_standards_subscription"</span> <span class="s2">"cis"</span> <span class="p">{</span>
  <span class="nx">standards_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}::standards/cis-aws-foundations-benchmark/v/1.4.0"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_securityhub_standards_subscription"</span> <span class="s2">"pci_dss"</span> <span class="p">{</span>
  <span class="nx">standards_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}::standards/pci-dss/v/3.2.1"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_securityhub_standards_subscription"</span> <span class="s2">"aws_foundational"</span> <span class="p">{</span>
  <span class="nx">standards_arn</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}::standards/aws-foundational-security-best-practices/v/1.0.0"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Custom Security Hub action</span>
<span class="nx">resource</span> <span class="s2">"aws_securityhub_action_target"</span> <span class="s2">"remediate"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"Remediate"</span>
  <span class="nx">identifier</span>  <span class="o">=</span> <span class="s2">"Remediate"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Trigger automated remediation"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_securityhub_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Lambda for custom security checks</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"security_checker"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"security_checker.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-custom-security-checks"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">security_checker</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">3008</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">SECURITY_HUB_PRODUCT_ARN</span> <span class="o">=</span> <span class="s2">"arn:aws:securityhub:${var.aws_region}:${data.aws_caller_identity.current.account_id}:product/${data.aws_caller_identity.current.account_id}/default"</span>
      <span class="nx">ENVIRONMENT</span>              <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">vpc_config</span> <span class="p">{</span>
    <span class="nx">subnet_ids</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">lambda</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule to trigger security checks</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"security_checks"</span> <span class="p">{</span>
  <span class="nx">name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-security-checks"</span>
  <span class="nx">description</span>         <span class="o">=</span> <span class="s2">"Trigger custom security checks"</span>
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"rate(6 hours)"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"security_checker"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">security_checks</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"SecurityChecker"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">security_checker</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># Config Rules for compliance</span>
<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"encrypted_volumes"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-encrypted-volumes"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"AWS"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="s2">"ENCRYPTED_VOLUMES"</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"restricted_ssh"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-restricted-ssh"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"AWS"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="s2">"INCOMING_SSH_DISABLED"</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"s3_bucket_encryption"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-s3-bucket-encryption"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"AWS"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="s2">"S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Custom Config rule with Lambda</span>
<span class="nx">resource</span> <span class="s2">"aws_config_config_rule"</span> <span class="s2">"custom_security_check"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-custom-security-check"</span>
  
  <span class="nx">source</span> <span class="p">{</span>
    <span class="nx">owner</span>             <span class="o">=</span> <span class="s2">"LAMBDA"</span>
    <span class="nx">source_identifier</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">config_rule_evaluator</span><span class="p">.</span><span class="nx">arn</span>
    
    <span class="nx">source_detail</span> <span class="p">{</span>
      <span class="nx">message_type</span> <span class="o">=</span> <span class="s2">"ConfigurationItemChangeNotification"</span>
    <span class="p">}</span>
    
    <span class="nx">source_detail</span> <span class="p">{</span>
      <span class="nx">message_type</span> <span class="o">=</span> <span class="s2">"OversizedConfigurationItemChangeNotification"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_config_configuration_recorder</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># GuardDuty configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_guardduty_detector"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">enable</span>                       <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">finding_publishing_frequency</span> <span class="o">=</span> <span class="s2">"FIFTEEN_MINUTES"</span>
  
  <span class="nx">datasources</span> <span class="p">{</span>
    <span class="nx">s3_logs</span> <span class="p">{</span>
      <span class="nx">enable</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="nx">kubernetes</span> <span class="p">{</span>
      <span class="nx">audit_logs</span> <span class="p">{</span>
        <span class="nx">enable</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">malware_protection</span> <span class="p">{</span>
      <span class="nx">scan_ec2_instance_with_findings</span> <span class="p">{</span>
        <span class="nx">ebs_volumes</span> <span class="p">{</span>
          <span class="nx">enable</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># GuardDuty threat intelligence sets</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"threat_intel"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-threat-intel-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_versioning"</span> <span class="s2">"threat_intel"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">threat_intel</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">versioning_configuration</span> <span class="p">{</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_object"</span> <span class="s2">"threat_list"</span> <span class="p">{</span>
  <span class="nx">bucket</span>  <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">threat_intel</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">key</span>     <span class="o">=</span> <span class="s2">"threat-lists/malicious-ips.txt"</span>
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">file</span><span class="p">(</span><span class="s2">"${path.module}/threat-lists/malicious-ips.txt"</span><span class="p">)</span>
  <span class="nx">etag</span>    <span class="o">=</span> <span class="nx">filemd5</span><span class="p">(</span><span class="s2">"${path.module}/threat-lists/malicious-ips.txt"</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_guardduty_threatintelset"</span> <span class="s2">"malicious_ips"</span> <span class="p">{</span>
  <span class="nx">activate</span>    <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">detector_id</span> <span class="o">=</span> <span class="nx">aws_guardduty_detector</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">format</span>      <span class="o">=</span> <span class="s2">"TXT"</span>
  <span class="nx">location</span>    <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.threat_intel.id}/${aws_s3_object.threat_list.key}"</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"malicious-ips"</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_s3_object</span><span class="p">.</span><span class="nx">threat_list</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># GuardDuty member accounts</span>
<span class="nx">resource</span> <span class="s2">"aws_guardduty_member"</span> <span class="s2">"member_accounts"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">member_accounts</span>
  
  <span class="nx">account_id</span>                 <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">account_id</span>
  <span class="nx">detector_id</span>                <span class="o">=</span> <span class="nx">aws_guardduty_detector</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">email</span>                      <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">email</span>
  <span class="nx">invite</span>                     <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">invitation_message</span>         <span class="o">=</span> <span class="s2">"You are invited to join GuardDuty"</span>
  <span class="nx">disable_email_notification</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1"># Inspector v2</span>
<span class="nx">resource</span> <span class="s2">"aws_inspector2_enabler"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">account_ids</span>    <span class="o">=</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">aws_caller_identity</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">account_id</span><span class="p">]</span>
  <span class="nx">resource_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"EC2"</span><span class="p">,</span> <span class="s2">"ECR"</span><span class="p">,</span> <span class="s2">"LAMBDA"</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Macie for S3 data protection</span>
<span class="nx">resource</span> <span class="s2">"aws_macie2_account"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">finding_publishing_frequency</span> <span class="o">=</span> <span class="s2">"FIFTEEN_MINUTES"</span>
  <span class="nx">status</span>                       <span class="o">=</span> <span class="s2">"ENABLED"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_macie2_classification_job"</span> <span class="s2">"s3_scan"</span> <span class="p">{</span>
  <span class="nx">job_type</span> <span class="o">=</span> <span class="s2">"ONE_TIME"</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-s3-sensitive-data-scan"</span>
  
  <span class="nx">s3_job_definition</span> <span class="p">{</span>
    <span class="nx">bucket_definitions</span> <span class="p">{</span>
      <span class="nx">account_id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_caller_identity</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">account_id</span>
      <span class="nx">buckets</span>    <span class="o">=</span> <span class="p">[</span><span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_macie2_account</span><span class="p">.</span><span class="nx">main</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Access Analyzer</span>
<span class="nx">resource</span> <span class="s2">"aws_accessanalyzer_analyzer"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">analyzer_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-access-analyzer"</span>
  <span class="nx">type</span>          <span class="o">=</span> <span class="s2">"ACCOUNT"</span>  <span class="c1"># or "ORGANIZATION"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Systems Manager compliance</span>
<span class="nx">resource</span> <span class="s2">"aws_ssm_association"</span> <span class="s2">"patch_baseline"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"AWS-RunPatchBaseline"</span>
  
  <span class="nx">targets</span> <span class="p">{</span>
    <span class="nx">key</span>    <span class="o">=</span> <span class="s2">"tag:Environment"</span>
    <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">environment</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"cron(0 2 ? * SUN *)"</span>
  
  <span class="nx">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Operation</span>    <span class="o">=</span> <span class="s2">"Install"</span>
    <span class="nx">RebootOption</span> <span class="o">=</span> <span class="s2">"RebootIfNeeded"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># KMS key policies for security</span>
<span class="nx">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"kms_key_policy"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">sid</span>    <span class="o">=</span> <span class="s2">"Enable IAM User Permissions"</span>
    <span class="nx">effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
    
    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"AWS"</span>
      <span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">actions</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"kms:*"</span><span class="p">]</span>
    <span class="nx">resources</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">sid</span>    <span class="o">=</span> <span class="s2">"Allow use of the key for encryption"</span>
    <span class="nx">effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
    
    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"Service"</span>
      <span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"logs.${var.aws_region}.amazonaws.com"</span><span class="p">,</span>
        <span class="s2">"s3.amazonaws.com"</span><span class="p">,</span>
        <span class="s2">"rds.amazonaws.com"</span>
      <span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">actions</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">"kms:Decrypt"</span><span class="p">,</span>
      <span class="s2">"kms:GenerateDataKey"</span><span class="p">,</span>
      <span class="s2">"kms:CreateGrant"</span><span class="p">,</span>
      <span class="s2">"kms:DescribeKey"</span>
    <span class="p">]</span>
    
    <span class="nx">resources</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"*"</span><span class="p">]</span>
    
    <span class="nx">condition</span> <span class="p">{</span>
      <span class="nx">test</span>     <span class="o">=</span> <span class="s2">"StringEquals"</span>
      <span class="nx">variable</span> <span class="o">=</span> <span class="s2">"kms:ViaService"</span>
      <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"s3.${var.aws_region}.amazonaws.com"</span><span class="p">,</span>
        <span class="s2">"rds.${var.aws_region}.amazonaws.com"</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_kms_key"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">description</span>             <span class="o">=</span> <span class="s2">"${var.environment} master key"</span>
  <span class="nx">deletion_window_in_days</span> <span class="o">=</span> <span class="mi">30</span>
  <span class="nx">enable_key_rotation</span>     <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">policy</span>                  <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_iam_policy_document</span><span class="p">.</span><span class="nx">kms_key_policy</span><span class="p">.</span><span class="nx">json</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Security automation with EventBridge and Lambda</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"security_findings"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-security-findings"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Capture Security Hub findings for automated remediation"</span>
  
  <span class="nx">event_pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">source</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"aws.securityhub"</span><span class="p">]</span>
    <span class="nx">detail-type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Security Hub Findings - Imported"</span><span class="p">]</span>
    <span class="nx">detail</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">findings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Severity</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"CRITICAL"</span><span class="p">,</span> <span class="s2">"HIGH"</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">Workflow</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Status</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"NEW"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"remediation"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">security_findings</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"RemediationFunction"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">auto_remediation</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"auto_remediation"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"auto_remediation.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-security-auto-remediation"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">remediation</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">300</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ENVIRONMENT</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># WAF rules for application protection</span>
<span class="nx">resource</span> <span class="s2">"aws_wafv2_web_acl"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>  <span class="o">=</span> <span class="s2">"${var.environment}-waf-acl"</span>
  <span class="nx">scope</span> <span class="o">=</span> <span class="s2">"REGIONAL"</span>  <span class="c1"># or "CLOUDFRONT"</span>
  
  <span class="nx">default_action</span> <span class="p">{</span>
    <span class="nx">allow</span> <span class="p">{}</span>
  <span class="p">}</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"RateLimitRule"</span>
    <span class="nx">priority</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="nx">statement</span> <span class="p">{</span>
      <span class="nx">rate_based_statement</span> <span class="p">{</span>
        <span class="nx">limit</span>              <span class="o">=</span> <span class="mi">2000</span>
        <span class="nx">aggregate_key_type</span> <span class="o">=</span> <span class="s2">"IP"</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">action</span> <span class="p">{</span>
      <span class="nx">block</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="nx">visibility_config</span> <span class="p">{</span>
      <span class="nx">cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">metric_name</span>                <span class="o">=</span> <span class="s2">"RateLimitRule"</span>
      <span class="nx">sampled_requests_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"ManagedRuleGroup"</span>
    <span class="nx">priority</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="nx">override_action</span> <span class="p">{</span>
      <span class="nx">none</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="nx">statement</span> <span class="p">{</span>
      <span class="nx">managed_rule_group_statement</span> <span class="p">{</span>
        <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"AWSManagedRulesKnownBadInputsRuleSet"</span>
        <span class="nx">vendor_name</span> <span class="o">=</span> <span class="s2">"AWS"</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">visibility_config</span> <span class="p">{</span>
      <span class="nx">cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">metric_name</span>                <span class="o">=</span> <span class="s2">"ManagedRuleGroup"</span>
      <span class="nx">sampled_requests_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">visibility_config</span> <span class="p">{</span>
    <span class="nx">cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">metric_name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-waf-acl"</span>
    <span class="nx">sampled_requests_enabled</span>   <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="cost-optimization-strategies">Cost Optimization Strategies</h2>

<h3 id="advanced-cost-management">Advanced Cost Management</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cost-optimization.tf - Cost management and optimization</span>

<span class="c1"># Cost anomaly detection</span>
<span class="nx">resource</span> <span class="s2">"aws_ce_anomaly_monitor"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"${var.environment}-cost-anomaly-monitor"</span>
  <span class="nx">monitor_type</span>      <span class="o">=</span> <span class="s2">"DIMENSIONAL"</span>
  <span class="nx">monitor_dimension</span> <span class="o">=</span> <span class="s2">"SERVICE"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_ce_anomaly_subscription"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>      <span class="o">=</span> <span class="s2">"${var.environment}-cost-anomaly-subscription"</span>
  <span class="nx">threshold</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># USD</span>
  <span class="nx">frequency</span> <span class="o">=</span> <span class="s2">"DAILY"</span>
  
  <span class="nx">monitor_arn_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">aws_ce_anomaly_monitor</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">]</span>
  
  <span class="nx">subscriber</span> <span class="p">{</span>
    <span class="nx">type</span>    <span class="o">=</span> <span class="s2">"EMAIL"</span>
    <span class="nx">address</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span>
  <span class="p">}</span>
  
  <span class="nx">subscriber</span> <span class="p">{</span>
    <span class="nx">type</span>    <span class="o">=</span> <span class="s2">"SNS"</span>
    <span class="nx">address</span> <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Budget alerts</span>
<span class="nx">resource</span> <span class="s2">"aws_budgets_budget"</span> <span class="s2">"monthly"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"${var.environment}-monthly-budget"</span>
  <span class="nx">budget_type</span>       <span class="o">=</span> <span class="s2">"COST"</span>
  <span class="nx">limit_amount</span>      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">monthly_budget_limit</span>
  <span class="nx">limit_unit</span>        <span class="o">=</span> <span class="s2">"USD"</span>
  <span class="nx">time_unit</span>         <span class="o">=</span> <span class="s2">"MONTHLY"</span>
  <span class="nx">time_period_start</span> <span class="o">=</span> <span class="s2">"2024-01-01_00:00"</span>
  
  <span class="nx">cost_types</span> <span class="p">{</span>
    <span class="nx">include_credit</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_discount</span>           <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_other_subscription</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_recurring</span>          <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_refund</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_subscription</span>       <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_support</span>            <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_tax</span>                <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_upfront</span>            <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">use_blended</span>                <span class="o">=</span> <span class="kc">false</span>
  <span class="err">}</span>
  
  <span class="nx">notification</span> <span class="p">{</span>
    <span class="nx">comparison_operator</span>        <span class="o">=</span> <span class="s2">"GREATER_THAN"</span>
    <span class="nx">threshold</span>                  <span class="o">=</span> <span class="mi">80</span>
    <span class="nx">threshold_type</span>             <span class="o">=</span> <span class="s2">"PERCENTAGE"</span>
    <span class="nx">notification_type</span>          <span class="o">=</span> <span class="s2">"FORECASTED"</span>
    <span class="nx">subscriber_email_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span><span class="p">]</span>
    <span class="nx">subscriber_sns_topic_arns</span>  <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">notification</span> <span class="p">{</span>
    <span class="nx">comparison_operator</span>        <span class="o">=</span> <span class="s2">"GREATER_THAN"</span>
    <span class="nx">threshold</span>                  <span class="o">=</span> <span class="mi">100</span>
    <span class="nx">threshold_type</span>             <span class="o">=</span> <span class="s2">"PERCENTAGE"</span>
    <span class="nx">notification_type</span>          <span class="o">=</span> <span class="s2">"ACTUAL"</span>
    <span class="nx">subscriber_email_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span><span class="p">]</span>
    <span class="nx">subscriber_sns_topic_arns</span>  <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Service-specific budgets</span>
<span class="nx">resource</span> <span class="s2">"aws_budgets_budget"</span> <span class="s2">"service_budgets"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">service_budgets</span>
  
  <span class="nx">name</span>              <span class="o">=</span> <span class="s2">"${var.environment}-${each.key}-budget"</span>
  <span class="nx">budget_type</span>       <span class="o">=</span> <span class="s2">"COST"</span>
  <span class="nx">limit_amount</span>      <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">limit</span>
  <span class="nx">limit_unit</span>        <span class="o">=</span> <span class="s2">"USD"</span>
  <span class="nx">time_unit</span>         <span class="o">=</span> <span class="s2">"MONTHLY"</span>
  <span class="nx">time_period_start</span> <span class="o">=</span> <span class="s2">"2024-01-01_00:00"</span>
  
  <span class="nx">cost_filter</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"Service"</span>
    <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span><span class="nx">each</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">cost_types</span> <span class="p">{</span>
    <span class="nx">include_credit</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_discount</span>           <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_other_subscription</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_recurring</span>          <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_refund</span>             <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_subscription</span>       <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_support</span>            <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">include_tax</span>                <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">include_upfront</span>            <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">use_blended</span>                <span class="o">=</span> <span class="kc">false</span>
  <span class="err">}</span>
  
  <span class="nx">notification</span> <span class="p">{</span>
    <span class="nx">comparison_operator</span>        <span class="o">=</span> <span class="s2">"GREATER_THAN"</span>
    <span class="nx">threshold</span>                  <span class="o">=</span> <span class="mi">90</span>
    <span class="nx">threshold_type</span>             <span class="o">=</span> <span class="s2">"PERCENTAGE"</span>
    <span class="nx">notification_type</span>          <span class="o">=</span> <span class="s2">"ACTUAL"</span>
    <span class="nx">subscriber_email_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">cost_alert_email</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Compute Optimizer enrollment</span>
<span class="nx">resource</span> <span class="s2">"aws_organizations_policy"</span> <span class="s2">"compute_optimizer"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"ComputeOptimizerEnrollment"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Enable Compute Optimizer for all accounts"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"SERVICE_CONTROL_POLICY"</span>
  
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"compute-optimizer:*"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"*"</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Lambda for cost optimization recommendations</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"cost_optimizer"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"cost_optimizer.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-cost-optimizer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">cost_optimizer</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">3008</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">SNS_TOPIC_ARN</span>    <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_recommendations</span><span class="p">.</span><span class="nx">arn</span>
      <span class="nx">S3_BUCKET</span>        <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">ENVIRONMENT</span>      <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:lambda:${var.aws_region}:336392948345:layer:AWSSDKPandas-Python39:1"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule for weekly cost analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"cost_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-weekly-cost-analysis"</span>
  <span class="nx">description</span>         <span class="o">=</span> <span class="s2">"Trigger weekly cost analysis"</span>
  <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"cron(0 9 ? * MON *)"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"cost_optimizer"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">cost_analysis</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"CostOptimizer"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">cost_optimizer</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># Cost and Usage Report</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"cost_reports"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-cost-reports-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_policy"</span> <span class="s2">"cost_reports"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"billingreports.amazonaws.com"</span>
        <span class="p">}</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s2">"s3:GetBucketAcl"</span><span class="p">,</span>
          <span class="s2">"s3:GetBucketPolicy"</span>
        <span class="p">]</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">arn</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"billingreports.amazonaws.com"</span>
        <span class="p">}</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"s3:PutObject"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"${aws_s3_bucket.cost_reports.arn}/*"</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cur_report_definition"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">report_name</span>                <span class="o">=</span> <span class="s2">"${var.environment}-cost-usage-report"</span>
  <span class="nx">time_unit</span>                  <span class="o">=</span> <span class="s2">"DAILY"</span>
  <span class="nx">format</span>                     <span class="o">=</span> <span class="s2">"Parquet"</span>
  <span class="nx">compression</span>                <span class="o">=</span> <span class="s2">"Parquet"</span>
  <span class="nx">additional_schema_elements</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"RESOURCES"</span><span class="p">]</span>
  <span class="nx">s3_bucket</span>                  <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="err">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">s3_prefix</span>                  <span class="o">=</span> <span class="s2">"cur"</span>
  <span class="nx">s3_region</span>                  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
  <span class="nx">additional_artifacts</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">"QUICKSIGHT"</span><span class="p">]</span>
  <span class="nx">report_versioning</span>          <span class="o">=</span> <span class="s2">"OVERWRITE_REPORT"</span>
<span class="p">}</span>

<span class="c1"># Reserved Instance utilization alerts</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"ri_utilization"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-low-ri-utilization"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"LessThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"1"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"ReservedInstanceUtilization"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/CE"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"86400"</span>  <span class="c1"># 24 hours</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"75"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"Reserved Instance utilization below 75%"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Currency</span> <span class="o">=</span> <span class="s2">"USD"</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Savings Plans utilization alerts</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"sp_utilization"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-low-sp-utilization"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"LessThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"1"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"SavingsPlansUtilization"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/CE"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"86400"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"90"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"Savings Plans utilization below 90%"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">cost_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
<span class="err">}</span>

<span class="c1"># Cost allocation tags</span>
<span class="nx">resource</span> <span class="s2">"aws_organizations_policy"</span> <span class="s2">"tagging"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"MandatoryTaggingPolicy"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Enforce cost allocation tags"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="s2">"TAG_POLICY"</span>
  
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">Environment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">tag_key</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="s2">"Environment"</span>
        <span class="p">}</span>
        <span class="nx">tag_value</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"Production"</span><span class="p">,</span> <span class="s2">"Staging"</span><span class="p">,</span> <span class="s2">"Development"</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">enforced_for</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ec2:instance"</span><span class="p">,</span> <span class="s2">"s3:bucket"</span><span class="p">,</span> <span class="s2">"rds:db"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">CostCenter</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">tag_key</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="s2">"CostCenter"</span>
        <span class="p">}</span>
        <span class="nx">enforced_for</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ec2:*"</span><span class="p">,</span> <span class="s2">"s3:*"</span><span class="p">,</span> <span class="s2">"rds:*"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">Project</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">tag_key</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="s2">"Project"</span>
        <span class="p">}</span>
        <span class="nx">enforced_for</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"@@assign"</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ec2:*"</span><span class="p">,</span> <span class="s2">"s3:*"</span><span class="p">,</span> <span class="s2">"rds:*"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Attach tagging policy to organization</span>
<span class="nx">resource</span> <span class="s2">"aws_organizations_policy_attachment"</span> <span class="s2">"tagging"</span> <span class="p">{</span>
  <span class="nx">policy_id</span> <span class="o">=</span> <span class="nx">aws_organizations_policy</span><span class="p">.</span><span class="nx">tagging</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="nx">aws_organizations_organization</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span>
<span class="p">}</span>

<span class="c1"># Instance Scheduler for non-production environments</span>
<span class="nx">module</span> <span class="s2">"instance_scheduler"</span> <span class="p">{</span>
  <span class="nx">source</span>  <span class="o">=</span> <span class="s2">"aws-ia/instance-scheduler/aws"</span>
  <span class="nx">version</span> <span class="o">=</span> <span class="s2">"2.0.0"</span>
  
  <span class="nx">scheduler_frequency</span> <span class="o">=</span> <span class="s2">"5"</span>
  
  <span class="nx">schedules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"business-hours"</span>
      <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Run instances during business hours only"</span>
      <span class="nx">timezone</span>    <span class="o">=</span> <span class="s2">"America/New_York"</span>
      
      <span class="nx">periods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"weekdays"</span>
          <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Monday to Friday"</span>
          <span class="nx">begintime</span>   <span class="o">=</span> <span class="s2">"08:00"</span>
          <span class="nx">endtime</span>     <span class="o">=</span> <span class="s2">"18:00"</span>
          <span class="nx">weekdays</span>    <span class="o">=</span> <span class="s2">"mon-fri"</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
  
  <span class="nx">tag_name</span> <span class="o">=</span> <span class="s2">"Schedule"</span>
<span class="p">}</span>

<span class="c1"># Spot Instance configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_launch_template"</span> <span class="s2">"spot"</span> <span class="p">{</span>
  <span class="nx">name_prefix</span> <span class="o">=</span> <span class="s2">"${var.environment}-spot-"</span>
  
  <span class="nx">instance_market_options</span> <span class="p">{</span>
    <span class="nx">market_type</span> <span class="o">=</span> <span class="s2">"spot"</span>
    
    <span class="nx">spot_options</span> <span class="p">{</span>
      <span class="nx">max_price</span>                      <span class="o">=</span> <span class="s2">"0.5"</span>  <span class="c1"># 50% of on-demand price</span>
      <span class="nx">spot_instance_type</span>             <span class="o">=</span> <span class="s2">"persistent"</span>
      <span class="nx">instance_interruption_behavior</span> <span class="o">=</span> <span class="s2">"stop"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tag_specifications</span> <span class="p">{</span>
    <span class="nx">resource_type</span> <span class="o">=</span> <span class="s2">"instance"</span>
    
    <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">InstanceType</span> <span class="o">=</span> <span class="s2">"spot"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># S3 lifecycle policies for cost optimization</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_lifecycle_configuration"</span> <span class="s2">"logs"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">id</span>     <span class="o">=</span> <span class="s2">"transition-old-logs"</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
    
    <span class="nx">transition</span> <span class="p">{</span>
      <span class="nx">days</span>          <span class="o">=</span> <span class="mi">30</span>
      <span class="nx">storage_class</span> <span class="o">=</span> <span class="s2">"STANDARD_IA"</span>
    <span class="p">}</span>
    
    <span class="nx">transition</span> <span class="p">{</span>
      <span class="nx">days</span>          <span class="o">=</span> <span class="mi">90</span>
      <span class="nx">storage_class</span> <span class="o">=</span> <span class="s2">"GLACIER"</span>
    <span class="p">}</span>
    
    <span class="nx">transition</span> <span class="p">{</span>
      <span class="nx">days</span>          <span class="o">=</span> <span class="mi">180</span>
      <span class="nx">storage_class</span> <span class="o">=</span> <span class="s2">"DEEP_ARCHIVE"</span>
    <span class="p">}</span>
    
    <span class="nx">expiration</span> <span class="p">{</span>
      <span class="nx">days</span> <span class="o">=</span> <span class="mi">365</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">id</span>     <span class="o">=</span> <span class="s2">"delete-incomplete-uploads"</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
    
    <span class="nx">abort_incomplete_multipart_upload</span> <span class="p">{</span>
      <span class="nx">days_after_initiation</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Athena for cost analysis</span>
<span class="nx">resource</span> <span class="s2">"aws_athena_database"</span> <span class="s2">"cost_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span>   <span class="o">=</span> <span class="s2">"${var.environment}_cost_analysis"</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">cost_reports</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_athena_workgroup"</span> <span class="s2">"cost_analysis"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-cost-analysis"</span>
  
  <span class="nx">configuration</span> <span class="p">{</span>
    <span class="nx">enforce_workgroup_configuration</span>    <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">publish_cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">result_configuration</span> <span class="p">{</span>
      <span class="nx">output_location</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.cost_reports.id}/athena-results/"</span>
      
      <span class="nx">encryption_configuration</span> <span class="p">{</span>
        <span class="nx">encryption_option</span> <span class="o">=</span> <span class="s2">"SSE_S3"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># QuickSight for cost visualization</span>
<span class="nx">resource</span> <span class="s2">"aws_quicksight_data_source"</span> <span class="s2">"cost_data"</span> <span class="p">{</span>
  <span class="nx">data_source_id</span> <span class="o">=</span> <span class="s2">"${var.environment}-cost-data"</span>
  <span class="nx">name</span>           <span class="o">=</span> <span class="s2">"Cost and Usage Report"</span>
  
  <span class="nx">parameters</span> <span class="p">{</span>
    <span class="nx">athena</span> <span class="p">{</span>
      <span class="nx">work_group</span> <span class="o">=</span> <span class="nx">aws_athena_workgroup</span><span class="p">.</span><span class="nx">cost_analysis</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">type</span> <span class="o">=</span> <span class="s2">"ATHENA"</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    for key in tag_schema.keys():
        self.ce_client.create_cost_category_definition(
            Name=f'CostCategory-{key}',
            Rules=[
                {
                    'Value': value,
                    'Rule': {
                        'Tags': {
                            'Key': key,
                            'Values': [value]
                        }
                    }
                } for value in tag_schema[key]
            ]
        )
</code></pre></div></div>

<h1 id="spot-instance-management">Spot Instance management</h1>
<p>class SpotInstanceManager:
    def <strong>init</strong>(self):
        self.ec2 = boto3.client(‘ec2’)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def create_spot_fleet(self,
                     target_capacity: int,
                     instance_types: List[str],
                     max_price: str,
                     subnets: List[str]) -&gt; str:
    """Create diversified Spot Fleet"""
    
    # Build launch specifications for each instance type
    launch_specs = []
    
    for instance_type in instance_types:
        for subnet in subnets:
            launch_specs.append({
                'InstanceType': instance_type,
                'ImageId': 'ami-12345678',  # Your AMI
                'KeyName': 'your-key-pair',
                'SecurityGroups': [{'GroupId': 'sg-12345678'}],
                'SubnetId': subnet,
                'IamInstanceProfile': {
                    'Arn': 'arn:aws:iam::account:instance-profile/role'
                },
                'TagSpecifications': [
                    {
                        'ResourceType': 'instance',
                        'Tags': [
                            {'Key': 'Name', 'Value': 'SpotFleet-Instance'},
                            {'Key': 'Type', 'Value': 'Spot'}
                        ]
                    }
                ]
            })
    
    response = self.ec2.request_spot_fleet(
        SpotFleetRequestConfig={
            'AllocationStrategy': 'diversified',
            'TargetCapacity': target_capacity,
            'SpotPrice': max_price,
            'IamFleetRole': 'arn:aws:iam::account:role/aws-ec2-spot-fleet-role',
            'LaunchSpecifications': launch_specs,
            'TerminateInstancesWithExpiration': True,
            'Type': 'maintain',
            'ReplaceUnhealthyInstances': True,
            'InstanceInterruptionBehavior': 'terminate',
            'TagSpecifications': [
                {
                    'ResourceType': 'spot-fleet-request',
                    'Tags': [
                        {'Key': 'Name', 'Value': 'MySpotFleet'}
                    ]
                }
            ]
        }
    )
    
    return response['SpotFleetRequestId'] ```
</code></pre></div></div>

<h2 id="emerging-services-and-research">Emerging Services and Research</h2>

<h3 id="aws-quantum-computing-and-braket">AWS Quantum Computing and Braket</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># quantum-computing.tf - AWS Braket quantum computing resources</span>

<span class="c1"># S3 bucket for quantum task results</span>
<span class="nx">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"quantum_results"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"${var.environment}-quantum-results-${data.aws_caller_identity.current.account_id}"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_versioning"</span> <span class="s2">"quantum_results"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">versioning_configuration</span> <span class="p">{</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s2">"Enabled"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_server_side_encryption_configuration"</span> <span class="s2">"quantum_results"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">apply_server_side_encryption_by_default</span> <span class="p">{</span>
      <span class="nx">sse_algorithm</span> <span class="o">=</span> <span class="s2">"AES256"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># IAM role for Braket</span>
<span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"braket"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-braket-role"</span>
  
  <span class="nx">assume_role_policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"sts:AssumeRole"</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"braket.amazonaws.com"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy"</span> <span class="s2">"braket"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-braket-policy"</span>
  <span class="nx">role</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">braket</span><span class="p">.</span><span class="nx">id</span>
  
  <span class="nx">policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s2">"s3:PutObject"</span><span class="p">,</span>
          <span class="s2">"s3:GetObject"</span><span class="p">,</span>
          <span class="s2">"s3:ListBucket"</span>
        <span class="p">]</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="p">[</span>
          <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">arn</span><span class="p">,</span>
          <span class="s2">"${aws_s3_bucket.quantum_results.arn}/*"</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Lambda function for quantum circuit execution</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"quantum_processor"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"quantum_processor.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-quantum-processor"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">quantum_lambda</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"index.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">3008</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">QUANTUM_RESULTS_BUCKET</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">ENVIRONMENT</span>           <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:lambda:${var.aws_region}:${data.aws_caller_identity.current.account_id}:layer:AmazonBraket:1"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># EventBridge rule for quantum task monitoring</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_rule"</span> <span class="s2">"quantum_task_state_change"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"${var.environment}-quantum-task-state-change"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Capture Braket quantum task state changes"</span>
  
  <span class="nx">event_pattern</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">source</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"aws.braket"</span><span class="p">]</span>
    <span class="nx">detail-type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Braket Task State Change"</span><span class="p">]</span>
    <span class="nx">detail</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">status</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"COMPLETED"</span><span class="p">,</span> <span class="s2">"FAILED"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_event_target"</span> <span class="s2">"quantum_notification"</span> <span class="p">{</span>
  <span class="nx">rule</span>      <span class="o">=</span> <span class="nx">aws_cloudwatch_event_rule</span><span class="p">.</span><span class="nx">quantum_task_state_change</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">target_id</span> <span class="o">=</span> <span class="s2">"QuantumNotification"</span>
  <span class="nx">arn</span>       <span class="o">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">quantum_notifications</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>

<span class="c1"># SNS topic for quantum task notifications</span>
<span class="nx">resource</span> <span class="s2">"aws_sns_topic"</span> <span class="s2">"quantum_notifications"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-quantum-notifications"</span>
  
  <span class="nx">kms_master_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sns</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="c1"># Lambda for quantum-classical hybrid algorithms</span>
<span class="nx">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"quantum_hybrid"</span> <span class="p">{</span>
  <span class="nx">filename</span>         <span class="o">=</span> <span class="s2">"quantum_hybrid.zip"</span>
  <span class="nx">function_name</span>    <span class="o">=</span> <span class="s2">"${var.environment}-quantum-hybrid-optimizer"</span>
  <span class="nx">role</span>            <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">quantum_lambda</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">handler</span>         <span class="o">=</span> <span class="s2">"vqe_optimizer.handler"</span>
  <span class="nx">runtime</span>         <span class="o">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">timeout</span>         <span class="o">=</span> <span class="mi">900</span>
  <span class="nx">memory_size</span>     <span class="o">=</span> <span class="mi">10240</span>  <span class="c1"># 10GB for optimization tasks</span>
  
  <span class="nx">ephemeral_storage</span> <span class="p">{</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="mi">10240</span>  <span class="c1"># 10GB</span>
  <span class="p">}</span>
  
  <span class="nx">environment</span> <span class="p">{</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">QUANTUM_DEVICE_ARN</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">quantum_device_arn</span>
      <span class="nx">S3_BUCKET</span>         <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">MAX_ITERATIONS</span>    <span class="o">=</span> <span class="s2">"100"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">vpc_config</span> <span class="p">{</span>
    <span class="nx">subnet_ids</span>         <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">lambda</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Step Functions for quantum workflow orchestration</span>
<span class="nx">resource</span> <span class="s2">"aws_sfn_state_machine"</span> <span class="s2">"quantum_workflow"</span> <span class="p">{</span>
  <span class="nx">name</span>     <span class="o">=</span> <span class="s2">"${var.environment}-quantum-workflow"</span>
  <span class="nx">role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">step_functions</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Comment</span> <span class="o">=</span> <span class="s2">"Quantum-Classical Hybrid Workflow"</span>
    <span class="nx">StartAt</span> <span class="o">=</span> <span class="s2">"PrepareQuantumCircuit"</span>
    <span class="nx">States</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">PrepareQuantumCircuit</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::lambda:invoke"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">FunctionName</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">quantum_processor</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">Payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"action"</span> <span class="p">=</span> <span class="s2">"prepare_circuit"</span>
            <span class="s2">"parameters.$"</span> <span class="p">=</span> <span class="s2">"$.circuit_params"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.circuit"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"SubmitQuantumTask"</span>
      <span class="p">}</span>
      
      <span class="nx">SubmitQuantumTask</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:braket:createQuantumTask"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">DeviceArn</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">quantum_device_arn</span>
          <span class="nx">OutputS3Bucket</span> <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">quantum_results</span><span class="p">.</span><span class="nx">id</span>
          <span class="nx">OutputS3KeyPrefix</span> <span class="o">=</span> <span class="s2">"tasks/"</span>
          <span class="nx">Shots</span> <span class="o">=</span> <span class="mi">1000</span>
          <span class="nx">Action</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"BraketSchemaHeader"</span> <span class="p">=</span> <span class="p">{</span>
              <span class="s2">"name"</span> <span class="p">=</span> <span class="s2">"braket.ir.jaqcd.program"</span>
              <span class="s2">"version"</span> <span class="p">=</span> <span class="s2">"1.0"</span>
            <span class="p">}</span>
            <span class="s2">"instructions.$"</span> <span class="p">=</span> <span class="s2">"$.circuit.instructions"</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">ResultPath</span> <span class="o">=</span> <span class="s2">"$.quantumTask"</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"WaitForQuantumTask"</span>
      <span class="p">}</span>
      
      <span class="nx">WaitForQuantumTask</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Wait"</span>
        <span class="nx">Seconds</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"GetQuantumTaskStatus"</span>
      <span class="p">}</span>
      
      <span class="nx">GetQuantumTaskStatus</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="s2">"arn:aws:states:::aws-sdk:braket:getQuantumTask"</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"QuantumTaskArn.$"</span> <span class="p">=</span> <span class="s2">"$.quantumTask.QuantumTaskArn"</span>
        <span class="p">}</span>
        <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"CheckTaskComplete"</span>
      <span class="p">}</span>
      
      <span class="nx">CheckTaskComplete</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Choice"</span>
        <span class="nx">Choices</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">Variable</span> <span class="o">=</span> <span class="s2">"$.Status"</span>
            <span class="nx">StringEquals</span> <span class="o">=</span> <span class="s2">"COMPLETED"</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"ProcessResults"</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">Variable</span> <span class="o">=</span> <span class="s2">"$.Status"</span>
            <span class="nx">StringEquals</span> <span class="o">=</span> <span class="s2">"FAILED"</span>
            <span class="nx">Next</span> <span class="o">=</span> <span class="s2">"HandleFailure"</span>
          <span class="p">}</span>
        <span class="p">]</span>
        <span class="nx">Default</span> <span class="o">=</span> <span class="s2">"WaitForQuantumTask"</span>
      <span class="p">}</span>
      
      <span class="nx">ProcessResults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Task"</span>
        <span class="nx">Resource</span> <span class="o">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">quantum_hybrid</span><span class="p">.</span><span class="nx">arn</span>
        <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">"action"</span> <span class="p">=</span> <span class="s2">"process_results"</span>
          <span class="s2">"results.$"</span> <span class="p">=</span> <span class="s2">"$.OutputS3Uri"</span>
        <span class="p">}</span>
        <span class="nx">End</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      
      <span class="nx">HandleFailure</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Fail"</span>
        <span class="nx">Cause</span> <span class="o">=</span> <span class="s2">"Quantum task failed"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="machine-learning-on-aws">Machine Learning on AWS</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sagemaker.tf - SageMaker MLOps infrastructure</span>

<span class="c1"># SageMaker execution role</span>
<span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"sagemaker_execution"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-sagemaker-execution-role"</span>
  
  <span class="nx">assume_role_policy</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2012-10-17"</span>
    <span class="nx">Statement</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Action</span> <span class="o">=</span> <span class="s2">"sts:AssumeRole"</span>
        <span class="nx">Effect</span> <span class="o">=</span> <span class="s2">"Allow"</span>
        <span class="nx">Principal</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">Service</span> <span class="o">=</span> <span class="s2">"sagemaker.amazonaws.com"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
  
  <span class="nx">managed_policy_arns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Feature Store</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_feature_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">feature_group_name</span>             <span class="o">=</span> <span class="s2">"${var.environment}-feature-group"</span>
  <span class="nx">record_identifier_feature_name</span> <span class="o">=</span> <span class="s2">"record_id"</span>
  <span class="nx">event_time_feature_name</span>        <span class="o">=</span> <span class="s2">"event_time"</span>
  <span class="nx">role_arn</span>                       <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"record_id"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"String"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"event_time"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"String"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"user_id"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"String"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"feature_1"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"Fractional"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"feature_2"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"Fractional"</span>
  <span class="p">}</span>
  
  <span class="nx">feature_definition</span> <span class="p">{</span>
    <span class="nx">feature_name</span> <span class="o">=</span> <span class="s2">"label"</span>
    <span class="nx">feature_type</span> <span class="o">=</span> <span class="s2">"Integral"</span>
  <span class="p">}</span>
  
  <span class="nx">online_store_config</span> <span class="p">{</span>
    <span class="nx">enable_online_store</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="nx">security_config</span> <span class="p">{</span>
      <span class="nx">kms_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">sagemaker</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">offline_store_config</span> <span class="p">{</span>
    <span class="nx">s3_storage_config</span> <span class="p">{</span>
      <span class="nx">s3_uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.feature_store.id}/offline-store"</span>
      
      <span class="nx">kms_key_id</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}</span>
    
    <span class="nx">data_catalog_config</span> <span class="p">{</span>
      <span class="nx">database</span>   <span class="o">=</span> <span class="nx">aws_glue_catalog_database</span><span class="p">.</span><span class="nx">feature_store</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">table_name</span> <span class="o">=</span> <span class="s2">"${var.environment}_features"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Model registry</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_model_package_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">model_package_group_name</span> <span class="o">=</span> <span class="s2">"${var.environment}-model-registry"</span>
  <span class="nx">model_package_group_description</span> <span class="o">=</span> <span class="s2">"Model registry for ML models"</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># SageMaker model</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_model"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-model"</span>
  <span class="nx">execution_role_arn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">primary_container</span> <span class="p">{</span>
    <span class="nx">image</span>          <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/ml-model:latest"</span>
    <span class="nx">model_data_url</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/model.tar.gz"</span>
    
    <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">SAGEMAKER_PROGRAM</span>           <span class="o">=</span> <span class="s2">"inference.py"</span>
      <span class="nx">SAGEMAKER_SUBMIT_DIRECTORY</span>  <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/code"</span>
      <span class="nx">SAGEMAKER_ENABLE_CLOUDWATCH_METRICS</span> <span class="o">=</span> <span class="s2">"true"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">vpc_config</span> <span class="p">{</span>
    <span class="nx">subnets</span>            <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_ids</span>
    <span class="nx">security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">sagemaker</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Multi-model endpoint configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_endpoint_configuration"</span> <span class="s2">"multi_model"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-multi-model-config"</span>
  
  <span class="nx">production_variants</span> <span class="p">{</span>
    <span class="nx">variant_name</span>           <span class="o">=</span> <span class="s2">"AllTraffic"</span>
    <span class="nx">model_name</span>            <span class="o">=</span> <span class="nx">aws_sagemaker_model</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">initial_instance_count</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">instance_type</span>         <span class="o">=</span> <span class="s2">"ml.m5.xlarge"</span>
    <span class="nx">initial_variant_weight</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># Enable multi-model</span>
    <span class="nx">model_data_download_timeout_in_seconds</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="nx">container_startup_health_check_timeout_in_seconds</span> <span class="o">=</span> <span class="mi">600</span>
  <span class="err">}</span>
  
  <span class="nx">data_capture_config</span> <span class="p">{</span>
    <span class="nx">enable_capture</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">initial_sampling_percentage</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="nx">destination_s3_uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.model_data_capture.id}/"</span>
    
    <span class="nx">capture_options</span> <span class="p">{</span>
      <span class="nx">capture_mode</span> <span class="o">=</span> <span class="s2">"Input"</span>
    <span class="p">}</span>
    
    <span class="nx">capture_options</span> <span class="p">{</span>
      <span class="nx">capture_mode</span> <span class="o">=</span> <span class="s2">"Output"</span>
    <span class="p">}</span>
    
    <span class="nx">capture_content_type_header</span> <span class="p">{</span>
      <span class="nx">json_content_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application/json"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># SageMaker endpoint</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_endpoint"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                 <span class="o">=</span> <span class="s2">"${var.environment}-endpoint"</span>
  <span class="nx">endpoint_config_name</span> <span class="o">=</span> <span class="nx">aws_sagemaker_endpoint_configuration</span><span class="p">.</span><span class="nx">multi_model</span><span class="p">.</span><span class="nx">name</span>
  
  <span class="nx">deployment_config</span> <span class="p">{</span>
    <span class="nx">blue_green_update_policy</span> <span class="p">{</span>
      <span class="nx">traffic_routing_configuration</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">"LINEAR"</span>
        <span class="nx">wait_interval_in_seconds</span> <span class="o">=</span> <span class="mi">300</span>
        
        <span class="nx">linear_step_size</span> <span class="p">{</span>
          <span class="nx">type</span>  <span class="o">=</span> <span class="s2">"INSTANCE_COUNT"</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">maximum_execution_timeout_in_seconds</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="p">}</span>
    
    <span class="nx">auto_rollback_configuration</span> <span class="p">{</span>
      <span class="nx">alarms</span> <span class="p">{</span>
        <span class="nx">alarm_name</span> <span class="o">=</span> <span class="nx">aws_cloudwatch_metric_alarm</span><span class="p">.</span><span class="nx">endpoint_error_rate</span><span class="p">.</span><span class="nx">alarm_name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Auto-scaling for SageMaker endpoint</span>
<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_target"</span> <span class="s2">"sagemaker_target"</span> <span class="p">{</span>
  <span class="nx">max_capacity</span>       <span class="o">=</span> <span class="mi">10</span>
  <span class="nx">min_capacity</span>       <span class="o">=</span> <span class="mi">2</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="s2">"endpoint/${aws_sagemaker_endpoint.main.name}/variant/AllTraffic"</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="s2">"sagemaker:variant:DesiredInstanceCount"</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="s2">"sagemaker"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_appautoscaling_policy"</span> <span class="s2">"sagemaker_target_tracking"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="o">=</span> <span class="s2">"${var.environment}-sagemaker-scaling"</span>
  <span class="nx">policy_type</span>        <span class="o">=</span> <span class="s2">"TargetTrackingScaling"</span>
  <span class="nx">resource_id</span>        <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sagemaker_target</span><span class="p">.</span><span class="nx">resource_id</span>
  <span class="nx">scalable_dimension</span> <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sagemaker_target</span><span class="p">.</span><span class="nx">scalable_dimension</span>
  <span class="nx">service_namespace</span>  <span class="o">=</span> <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sagemaker_target</span><span class="p">.</span><span class="nx">service_namespace</span>
  
  <span class="nx">target_tracking_scaling_policy_configuration</span> <span class="p">{</span>
    <span class="nx">predefined_metric_specification</span> <span class="p">{</span>
      <span class="nx">predefined_metric_type</span> <span class="o">=</span> <span class="s2">"SageMakerVariantInvocationsPerInstance"</span>
    <span class="p">}</span>
    
    <span class="nx">target_value</span> <span class="o">=</span> <span class="mf">70.0</span>
    <span class="nx">scale_in_cooldown</span>  <span class="o">=</span> <span class="mi">300</span>
    <span class="nx">scale_out_cooldown</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># SageMaker Pipeline</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_pipeline"</span> <span class="s2">"ml_pipeline"</span> <span class="p">{</span>
  <span class="nx">pipeline_name</span>         <span class="o">=</span> <span class="s2">"${var.environment}-ml-pipeline"</span>
  <span class="nx">pipeline_display_name</span> <span class="o">=</span> <span class="s2">"ML Training Pipeline"</span>
  <span class="nx">role_arn</span>             <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
  
  <span class="nx">pipeline_definition</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">Version</span> <span class="o">=</span> <span class="s2">"2020-12-01"</span>
    <span class="nx">Parameters</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"ProcessingInstanceCount"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Integer"</span>
        <span class="nx">DefaultValue</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"TrainingInstanceType"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"String"</span>
        <span class="nx">DefaultValue</span> <span class="o">=</span> <span class="s2">"ml.m5.xlarge"</span>
      <span class="p">}</span>
    <span class="p">]</span>
    <span class="nx">Steps</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"DataProcessing"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Processing"</span>
        <span class="nx">Arguments</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">ProcessingResources</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">ClusterConfig</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">InstanceCount</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Parameters.ProcessingInstanceCount"</span> <span class="p">}</span>
              <span class="nx">InstanceType</span> <span class="o">=</span> <span class="s2">"ml.m5.xlarge"</span>
              <span class="nx">VolumeSizeInGB</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">AppSpecification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">ImageUri</span> <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/processing:latest"</span>
          <span class="p">}</span>
          <span class="nx">RoleArn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">ProcessingInputs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">InputName</span> <span class="o">=</span> <span class="s2">"input-data"</span>
              <span class="nx">S3Input</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">S3Uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.training_data.id}/raw/"</span>
                <span class="nx">LocalPath</span> <span class="o">=</span> <span class="s2">"/opt/ml/processing/input"</span>
                <span class="nx">S3DataType</span> <span class="o">=</span> <span class="s2">"S3Prefix"</span>
                <span class="nx">S3InputMode</span> <span class="o">=</span> <span class="s2">"File"</span>
                <span class="nx">S3DataDistributionType</span> <span class="o">=</span> <span class="s2">"FullyReplicated"</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">]</span>
          <span class="nx">ProcessingOutputConfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">Outputs</span> <span class="o">=</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="nx">OutputName</span> <span class="o">=</span> <span class="s2">"processed-data"</span>
                <span class="nx">S3Output</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">S3Uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.training_data.id}/processed/"</span>
                  <span class="nx">LocalPath</span> <span class="o">=</span> <span class="s2">"/opt/ml/processing/output"</span>
                  <span class="nx">S3UploadMode</span> <span class="o">=</span> <span class="s2">"EndOfJob"</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"ModelTraining"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"Training"</span>
        <span class="nx">Arguments</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">AlgorithmSpecification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">TrainingImage</span> <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/training:latest"</span>
            <span class="nx">TrainingInputMode</span> <span class="o">=</span> <span class="s2">"File"</span>
            <span class="nx">EnableSageMakerMetricsTimeSeries</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="p">}</span>
          <span class="nx">RoleArn</span> <span class="o">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">sagemaker_execution</span><span class="p">.</span><span class="nx">arn</span>
          <span class="nx">OutputDataConfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">S3OutputPath</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/"</span>
            <span class="nx">KmsKeyId</span> <span class="o">=</span> <span class="nx">aws_kms_key</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">id</span>
          <span class="p">}</span>
          <span class="nx">ResourceConfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">InstanceCount</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nx">InstanceType</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Parameters.TrainingInstanceType"</span> <span class="p">}</span>
            <span class="nx">VolumeSizeInGB</span> <span class="o">=</span> <span class="mi">30</span>
          <span class="p">}</span>
          <span class="nx">StoppingCondition</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">MaxRuntimeInSeconds</span> <span class="o">=</span> <span class="mi">86400</span>
          <span class="p">}</span>
          <span class="nx">HyperParameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">epochs</span> <span class="o">=</span> <span class="s2">"10"</span>
            <span class="nx">batch_size</span> <span class="o">=</span> <span class="s2">"32"</span>
            <span class="nx">learning_rate</span> <span class="o">=</span> <span class="s2">"0.001"</span>
          <span class="p">}</span>
          <span class="nx">InputDataConfig</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">ChannelName</span> <span class="o">=</span> <span class="s2">"training"</span>
              <span class="nx">DataSource</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">S3DataSource</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">S3DataType</span> <span class="o">=</span> <span class="s2">"S3Prefix"</span>
                  <span class="nx">S3Uri</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Steps.DataProcessing.ProcessingOutputConfig.Outputs[0].S3Output.S3Uri"</span> <span class="p">}</span>
                  <span class="nx">S3DataDistributionType</span> <span class="o">=</span> <span class="s2">"FullyReplicated"</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="nx">ContentType</span> <span class="o">=</span> <span class="s2">"application/x-parquet"</span>
              <span class="nx">CompressionType</span> <span class="o">=</span> <span class="s2">"None"</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">DependsOn</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"DataProcessing"</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">Name</span> <span class="o">=</span> <span class="s2">"RegisterModel"</span>
        <span class="nx">Type</span> <span class="o">=</span> <span class="s2">"RegisterModel"</span>
        <span class="nx">Arguments</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">ModelPackageGroupName</span> <span class="o">=</span> <span class="nx">aws_sagemaker_model_package_group</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">model_package_group_name</span>
          <span class="nx">ModelMetrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">ModelQuality</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">Statistics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">ContentType</span> <span class="o">=</span> <span class="s2">"application/json"</span>
                <span class="nx">S3Uri</span> <span class="o">=</span> <span class="s2">"s3://${aws_s3_bucket.models.id}/evaluation/statistics.json"</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">InferenceSpecification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">Containers</span> <span class="o">=</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="nx">Image</span> <span class="o">=</span> <span class="s2">"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/inference:latest"</span>
                <span class="nx">ModelDataUrl</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"Get"</span> <span class="p">=</span> <span class="s2">"Steps.ModelTraining.ModelArtifacts.S3ModelArtifacts"</span> <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">]</span>
            <span class="nx">SupportedContentTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application/json"</span><span class="p">]</span>
            <span class="nx">SupportedResponseMIMETypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application/json"</span><span class="p">]</span>
          <span class="p">}</span>
          <span class="nx">ModelApprovalStatus</span> <span class="o">=</span> <span class="s2">"PendingManualApproval"</span>
        <span class="p">}</span>
        <span class="nx">DependsOn</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ModelTraining"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">})</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># CloudWatch monitoring for ML endpoints</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudwatch_metric_alarm"</span> <span class="s2">"endpoint_error_rate"</span> <span class="p">{</span>
  <span class="nx">alarm_name</span>          <span class="o">=</span> <span class="s2">"${var.environment}-endpoint-error-rate"</span>
  <span class="nx">comparison_operator</span> <span class="o">=</span> <span class="s2">"GreaterThanThreshold"</span>
  <span class="nx">evaluation_periods</span>  <span class="o">=</span> <span class="s2">"2"</span>
  <span class="nx">metric_name</span>         <span class="o">=</span> <span class="s2">"ModelInvocation4XXErrors"</span>
  <span class="nx">namespace</span>           <span class="o">=</span> <span class="s2">"AWS/SageMaker"</span>
  <span class="nx">period</span>              <span class="o">=</span> <span class="s2">"300"</span>
  <span class="nx">statistic</span>           <span class="o">=</span> <span class="s2">"Average"</span>
  <span class="nx">threshold</span>           <span class="o">=</span> <span class="s2">"0.05"</span>
  <span class="nx">alarm_description</span>   <span class="o">=</span> <span class="s2">"This metric monitors endpoint error rate"</span>
  <span class="nx">alarm_actions</span>       <span class="o">=</span> <span class="p">[</span><span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">ml_alerts</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
  
  <span class="nx">dimensions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">EndpointName</span> <span class="o">=</span> <span class="nx">aws_sagemaker_endpoint</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">VariantName</span>  <span class="o">=</span> <span class="s2">"AllTraffic"</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="c1"># Model monitoring schedule</span>
<span class="nx">resource</span> <span class="s2">"aws_sagemaker_monitoring_schedule"</span> <span class="s2">"model_quality"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">"${var.environment}-model-quality-monitor"</span>
  
  <span class="nx">monitoring_schedule_config</span> <span class="p">{</span>
    <span class="nx">monitoring_job_definition_name</span> <span class="o">=</span> <span class="nx">aws_sagemaker_data_quality_job_definition</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">monitoring_type</span>                <span class="o">=</span> <span class="s2">"DataQuality"</span>
    
    <span class="nx">schedule_config</span> <span class="p">{</span>
      <span class="nx">schedule_expression</span> <span class="o">=</span> <span class="s2">"cron(0 * ? * * *)"</span>  <span class="c1"># Every hour</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="infrastructure-as-code-best-practices">Infrastructure as Code Best Practices</h2>

<h3 id="terraform-advanced-patterns">Terraform Advanced Patterns</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">from</span> <span class="nx">aws_cdk</span> <span class="nx">import</span> <span class="err">(</span>
    <span class="nx">core</span> <span class="nx">as</span> <span class="nx">cdk</span><span class="err">,</span>
    <span class="nx">aws_ec2</span> <span class="nx">as</span> <span class="nx">ec2</span><span class="err">,</span>
    <span class="nx">aws_ecs</span> <span class="nx">as</span> <span class="nx">ecs</span><span class="err">,</span>
    <span class="nx">aws_ecs_patterns</span> <span class="nx">as</span> <span class="nx">ecs_patterns</span><span class="err">,</span>
    <span class="nx">aws_elasticloadbalancingv2</span> <span class="nx">as</span> <span class="nx">elbv2</span><span class="err">,</span>
    <span class="nx">aws_rds</span> <span class="nx">as</span> <span class="nx">rds</span><span class="err">,</span>
    <span class="nx">aws_secretsmanager</span> <span class="nx">as</span> <span class="nx">sm</span><span class="err">,</span>
    <span class="nx">aws_cloudwatch</span> <span class="nx">as</span> <span class="nx">cloudwatch</span><span class="err">,</span>
    <span class="nx">aws_cloudwatch_actions</span> <span class="nx">as</span> <span class="nx">cw_actions</span><span class="err">,</span>
    <span class="nx">aws_sns</span> <span class="nx">as</span> <span class="nx">sns</span><span class="err">,</span>
    <span class="nx">aws_lambda</span> <span class="nx">as</span> <span class="nx">lambda_</span><span class="err">,</span>
    <span class="nx">aws_apigateway</span> <span class="nx">as</span> <span class="nx">apigw</span><span class="err">,</span>
    <span class="nx">custom_resources</span> <span class="nx">as</span> <span class="nx">cr</span>
<span class="err">)</span>
<span class="nx">from</span> <span class="nx">constructs</span> <span class="nx">import</span> <span class="nx">Construct</span>
<span class="nx">import</span> <span class="nx">json</span>

<span class="nx">class</span> <span class="nx">MicroservicesStack</span><span class="err">(</span><span class="nx">cdk</span><span class="err">.</span><span class="nx">Stack</span><span class="err">)</span><span class="o">:</span>
    <span class="nx">def</span> <span class="nx">__init__</span><span class="err">(</span><span class="nx">self</span><span class="err">,</span> <span class="nx">scope</span><span class="o">:</span> <span class="nx">Construct</span><span class="err">,</span> <span class="nx">construct_id</span><span class="o">:</span> <span class="nx">str</span><span class="err">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="err">)</span> <span class="o">-&gt;</span> <span class="nx">None</span><span class="o">:</span>
        <span class="nx">super</span><span class="err">().</span><span class="nx">__init__</span><span class="err">(</span><span class="nx">scope</span><span class="err">,</span> <span class="nx">construct_id</span><span class="err">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="err">)</span>
        
        <span class="c1"># Create VPC with custom configuration</span>
        <span class="nx">vpc</span> <span class="o">=</span> <span class="nx">ec2</span><span class="err">.</span><span class="nx">Vpc</span><span class="err">(</span>
            <span class="nx">self</span><span class="err">,</span> <span class="s2">"MicroservicesVPC"</span><span class="err">,</span>
            <span class="nx">max_azs</span><span class="o">=</span><span class="mi">3</span><span class="err">,</span>
            <span class="nx">nat_gateways</span><span class="o">=</span><span class="mi">2</span><span class="err">,</span>
            <span class="nx">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
                <span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetConfiguration</span><span class="p">(</span>
                    <span class="nx">name</span><span class="o">=</span><span class="s2">"Public"</span><span class="p">,</span>
                    <span class="nx">subnet_type</span><span class="o">=</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetType</span><span class="p">.</span><span class="nx">PUBLIC</span><span class="p">,</span>
                    <span class="nx">cidr_mask</span><span class="o">=</span><span class="mi">24</span>
                <span class="p">),</span>
                <span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetConfiguration</span><span class="p">(</span>
                    <span class="nx">name</span><span class="o">=</span><span class="s2">"Private"</span><span class="p">,</span>
                    <span class="nx">subnet_type</span><span class="o">=</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetType</span><span class="p">.</span><span class="nx">PRIVATE</span><span class="p">,</span>
                    <span class="nx">cidr_mask</span><span class="o">=</span><span class="mi">24</span>
                <span class="p">),</span>
                <span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetConfiguration</span><span class="p">(</span>
                    <span class="nx">name</span><span class="o">=</span><span class="s2">"Isolated"</span><span class="p">,</span>
                    <span class="nx">subnet_type</span><span class="o">=</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">SubnetType</span><span class="p">.</span><span class="nx">ISOLATED</span><span class="p">,</span>
                    <span class="nx">cidr_mask</span><span class="o">=</span><span class="mi">24</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="err">)</span>
        
        <span class="c1"># Create ECS Cluster with capacity providers</span>
        <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">ecs</span><span class="err">.</span><span class="nx">Cluster</span><span class="err">(</span>
            <span class="nx">self</span><span class="err">,</span> <span class="s2">"Cluster"</span><span class="err">,</span>
            <span class="nx">vpc</span><span class="o">=</span><span class="nx">vpc</span><span class="err">,</span>
            <span class="nx">container_insights</span><span class="o">=</span><span class="nx">True</span>
        <span class="err">)</span>
        
        <span class="c1"># Add Fargate Spot capacity provider</span>
        <span class="nx">cluster</span><span class="err">.</span><span class="nx">add_capacity_provider</span><span class="err">(</span>
            <span class="nx">ecs</span><span class="err">.</span><span class="nx">FargateCapacityProvider</span><span class="err">(</span>
                <span class="nx">self</span><span class="err">,</span> <span class="s2">"FargateSpotProvider"</span><span class="err">,</span>
                <span class="nx">spot</span><span class="o">=</span><span class="nx">True</span>
            <span class="err">)</span>
        <span class="err">)</span>
        
        <span class="c1"># Create RDS Aurora Serverless v2</span>
        <span class="nx">db_secret</span> <span class="o">=</span> <span class="nx">sm</span><span class="err">.</span><span class="nx">Secret</span><span class="err">(</span>
            <span class="nx">self</span><span class="err">,</span> <span class="s2">"DBSecret"</span><span class="err">,</span>
            <span class="nx">generate_secret_string</span><span class="o">=</span><span class="nx">sm</span><span class="err">.</span><span class="nx">SecretStringGenerator</span><span class="err">(</span>
                <span class="nx">secret_string_template</span><span class="o">=</span><span class="nx">json</span><span class="err">.</span><span class="nx">dumps</span><span class="err">(</span><span class="p">{</span><span class="s2">"username"</span><span class="o">:</span> <span class="s2">"admin"</span><span class="p">}</span><span class="err">),</span>
                <span class="nx">generate_string_key</span><span class="o">=</span><span class="s2">"password"</span><span class="err">,</span>
                <span class="nx">exclude_characters</span><span class="o">=</span><span class="s2">" %+~`#$&amp;*()|[]{}:;&lt;&gt;?!'/</span><span class="err">\</span><span class="se">\"</span><span class="s2">
            )
        )
        
        db_cluster = rds.DatabaseCluster(
            self, "</span><span class="nx">AuroraCluster</span><span class="s2">",
            engine=rds.DatabaseClusterEngine.aurora_mysql(
                version=rds.AuroraMysqlEngineVersion.VER_3_01_0
            ),
            serverless_v2_scaling_configuration=rds.ServerlessV2ScalingConfiguration(
                min_capacity=0.5,
                max_capacity=2
            ),
            credentials=rds.Credentials.from_secret(db_secret),
            vpc=vpc,
            vpc_subnets=ec2.SubnetSelection(
                subnet_type=ec2.SubnetType.ISOLATED
            ),
            backup=rds.BackupProps(
                retention=cdk.Duration.days(7)
            ),
            deletion_protection=True
        )
        
        # Create shared ALB
        alb = elbv2.ApplicationLoadBalancer(
            self, "</span><span class="nx">ALB</span><span class="s2">",
            vpc=vpc,
            internet_facing=True,
            http2_enabled=True
        )
        
        # Add CloudWatch alarms
        alarm = cloudwatch.Alarm(
            self, "</span><span class="nx">HighErrorRate</span><span class="s2">",
            metric=alb.metric_target_response_time(),
            threshold=1000,
            evaluation_periods=2
        )
        
        # SNS topic for alarms
        alarm_topic = sns.Topic(
            self, "</span><span class="nx">AlarmTopic</span><span class="s2">",
            display_name="</span><span class="nx">Microservices</span> <span class="nx">Alarms</span><span class="s2">"
        )
        
        alarm.add_alarm_action(cw_actions.SnsAction(alarm_topic))
        
        # Deploy microservices
        self.deploy_microservice(
            cluster=cluster,
            alb=alb,
            service_name="</span><span class="nx">users</span><span class="s2">",
            image="</span><span class="nx">users-service</span><span class="o">:</span><span class="nx">latest</span><span class="s2">",
            port=8080,
            priority=1,
            path_pattern="</span><span class="o">/</span><span class="nx">users</span><span class="cm">/*",
            environment={
                "DB_SECRET_ARN": db_secret.secret_arn,
                "DB_CLUSTER_ARN": db_cluster.cluster_arn
            }
        )
        
        self.deploy_microservice(
            cluster=cluster,
            alb=alb,
            service_name="orders",
            image="orders-service:latest",
            port=8081,
            priority=2,
            path_pattern="/orders/*",
            environment={
                "DB_SECRET_ARN": db_secret.secret_arn,
                "DB_CLUSTER_ARN": db_cluster.cluster_arn
            }
        )
        
        # Create API Gateway for serverless endpoints
        api = apigw.RestApi(
            self, "MicroservicesAPI",
            deploy_options=apigw.StageOptions(
                logging_level=apigw.MethodLoggingLevel.INFO,
                data_trace_enabled=True,
                tracing_enabled=True
            )
        )
        
        # Lambda function for async processing
        async_processor = lambda_.Function(
            self, "AsyncProcessor",
            runtime=lambda_.Runtime.PYTHON_3_9,
            handler="index.handler",
            code=lambda_.Code.from_asset("lambda"),
            vpc=vpc,
            environment={
                "DB_SECRET_ARN": db_secret.secret_arn
            },
            reserved_concurrent_executions=100,
            tracing=lambda_.Tracing.ACTIVE
        )
        
        # Grant permissions
        db_secret.grant_read(async_processor)
        db_cluster.grant_connect(async_processor)
        
        # Custom resource for database initialization
        db_init = cr.AwsCustomResource(
            self, "DBInit",
            on_create=cr.AwsSdkCall(
                service="RDS",
                action="executeStatement",
                parameters={
                    "resourceArn": db_cluster.cluster_arn,
                    "secretArn": db_secret.secret_arn,
                    "database": "mysql",
                    "sql": "CREATE DATABASE IF NOT EXISTS microservices;"
                },
                physical_resource_id=cr.PhysicalResourceId.of("DBInit")
            ),
            policy=cr.AwsCustomResourcePolicy.from_sdk_calls(
                resources=[db_cluster.cluster_arn]
            )
        )
        
        # Output values
        cdk.CfnOutput(
            self, "ALBDNSName",
            value=alb.load_balancer_dns_name,
            description="ALB DNS Name"
        )
        
        cdk.CfnOutput(
            self, "APIEndpoint",
            value=api.url,
            description="API Gateway Endpoint"
        )
    
    def deploy_microservice(self,
                           cluster: ecs.Cluster,
                           alb: elbv2.ApplicationLoadBalancer,
                           service_name: str,
                           image: str,
                           port: int,
                           priority: int,
                           path_pattern: str,
                           environment: dict):
        """Deploy a microservice to ECS"""
        
        # Create task definition
        task_definition = ecs.FargateTaskDefinition(
            self, f"{service_name}TaskDef",
            memory_limit_mib=512,
            cpu=256
        )
        
        # Add container
        container = task_definition.add_container(
            f"{service_name}Container",
            image=ecs.ContainerImage.from_registry(image),
            logging=ecs.LogDrivers.aws_logs(
                stream_prefix=service_name
            ),
            environment=environment,
            health_check=ecs.HealthCheck(
                command=["CMD-SHELL", f"curl -f http://localhost:{port}/health || exit 1"],
                interval=cdk.Duration.seconds(30),
                timeout=cdk.Duration.seconds(5),
                retries=3
            )
        )
        
        container.add_port_mappings(
            ecs.PortMapping(
                container_port=port,
                protocol=ecs.Protocol.TCP
            )
        )
        
        # Create service
        service = ecs.FargateService(
            self, f"{service_name}Service",
            cluster=cluster,
            task_definition=task_definition,
            desired_count=2,
            capacity_provider_strategies=[
                ecs.CapacityProviderStrategy(
                    capacity_provider="FARGATE_SPOT",
                    weight=2
                ),
                ecs.CapacityProviderStrategy(
                    capacity_provider="FARGATE",
                    weight=1
                )
            ],
            circuit_breaker=ecs.DeploymentCircuitBreaker(
                rollback=True
            )
        )
        
        # Configure auto-scaling
        scaling = service.auto_scale_task_count(
            min_capacity=2,
            max_capacity=10
        )
        
        scaling.scale_on_cpu_utilization(
            "CpuScaling",
            target_utilization_percent=70,
            scale_in_cooldown=cdk.Duration.seconds(60),
            scale_out_cooldown=cdk.Duration.seconds(60)
        )
        
        scaling.scale_on_request_count(
            "RequestScaling",
            requests_per_target=1000,
            target_group=alb.add_targets(
                f"{service_name}TG",
                port=port,
                targets=[service],
                health_check=elbv2.HealthCheck(
                    path=f"/{service_name}/health",
                    interval=cdk.Duration.seconds(30)
                )
            )
        )
        
        # Add ALB listener rule
        alb.add_listener(
            f"{service_name}Listener",
            port=80
        ).add_targets(
            f"{service_name}Targets",
            port=port,
            targets=[service],
            priority=priority,
            conditions=[
                elbv2.ListenerCondition.path_patterns([path_pattern])
            ]
        )
</span></code></pre></div></div>

<h2 id="future-directions">Future Directions</h2>

<ol>
  <li>
<strong>Serverless-First Architecture</strong> - Continued evolution toward event-driven, serverless patterns</li>
  <li>
<strong>Edge Computing</strong> - AWS Wavelength and Local Zones for ultra-low latency</li>
  <li>
<strong>Quantum-Classical Hybrid</strong> - Integration of quantum computing with classical workloads</li>
  <li>
<strong>AI/ML Democratization</strong> - No-code/low-code ML solutions</li>
  <li>
<strong>Sustainability</strong> - Carbon-aware computing and green cloud initiatives</li>
  <li>
<strong>Web3 Integration</strong> - Blockchain and decentralized application support</li>
  <li>
<strong>Advanced Observability</strong> - AI-driven anomaly detection and predictive scaling</li>
</ol>

