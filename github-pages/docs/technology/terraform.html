<h1 id="terraform">Terraform</h1>

<header><link rel="stylesheet" href="https://andrewaltimit.github.io/Documentation/style.css"></header>

<div class="hero-section">
  <div class="hero-content">
    <h1 class="hero-title">Terraform</h1>
    <p class="hero-subtitle">Infrastructure as Code: Theory and Practice</p>
  </div>
</div>

<div class="intro-card">
  <p class="lead-text">Terraform represents a paradigm shift in infrastructure management, applying software engineering principles to infrastructure provisioning. Built on graph theory, functional programming concepts, and distributed systems principles, Terraform enables declarative infrastructure management with mathematical guarantees about convergence and consistency.</p>
  
  <div class="key-insights">
    <div class="insight-card">
      <i class="fas fa-project-diagram"></i>
      <h4>Graph-Based Execution</h4>
      <p>Directed acyclic graphs for dependencies</p>
    </div>
    <div class="insight-card">
      <i class="fas fa-sync-alt"></i>
      <h4>Declarative Convergence</h4>
      <p>Mathematical state reconciliation</p>
    </div>
    <div class="insight-card">
      <i class="fas fa-shield-alt"></i>
      <h4>Type Safety</h4>
      <p>Static analysis and validation</p>
    </div>
  </div>
</div>

<h2 id="mathematical-foundations">Mathematical Foundations</h2>

<h3 id="category-theory-in-infrastructure">Category Theory in Infrastructure</h3>

<p>Terraform’s type system and module composition can be understood through category theory:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Infrastructure as a category</span>
<span class="kr">class</span> <span class="kt">InfraCategory</span> <span class="kr">where</span>
  <span class="c1">-- Objects are infrastructure states</span>
  <span class="kr">type</span> <span class="kt">State</span> <span class="o">::</span> <span class="o">*</span>
  
  <span class="c1">-- Morphisms are terraform operations</span>
  <span class="kr">type</span> <span class="kt">Operation</span> <span class="o">::</span> <span class="kt">State</span> <span class="o">-&gt;</span> <span class="kt">State</span> <span class="o">-&gt;</span> <span class="o">*</span>
  
  <span class="c1">-- Identity operation (no-op)</span>
  <span class="n">id</span> <span class="o">::</span> <span class="kt">Operation</span> <span class="n">s</span> <span class="n">s</span>
  
  <span class="c1">-- Composition of operations</span>
  <span class="p">(</span><span class="o">.</span><span class="p">)</span> <span class="o">::</span> <span class="kt">Operation</span> <span class="n">b</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="kt">Operation</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="kt">Operation</span> <span class="n">a</span> <span class="n">c</span>
  
  <span class="c1">-- Laws:</span>
  <span class="c1">-- Left identity: id . f = f</span>
  <span class="c1">-- Right identity: f . id = f</span>
  <span class="c1">-- Associativity: (f . g) . h = f . (g . h)</span>
</code></pre></div></div>

<h3 id="terraform-execution-model">Terraform Execution Model</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">networkx</span> <span class="k">as</span> <span class="n">nx</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="n">hashlib</span>

<span class="k">class</span> <span class="nc">ResourceAction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CREATE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">create</span><span class="sh">"</span>
    <span class="n">UPDATE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">update</span><span class="sh">"</span>
    <span class="n">DELETE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">delete</span><span class="sh">"</span>
    <span class="n">REPLACE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span>
    <span class="n">NO_OP</span> <span class="o">=</span> <span class="sh">"</span><span class="s">no-op</span><span class="sh">"</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Resource</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Represents a Terraform resource</span><span class="sh">"""</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">address</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="nb">type</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
    
    <span class="k">def</span> <span class="nf">config_hash</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Compute hash of configuration for change detection</span><span class="sh">"""</span>
        <span class="n">config_str</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="nf">items</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">config_str</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">TerraformGraph</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Terraform</span><span class="sh">'</span><span class="s">s resource dependency graph implementation</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="p">.</span><span class="nc">DiGraph</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Resource</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_resource</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="n">Resource</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Add resource to graph</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">add_node</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_dependency</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Add dependency edge (source depends on target)</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">add_edge</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>  <span class="c1"># Reversed for topological order
</span>    
    <span class="k">def</span> <span class="nf">detect_cycles</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">Detect dependency cycles using Tarjan</span><span class="sh">'</span><span class="s">s algorithm</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cycles</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">nx</span><span class="p">.</span><span class="nf">simple_cycles</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">cycles</span>
        <span class="k">except</span> <span class="n">nx</span><span class="p">.</span><span class="n">NetworkXNoCycle</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">topological_sort</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Get execution order using Kahn</span><span class="sh">'</span><span class="s">s algorithm</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">detect_cycles</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Dependency cycle detected</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">nx</span><span class="p">.</span><span class="nf">topological_sort</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">parallel_execution_plan</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">Generate parallel execution plan using level-based scheduling</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">detect_cycles</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Dependency cycle detected</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">nodes</span><span class="p">())</span>
        
        <span class="k">while</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="c1"># Find nodes with no dependencies in remaining set
</span>            <span class="n">level</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">:</span>
                <span class="n">predecessors</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">predecessors</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">predecessors</span><span class="p">.</span><span class="nf">intersection</span><span class="p">(</span><span class="n">remaining</span><span class="p">):</span>
                    <span class="n">level</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">level</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Unexpected graph structure</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="n">levels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="n">remaining</span> <span class="o">-=</span> <span class="n">level</span>
        
        <span class="k">return</span> <span class="n">levels</span>

<span class="k">class</span> <span class="nc">TerraformPlanner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Plan generator with diff algorithm</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">:</span> <span class="n">TerraformGraph</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
    
    <span class="k">def</span> <span class="nf">diff_resource</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="n">Resource</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResourceAction</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Determine action for resource using 3-way diff</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">resource</span><span class="p">.</span><span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResourceAction</span><span class="p">.</span><span class="n">CREATE</span>
        
        <span class="k">if</span> <span class="n">resource</span><span class="p">.</span><span class="n">config</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResourceAction</span><span class="p">.</span><span class="n">DELETE</span>
        
        <span class="c1"># Check for changes requiring replacement
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_requires_replacement</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ResourceAction</span><span class="p">.</span><span class="n">REPLACE</span>
        
        <span class="c1"># Check for in-place updates
</span>        <span class="k">if</span> <span class="n">resource</span><span class="p">.</span><span class="nf">config_hash</span><span class="p">()</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_state_hash</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">state</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ResourceAction</span><span class="p">.</span><span class="n">UPDATE</span>
        
        <span class="k">return</span> <span class="n">ResourceAction</span><span class="p">.</span><span class="n">NO_OP</span>
    
    <span class="k">def</span> <span class="nf">generate_plan</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResourceAction</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">Generate execution plan with actions</span><span class="sh">"""</span>
        <span class="n">plan</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">topological_sort</span><span class="p">():</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="n">resources</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">diff_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="n">ResourceAction</span><span class="p">.</span><span class="n">NO_OP</span><span class="p">:</span>
                <span class="n">plan</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">address</span><span class="p">,</span> <span class="n">action</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">plan</span>
</code></pre></div></div>

<h2 id="advanced-provider-architecture">Advanced Provider Architecture</h2>

<h3 id="provider-plugin-system">Provider Plugin System</h3>

<p>Terraform’s provider architecture implements a plugin system based on gRPC and protocol buffers:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Provider interface definition</span>
<span class="k">type</span> <span class="n">Provider</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="c">// GetSchema returns the complete schema for the provider</span>
    <span class="n">GetSchema</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">GetProviderSchemaResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    
    <span class="c">// ValidateConfig validates the provider configuration</span>
    <span class="n">ValidateConfig</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ValidateProviderConfigRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ValidateProviderConfigResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    
    <span class="c">// Configure configures the provider with the given configuration</span>
    <span class="n">Configure</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ConfigureProviderRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ConfigureProviderResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    
    <span class="c">// Resource management</span>
    <span class="n">ReadResource</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ReadResourceRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ReadResourceResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="n">PlanResourceChange</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">PlanResourceChangeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">PlanResourceChangeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="n">ApplyResourceChange</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ApplyResourceChangeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ApplyResourceChangeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    
    <span class="c">// Import support</span>
    <span class="n">ImportResourceState</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ImportResourceStateRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ImportResourceStateResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Provider implementation with retry logic and circuit breaker</span>
<span class="k">type</span> <span class="n">AdvancedAWSProvider</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">client</span>      <span class="o">*</span><span class="n">aws</span><span class="o">.</span><span class="n">Client</span>
    <span class="n">retryPolicy</span> <span class="n">RetryPolicy</span>
    <span class="n">breaker</span>     <span class="o">*</span><span class="n">CircuitBreaker</span>
    <span class="n">limiter</span>     <span class="o">*</span><span class="n">RateLimiter</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">AdvancedAWSProvider</span><span class="p">)</span> <span class="n">ApplyResourceChange</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ApplyResourceChangeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ApplyResourceChangeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// Circuit breaker pattern for fault tolerance</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">breaker</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ApplyResourceChangeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">// Rate limiting</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">limiter</span><span class="o">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
        <span class="p">}</span>
        
        <span class="c">// Exponential backoff retry</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">retryPolicy</span><span class="o">.</span><span class="n">ExecuteWithRetry</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="n">tfprotov5</span><span class="o">.</span><span class="n">ApplyResourceChangeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">applyChange</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="provider-authentication-and-security">Provider Authentication and Security</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced provider configuration with multiple authentication methods</span>
<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
  
  <span class="c1"># AssumeRole with external ID for cross-account access</span>
  <span class="nx">assume_role</span> <span class="p">{</span>
    <span class="nx">role_arn</span>     <span class="o">=</span> <span class="s2">"arn:aws:iam::${var.target_account_id}:role/TerraformRole"</span>
    <span class="nx">session_name</span> <span class="o">=</span> <span class="s2">"terraform-${var.environment}"</span>
    <span class="nx">external_id</span>  <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">external_id</span>
    
    <span class="c1"># Transitive tags for compliance</span>
    <span class="nx">transitive_tag_keys</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">"Environment"</span><span class="p">,</span>
      <span class="s2">"Project"</span><span class="p">,</span>
      <span class="s2">"CostCenter"</span>
    <span class="p">]</span>
  <span class="p">}</span>
  
  <span class="c1"># Default tags applied to all resources</span>
  <span class="nx">default_tags</span> <span class="p">{</span>
    <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ManagedBy</span>   <span class="o">=</span> <span class="s2">"Terraform"</span>
      <span class="nx">Environment</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
      <span class="nx">GitCommit</span>   <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">external</span><span class="p">.</span><span class="nx">git_commit</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">sha</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Retry configuration</span>
  <span class="nx">retry_mode</span>       <span class="o">=</span> <span class="s2">"adaptive"</span>
  <span class="nx">max_retries</span>      <span class="o">=</span> <span class="mi">10</span>
  
  <span class="c1"># Custom endpoints for testing</span>
  <span class="nx">dynamic</span> <span class="s2">"endpoints"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">localstack_enabled</span> <span class="o">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="p">[]</span>
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">s3</span>       <span class="o">=</span> <span class="s2">"http://localhost:4566"</span>
      <span class="nx">dynamodb</span> <span class="o">=</span> <span class="s2">"http://localhost:4566"</span>
      <span class="nx">lambda</span>   <span class="o">=</span> <span class="s2">"http://localhost:4566"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Git commit data source for tracking</span>
<span class="nx">data</span> <span class="s2">"external"</span> <span class="s2">"git_commit"</span> <span class="p">{</span>
  <span class="nx">program</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"sh"</span><span class="p">,</span> <span class="s2">"-c"</span><span class="p">,</span> <span class="s2">"echo '{</span><span class="se">\"</span><span class="s2">sha</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">'$(git rev-parse HEAD)'</span><span class="se">\"</span><span class="s2">}' "</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="resource-lifecycle-theory">Resource Lifecycle Theory</h2>

<h3 id="formal-resource-model">Formal Resource Model</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ResourceState</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Immutable representation of resource state</span><span class="sh">"""</span>
    <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">hash</span><span class="p">(</span><span class="nf">tuple</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="nf">items</span><span class="p">())))</span>

<span class="k">class</span> <span class="nc">ResourceLifecycle</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Abstract base class for resource lifecycle management</span><span class="sh">"""</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">desired</span><span class="p">:</span> <span class="n">ResourceState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResourceState</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Create resource with desired state</span><span class="sh">"""</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResourceState</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Read current resource state</span><span class="sh">"""</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="n">ResourceState</span><span class="p">,</span> <span class="n">desired</span><span class="p">:</span> <span class="n">ResourceState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResourceState</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Update resource from current to desired state</span><span class="sh">"""</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="n">ResourceState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Delete resource</span><span class="sh">"""</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">TransactionalResourceManager</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Manages resources with ACID guarantees</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">state_store</span><span class="p">:</span> <span class="sh">'</span><span class="s">StateStore</span><span class="sh">'</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state_store</span> <span class="o">=</span> <span class="n">state_store</span>
        <span class="n">self</span><span class="p">.</span><span class="n">locks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transaction_log</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">apply_change</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> 
                          <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                          <span class="n">lifecycle</span><span class="p">:</span> <span class="n">ResourceLifecycle</span><span class="p">,</span>
                          <span class="n">desired_state</span><span class="p">:</span> <span class="n">ResourceState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResourceState</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Apply resource change with transactional semantics</span><span class="sh">"""</span>
        
        <span class="c1"># Acquire distributed lock
</span>        <span class="n">lock_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">resource_type</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">resource_id</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="nf">acquire_lock</span><span class="p">(</span><span class="n">lock_key</span><span class="p">):</span>
            <span class="c1"># Begin transaction
</span>            <span class="n">txn_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">begin_transaction</span><span class="p">()</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Read current state
</span>                <span class="n">current</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lifecycle</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
                
                <span class="c1"># Determine operation
</span>                <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">desired_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># Create
</span>                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lifecycle</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">desired_state</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">log_operation</span><span class="p">(</span><span class="n">txn_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">CREATE</span><span class="sh">"</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    
                <span class="k">elif</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">desired_state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># Delete
</span>                    <span class="k">await</span> <span class="n">lifecycle</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">log_operation</span><span class="p">(</span><span class="n">txn_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">DELETE</span><span class="sh">"</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                    
                <span class="k">elif</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">desired_state</span><span class="p">:</span>
                    <span class="c1"># Update
</span>                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lifecycle</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">desired_state</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">log_operation</span><span class="p">(</span><span class="n">txn_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">UPDATE</span><span class="sh">"</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No-op
</span>                    <span class="n">result</span> <span class="o">=</span> <span class="n">current</span>
                
                <span class="c1"># Commit transaction
</span>                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">commit_transaction</span><span class="p">(</span><span class="n">txn_id</span><span class="p">)</span>
                
                <span class="c1"># Update state store
</span>                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">state_store</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">lock_key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="n">result</span>
                
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Rollback on error
</span>                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">rollback_transaction</span><span class="p">(</span><span class="n">txn_id</span><span class="p">)</span>
                <span class="k">raise</span>

<span class="c1">## Creating and Managing Resources
</span>
<span class="c1">### Creating an Amazon S3 Bucket
</span>
<span class="n">Let</span><span class="sh">'</span><span class="s">s create an Amazon S3 bucket as an example resource. Add the following code to your `main.tf` file:

```terraform
# Modern S3 bucket with security best practices
resource </span><span class="sh">"</span><span class="s">aws_s3_bucket</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">example_bucket</span><span class="sh">"</span><span class="s"> {
  bucket = </span><span class="sh">"</span><span class="s">my-example-bucket-terraform-${data.aws_caller_identity.current.account_id}</span><span class="sh">"</span><span class="s">
}

# Separate ACL resource (AWS provider v4+)
resource </span><span class="sh">"</span><span class="s">aws_s3_bucket_acl</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">example_bucket_acl</span><span class="sh">"</span><span class="s"> {
  bucket = aws_s3_bucket.example_bucket.id
  acl    = </span><span class="sh">"</span><span class="s">private</span><span class="sh">"</span><span class="s">
}

# Enable versioning for data protection
resource </span><span class="sh">"</span><span class="s">aws_s3_bucket_versioning</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">example_bucket_versioning</span><span class="sh">"</span><span class="s"> {
  bucket = aws_s3_bucket.example_bucket.id
  
  versioning_configuration {
    status = </span><span class="sh">"</span><span class="s">Enabled</span><span class="sh">"</span><span class="s">
  }
}

# Server-side encryption
resource </span><span class="sh">"</span><span class="s">aws_s3_bucket_server_side_encryption_configuration</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">example_bucket_encryption</span><span class="sh">"</span><span class="s"> {
  bucket = aws_s3_bucket.example_bucket.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = </span><span class="sh">"</span><span class="s">aws:kms</span><span class="sh">"</span><span class="s">
      kms_master_key_id = aws_kms_key.bucket_key.arn
    }
    bucket_key_enabled = true
  }
}

# KMS key for encryption
resource </span><span class="sh">"</span><span class="s">aws_kms_key</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">bucket_key</span><span class="sh">"</span><span class="s"> {
  description             = </span><span class="sh">"</span><span class="s">KMS key for S3 bucket encryption</span><span class="sh">"</span><span class="s">
  deletion_window_in_days = 10
  enable_key_rotation     = true
  
  tags = {
    Purpose = </span><span class="sh">"</span><span class="s">S3BucketEncryption</span><span class="sh">"</span><span class="s">
  }
}

# Bucket policy with least privilege
resource </span><span class="sh">"</span><span class="s">aws_s3_bucket_policy</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">example_bucket_policy</span><span class="sh">"</span><span class="s"> {
  bucket = aws_s3_bucket.example_bucket.id
  
  policy = jsonencode({
    Version = </span><span class="sh">"</span><span class="s">2012-10-17</span><span class="sh">"</span><span class="s">
    Statement = [
      {
        Sid    = </span><span class="sh">"</span><span class="s">DenyInsecureTransport</span><span class="sh">"</span><span class="s">
        Effect = </span><span class="sh">"</span><span class="s">Deny</span><span class="sh">"</span><span class="s">
        Principal = </span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="s">
        Action = </span><span class="sh">"</span><span class="s">s3:*</span><span class="sh">"</span><span class="s">
        Resource = [
          aws_s3_bucket.example_bucket.arn,
          </span><span class="sh">"</span><span class="s">${aws_s3_bucket.example_bucket.arn}/*</span><span class="sh">"</span><span class="s">
        ]
        Condition = {
          Bool = {
            </span><span class="sh">"</span><span class="s">aws:SecureTransport</span><span class="sh">"</span><span class="s"> = </span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="s">
          }
        }
      },
      {
        Sid    = </span><span class="sh">"</span><span class="s">DenyUnencryptedObjectUploads</span><span class="sh">"</span><span class="s">
        Effect = </span><span class="sh">"</span><span class="s">Deny</span><span class="sh">"</span><span class="s">
        Principal = </span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="s">
        Action = </span><span class="sh">"</span><span class="s">s3:PutObject</span><span class="sh">"</span><span class="s">
        Resource = </span><span class="sh">"</span><span class="s">${aws_s3_bucket.example_bucket.arn}/*</span><span class="sh">"</span><span class="s">
        Condition = {
          StringNotEquals = {
            </span><span class="sh">"</span><span class="s">s3:x-amz-server-side-encryption</span><span class="sh">"</span><span class="s"> = </span><span class="sh">"</span><span class="s">aws:kms</span><span class="sh">"</span><span class="s">
          }
        }
      }
    ]
  })
}

# Lifecycle rules for cost optimization
resource </span><span class="sh">"</span><span class="s">aws_s3_bucket_lifecycle_configuration</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">example_bucket_lifecycle</span><span class="sh">"</span><span class="s"> {
  bucket = aws_s3_bucket.example_bucket.id
  
  rule {
    id     = </span><span class="sh">"</span><span class="s">transition-to-ia</span><span class="sh">"</span><span class="s">
    status = </span><span class="sh">"</span><span class="s">Enabled</span><span class="sh">"</span><span class="s">
    
    transition {
      days          = 30
      storage_class = </span><span class="sh">"</span><span class="s">STANDARD_IA</span><span class="sh">"</span><span class="s">
    }
    
    transition {
      days          = 90
      storage_class = </span><span class="sh">"</span><span class="s">GLACIER</span><span class="sh">"</span><span class="s">
    }
    
    noncurrent_version_expiration {
      noncurrent_days = 90
    }
  }
}

# Data source for current AWS account
data </span><span class="sh">"</span><span class="s">aws_caller_identity</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">current</span><span class="sh">"</span><span class="s"> {}
</span></code></pre></div></div>

<p>This code defines a new AWS S3 bucket with the specified name and access control list (ACL) set to private.</p>

<p>To create the S3 bucket, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform apply
</code></pre></div></div>

<p>Terraform will show you a plan of the changes to be made and prompt you to confirm. Type <code class="language-plaintext highlighter-rouge">yes</code> and press Enter to proceed. Once the S3 bucket is created, you should see it in the <a href="https://s3.console.aws.amazon.com/">AWS S3 Management Console</a>.</p>

<h3 id="updating-and-destroying-resources">Updating and Destroying Resources</h3>

<p>To update a resource, modify its configuration in your <code class="language-plaintext highlighter-rouge">main.tf</code> file and run <code class="language-plaintext highlighter-rouge">terraform apply</code> again. For example, change the <code class="language-plaintext highlighter-rouge">acl</code> of the S3 bucket to “public-read”:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"example_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"my-example-bucket-terraform"</span>
  <span class="nx">acl</span>    <span class="o">=</span> <span class="s2">"public-read"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Run <code class="language-plaintext highlighter-rouge">terraform apply</code> and confirm the changes. The S3 bucket’s ACL will be updated to “public-read”.</p>

<p>To destroy a resource, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy
</code></pre></div></div>

<p>Terraform will show you a plan of the resources to be destroyed and prompt you to confirm. Type <code class="language-plaintext highlighter-rouge">yes</code> and press Enter to proceed. The S3 bucket will be deleted.</p>

<h2 id="type-system-and-variable-validation">Type System and Variable Validation</h2>

<h3 id="advanced-type-theory">Advanced Type Theory</h3>

<p>Terraform’s type system is based on structural typing with support for complex types:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Type constraints and custom validation</span>
<span class="nx">variable</span> <span class="s2">"instance_config"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Complex instance configuration with validation"</span>
  
  <span class="nx">type</span> <span class="o">=</span> <span class="nx">object</span><span class="p">({</span>
    <span class="nx">instance_type</span> <span class="o">=</span> <span class="nx">string</span>
    <span class="nx">volume_config</span> <span class="o">=</span> <span class="nx">object</span><span class="p">({</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="nx">number</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="nx">string</span>
      <span class="nx">iops</span> <span class="o">=</span> <span class="nx">optional</span><span class="err">(</span><span class="nx">number</span><span class="p">)</span>
      <span class="nx">throughput</span> <span class="o">=</span> <span class="nx">optional</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">network_config</span> <span class="o">=</span> <span class="nx">object</span><span class="p">({</span>
      <span class="nx">vpc_id</span>     <span class="o">=</span> <span class="nx">string</span>
      <span class="nx">subnet_ids</span> <span class="o">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
      <span class="nx">security_groups</span> <span class="o">=</span> <span class="nx">optional</span><span class="p">(</span><span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">),</span> <span class="p">[])</span>
    <span class="p">})</span>
    <span class="nx">tags</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="p">})</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="o">=</span> <span class="nx">contains</span><span class="p">(</span>
      <span class="p">[</span><span class="s2">"t3.micro"</span><span class="p">,</span> <span class="s2">"t3.small"</span><span class="p">,</span> <span class="s2">"t3.medium"</span><span class="p">,</span> <span class="s2">"m5.large"</span><span class="p">,</span> <span class="s2">"m5.xlarge"</span><span class="p">],</span>
      <span class="nx">var</span><span class="p">.</span><span class="nx">instance_config</span><span class="p">.</span><span class="nx">instance_type</span>
    <span class="p">)</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"Instance type must be one of the allowed values."</span>
  <span class="p">}</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="o">=</span> <span class="p">(</span>
      <span class="nx">var</span><span class="p">.</span><span class="nx">instance_config</span><span class="p">.</span><span class="nx">volume_config</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">"gp3"</span> <span class="o">?</span> 
      <span class="nx">var</span><span class="p">.</span><span class="nx">instance_config</span><span class="p">.</span><span class="nx">volume_config</span><span class="p">.</span><span class="nx">iops</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">:</span> 
      <span class="kc">true</span>
    <span class="p">)</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"IOPS must be specified for gp3 volumes."</span>
  <span class="p">}</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="o">=</span> <span class="nx">alltrue</span><span class="p">([</span>
      <span class="nx">for</span> <span class="nx">subnet_id</span> <span class="nx">in</span> <span class="nx">var</span><span class="p">.</span><span class="nx">instance_config</span><span class="p">.</span><span class="nx">network_config</span><span class="p">.</span><span class="nx">subnet_ids</span> <span class="o">:</span>
      <span class="nx">can</span><span class="p">(</span><span class="nx">regex</span><span class="p">(</span><span class="s2">"^subnet-[a-f0-9]{8,17}$"</span><span class="p">,</span> <span class="nx">subnet_id</span><span class="p">))</span>
    <span class="p">])</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"All subnet IDs must be valid AWS subnet identifiers."</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Custom validation functions</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Validate CIDR blocks</span>
  <span class="nx">validate_cidr</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">in</span> <span class="nx">var</span><span class="p">.</span><span class="nx">network_cidrs</span> <span class="o">:</span>
    <span class="nx">k</span> <span class="o">=&gt;</span> <span class="nx">regex</span><span class="p">(</span><span class="s2">"^([0-9]{1,3}</span><span class="err">\\</span><span class="s2">.){3}[0-9]{1,3}/[0-9]{1,2}$"</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">!</span><span class="p">=</span> <span class="kc">null</span>
  <span class="p">}</span>
  
  <span class="c1"># Cross-variable validation</span>
  <span class="nx">validate_config</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span> <span class="o">==</span> <span class="s2">"production"</span> <span class="o">?</span> 
    <span class="nx">var</span><span class="p">.</span><span class="nx">instance_config</span><span class="p">.</span><span class="nx">instance_type</span> <span class="o">!=</span> <span class="s2">"t3.micro"</span> <span class="o">:</span> 
    <span class="kc">true</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Type composition and generic modules</span>
<span class="nx">variable</span> <span class="s2">"generic_resource_config"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">object</span><span class="p">({</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="nx">bool</span>
    <span class="nx">config</span>  <span class="o">=</span> <span class="nx">any</span>  <span class="c1"># Allows polymorphic configuration</span>
  <span class="p">}))</span>
  
  <span class="nx">default</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">s3</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">versioning</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">lifecycle_rules</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="s2">"cleanup"</span>
            <span class="nx">expiration_days</span> <span class="o">=</span> <span class="mi">90</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">rds</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">engine</span> <span class="o">=</span> <span class="s2">"postgres"</span>
        <span class="nx">version</span> <span class="o">=</span> <span class="s2">"13.7"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="variable-loading-and-precedence">Variable Loading and Precedence</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VariableLoader</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Implements Terraform</span><span class="sh">'</span><span class="s">s variable loading logic</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">precedence_levels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">environment</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">terraform.tfvars</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">terraform.tfvars.json</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">*.auto.tfvars</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">*.auto.tfvars.json</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">-var-file</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">-var</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">TF_VAR_</span><span class="sh">"</span>
        <span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">load_variables</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Load variables with proper precedence</span><span class="sh">"""</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Apply in precedence order
</span>        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">precedence_levels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="n">result</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">validate_types</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
                      <span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="sh">'</span><span class="s">TypeConstraint</span><span class="sh">'</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Type checking and validation</span><span class="sh">"""</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">constraint</span><span class="p">.</span><span class="nf">validate</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]):</span>
                    <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="sh">"</span><span class="s">Variable </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">: expected </span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s">, </span><span class="sh">"</span>
                        <span class="sa">f</span><span class="sh">"</span><span class="s">got </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]).</span><span class="n">__name__</span><span class="si">}</span><span class="sh">"</span>
                    <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></div>

<h2 id="using-variables">Using Variables</h2>

<p>Create a new file named <code class="language-plaintext highlighter-rouge">variables.tf</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch </span>variables.tf
</code></pre></div></div>

<p>Open <code class="language-plaintext highlighter-rouge">variables.tf</code> and add the following variable definitions:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">variable</span> <span class="s2">"region"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"AWS region"</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="s2">"us-west-2"</span>
<span class="p">}</span>

<span class="k">variable</span> <span class="s2">"bucket_name"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The name of the S3 bucket"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
<span class="p">}</span>

<span class="k">variable</span> <span class="s2">"bucket_acl"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The access control list for the S3 bucket"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="s2">"private"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>These variable definitions include a description, type, and optional default value.</p>

<h3 id="using-variables-in-configurations">Using Variables in Configurations</h3>

<p>Update your <code class="language-plaintext highlighter-rouge">main.tf</code> file to use the defined variables:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">region</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"example_bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">bucket_name</span>
  <span class="nx">acl</span>    <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">bucket_acl</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="providing-variable-values">Providing Variable Values</h3>

<p>Create a new file named <code class="language-plaintext highlighter-rouge">terraform.tfvars</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch </span>terraform.tfvars
</code></pre></div></div>

<p>Open <code class="language-plaintext highlighter-rouge">terraform.tfvars</code> and add the following variable values:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">bucket_name</span> <span class="o">=</span> <span class="s2">"my-example-bucket-terraform"</span>
</code></pre></div></div>

<p>Now, when you run <code class="language-plaintext highlighter-rouge">terraform apply</code>, Terraform will use the provided variable values from <code class="language-plaintext highlighter-rouge">terraform.tfvars</code>.</p>

<h2 id="state-management-theory">State Management Theory</h2>

<h3 id="distributed-state-consistency">Distributed State Consistency</h3>

<p>Terraform state management implements distributed systems principles:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// State backend interface with consistency guarantees</span>
<span class="k">type</span> <span class="n">StateBackend</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="c">// Lock acquires a distributed lock with timeout</span>
    <span class="n">Lock</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">info</span> <span class="o">*</span><span class="n">LockInfo</span><span class="p">)</span> <span class="p">(</span><span class="n">LockID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    
    <span class="c">// Unlock releases the lock</span>
    <span class="n">Unlock</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">id</span> <span class="n">LockID</span><span class="p">)</span> <span class="kt">error</span>
    
    <span class="c">// Get retrieves state with consistency level</span>
    <span class="n">Get</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">consistency</span> <span class="n">ConsistencyLevel</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">State</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    
    <span class="c">// Put stores state with conditional update</span>
    <span class="n">Put</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">state</span> <span class="o">*</span><span class="n">State</span><span class="p">,</span> <span class="n">condition</span> <span class="o">*</span><span class="n">Condition</span><span class="p">)</span> <span class="kt">error</span>
    
    <span class="c">// Watch monitors state changes</span>
    <span class="n">Watch</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="n">StateChange</span>
<span class="p">}</span>

<span class="c">// S3 backend with DynamoDB locking</span>
<span class="k">type</span> <span class="n">S3Backend</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">bucket</span>    <span class="kt">string</span>
    <span class="n">key</span>       <span class="kt">string</span>
    <span class="n">s3Client</span>  <span class="o">*</span><span class="n">s3</span><span class="o">.</span><span class="n">Client</span>
    <span class="n">ddbClient</span> <span class="o">*</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">Client</span>
    <span class="n">lockTable</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">S3Backend</span><span class="p">)</span> <span class="n">Lock</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">info</span> <span class="o">*</span><span class="n">LockInfo</span><span class="p">)</span> <span class="p">(</span><span class="n">LockID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lockID</span> <span class="o">:=</span> <span class="n">generateLockID</span><span class="p">()</span>
    
    <span class="c">// Attempt to acquire lock in DynamoDB</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">b</span><span class="o">.</span><span class="n">ddbClient</span><span class="o">.</span><span class="n">PutItem</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">PutItemInput</span><span class="p">{</span>
        <span class="n">TableName</span><span class="o">:</span> <span class="n">aws</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lockTable</span><span class="p">),</span>
        <span class="n">Item</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">types</span><span class="o">.</span><span class="n">AttributeValue</span><span class="p">{</span>
            <span class="s">"LockID"</span><span class="o">:</span>    <span class="o">&amp;</span><span class="n">types</span><span class="o">.</span><span class="n">AttributeValueMemberS</span><span class="p">{</span><span class="n">Value</span><span class="o">:</span> <span class="kt">string</span><span class="p">(</span><span class="n">lockID</span><span class="p">)},</span>
            <span class="s">"Path"</span><span class="o">:</span>      <span class="o">&amp;</span><span class="n">types</span><span class="o">.</span><span class="n">AttributeValueMemberS</span><span class="p">{</span><span class="n">Value</span><span class="o">:</span> <span class="n">b</span><span class="o">.</span><span class="n">key</span><span class="p">},</span>
            <span class="s">"Info"</span><span class="o">:</span>      <span class="o">&amp;</span><span class="n">types</span><span class="o">.</span><span class="n">AttributeValueMemberS</span><span class="p">{</span><span class="n">Value</span><span class="o">:</span> <span class="n">info</span><span class="o">.</span><span class="n">String</span><span class="p">()},</span>
            <span class="s">"Created"</span><span class="o">:</span>   <span class="o">&amp;</span><span class="n">types</span><span class="o">.</span><span class="n">AttributeValueMemberN</span><span class="p">{</span><span class="n">Value</span><span class="o">:</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">())},</span>
            <span class="s">"TTL"</span><span class="o">:</span>       <span class="o">&amp;</span><span class="n">types</span><span class="o">.</span><span class="n">AttributeValueMemberN</span><span class="p">{</span><span class="n">Value</span><span class="o">:</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">30</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">)</span><span class="o">.</span><span class="n">Unix</span><span class="p">())},</span>
        <span class="p">},</span>
        <span class="n">ConditionExpression</span><span class="o">:</span> <span class="n">aws</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"attribute_not_exists(LockID)"</span><span class="p">),</span>
    <span class="p">})</span>
    
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">var</span> <span class="n">condErr</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">ConditionalCheckFailedException</span>
        <span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">As</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">condErr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">ErrLockHeld</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">lockID</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="advanced-remote-state-configuration">Advanced Remote State Configuration</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># S3 backend with enhanced security and performance</span>
<span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="s2">"s3"</span> <span class="p">{</span>
    <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"terraform-state-${data.aws_caller_identity.current.account_id}"</span>
    <span class="nx">key</span>    <span class="o">=</span> <span class="s2">"${var.project}/${var.environment}/terraform.tfstate"</span>
    <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
    
    <span class="c1"># DynamoDB table for state locking</span>
    <span class="nx">dynamodb_table</span> <span class="o">=</span> <span class="s2">"terraform-state-locks"</span>
    
    <span class="c1"># Encryption at rest</span>
    <span class="nx">encrypt</span>        <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">kms_key_id</span>     <span class="o">=</span> <span class="s2">"arn:aws:kms:${var.aws_region}:${data.aws_caller_identity.current.account_id}:key/${var.kms_key_id}"</span>
    
    <span class="c1"># Access logging</span>
    <span class="nx">access_logging</span> <span class="p">{</span>
      <span class="nx">target_bucket</span> <span class="o">=</span> <span class="s2">"terraform-state-access-logs"</span>
      <span class="nx">target_prefix</span> <span class="o">=</span> <span class="s2">"state-access/"</span>
    <span class="p">}</span>
    
    <span class="c1"># Workspace key prefix</span>
    <span class="nx">workspace_key_prefix</span> <span class="o">=</span> <span class="s2">"workspaces"</span>
    
    <span class="c1"># Skip metadata API check (for restricted environments)</span>
    <span class="nx">skip_metadata_api_check</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="c1"># Custom endpoint for S3-compatible storage</span>
    <span class="nx">endpoint</span> <span class="o">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">s3_endpoint</span>
    
    <span class="c1"># Force path style for compatibility</span>
    <span class="nx">force_path_style</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">use_path_style</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># State locking table</span>
<span class="nx">resource</span> <span class="s2">"aws_dynamodb_table"</span> <span class="s2">"terraform_locks"</span> <span class="p">{</span>
  <span class="nx">name</span>         <span class="o">=</span> <span class="s2">"terraform-state-locks"</span>
  <span class="nx">billing_mode</span> <span class="o">=</span> <span class="s2">"PAY_PER_REQUEST"</span>
  <span class="nx">hash_key</span>     <span class="o">=</span> <span class="s2">"LockID"</span>
  
  <span class="c1"># TTL for automatic lock cleanup</span>
  <span class="nx">ttl</span> <span class="p">{</span>
    <span class="nx">attribute_name</span> <span class="o">=</span> <span class="s2">"TTL"</span>
    <span class="nx">enabled</span>        <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Point-in-time recovery</span>
  <span class="nx">point_in_time_recovery</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Global secondary index for querying locks</span>
  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>            <span class="o">=</span> <span class="s2">"PathIndex"</span>
    <span class="nx">hash_key</span>        <span class="o">=</span> <span class="s2">"Path"</span>
    <span class="nx">projection_type</span> <span class="o">=</span> <span class="s2">"ALL"</span>
  <span class="p">}</span>
  
  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Purpose</span> <span class="o">=</span> <span class="s2">"TerraformStateLocking"</span>
    <span class="nx">Critical</span> <span class="o">=</span> <span class="s2">"true"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="state-migration-and-refactoring">State Migration and Refactoring</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StateMigrator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Handles complex state migrations and refactoring</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">source_backend</span><span class="p">:</span> <span class="n">StateBackend</span><span class="p">,</span> <span class="n">target_backend</span><span class="p">:</span> <span class="n">StateBackend</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source_backend</span>
        <span class="n">self</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target_backend</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">migrate_with_transformation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> 
                                        <span class="n">transformer</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">State</span><span class="p">],</span> <span class="n">State</span><span class="p">],</span>
                                        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MigrationResult</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Migrate state with transformation function</span><span class="sh">"""</span>
        
        <span class="c1"># Acquire locks on both backends
</span>        <span class="n">source_lock</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="nf">lock</span><span class="p">(</span><span class="nc">LockInfo</span><span class="p">(</span><span class="sh">"</span><span class="s">migration-read</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">target_lock</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="nf">lock</span><span class="p">(</span><span class="nc">LockInfo</span><span class="p">(</span><span class="sh">"</span><span class="s">migration-write</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read source state
</span>            <span class="n">source_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">ConsistencyLevel</span><span class="p">.</span><span class="n">STRONG</span><span class="p">)</span>
            
            <span class="c1"># Apply transformation
</span>            <span class="n">target_state</span> <span class="o">=</span> <span class="nf">transformer</span><span class="p">(</span><span class="n">source_state</span><span class="p">)</span>
            
            <span class="c1"># Validate transformed state
</span>            <span class="n">validation_errors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">validate_state</span><span class="p">(</span><span class="n">target_state</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validation_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">State validation failed: </span><span class="si">{</span><span class="n">validation_errors</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="c1"># Write to target
</span>                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">target_state</span><span class="p">,</span> <span class="nc">Condition</span><span class="p">(</span><span class="n">not_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                
                <span class="c1"># Verify write
</span>                <span class="n">verified_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">ConsistencyLevel</span><span class="p">.</span><span class="n">STRONG</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verified_state</span><span class="p">.</span><span class="nf">hash</span><span class="p">()</span> <span class="o">!=</span> <span class="n">target_state</span><span class="p">.</span><span class="nf">hash</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">State verification failed</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="nc">MigrationResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">resources_migrated</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">target_state</span><span class="p">.</span><span class="n">resources</span><span class="p">),</span>
                <span class="n">transformations_applied</span><span class="o">=</span><span class="n">transformer</span><span class="p">.</span><span class="n">transformations_count</span>
            <span class="p">)</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always release locks
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="nf">unlock</span><span class="p">(</span><span class="n">source_lock</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="nf">unlock</span><span class="p">(</span><span class="n">target_lock</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="outputs-and-remote-state-management">Outputs and Remote State Management</h2>

<p>Outputs in Terraform are used to display specific values from your configuration after it is applied.</p>

<h3 id="defining-outputs">Defining Outputs</h3>

<p>Create a new file named <code class="language-plaintext highlighter-rouge">outputs.tf</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch </span>outputs.tf
</code></pre></div></div>

<p>Open <code class="language-plaintext highlighter-rouge">outputs.tf</code> and add the following output definition:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">output</span> <span class="s2">"bucket_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The Amazon Resource Name (ARN) of the created S3 bucket"</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">example_bucket</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After applying your configuration with <code class="language-plaintext highlighter-rouge">terraform apply</code>, the output value will be displayed.</p>

<h3 id="remote-state-management">Remote State Management</h3>

<p>By default, Terraform stores the state of your infrastructure in a local file named <code class="language-plaintext highlighter-rouge">terraform.tfstate</code>. To store the state remotely and enable collaboration, you can use remote state backends like Amazon S3.</p>

<p>To configure a remote backend, update your <code class="language-plaintext highlighter-rouge">main.tf</code> file with the following code:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="s2">"s3"</span> <span class="p">{</span>
    <span class="nx">bucket</span> <span class="o">=</span> <span class="s2">"my-terraform-state-bucket"</span>
    <span class="nx">key</span>    <span class="o">=</span> <span class="s2">"terraform-aws-example/terraform.tfstate"</span>
    <span class="nx">region</span> <span class="o">=</span> <span class="s2">"us-west-2"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">"my-terraform-state-bucket"</code> with the name of an existing S3 bucket in your AWS account. The <code class="language-plaintext highlighter-rouge">key</code> specifies the path in the bucket where the state file will be stored.</p>

<p>After updating the <code class="language-plaintext highlighter-rouge">main.tf</code>, run <code class="language-plaintext highlighter-rouge">terraform init</code> again:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform init
</code></pre></div></div>

<p>Terraform will prompt you to confirm the migration of the local state to the remote backend. Type <code class="language-plaintext highlighter-rouge">yes</code> and press Enter to proceed. From now on, Terraform will store the state in the specified S3 bucket.</p>

<h2 id="advanced-module-patterns">Advanced Module Patterns</h2>

<h3 id="module-composition-theory">Module Composition Theory</h3>

<p>Modules in Terraform can be understood as functors in category theory:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Generic module interface pattern</span>
<span class="nx">module</span> <span class="s2">"generic_app"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/composable-app"</span>
  
  <span class="c1"># Module composition using higher-order modules</span>
  <span class="nx">providers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>   <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">us_east_1</span>
    <span class="nx">aws</span><span class="p">.</span><span class="nx">secondary</span> <span class="o">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">us_west_2</span>
  <span class="p">}</span>
  
  <span class="c1"># Dependency injection pattern</span>
  <span class="nx">dependencies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">network</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">network</span>
    <span class="nx">security</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">security</span>
    <span class="nx">monitoring</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">monitoring</span>
  <span class="p">}</span>
  
  <span class="c1"># Feature flags for conditional composition</span>
  <span class="nx">features</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">multi_region</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">auto_scaling</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">blue_green</span>   <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">canary</span>       <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
  
  <span class="c1"># Dynamic configuration</span>
  <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">applications</span>
  
  <span class="nx">app_config</span> <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span>
<span class="p">}</span>

<span class="c1"># Module with advanced type constraints</span>
<span class="nx">module</span> <span class="s2">"typed_infrastructure"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./modules/typed-infra"</span>
  
  <span class="c1"># Type-safe configuration using experiments</span>
  <span class="nx">configuration</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">compute</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">instances</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">i</span> <span class="nx">in</span> <span class="nx">range</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">instance_count</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span>
          <span class="nx">name</span> <span class="o">=</span> <span class="s2">"instance-${i}"</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">instance_types</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">length</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">instance_types</span><span class="p">)]</span>
          
          <span class="c1"># Conditional nested objects</span>
          <span class="nx">monitoring</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">enable_monitoring</span> <span class="o">?</span> <span class="p">{</span>
            <span class="nx">detailed</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="nx">interval</span> <span class="o">=</span> <span class="mi">60</span>
          <span class="p">}</span> <span class="o">:</span> <span class="kc">null</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="module-testing-framework">Module Testing Framework</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Terratest-style module testing</span>
<span class="k">func</span> <span class="n">TestComposableAppModule</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Parallel</span><span class="p">()</span>
    
    <span class="c">// Test matrix for different configurations</span>
    <span class="n">testCases</span> <span class="o">:=</span> <span class="p">[]</span><span class="k">struct</span> <span class="p">{</span>
        <span class="n">name</span>     <span class="kt">string</span>
        <span class="n">vars</span>     <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}</span>
        <span class="n">validate</span> <span class="k">func</span><span class="p">(</span><span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">terraform</span><span class="o">.</span><span class="n">Options</span><span class="p">,</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{})</span>
    <span class="p">}{</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="o">:</span> <span class="s">"multi-region-deployment"</span><span class="p">,</span>
            <span class="n">vars</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span>
                <span class="s">"features"</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span>
                    <span class="s">"multi_region"</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
                    <span class="s">"auto_scaling"</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="n">validate</span><span class="o">:</span> <span class="n">validateMultiRegion</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="o">:</span> <span class="s">"single-region-basic"</span><span class="p">,</span>
            <span class="n">vars</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span>
                <span class="s">"features"</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span>
                    <span class="s">"multi_region"</span><span class="o">:</span> <span class="no">false</span><span class="p">,</span>
                    <span class="s">"auto_scaling"</span><span class="o">:</span> <span class="no">false</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="n">validate</span><span class="o">:</span> <span class="n">validateSingleRegion</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tc</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">testCases</span> <span class="p">{</span>
        <span class="n">tc</span> <span class="o">:=</span> <span class="n">tc</span> <span class="c">// Capture range variable</span>
        
        <span class="n">t</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">tc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">t</span><span class="o">.</span><span class="n">Parallel</span><span class="p">()</span>
            
            <span class="n">terraformOptions</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">terraform</span><span class="o">.</span><span class="n">Options</span><span class="p">{</span>
                <span class="n">TerraformDir</span><span class="o">:</span> <span class="s">"../../modules/composable-app"</span><span class="p">,</span>
                <span class="n">Vars</span><span class="o">:</span>         <span class="n">tc</span><span class="o">.</span><span class="n">vars</span><span class="p">,</span>
                <span class="n">NoColor</span><span class="o">:</span>      <span class="no">true</span><span class="p">,</span>
                
                <span class="c">// Retry configuration for flaky resources</span>
                <span class="n">RetryableTerraformErrors</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
                    <span class="s">".*timeout.*"</span><span class="o">:</span> <span class="s">"Timeout error occurred"</span><span class="p">,</span>
                    <span class="s">".*rate limit.*"</span><span class="o">:</span> <span class="s">"Rate limit hit"</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">MaxRetries</span><span class="o">:</span> <span class="m">3</span><span class="p">,</span>
                <span class="n">TimeBetweenRetries</span><span class="o">:</span> <span class="m">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="c">// Clean up resources</span>
            <span class="k">defer</span> <span class="n">terraform</span><span class="o">.</span><span class="n">Destroy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">terraformOptions</span><span class="p">)</span>
            
            <span class="c">// Deploy infrastructure</span>
            <span class="n">terraform</span><span class="o">.</span><span class="n">InitAndApply</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">terraformOptions</span><span class="p">)</span>
            
            <span class="c">// Get outputs</span>
            <span class="n">outputs</span> <span class="o">:=</span> <span class="n">terraform</span><span class="o">.</span><span class="n">OutputAll</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">terraformOptions</span><span class="p">)</span>
            
            <span class="c">// Run validations</span>
            <span class="n">tc</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">terraformOptions</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="module-registry-protocol">Module Registry Protocol</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ModuleRegistry</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Implementation of Terraform Module Registry Protocol</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">discover</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Implement service discovery</span><span class="sh">"""</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/.well-known/terraform.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_versions</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">List available module versions</span><span class="sh">"""</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/v1/modules/</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s">/versions</span><span class="sh">"</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">version</span><span class="sh">"</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">modules</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">versions</span><span class="sh">"</span><span class="p">]]</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Get module download URL</span><span class="sh">"""</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/v1/modules/</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s">/download</span><span class="sh">"</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        
        <span class="c1"># Follow redirect to actual download URL
</span>        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">"</span><span class="s">X-Terraform-Get</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">download_url</span><span class="sh">"</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">generate_lock_file</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ModuleRef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Generate module lock file for reproducible builds</span><span class="sh">"""</span>
        <span class="n">lock_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">version</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">modules</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
            <span class="n">lock_data</span><span class="p">[</span><span class="sh">"</span><span class="s">modules</span><span class="sh">"</span><span class="p">][</span><span class="n">module</span><span class="p">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">:</span> <span class="n">module</span><span class="p">.</span><span class="n">source</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">version</span><span class="sh">"</span><span class="p">:</span> <span class="n">module</span><span class="p">.</span><span class="n">version</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">module</span><span class="p">.</span><span class="nf">calculate_hash</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">dependencies</span><span class="sh">"</span><span class="p">:</span> <span class="n">module</span><span class="p">.</span><span class="n">dependencies</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">lock_data</span>
</code></pre></div></div>

<h2 id="modules">Modules</h2>

<p>Modules in Terraform are self-contained, reusable packages of Terraform configurations. They allow you to organize your infrastructure into smaller, maintainable units and promote the reuse of common configurations.</p>

<h3 id="creating-a-module">Creating a Module</h3>

<p>Create a new directory named <code class="language-plaintext highlighter-rouge">modules</code> in your Terraform project and create a subdirectory named <code class="language-plaintext highlighter-rouge">s3_bucket</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> modules/s3_bucket
</code></pre></div></div>

<p>Inside the <code class="language-plaintext highlighter-rouge">s3_bucket</code> directory, create two files: <code class="language-plaintext highlighter-rouge">main.tf</code> and <code class="language-plaintext highlighter-rouge">variables.tf</code>.</p>

<p>Open <code class="language-plaintext highlighter-rouge">modules/s3_bucket/main.tf</code> and add the following code:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"aws_s3_bucket"</span> <span class="s2">"bucket"</span> <span class="p">{</span>
  <span class="nx">bucket</span> <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">bucket_name</span>
  <span class="nx">acl</span>    <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">bucket_acl</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Open <code class="language-plaintext highlighter-rouge">modules/s3_bucket/variables.tf</code> and add the following variable definitions:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">variable</span> <span class="s2">"bucket_name"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The name of the S3 bucket"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
<span class="p">}</span>

<span class="k">variable</span> <span class="s2">"bucket_acl"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The access control list for the S3 bucket"</span>
  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">default</span>     <span class="o">=</span> <span class="s2">"private"</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="using-a-module-in-your-configuration">Using a Module in Your Configuration</h3>

<p>Update your <code class="language-plaintext highlighter-rouge">main.tf</code> file in the root directory of your Terraform project to use the <code class="language-plaintext highlighter-rouge">s3_bucket</code> module:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">region</span>
<span class="p">}</span>

<span class="k">module</span> <span class="s2">"example_bucket"</span> <span class="p">{</span>
  <span class="nx">source</span>     <span class="o">=</span> <span class="s2">"./modules/s3_bucket"</span>
  <span class="nx">bucket_name</span> <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">bucket_name</span>
  <span class="nx">bucket_acl</span>  <span class="o">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">bucket_acl</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, when you run <code class="language-plaintext highlighter-rouge">terraform apply</code>, Terraform will use the <code class="language-plaintext highlighter-rouge">s3_bucket</code> module to create the S3 bucket.</p>

<h3 id="module-outputs">Module Outputs</h3>

<p>To use the output values from a module, you need to define them in the module configuration. Add the following output definition to <code class="language-plaintext highlighter-rouge">modules/s3_bucket/outputs.tf</code>:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">output</span> <span class="s2">"bucket_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The Amazon Resource Name (ARN) of the created S3 bucket"</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="nx">aws_s3_bucket</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To access this output value in your root configuration, update <code class="language-plaintext highlighter-rouge">outputs.tf</code> in the root directory:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">output</span> <span class="s2">"bucket_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"The Amazon Resource Name (ARN) of the created S3 bucket"</span>
  <span class="nx">value</span>       <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">example_bucket</span><span class="p">.</span><span class="nx">bucket_arn</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After applying your configuration with <code class="language-plaintext highlighter-rouge">terraform apply</code>, the output value will be displayed.</p>

<h2 id="performance-optimization">Performance Optimization</h2>

<h3 id="parallel-execution-and-resource-batching">Parallel Execution and Resource Batching</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Terraform's parallel execution engine</span>
<span class="k">type</span> <span class="n">ParallelExecutor</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">maxConcurrency</span> <span class="kt">int</span>
    <span class="n">semaphore</span>      <span class="k">chan</span> <span class="k">struct</span><span class="p">{}</span>
    <span class="n">errorGroup</span>     <span class="o">*</span><span class="n">errgroup</span><span class="o">.</span><span class="n">Group</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">e</span> <span class="o">*</span><span class="n">ParallelExecutor</span><span class="p">)</span> <span class="n">ExecutePlan</span><span class="p">(</span><span class="n">plan</span> <span class="o">*</span><span class="n">Plan</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c">// Build execution graph</span>
    <span class="n">graph</span> <span class="o">:=</span> <span class="n">plan</span><span class="o">.</span><span class="n">BuildDependencyGraph</span><span class="p">()</span>
    
    <span class="c">// Get parallel execution levels</span>
    <span class="n">levels</span> <span class="o">:=</span> <span class="n">graph</span><span class="o">.</span><span class="n">GetParallelLevels</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">level</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">levels</span> <span class="p">{</span>
        <span class="c">// Execute all resources in this level in parallel</span>
        <span class="n">g</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">:=</span> <span class="n">errgroup</span><span class="o">.</span><span class="n">WithContext</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">resource</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">level</span> <span class="p">{</span>
            <span class="n">resource</span> <span class="o">:=</span> <span class="n">resource</span> <span class="c">// Capture loop variable</span>
            
            <span class="n">g</span><span class="o">.</span><span class="n">Go</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
                <span class="c">// Acquire semaphore</span>
                <span class="k">select</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">e</span><span class="o">.</span><span class="n">semaphore</span> <span class="o">&lt;-</span> <span class="k">struct</span><span class="p">{}{}</span><span class="o">:</span>
                    <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="o">&lt;-</span><span class="n">e</span><span class="o">.</span><span class="n">semaphore</span> <span class="p">}()</span>
                <span class="k">case</span> <span class="o">&lt;-</span><span class="n">ctx</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span><span class="o">:</span>
                    <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span>
                <span class="p">}</span>
                
                <span class="c">// Execute resource operation</span>
                <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">executeResource</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">g</span><span class="o">.</span><span class="n">Wait</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">err</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="c">// Batching API calls for performance</span>
<span class="k">func</span> <span class="p">(</span><span class="n">e</span> <span class="o">*</span><span class="n">ParallelExecutor</span><span class="p">)</span> <span class="n">executeResource</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Resource</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">r</span><span class="o">.</span><span class="n">Type</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">"aws_instance"</span><span class="o">:</span>
        <span class="c">// Batch EC2 operations</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">batchEC2Operations</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">case</span> <span class="s">"aws_security_group_rule"</span><span class="o">:</span>
        <span class="c">// Batch security group rules</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">batchSecurityGroupRules</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">executeSingle</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="state-performance-optimization">State Performance Optimization</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Optimize state operations with partial updates</span>
<span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="nx">module_variable_optional_attrs</span><span class="p">]</span>
  
  <span class="c1"># Configure backend with performance optimizations</span>
  <span class="nx">backend</span> <span class="s2">"s3"</span> <span class="p">{</span>
    <span class="c1"># Enable state compression</span>
    <span class="nx">compress</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="c1"># Partial state updates (reduces lock time)</span>
    <span class="nx">enable_partial_updates</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="c1"># Async state uploads</span>
    <span class="nx">async_upload</span> <span class="o">=</span> <span class="kc">true</span>
    
    <span class="c1"># Connection pooling</span>
    <span class="nx">max_connections</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Resource targeting for large infrastructures</span>
<span class="nx">resource</span> <span class="s2">"null_resource"</span> <span class="s2">"targeted_apply"</span> <span class="p">{</span>
  <span class="nx">provisioner</span> <span class="s2">"local-exec"</span> <span class="p">{</span>
    <span class="nx">command</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="nx">EOT</span>
      <span class="c1"># Apply only specific resources</span>
      <span class="nx">terraform</span> <span class="nx">apply</span> <span class="o">-</span><span class="nx">target</span><span class="o">=</span><span class="nx">module</span><span class="err">.</span><span class="nx">critical_path</span>
      
      <span class="c1"># Then apply dependent resources</span>
      <span class="nx">terraform</span> <span class="nx">apply</span> <span class="o">-</span><span class="nx">target</span><span class="o">=</span><span class="nx">module</span><span class="p">.</span><span class="nx">dependent_resources</span>
      
      <span class="c1"># Finally, full apply</span>
      <span class="nx">terraform</span> <span class="nx">apply</span>
    <span class="nx">EOT</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-patterns">Security Patterns</h2>

<h3 id="policy-as-code">Policy as Code</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sentinel policy for compliance</span>
<span class="nx">policy</span> <span class="s2">"require-encryption"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="s2">"./policies/encryption.sentinel"</span>
  
  <span class="nx">enforcement_level</span> <span class="o">=</span> <span class="s2">"hard-mandatory"</span>
<span class="p">}</span>

<span class="c1"># OPA (Open Policy Agent) integration</span>
<span class="nx">data</span> <span class="s2">"opa_policy_decision"</span> <span class="s2">"deployment"</span> <span class="p">{</span>
  <span class="nx">input</span> <span class="o">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">terraform_plan</span> <span class="o">=</span> <span class="nx">jsondecode</span><span class="p">(</span><span class="nx">file</span><span class="p">(</span><span class="s2">"${path.module}/tfplan.json"</span><span class="p">))</span>
    <span class="nx">user</span>           <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_caller_identity</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">environment</span>    <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">environment</span>
  <span class="p">})</span>
  
  <span class="nx">query</span> <span class="o">=</span> <span class="s2">"data.terraform.authorization.allow"</span>
  
  <span class="nx">policy</span> <span class="o">=</span> <span class="nx">file</span><span class="p">(</span><span class="s2">"${path.module}/policies/deployment.rego"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Automated security scanning</span>
<span class="nx">resource</span> <span class="s2">"null_resource"</span> <span class="s2">"security_scan"</span> <span class="p">{</span>
  <span class="nx">provisioner</span> <span class="s2">"local-exec"</span> <span class="p">{</span>
    <span class="nx">command</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="nx">EOT</span>
      <span class="c1"># Checkov security scanning</span>
      <span class="nx">checkov</span> <span class="o">-</span><span class="nx">f</span> <span class="nx">$</span><span class="p">{</span><span class="nx">path</span><span class="p">.</span><span class="nx">module</span><span class="p">}</span> <span class="o">--</span><span class="nx">framework</span> <span class="nx">terraform</span>
      
      <span class="c1"># tfsec static analysis</span>
      <span class="nx">tfsec</span> <span class="nx">$</span><span class="p">{</span><span class="nx">path</span><span class="p">.</span><span class="nx">module</span><span class="p">}</span> <span class="o">--</span><span class="nx">minimum-severity</span> <span class="nx">HIGH</span>
      
      <span class="c1"># Terrascan policy enforcement</span>
      <span class="nx">terrascan</span> <span class="nx">scan</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">terraform</span> <span class="o">-</span><span class="nx">d</span> <span class="nx">$</span><span class="p">{</span><span class="nx">path</span><span class="p">.</span><span class="nx">module</span><span class="p">}</span>
    <span class="nx">EOT</span>
  <span class="err">}</span>
  
  <span class="nx">triggers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">always_run</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">()</span>
  <span class="p">}</span>
<span class="err">}</span>
</code></pre></div></div>

<h3 id="secret-management">Secret Management</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Vault provider for dynamic secrets</span>
<span class="nx">provider</span> <span class="s2">"vault"</span> <span class="p">{</span>
  <span class="nx">address</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">vault_addr</span>
  
  <span class="nx">auth_login</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="s2">"auth/aws/login"</span>
    
    <span class="nx">parameters</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">role</span> <span class="o">=</span> <span class="s2">"terraform-${var.environment}"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Dynamic database credentials</span>
<span class="nx">data</span> <span class="s2">"vault_database_creds"</span> <span class="s2">"db"</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="o">=</span> <span class="s2">"database"</span>
  <span class="nx">role</span>    <span class="o">=</span> <span class="s2">"readonly"</span>
<span class="p">}</span>

<span class="c1"># AWS dynamic credentials</span>
<span class="nx">data</span> <span class="s2">"vault_aws_access_credentials"</span> <span class="s2">"creds"</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="o">=</span> <span class="s2">"aws"</span>
  <span class="nx">role</span>    <span class="o">=</span> <span class="s2">"deploy"</span>
  <span class="nx">type</span>    <span class="o">=</span> <span class="s2">"sts"</span>
<span class="p">}</span>

<span class="c1"># Encrypted variable handling</span>
<span class="nx">variable</span> <span class="s2">"sensitive_config"</span> <span class="p">{</span>
  <span class="nx">type</span>      <span class="o">=</span> <span class="nx">string</span>
  <span class="nx">sensitive</span> <span class="o">=</span> <span class="kc">true</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="o">=</span> <span class="nx">can</span><span class="p">(</span><span class="nx">jsondecode</span><span class="p">(</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">aws_kms_secrets</span><span class="p">.</span><span class="nx">decrypted</span><span class="p">.</span><span class="nx">plaintext</span><span class="p">[</span><span class="s2">"config"</span><span class="p">]</span>
    <span class="p">))</span>
    <span class="nx">error_message</span> <span class="o">=</span> <span class="s2">"Failed to decrypt sensitive configuration."</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="meta-programming-and-code-generation">Meta-Programming and Code Generation</h2>

<h3 id="dynamic-resource-generation">Dynamic Resource Generation</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Generate resources from external data</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Load configuration from external source</span>
  <span class="nx">resource_definitions</span> <span class="o">=</span> <span class="nx">jsondecode</span><span class="p">(</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">resource_config</span><span class="p">.</span><span class="nx">response_body</span>
  <span class="p">)</span>
  
  <span class="c1"># Transform into Terraform resources</span>
  <span class="nx">generated_resources</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">config</span> <span class="nx">in</span> <span class="nx">local</span><span class="p">.</span><span class="nx">resource_definitions</span> <span class="o">:</span> <span class="nx">name</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1"># Meta-programming pattern</span>
      <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">instances</span>
      
      <span class="c1"># Dynamic block generation</span>
      <span class="nx">dynamic</span> <span class="s2">"setting"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">settings</span>
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">name</span>  <span class="o">=</span> <span class="nx">setting</span><span class="p">.</span><span class="nx">key</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">setting</span><span class="p">.</span><span class="nx">value</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Code generation with templatefile</span>
<span class="nx">resource</span> <span class="s2">"local_file"</span> <span class="s2">"generated_module"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="o">=</span> <span class="nx">local</span><span class="p">.</span><span class="nx">generated_resources</span>
  
  <span class="nx">filename</span> <span class="o">=</span> <span class="s2">"${path.module}/generated/${each.key}.tf"</span>
  
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">templatefile</span><span class="p">(</span><span class="s2">"${path.module}/templates/resource.tftpl"</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">resource_type</span> <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">type</span>
    <span class="nx">resource_name</span> <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">key</span>
    <span class="nx">configuration</span> <span class="o">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Terraform CDK example</span>
<span class="c1"># typescript</span>
<span class="nx">import</span> <span class="p">{</span> <span class="nx">Construct</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'constructs'</span><span class="err">;</span>
<span class="nx">import</span> <span class="p">{</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">TerraformStack</span><span class="p">,</span> <span class="nx">TerraformOutput</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'cdktf'</span><span class="err">;</span>
<span class="nx">import</span> <span class="p">{</span> <span class="nx">AwsProvider</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@cdktf/provider-aws'</span><span class="err">;</span>

<span class="nx">class</span> <span class="nx">MetaProgrammingStack</span> <span class="nx">extends</span> <span class="nx">TerraformStack</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="o">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span><span class="err">;</span>
    
    <span class="nx">new</span> <span class="nx">AwsProvider</span><span class="p">(</span><span class="nx">this</span><span class="p">,</span> <span class="s1">'aws'</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">region</span><span class="o">:</span> <span class="s1">'us-east-1'</span>
    <span class="p">})</span><span class="err">;</span>
    
    <span class="c1">// Generate resources programmatically</span>
    <span class="nx">const</span> <span class="nx">resources</span> <span class="o">=</span> <span class="nx">this</span><span class="p">.</span><span class="nx">generateResources</span><span class="p">()</span><span class="err">;</span>
    
    <span class="nx">resources</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">=</span><span class="o">&gt;</span> <span class="p">{</span>
      <span class="nx">new</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">this</span><span class="p">,</span> <span class="err">`</span><span class="nx">resource-$</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span><span class="err">`</span><span class="p">,</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span><span class="err">;</span>
    <span class="p">})</span><span class="err">;</span>
  <span class="p">}</span>
  
  <span class="nx">private</span> <span class="nx">generateResources</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Complex logic for resource generation</span>
    <span class="nx">return</span> <span class="nx">configurations</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">config</span> <span class="o">=&gt;</span> <span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">this</span><span class="p">.</span><span class="nx">resolveResourceType</span><span class="p">(</span><span class="nx">config</span><span class="p">),</span>
      <span class="nx">config</span><span class="o">:</span> <span class="nx">this</span><span class="p">.</span><span class="nx">transformConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
    <span class="p">}))</span><span class="err">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="testing-strategies">Testing Strategies</h2>

<h3 id="contract-testing">Contract Testing</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Contract tests for modules</span>
<span class="k">func</span> <span class="n">TestModuleContract</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tests</span> <span class="o">:=</span> <span class="p">[]</span><span class="k">struct</span> <span class="p">{</span>
        <span class="n">name</span>     <span class="kt">string</span>
        <span class="n">module</span>   <span class="kt">string</span>
        <span class="n">contract</span> <span class="n">ModuleContract</span>
    <span class="p">}{</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="o">:</span>   <span class="s">"networking-module-contract"</span><span class="p">,</span>
            <span class="n">module</span><span class="o">:</span> <span class="s">"./modules/networking"</span><span class="p">,</span>
            <span class="n">contract</span><span class="o">:</span> <span class="n">ModuleContract</span><span class="p">{</span>
                <span class="n">RequiredInputs</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"vpc_cidr"</span><span class="p">,</span> <span class="s">"availability_zones"</span><span class="p">},</span>
                <span class="n">RequiredOutputs</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"vpc_id"</span><span class="p">,</span> <span class="s">"subnet_ids"</span><span class="p">,</span> <span class="s">"nat_gateway_ids"</span><span class="p">},</span>
                <span class="n">ResourceTypes</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"aws_vpc"</span><span class="p">,</span> <span class="s">"aws_subnet"</span><span class="p">,</span> <span class="s">"aws_nat_gateway"</span><span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// Parse module</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">tfconfig</span><span class="o">.</span><span class="n">LoadModule</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
            <span class="n">require</span><span class="o">.</span><span class="n">NoError</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            
            <span class="c">// Verify contract</span>
            <span class="n">tt</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">// Property-based testing</span>
<span class="k">func</span> <span class="n">TestInfrastructureProperties</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">quick</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">instanceCount</span> <span class="kt">int</span><span class="p">,</span> <span class="n">azCount</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">instanceCount</span> <span class="o">&lt;</span> <span class="m">0</span> <span class="o">||</span> <span class="n">azCount</span> <span class="o">&lt;</span> <span class="m">0</span> <span class="p">{</span>
            <span class="k">return</span> <span class="no">true</span> <span class="c">// Skip invalid inputs</span>
        <span class="p">}</span>
        
        <span class="c">// Apply terraform with generated inputs</span>
        <span class="n">opts</span> <span class="o">:=</span> <span class="n">terraform</span><span class="o">.</span><span class="n">WithDefaultRetryableErrors</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">terraform</span><span class="o">.</span><span class="n">Options</span><span class="p">{</span>
            <span class="n">TerraformDir</span><span class="o">:</span> <span class="s">"./test"</span><span class="p">,</span>
            <span class="n">Vars</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span>
                <span class="s">"instance_count"</span><span class="o">:</span> <span class="n">instanceCount</span> <span class="o">%</span> <span class="m">10</span><span class="p">,</span> <span class="c">// Limit for testing</span>
                <span class="s">"az_count"</span><span class="o">:</span>       <span class="n">azCount</span> <span class="o">%</span> <span class="m">3</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">})</span>
        
        <span class="k">defer</span> <span class="n">terraform</span><span class="o">.</span><span class="n">Destroy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="n">terraform</span><span class="o">.</span><span class="n">InitAndApply</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        
        <span class="c">// Verify properties</span>
        <span class="n">actualInstances</span> <span class="o">:=</span> <span class="n">terraform</span><span class="o">.</span><span class="n">OutputList</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="s">"instance_ids"</span><span class="p">)</span>
        <span class="n">actualAZs</span> <span class="o">:=</span> <span class="n">terraform</span><span class="o">.</span><span class="n">OutputList</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="s">"availability_zones"</span><span class="p">)</span>
        
        <span class="c">// Property: instance count matches input</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">actualInstances</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">instanceCount</span> <span class="o">%</span> <span class="m">10</span><span class="p">)</span>
    <span class="p">},</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="compliance-testing">Compliance Testing</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pytest</span>
<span class="kn">from</span> <span class="n">terraform_compliance.common</span> <span class="kn">import</span> <span class="n">Validator</span>

<span class="k">class</span> <span class="nc">TestCompliance</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Automated compliance testing for Terraform configurations</span><span class="sh">"""</span>
    
    <span class="nd">@pytest.mark.compliance</span>
    <span class="k">def</span> <span class="nf">test_encryption_requirements</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">terraform_plan</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Ensure all storage resources are encrypted</span><span class="sh">"""</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="nc">Validator</span><span class="p">(</span><span class="n">terraform_plan</span><span class="p">)</span>
        
        <span class="c1"># Check S3 buckets
</span>        <span class="n">s3_buckets</span> <span class="o">=</span> <span class="n">validator</span><span class="p">.</span><span class="nf">select_resources</span><span class="p">(</span><span class="sh">"</span><span class="s">aws_s3_bucket</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">s3_buckets</span><span class="p">:</span>
            <span class="n">encryption</span> <span class="o">=</span> <span class="n">validator</span><span class="p">.</span><span class="nf">select_related</span><span class="p">(</span>
                <span class="n">bucket</span><span class="p">,</span> 
                <span class="sh">"</span><span class="s">aws_s3_bucket_server_side_encryption_configuration</span><span class="sh">"</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">encryption</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bucket </span><span class="si">{</span><span class="n">bucket</span><span class="p">[</span><span class="sh">'</span><span class="s">address</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> missing encryption</span><span class="sh">"</span>
        
        <span class="c1"># Check EBS volumes
</span>        <span class="n">ebs_volumes</span> <span class="o">=</span> <span class="n">validator</span><span class="p">.</span><span class="nf">select_resources</span><span class="p">(</span><span class="sh">"</span><span class="s">aws_ebs_volume</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">ebs_volumes</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">volume</span><span class="p">[</span><span class="sh">'</span><span class="s">values</span><span class="sh">'</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">encrypted</span><span class="sh">'</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> \
                <span class="sa">f</span><span class="sh">"</span><span class="s">EBS volume </span><span class="si">{</span><span class="n">volume</span><span class="p">[</span><span class="sh">'</span><span class="s">address</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> not encrypted</span><span class="sh">"</span>
    
    <span class="nd">@pytest.mark.compliance</span>
    <span class="k">def</span> <span class="nf">test_network_isolation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">terraform_plan</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Verify network isolation requirements</span><span class="sh">"""</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="nc">Validator</span><span class="p">(</span><span class="n">terraform_plan</span><span class="p">)</span>
        
        <span class="c1"># No public IPs in production
</span>        <span class="k">if</span> <span class="n">validator</span><span class="p">.</span><span class="nf">get_variable</span><span class="p">(</span><span class="sh">'</span><span class="s">environment</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">production</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">validator</span><span class="p">.</span><span class="nf">select_resources</span><span class="p">(</span><span class="sh">"</span><span class="s">aws_instance</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">[</span><span class="sh">'</span><span class="s">values</span><span class="sh">'</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">associate_public_ip_address</span><span class="sh">'</span><span class="p">),</span> \
                    <span class="sa">f</span><span class="sh">"</span><span class="s">Instance </span><span class="si">{</span><span class="n">instance</span><span class="p">[</span><span class="sh">'</span><span class="s">address</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> has public IP in production</span><span class="sh">"</span>
</code></pre></div></div>

<h2 id="research-frontiers">Research Frontiers</h2>

<h3 id="quantum-infrastructure-modeling">Quantum Infrastructure Modeling</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Theoretical: Quantum superposition for infrastructure states
</span><span class="k">class</span> <span class="nc">QuantumInfrastructure</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Research concept: Model infrastructure states as quantum superpositions
    to explore multiple configurations simultaneously
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">qubits</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">initialize_infrastructure_qubits</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">superposition_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Create superposition of all possible infrastructure states
        </span><span class="sh">"""</span>
        <span class="c1"># |ψ⟩ = Σ αᵢ|configᵢ⟩
</span>        <span class="c1"># Where each |configᵢ⟩ represents a valid infrastructure configuration
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">measure_optimal_configuration</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Collapse to optimal configuration based on constraints
        </span><span class="sh">"""</span>
        <span class="c1"># Apply quantum optimization algorithms
</span>        <span class="k">pass</span>
</code></pre></div></div>

<h3 id="ai-driven-infrastructure">AI-Driven Infrastructure</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">NeuralInfrastructureOptimizer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Use deep learning to optimize infrastructure configurations
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_model</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reinforcement_learner</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_rl_agent</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Neural network for predicting optimal configurations
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,)),</span>  <span class="c1"># Variable length configs
</span>            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">LSTM</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Attention</span><span class="p">(),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">),</span>
            <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">sigmoid</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># Cost prediction
</span>        <span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">optimize_infrastructure</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Generate optimal Terraform configuration using AI
        </span><span class="sh">"""</span>
        <span class="c1"># Use reinforcement learning to explore configuration space
</span>        <span class="n">state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">encode_requirements</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_steps</span><span class="p">):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">reinforcement_learner</span><span class="p">.</span><span class="nf">act</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">next_state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">apply_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">decode_configuration</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
            
            <span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span>
</code></pre></div></div>

<h2 id="references-and-further-reading">References and Further Reading</h2>

<h3 id="academic-papers">Academic Papers</h3>
<ul>
  <li>“Formal Verification of Infrastructure as Code” - ACM SIGPLAN 2021</li>
  <li>“Category Theory for Infrastructure Composition” - ICFP 2020</li>
  <li>“Distributed Consensus in Infrastructure Management” - OSDI 2019</li>
</ul>

<h3 id="books">Books</h3>
<ul>
  <li>“Infrastructure as Code: Dynamic Systems for the Cloud Age” - Kief Morris</li>
  <li>“Terraform: Up &amp; Running” - Yevgeniy Brikman</li>
  <li>“The Tao of Microservices” - Richard Rodger</li>
</ul>

<h3 id="research-projects">Research Projects</h3>
<ul>
  <li>
<strong>CNCF Crossplane</strong>: Kubernetes-based Infrastructure as Code</li>
  <li>
<strong>AWS CDK</strong>: Cloud Development Kit for programmatic infrastructure</li>
  <li>
<strong>Pulumi</strong>: Infrastructure as Code using general-purpose languages</li>
</ul>

<h3 id="advanced-topics">Advanced Topics</h3>
<ul>
  <li>Graph algorithms for dependency resolution</li>
  <li>Distributed locking mechanisms</li>
  <li>State reconciliation algorithms</li>
  <li>Policy engines and compliance frameworks</li>
  <li>Infrastructure testing methodologies</li>
</ul>

<p>This comprehensive documentation transforms Terraform from a simple provisioning tool into a sophisticated system for infrastructure management, incorporating computer science theory, distributed systems principles, and cutting-edge research in infrastructure automation.</p>
